ok 1 - create systemcontacts 1
ok 2 - create contracts 1
ok 3 - create resellers 1
ok 4 - create billingprofiles 1
ok 5 - create billingzones 1
ok 6 - create billingfees 1
ok 7 - create billingfees 2
ok 8 - patch contracts id 61929
ok 9 - create domains 1
ok 10 - create billingprofiles 2
ok 11 - create billingzones 2
ok 12 - create billingfees 3
ok 13 - create billingfees 4
ok 14 - create billingprofiles 3
ok 15 - create billingzones 3
ok 16 - create billingfees 5
ok 17 - create billingfees 6
ok 18 - create systemcontacts 2
ok 19 - create contracts 2
ok 20 - create resellers 2
ok 21 - create billingprofiles 4
ok 22 - create billingzones 4
ok 23 - create billingfees 7
ok 24 - create billingfees 8
ok 25 - patch contracts id 61930
ok 26 - create domains 2
ok 27 - create billingprofiles 5
ok 28 - create billingzones 5
ok 29 - create billingfees 9
ok 30 - create billingfees 10
ok 31 - create billingprofiles 6
ok 32 - create billingzones 6
ok 33 - create billingfees 11
ok 34 - create billingfees 12
ok 35 - create customercontacts 1
ok 36 - create customers 1
ok 37 - setting customer id 61931 cash_balance to 0 cents
ok 38 - create subscribers 1
ok 39 - very first balance interval: fetch customer id 61931 balance intervals collection page
ok 40 - very first balance interval: check interval 77439 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 41 - very first balance interval: check interval 77439 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 42 - very first balance interval: check interval 77439 cash balance 0 = 0
ok 43 - very first balance interval: check interval 77439 billing profile id 1137 = 1137
ok 44 - very first balance interval: check if all expected items are listed
ok 45 - create customercontacts 2
ok 46 - create customers 2
ok 47 - setting customer id 61932 cash_balance to 0 cents
ok 48 - create subscribers 2
ok 49 - very first balance interval: fetch customer id 61932 balance intervals collection page
ok 50 - very first balance interval: check interval 77440 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 51 - very first balance interval: check interval 77440 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 52 - very first balance interval: check interval 77440 cash balance 0 = 0
ok 53 - very first balance interval: check interval 77440 billing profile id 1137 = 1137
ok 54 - very first balance interval: check if all expected items are listed
ok 55 - create customercontacts 3
ok 56 - create customers 3
ok 57 - setting customer id 61933 cash_balance to 0 cents
ok 58 - create subscribers 3
ok 59 - very first balance interval: fetch customer id 61933 balance intervals collection page
ok 60 - very first balance interval: check interval 77441 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 61 - very first balance interval: check interval 77441 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 62 - very first balance interval: check interval 77441 cash balance 0 = 0
ok 63 - very first balance interval: check interval 77441 billing profile id 1137 = 1137
ok 64 - very first balance interval: check if all expected items are listed
ok 65 - create customercontacts 4
ok 66 - create customers 4
ok 67 - setting customer id 61934 cash_balance to 0 cents
ok 68 - create subscribers 4
ok 69 - very first balance interval: fetch customer id 61934 balance intervals collection page
ok 70 - very first balance interval: check interval 77442 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 71 - very first balance interval: check interval 77442 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 72 - very first balance interval: check interval 77442 cash balance 0 = 0
ok 73 - very first balance interval: check interval 77442 billing profile id 1140 = 1140
ok 74 - very first balance interval: check if all expected items are listed
ok 75 - cdrs id 50861, 50862, 50863 created
INFO: Trying to connect to billing db...
INFO: Successfully connected to duplication db...
INFO: Trying to connect to provisioning db...
INFO: Successfully connected to provisioning db...
INFO: Trying to connect to accounting db...
INFO: Successfully connected to accounting db...
WARNING: No duplication db credentials, disabled.
INFO: local cdr relation column model loaded
INFO: local cdr cash balance column model loaded
INFO: local cdr time balance column model loaded
INFO: Up and running.
INFO: Grabbed 3 CDRs
DEBUG: start rating CDR ID 50861
DEBUG: 4 contract(s) locked: 61929, 61930, 61931, 61934
INFO: 1/3 - rate CDR ID 50861
DEBUG: fetching source provider info for source_provider_id #61929
DEBUG: catching up contract ID 61929 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61929 billing mapping (reseller) is profile id 1136 for time 1515794926.000 from ipv4 source ip 192.168.0.1
DEBUG: source_provider_info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1136,
                         'product_id' => 3,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => '61929',
                         'prepaid' => 0,
                         'class' => 'reseller',
                         'int_charge' => '0'
                       },
          'balances' => [
                          {
                            'id' => 77437,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: fetching destination provider info for destination_provider_id #61930
DEBUG: catching up contract ID 61930 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61930 billing mapping (reseller) is profile id 1139 for time 1515794926.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_provider_info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1139,
                         'product_id' => 3,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => '61930',
                         'prepaid' => 0,
                         'class' => 'reseller',
                         'int_charge' => '0'
                       },
          'balances' => [
                          {
                            'id' => 77438,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: ### 1. write pass ###
DEBUG: call from local subscriber, source_user_id is 38335c81-2e60-42ab-a5e9-364f90a86fc1
DEBUG: call to local subscriber, destination_user_id is 82fbdb32-446d-4f9b-b326-055667a6a4c8
DEBUG: destination provider has billing profile 1139, get reseller termination cost
DEBUG: calculating call cost for profile_id 1139 with type call, direction in, src_user_domain 888111515794822@testa.com.1515794822, dst_user_domain 888241515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '1',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '^888.+',
          'off_follow_interval' => 30,
          'fee_id' => 1624,
          'use_free_time' => 0,
          'on_init_rate' => '1',
          'zone_id' => 508,
          'off_init_interval' => 60,
          'pattern' => '.',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 1 per sec to costs
DEBUG: interval is 60, so rate for this interval is 60
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77438,
          'cash_balance_interval' => 0,
          'cash_balance' => 0,
          'start_unix' => 1514761200,
          'start' => '2018-01-01 00:00:00',
          'free_time_balance_old' => 0,
          'end_unix' => 1517439599,
          'cash_balance_old' => 0,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 60 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 60
DEBUG: rating_duration = 90
DEBUG: 1 contract balance row(s) updated
DEBUG: destination reseller termination cost is 90
DEBUG: get customer termination cost for destination_user_id 82fbdb32-446d-4f9b-b326-055667a6a4c8
DEBUG: catching up contract ID 61934 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61934 billing mapping (sipaccount) is profile id 1140 for time 1515794926.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_customer info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1140,
                         'product_id' => 4,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => 61934,
                         'prepaid' => 0,
                         'class' => 'sipaccount',
                         'int_charge' => '0'
                       },
          'balances' => [
                          {
                            'id' => 77442,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1140 with type call, direction in, src_user_domain 888111515794822@testa.com.1515794822, dst_user_domain 888241515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '5',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '^8881.+',
          'off_follow_interval' => 30,
          'fee_id' => 1626,
          'use_free_time' => 0,
          'on_init_rate' => '5',
          'zone_id' => 509,
          'off_init_interval' => 60,
          'pattern' => '.',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 5 per sec to costs
DEBUG: interval is 60, so rate for this interval is 300
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77442,
          'cash_balance' => '0',
          'cash_balance_interval' => '0',
          'start' => '2018-01-01 00:00:00',
          'start_unix' => 1514761200,
          'free_time_balance_old' => 0,
          'cash_balance_old' => '0',
          'end_unix' => 1517439599,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 300 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 300
DEBUG: rating_duration = 90
DEBUG: got call cost 330 and free time 0
DEBUG: billing profile is post-paid, update contract balance
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 330
DEBUG: destination customer termination cost is 330
DEBUG: calculating call cost for profile_id 1136 with type call, direction out, src_user_domain 888111515794822@testa.com.1515794822, dst_user_domain 888241515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '2',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '.',
          'off_follow_interval' => 30,
          'fee_id' => 1617,
          'use_free_time' => 0,
          'on_init_rate' => '2',
          'zone_id' => 505,
          'off_init_interval' => 60,
          'pattern' => '^888.+',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 2 per sec to costs
DEBUG: interval is 60, so rate for this interval is 120
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77437,
          'cash_balance_interval' => 0,
          'cash_balance' => 0,
          'start_unix' => 1514761200,
          'start' => '2018-01-01 00:00:00',
          'free_time_balance_old' => 0,
          'end_unix' => 1517439599,
          'cash_balance_old' => 0,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 120 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 120
DEBUG: rating_duration = 90
DEBUG: 1 contract balance row(s) updated
DEBUG: catching up contract ID 61931 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61931 billing mapping (sipaccount) is profile id 1137 for time 1515794926.000 from ipv4 source ip 192.168.0.1
DEBUG: source_customer info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1137,
                         'product_id' => 4,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => 61931,
                         'prepaid' => 0,
                         'int_charge' => '0',
                         'class' => 'sipaccount'
                       },
          'balances' => [
                          {
                            'id' => 77439,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1137 with type call, direction out, src_user_domain 888111515794822@testa.com.1515794822, dst_user_domain 888241515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '6',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '.',
          'off_follow_interval' => 30,
          'fee_id' => 1619,
          'use_free_time' => 0,
          'on_init_rate' => '6',
          'zone_id' => 506,
          'off_init_interval' => 60,
          'pattern' => '^8882.+',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 6 per sec to costs
DEBUG: interval is 60, so rate for this interval is 360
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77439,
          'cash_balance' => '0',
          'cash_balance_interval' => '0',
          'start' => '2018-01-01 00:00:00',
          'start_unix' => 1514761200,
          'free_time_balance_old' => 0,
          'cash_balance_old' => '0',
          'end_unix' => 1517439599,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 360 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 360
DEBUG: rating_duration = 90
DEBUG: got call cost 390 and free time 0
DEBUG: billing profile is post-paid, update contract balance
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 390
DEBUG: cdr ID 50861 updated
DEBUG: empty 'source_carrier_cash_balance' local col data for cdr id 50861, skipping
DEBUG: empty 'source_carrier_free_time_balance' local col data for cdr id 50861, skipping
DEBUG: empty 'source_carrier_profile_package_id' local col data for cdr id 50861, skipping
DEBUG: empty 'source_carrier_contract_balance_id' local col data for cdr id 50861, skipping
DEBUG: local col data created or up to date for cdr id 50861, column 'source_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50861, column 'source_reseller_free_time_balance': 0, 0
DEBUG: empty 'source_reseller_profile_package_id' local col data for cdr id 50861, skipping
DEBUG: local col data created or up to date for cdr id 50861, column 'source_reseller_contract_balance_id': 77437
DEBUG: local col data created or up to date for cdr id 50861, column 'source_customer_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50861, column 'source_customer_free_time_balance': 0, 0
DEBUG: empty 'source_customer_profile_package_id' local col data for cdr id 50861, skipping
DEBUG: local col data created or up to date for cdr id 50861, column 'source_customer_contract_balance_id': 77439
DEBUG: empty 'destination_carrier_cash_balance' local col data for cdr id 50861, skipping
DEBUG: empty 'destination_carrier_free_time_balance' local col data for cdr id 50861, skipping
DEBUG: empty 'destination_carrier_profile_package_id' local col data for cdr id 50861, skipping
DEBUG: empty 'destination_carrier_contract_balance_id' local col data for cdr id 50861, skipping
DEBUG: local col data created or up to date for cdr id 50861, column 'destination_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50861, column 'destination_reseller_free_time_balance': 0, 0
DEBUG: empty 'destination_reseller_profile_package_id' local col data for cdr id 50861, skipping
DEBUG: local col data created or up to date for cdr id 50861, column 'destination_reseller_contract_balance_id': 77438
DEBUG: local col data created or up to date for cdr id 50861, column 'destination_customer_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50861, column 'destination_customer_free_time_balance': 0, 0
DEBUG: empty 'destination_customer_profile_package_id' local col data for cdr id 50861, skipping
DEBUG: local col data created or up to date for cdr id 50861, column 'destination_customer_contract_balance_id': 77442
DEBUG: rating cdr ID 50861 completed successfully in 0.249 secs
DEBUG: start rating CDR ID 50862
DEBUG: 4 contract(s) locked: 61929, 61930, 61932, 61934
INFO: 2/3 - rate CDR ID 50862
DEBUG: fetching source provider info for source_provider_id #61929
DEBUG: catching up contract ID 61929 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61929 billing mapping (reseller) is profile id 1136 for time 1515794927.000 from ipv4 source ip 192.168.0.1
DEBUG: source_provider_info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1136,
                         'product_id' => 3,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => '61929',
                         'prepaid' => 0,
                         'int_charge' => '0',
                         'class' => 'reseller'
                       },
          'balances' => [
                          {
                            'id' => 77437,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '150',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: fetching destination provider info for destination_provider_id #61930
DEBUG: catching up contract ID 61930 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61930 billing mapping (reseller) is profile id 1139 for time 1515794927.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_provider_info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1139,
                         'product_id' => 3,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => '61930',
                         'prepaid' => 0,
                         'int_charge' => '0',
                         'class' => 'reseller'
                       },
          'balances' => [
                          {
                            'id' => 77438,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '90',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: ### 1. write pass ###
DEBUG: call from local subscriber, source_user_id is 9cbe75b0-78a2-4f5f-8988-07c4daabd84e
DEBUG: call to local subscriber, destination_user_id is 82fbdb32-446d-4f9b-b326-055667a6a4c8
DEBUG: destination provider has billing profile 1139, get reseller termination cost
DEBUG: calculating call cost for profile_id 1139 with type call, direction in, src_user_domain 888121515794822@testa.com.1515794822, dst_user_domain 888241515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '1',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '^888.+',
          'off_follow_interval' => 30,
          'fee_id' => 1624,
          'use_free_time' => 0,
          'on_init_rate' => '1',
          'zone_id' => 508,
          'off_init_interval' => 60,
          'pattern' => '.',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 1 per sec to costs
DEBUG: interval is 60, so rate for this interval is 60
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77438,
          'cash_balance_interval' => 90,
          'cash_balance' => 0,
          'start_unix' => 1514761200,
          'start' => '2018-01-01 00:00:00',
          'free_time_balance_old' => 0,
          'end_unix' => 1517439599,
          'cash_balance_old' => 0,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 60 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 60
DEBUG: rating_duration = 90
DEBUG: 1 contract balance row(s) updated
DEBUG: destination reseller termination cost is 90
DEBUG: get customer termination cost for destination_user_id 82fbdb32-446d-4f9b-b326-055667a6a4c8
DEBUG: catching up contract ID 61934 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61934 billing mapping (sipaccount) is profile id 1140 for time 1515794927.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_customer info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1140,
                         'product_id' => 4,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => 61934,
                         'prepaid' => 0,
                         'int_charge' => '0',
                         'class' => 'sipaccount'
                       },
          'balances' => [
                          {
                            'id' => 77442,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '330',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1140 with type call, direction in, src_user_domain 888121515794822@testa.com.1515794822, dst_user_domain 888241515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '5',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '^8881.+',
          'off_follow_interval' => 30,
          'fee_id' => 1626,
          'use_free_time' => 0,
          'on_init_rate' => '5',
          'zone_id' => 509,
          'off_init_interval' => 60,
          'pattern' => '.',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 5 per sec to costs
DEBUG: interval is 60, so rate for this interval is 300
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77442,
          'cash_balance' => '0',
          'cash_balance_interval' => '330',
          'start' => '2018-01-01 00:00:00',
          'start_unix' => 1514761200,
          'free_time_balance_old' => 0,
          'cash_balance_old' => '0',
          'end_unix' => 1517439599,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 300 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 300
DEBUG: rating_duration = 90
DEBUG: got call cost 330 and free time 0
DEBUG: billing profile is post-paid, update contract balance
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 330
DEBUG: destination customer termination cost is 330
DEBUG: calculating call cost for profile_id 1136 with type call, direction out, src_user_domain 888121515794822@testa.com.1515794822, dst_user_domain 888241515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '2',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '.',
          'off_follow_interval' => 30,
          'fee_id' => 1617,
          'use_free_time' => 0,
          'on_init_rate' => '2',
          'zone_id' => 505,
          'off_init_interval' => 60,
          'pattern' => '^888.+',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 2 per sec to costs
DEBUG: interval is 60, so rate for this interval is 120
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77437,
          'cash_balance_interval' => 150,
          'cash_balance' => 0,
          'start_unix' => 1514761200,
          'start' => '2018-01-01 00:00:00',
          'free_time_balance_old' => 0,
          'end_unix' => 1517439599,
          'cash_balance_old' => 0,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 120 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 120
DEBUG: rating_duration = 90
DEBUG: 1 contract balance row(s) updated
DEBUG: catching up contract ID 61932 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61932 billing mapping (sipaccount) is profile id 1137 for time 1515794927.000 from ipv4 source ip 192.168.0.1
DEBUG: source_customer info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1137,
                         'product_id' => 4,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => 61932,
                         'prepaid' => 0,
                         'int_charge' => '0',
                         'class' => 'sipaccount'
                       },
          'balances' => [
                          {
                            'id' => 77440,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1137 with type call, direction out, src_user_domain 888121515794822@testa.com.1515794822, dst_user_domain 888241515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '6',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '.',
          'off_follow_interval' => 30,
          'fee_id' => 1619,
          'use_free_time' => 0,
          'on_init_rate' => '6',
          'zone_id' => 506,
          'off_init_interval' => 60,
          'pattern' => '^8882.+',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 6 per sec to costs
DEBUG: interval is 60, so rate for this interval is 360
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77440,
          'cash_balance' => '0',
          'cash_balance_interval' => '0',
          'start' => '2018-01-01 00:00:00',
          'start_unix' => 1514761200,
          'free_time_balance_old' => 0,
          'cash_balance_old' => '0',
          'end_unix' => 1517439599,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 360 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 360
DEBUG: rating_duration = 90
DEBUG: got call cost 390 and free time 0
DEBUG: billing profile is post-paid, update contract balance
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 390
DEBUG: cdr ID 50862 updated
DEBUG: empty 'source_carrier_cash_balance' local col data for cdr id 50862, skipping
DEBUG: empty 'source_carrier_free_time_balance' local col data for cdr id 50862, skipping
DEBUG: empty 'source_carrier_profile_package_id' local col data for cdr id 50862, skipping
DEBUG: empty 'source_carrier_contract_balance_id' local col data for cdr id 50862, skipping
DEBUG: local col data created or up to date for cdr id 50862, column 'source_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50862, column 'source_reseller_free_time_balance': 0, 0
DEBUG: empty 'source_reseller_profile_package_id' local col data for cdr id 50862, skipping
DEBUG: local col data created or up to date for cdr id 50862, column 'source_reseller_contract_balance_id': 77437
DEBUG: local col data created or up to date for cdr id 50862, column 'source_customer_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50862, column 'source_customer_free_time_balance': 0, 0
DEBUG: empty 'source_customer_profile_package_id' local col data for cdr id 50862, skipping
DEBUG: local col data created or up to date for cdr id 50862, column 'source_customer_contract_balance_id': 77440
DEBUG: empty 'destination_carrier_cash_balance' local col data for cdr id 50862, skipping
DEBUG: empty 'destination_carrier_free_time_balance' local col data for cdr id 50862, skipping
DEBUG: empty 'destination_carrier_profile_package_id' local col data for cdr id 50862, skipping
DEBUG: empty 'destination_carrier_contract_balance_id' local col data for cdr id 50862, skipping
DEBUG: local col data created or up to date for cdr id 50862, column 'destination_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50862, column 'destination_reseller_free_time_balance': 0, 0
DEBUG: empty 'destination_reseller_profile_package_id' local col data for cdr id 50862, skipping
DEBUG: local col data created or up to date for cdr id 50862, column 'destination_reseller_contract_balance_id': 77438
DEBUG: local col data created or up to date for cdr id 50862, column 'destination_customer_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50862, column 'destination_customer_free_time_balance': 0, 0
DEBUG: empty 'destination_customer_profile_package_id' local col data for cdr id 50862, skipping
DEBUG: local col data created or up to date for cdr id 50862, column 'destination_customer_contract_balance_id': 77442
DEBUG: rating cdr ID 50862 completed successfully in 0.180 secs
DEBUG: start rating CDR ID 50863
DEBUG: 4 contract(s) locked: 61929, 61930, 61933, 61934
INFO: 3/3 - rate CDR ID 50863
DEBUG: fetching source provider info for source_provider_id #61929
DEBUG: catching up contract ID 61929 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61929 billing mapping (reseller) is profile id 1136 for time 1515794928.000 from ipv4 source ip 192.168.0.1
DEBUG: source_provider_info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1136,
                         'product_id' => 3,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => '61929',
                         'prepaid' => 0,
                         'int_charge' => '0',
                         'class' => 'reseller'
                       },
          'balances' => [
                          {
                            'id' => 77437,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '300',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: fetching destination provider info for destination_provider_id #61930
DEBUG: catching up contract ID 61930 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61930 billing mapping (reseller) is profile id 1139 for time 1515794928.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_provider_info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1139,
                         'product_id' => 3,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => '61930',
                         'prepaid' => 0,
                         'int_charge' => '0',
                         'class' => 'reseller'
                       },
          'balances' => [
                          {
                            'id' => 77438,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '180',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: ### 1. write pass ###
DEBUG: call from local subscriber, source_user_id is 28cd5b78-7755-42ac-a260-8b3deb4014a3
DEBUG: call to local subscriber, destination_user_id is 82fbdb32-446d-4f9b-b326-055667a6a4c8
DEBUG: destination provider has billing profile 1139, get reseller termination cost
DEBUG: calculating call cost for profile_id 1139 with type call, direction in, src_user_domain 888131515794822@testa.com.1515794822, dst_user_domain 888241515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '1',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '^888.+',
          'off_follow_interval' => 30,
          'fee_id' => 1624,
          'use_free_time' => 0,
          'on_init_rate' => '1',
          'zone_id' => 508,
          'off_init_interval' => 60,
          'pattern' => '.',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 1 per sec to costs
DEBUG: interval is 60, so rate for this interval is 60
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77438,
          'cash_balance_interval' => 180,
          'cash_balance' => 0,
          'start_unix' => 1514761200,
          'start' => '2018-01-01 00:00:00',
          'free_time_balance_old' => 0,
          'end_unix' => 1517439599,
          'cash_balance_old' => 0,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 60 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 60
DEBUG: rating_duration = 90
DEBUG: 1 contract balance row(s) updated
DEBUG: destination reseller termination cost is 90
DEBUG: get customer termination cost for destination_user_id 82fbdb32-446d-4f9b-b326-055667a6a4c8
DEBUG: catching up contract ID 61934 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61934 billing mapping (sipaccount) is profile id 1140 for time 1515794928.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_customer info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1140,
                         'product_id' => 4,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => 61934,
                         'prepaid' => 0,
                         'int_charge' => '0',
                         'class' => 'sipaccount'
                       },
          'balances' => [
                          {
                            'id' => 77442,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '660',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1140 with type call, direction in, src_user_domain 888131515794822@testa.com.1515794822, dst_user_domain 888241515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '5',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '^8881.+',
          'off_follow_interval' => 30,
          'fee_id' => 1626,
          'use_free_time' => 0,
          'on_init_rate' => '5',
          'zone_id' => 509,
          'off_init_interval' => 60,
          'pattern' => '.',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 5 per sec to costs
DEBUG: interval is 60, so rate for this interval is 300
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77442,
          'cash_balance' => '0',
          'cash_balance_interval' => '660',
          'start' => '2018-01-01 00:00:00',
          'start_unix' => 1514761200,
          'free_time_balance_old' => 0,
          'cash_balance_old' => '0',
          'end_unix' => 1517439599,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 300 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 300
DEBUG: rating_duration = 90
DEBUG: got call cost 330 and free time 0
DEBUG: billing profile is post-paid, update contract balance
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 330
DEBUG: destination customer termination cost is 330
DEBUG: calculating call cost for profile_id 1136 with type call, direction out, src_user_domain 888131515794822@testa.com.1515794822, dst_user_domain 888241515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '2',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '.',
          'off_follow_interval' => 30,
          'fee_id' => 1617,
          'use_free_time' => 0,
          'on_init_rate' => '2',
          'zone_id' => 505,
          'off_init_interval' => 60,
          'pattern' => '^888.+',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 2 per sec to costs
DEBUG: interval is 60, so rate for this interval is 120
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77437,
          'cash_balance_interval' => 300,
          'cash_balance' => 0,
          'start_unix' => 1514761200,
          'start' => '2018-01-01 00:00:00',
          'free_time_balance_old' => 0,
          'end_unix' => 1517439599,
          'cash_balance_old' => 0,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 120 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 120
DEBUG: rating_duration = 90
DEBUG: 1 contract balance row(s) updated
DEBUG: catching up contract ID 61933 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61933 billing mapping (sipaccount) is profile id 1137 for time 1515794928.000 from ipv4 source ip 192.168.0.1
DEBUG: source_customer info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1137,
                         'product_id' => 4,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => 61933,
                         'prepaid' => 0,
                         'int_charge' => '0',
                         'class' => 'sipaccount'
                       },
          'balances' => [
                          {
                            'id' => 77441,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1137 with type call, direction out, src_user_domain 888131515794822@testa.com.1515794822, dst_user_domain 888241515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '6',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '.',
          'off_follow_interval' => 30,
          'fee_id' => 1619,
          'use_free_time' => 0,
          'on_init_rate' => '6',
          'zone_id' => 506,
          'off_init_interval' => 60,
          'pattern' => '^8882.+',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 6 per sec to costs
DEBUG: interval is 60, so rate for this interval is 360
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77441,
          'cash_balance' => '0',
          'cash_balance_interval' => '0',
          'start' => '2018-01-01 00:00:00',
          'start_unix' => 1514761200,
          'free_time_balance_old' => 0,
          'cash_balance_old' => '0',
          'end_unix' => 1517439599,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 360 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 360
DEBUG: rating_duration = 90
DEBUG: got call cost 390 and free time 0
DEBUG: billing profile is post-paid, update contract balance
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 390
DEBUG: cdr ID 50863 updated
DEBUG: empty 'source_carrier_cash_balance' local col data for cdr id 50863, skipping
DEBUG: empty 'source_carrier_free_time_balance' local col data for cdr id 50863, skipping
DEBUG: empty 'source_carrier_profile_package_id' local col data for cdr id 50863, skipping
DEBUG: empty 'source_carrier_contract_balance_id' local col data for cdr id 50863, skipping
DEBUG: local col data created or up to date for cdr id 50863, column 'source_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50863, column 'source_reseller_free_time_balance': 0, 0
DEBUG: empty 'source_reseller_profile_package_id' local col data for cdr id 50863, skipping
DEBUG: local col data created or up to date for cdr id 50863, column 'source_reseller_contract_balance_id': 77437
DEBUG: local col data created or up to date for cdr id 50863, column 'source_customer_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50863, column 'source_customer_free_time_balance': 0, 0
DEBUG: empty 'source_customer_profile_package_id' local col data for cdr id 50863, skipping
DEBUG: local col data created or up to date for cdr id 50863, column 'source_customer_contract_balance_id': 77441
DEBUG: empty 'destination_carrier_cash_balance' local col data for cdr id 50863, skipping
DEBUG: empty 'destination_carrier_free_time_balance' local col data for cdr id 50863, skipping
DEBUG: empty 'destination_carrier_profile_package_id' local col data for cdr id 50863, skipping
DEBUG: empty 'destination_carrier_contract_balance_id' local col data for cdr id 50863, skipping
DEBUG: local col data created or up to date for cdr id 50863, column 'destination_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50863, column 'destination_reseller_free_time_balance': 0, 0
DEBUG: empty 'destination_reseller_profile_package_id' local col data for cdr id 50863, skipping
DEBUG: local col data created or up to date for cdr id 50863, column 'destination_reseller_contract_balance_id': 77438
DEBUG: local col data created or up to date for cdr id 50863, column 'destination_customer_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50863, column 'destination_customer_free_time_balance': 0, 0
DEBUG: empty 'destination_customer_profile_package_id' local col data for cdr id 50863, skipping
DEBUG: local col data created or up to date for cdr id 50863, column 'destination_customer_contract_balance_id': 77442
DEBUG: rating cdr ID 50863 completed successfully in 0.257 secs
INFO: Batch of 3 CDRs completed. 3 CDRs rated overall so far.
INFO: Less than 5 new CDRs, sleep 10
ok 76 - rate-o-mat executed
ok 77 - postpaid, no balance: rating_status = ok
ok 78 - postpaid, no balance: source_customer_cost = 390.000000
ok 79 - postpaid, no balance: destination_customer_cost = 330.000000
ok 80 - postpaid, no balance: destination_reseller_cost = 90.000000
ok 81 - postpaid, no balance: source_reseller_cost = 150.000000
ok 82 - postpaid, no balance: id = 50862
ok 83 - postpaid, no balance: rating_status = ok
ok 84 - postpaid, no balance: destination_customer_cost = 330.000000
ok 85 - postpaid, no balance: source_customer_cost = 390.000000
ok 86 - postpaid, no balance: source_reseller_cost = 150.000000
ok 87 - postpaid, no balance: destination_reseller_cost = 90.000000
ok 88 - postpaid, no balance: id = 50863
ok 89 - postpaid, no balance: source_customer_cost = 390.000000
ok 90 - postpaid, no balance: destination_customer_cost = 330.000000
ok 91 - postpaid, no balance: rating_status = ok
ok 92 - postpaid, no balance: id = 50861
ok 93 - postpaid, no balance: source_reseller_cost = 150.000000
ok 94 - postpaid, no balance: destination_reseller_cost = 90.000000
ok 95 - cdrs were all processed
ok 96 - postpaid, no balance, caller 1: cdr id 50861 source_customer_contract_balance_id number of records 1 = 1
ok 97 - postpaid, no balance, caller 1: fetch customer id 61931 balance intervals collection page
ok 98 - postpaid, no balance, caller 1: check 'total_count' of collection
ok 99 - postpaid, no balance, caller 1: check interval 77439 cash balance 0 = 0
ok 100 - postpaid, no balance, caller 1: check interval 77439 cash balance interval 3.9 = 3.9
ok 101 - postpaid, no balance, caller 1: check interval 77439 id = 77439
ok 102 - postpaid, no balance, caller 1: check if all expected items are listed
ok 103 - postpaid, no balance, caller 1: cdr id 50861 source_customer_cash_balance before 0.0000 = 0.0000
ok 104 - postpaid, no balance, caller 1: cdr id 50861 source_customer_cash_balance after 0.0000 = 0.0000
ok 105 - postpaid, no balance, caller 2: cdr id 50862 source_customer_contract_balance_id number of records 1 = 1
ok 106 - postpaid, no balance, caller 2: fetch customer id 61932 balance intervals collection page
ok 107 - postpaid, no balance, caller 2: check 'total_count' of collection
ok 108 - postpaid, no balance, caller 2: check interval 77440 cash balance 0 = 0
ok 109 - postpaid, no balance, caller 2: check interval 77440 cash balance interval 3.9 = 3.9
ok 110 - postpaid, no balance, caller 2: check interval 77440 id = 77440
ok 111 - postpaid, no balance, caller 2: check if all expected items are listed
ok 112 - postpaid, no balance, caller 2: cdr id 50862 source_customer_cash_balance before 0.0000 = 0.0000
ok 113 - postpaid, no balance, caller 2: cdr id 50862 source_customer_cash_balance after 0.0000 = 0.0000
ok 114 - postpaid, no balance, caller 3: cdr id 50863 source_customer_contract_balance_id number of records 1 = 1
ok 115 - postpaid, no balance, caller 3: fetch customer id 61933 balance intervals collection page
ok 116 - postpaid, no balance, caller 3: check 'total_count' of collection
ok 117 - postpaid, no balance, caller 3: check interval 77441 cash balance 0 = 0
ok 118 - postpaid, no balance, caller 3: check interval 77441 cash balance interval 3.9 = 3.9
ok 119 - postpaid, no balance, caller 3: check interval 77441 id = 77441
ok 120 - postpaid, no balance, caller 3: check if all expected items are listed
ok 121 - postpaid, no balance, caller 3: cdr id 50863 source_customer_cash_balance before 0.0000 = 0.0000
ok 122 - postpaid, no balance, caller 3: cdr id 50863 source_customer_cash_balance after 0.0000 = 0.0000
ok 123 - postpaid, no balance, callee: cdr id 50861 destination_customer_contract_balance_id number of records 1 = 1
ok 124 - postpaid, no balance, callee: fetch customer id 61934 balance intervals collection page
ok 125 - postpaid, no balance, callee: check 'total_count' of collection
ok 126 - postpaid, no balance, callee: check interval 77442 cash balance 0 = 0
ok 127 - postpaid, no balance, callee: check interval 77442 cash balance interval 9.9 = 9.9
ok 128 - postpaid, no balance, callee: check interval 77442 id = 77442
ok 129 - postpaid, no balance, callee: check if all expected items are listed
ok 130 - postpaid, no balance, callee: cdr id 50861 destination_customer_contract_balance_id 77442 = 77442
ok 131 - postpaid, no balance, callee: cdr id 50861 destination_customer_cash_balance before 0.0000 = 0.0000
ok 132 - postpaid, no balance, callee: cdr id 50861 destination_customer_cash_balance after 0.0000 = 0.0000
ok 133 - postpaid, no balance, callee: cdr id 50862 destination_customer_contract_balance_id 77442 = 77442
ok 134 - postpaid, no balance, callee: cdr id 50862 destination_customer_cash_balance before 0.0000 = 0.0000
ok 135 - postpaid, no balance, callee: cdr id 50862 destination_customer_cash_balance after 0.0000 = 0.0000
ok 136 - postpaid, no balance, callee: cdr id 50863 destination_customer_contract_balance_id 77442 = 77442
ok 137 - postpaid, no balance, callee: cdr id 50863 destination_customer_cash_balance before 0.0000 = 0.0000
ok 138 - postpaid, no balance, callee: cdr id 50863 destination_customer_cash_balance after 0.0000 = 0.0000
ok 139 - postpaid, no balance, callers' provider: cdr id 50861 source_reseller_contract_balance_id number of records 1 = 1
ok 140 - postpaid, no balance, callers' provider: fetch customer id 61929 balance intervals collection page
ok 141 - postpaid, no balance, callers' provider: check 'total_count' of collection
ok 142 - postpaid, no balance, callers' provider: check interval 77437 cash balance interval 4.5 = 4.5
ok 143 - postpaid, no balance, callers' provider: check interval 77437 id = 77437
ok 144 - postpaid, no balance, callers' provider: check if all expected items are listed
ok 145 - postpaid, no balance, callers' provider: cdr id 50861 source_carrier_contract_balance_id number of records 0 = 0
ok 146 - postpaid, no balance, callers' provider: cdr id 50861 source_reseller_contract_balance_id 77437 = 77437
ok 147 - postpaid, no balance, callers' provider: cdr id 50862 source_carrier_contract_balance_id number of records 0 = 0
ok 148 - postpaid, no balance, callers' provider: cdr id 50862 source_reseller_contract_balance_id 77437 = 77437
ok 149 - postpaid, no balance, callers' provider: cdr id 50863 source_carrier_contract_balance_id number of records 0 = 0
ok 150 - postpaid, no balance, callers' provider: cdr id 50863 source_reseller_contract_balance_id 77437 = 77437
ok 151 - postpaid, no balance, callee's provider: cdr id 50861 destination_reseller_contract_balance_id number of records 1 = 1
ok 152 - postpaid, no balance, callee's provider: fetch customer id 61930 balance intervals collection page
ok 153 - postpaid, no balance, callee's provider: check 'total_count' of collection
ok 154 - postpaid, no balance, callee's provider: check interval 77438 cash balance interval 2.7 = 2.7
ok 155 - postpaid, no balance, callee's provider: check interval 77438 id = 77438
ok 156 - postpaid, no balance, callee's provider: check if all expected items are listed
ok 157 - postpaid, no balance, callee's provider: cdr id 50861 destination_carrier_contract_balance_id number of records 0 = 0
ok 158 - postpaid, no balance, callee's provider: cdr id 50861 destination_reseller_contract_balance_id 77438 = 77438
ok 159 - postpaid, no balance, callee's provider: cdr id 50862 destination_carrier_contract_balance_id number of records 0 = 0
ok 160 - postpaid, no balance, callee's provider: cdr id 50862 destination_reseller_contract_balance_id 77438 = 77438
ok 161 - postpaid, no balance, callee's provider: cdr id 50863 destination_carrier_contract_balance_id number of records 0 = 0
ok 162 - postpaid, no balance, callee's provider: cdr id 50863 destination_reseller_contract_balance_id 77438 = 77438
ok 163 - postpaid, no balance providers and subscriber must not have a profile package: cdr id 50861 source_carrier_profile_package_id number of records 0 = 0
ok 164 - postpaid, no balance providers and subscriber must not have a profile package: cdr id 50861 source_reseller_profile_package_id number of records 0 = 0
ok 165 - postpaid, no balance providers and subscriber must not have a profile package: cdr id 50861 source_customer_profile_package_id number of records 0 = 0
ok 166 - postpaid, no balance providers and subscriber must not have a profile package: cdr id 50861 destination_carrier_profile_package_id number of records 0 = 0
ok 167 - postpaid, no balance providers and subscriber must not have a profile package: cdr id 50861 destination_reseller_profile_package_id number of records 0 = 0
ok 168 - postpaid, no balance providers and subscriber must not have a profile package: cdr id 50861 destination_customer_profile_package_id number of records 0 = 0
ok 169 - postpaid, no balance providers and subscriber must not have a profile package: cdr id 50862 source_carrier_profile_package_id number of records 0 = 0
ok 170 - postpaid, no balance providers and subscriber must not have a profile package: cdr id 50862 source_reseller_profile_package_id number of records 0 = 0
ok 171 - postpaid, no balance providers and subscriber must not have a profile package: cdr id 50862 source_customer_profile_package_id number of records 0 = 0
ok 172 - postpaid, no balance providers and subscriber must not have a profile package: cdr id 50862 destination_carrier_profile_package_id number of records 0 = 0
ok 173 - postpaid, no balance providers and subscriber must not have a profile package: cdr id 50862 destination_reseller_profile_package_id number of records 0 = 0
ok 174 - postpaid, no balance providers and subscriber must not have a profile package: cdr id 50862 destination_customer_profile_package_id number of records 0 = 0
ok 175 - postpaid, no balance providers and subscriber must not have a profile package: cdr id 50863 source_carrier_profile_package_id number of records 0 = 0
ok 176 - postpaid, no balance providers and subscriber must not have a profile package: cdr id 50863 source_reseller_profile_package_id number of records 0 = 0
ok 177 - postpaid, no balance providers and subscriber must not have a profile package: cdr id 50863 source_customer_profile_package_id number of records 0 = 0
ok 178 - postpaid, no balance providers and subscriber must not have a profile package: cdr id 50863 destination_carrier_profile_package_id number of records 0 = 0
ok 179 - postpaid, no balance providers and subscriber must not have a profile package: cdr id 50863 destination_reseller_profile_package_id number of records 0 = 0
ok 180 - postpaid, no balance providers and subscriber must not have a profile package: cdr id 50863 destination_customer_profile_package_id number of records 0 = 0
ok 181 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50861 source_carrier_free_time_balance number of records 0 = 0
ok 182 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50861 source_reseller_free_time_balance before 0 = 0
ok 183 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50861 source_reseller_free_time_balance after 0 = 0
ok 184 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50861 source_customer_free_time_balance before 0 = 0
ok 185 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50861 source_customer_free_time_balance after 0 = 0
ok 186 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50861 destination_carrier_free_time_balance number of records 0 = 0
ok 187 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50861 destination_reseller_free_time_balance before 0 = 0
ok 188 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50861 destination_reseller_free_time_balance after 0 = 0
ok 189 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50861 destination_customer_free_time_balance before 0 = 0
ok 190 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50861 destination_customer_free_time_balance after 0 = 0
ok 191 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50862 source_carrier_free_time_balance number of records 0 = 0
ok 192 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50862 source_reseller_free_time_balance before 0 = 0
ok 193 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50862 source_reseller_free_time_balance after 0 = 0
ok 194 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50862 source_customer_free_time_balance before 0 = 0
ok 195 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50862 source_customer_free_time_balance after 0 = 0
ok 196 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50862 destination_carrier_free_time_balance number of records 0 = 0
ok 197 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50862 destination_reseller_free_time_balance before 0 = 0
ok 198 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50862 destination_reseller_free_time_balance after 0 = 0
ok 199 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50862 destination_customer_free_time_balance before 0 = 0
ok 200 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50862 destination_customer_free_time_balance after 0 = 0
ok 201 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50863 source_carrier_free_time_balance number of records 0 = 0
ok 202 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50863 source_reseller_free_time_balance before 0 = 0
ok 203 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50863 source_reseller_free_time_balance after 0 = 0
ok 204 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50863 source_customer_free_time_balance before 0 = 0
ok 205 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50863 source_customer_free_time_balance after 0 = 0
ok 206 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50863 destination_carrier_free_time_balance number of records 0 = 0
ok 207 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50863 destination_reseller_free_time_balance before 0 = 0
ok 208 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50863 destination_reseller_free_time_balance after 0 = 0
ok 209 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50863 destination_customer_free_time_balance before 0 = 0
ok 210 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50863 destination_customer_free_time_balance after 0 = 0
ok 211 - postpaid, no balance providers must have zero balance: cdr id 50861 source_carrier_cash_balance number of records 0 = 0
ok 212 - postpaid, no balance providers must have zero balance: cdr id 50861 source_reseller_cash_balance before 0.0000 = 0.0000
ok 213 - postpaid, no balance providers must have zero balance: cdr id 50861 source_reseller_cash_balance after 0.0000 = 0.0000
ok 214 - postpaid, no balance providers must have zero balance: cdr id 50861 destination_carrier_cash_balance number of records 0 = 0
ok 215 - postpaid, no balance providers must have zero balance: cdr id 50861 destination_reseller_cash_balance before 0.0000 = 0.0000
ok 216 - postpaid, no balance providers must have zero balance: cdr id 50861 destination_reseller_cash_balance after 0.0000 = 0.0000
ok 217 - postpaid, no balance providers must have zero balance: cdr id 50862 source_carrier_cash_balance number of records 0 = 0
ok 218 - postpaid, no balance providers must have zero balance: cdr id 50862 source_reseller_cash_balance before 0.0000 = 0.0000
ok 219 - postpaid, no balance providers must have zero balance: cdr id 50862 source_reseller_cash_balance after 0.0000 = 0.0000
ok 220 - postpaid, no balance providers must have zero balance: cdr id 50862 destination_carrier_cash_balance number of records 0 = 0
ok 221 - postpaid, no balance providers must have zero balance: cdr id 50862 destination_reseller_cash_balance before 0.0000 = 0.0000
ok 222 - postpaid, no balance providers must have zero balance: cdr id 50862 destination_reseller_cash_balance after 0.0000 = 0.0000
ok 223 - postpaid, no balance providers must have zero balance: cdr id 50863 source_carrier_cash_balance number of records 0 = 0
ok 224 - postpaid, no balance providers must have zero balance: cdr id 50863 source_reseller_cash_balance before 0.0000 = 0.0000
ok 225 - postpaid, no balance providers must have zero balance: cdr id 50863 source_reseller_cash_balance after 0.0000 = 0.0000
ok 226 - postpaid, no balance providers must have zero balance: cdr id 50863 destination_carrier_cash_balance number of records 0 = 0
ok 227 - postpaid, no balance providers must have zero balance: cdr id 50863 destination_reseller_cash_balance before 0.0000 = 0.0000
ok 228 - postpaid, no balance providers must have zero balance: cdr id 50863 destination_reseller_cash_balance after 0.0000 = 0.0000
ok 229 - create customercontacts 5
ok 230 - create customers 5
ok 231 - setting customer id 61935 cash_balance to 1000 cents
ok 232 - create subscribers 5
ok 233 - very first balance interval: fetch customer id 61935 balance intervals collection page
ok 234 - very first balance interval: check interval 77443 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 235 - very first balance interval: check interval 77443 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 236 - very first balance interval: check interval 77443 cash balance 10 = 10
ok 237 - very first balance interval: check interval 77443 billing profile id 1137 = 1137
ok 238 - very first balance interval: check if all expected items are listed
ok 239 - create customercontacts 6
ok 240 - create customers 6
ok 241 - setting customer id 61936 cash_balance to 1000 cents
ok 242 - create subscribers 6
ok 243 - very first balance interval: fetch customer id 61936 balance intervals collection page
ok 244 - very first balance interval: check interval 77444 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 245 - very first balance interval: check interval 77444 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 246 - very first balance interval: check interval 77444 cash balance 10 = 10
ok 247 - very first balance interval: check interval 77444 billing profile id 1137 = 1137
ok 248 - very first balance interval: check if all expected items are listed
ok 249 - create customercontacts 7
ok 250 - create customers 7
ok 251 - setting customer id 61937 cash_balance to 1000 cents
ok 252 - create subscribers 7
ok 253 - very first balance interval: fetch customer id 61937 balance intervals collection page
ok 254 - very first balance interval: check interval 77445 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 255 - very first balance interval: check interval 77445 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 256 - very first balance interval: check interval 77445 cash balance 10 = 10
ok 257 - very first balance interval: check interval 77445 billing profile id 1137 = 1137
ok 258 - very first balance interval: check if all expected items are listed
ok 259 - create customercontacts 8
ok 260 - create customers 8
ok 261 - setting customer id 61938 cash_balance to 1000 cents
ok 262 - create subscribers 8
ok 263 - very first balance interval: fetch customer id 61938 balance intervals collection page
ok 264 - very first balance interval: check interval 77446 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 265 - very first balance interval: check interval 77446 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 266 - very first balance interval: check interval 77446 cash balance 10 = 10
ok 267 - very first balance interval: check interval 77446 billing profile id 1140 = 1140
ok 268 - very first balance interval: check if all expected items are listed
ok 269 - cdrs id 50864, 50865, 50866 created
INFO: Trying to connect to billing db...
INFO: Successfully connected to duplication db...
INFO: Trying to connect to provisioning db...
INFO: Successfully connected to provisioning db...
INFO: Trying to connect to accounting db...
INFO: Successfully connected to accounting db...
WARNING: No duplication db credentials, disabled.
INFO: local cdr relation column model loaded
INFO: local cdr cash balance column model loaded
INFO: local cdr time balance column model loaded
INFO: Up and running.
INFO: Grabbed 3 CDRs
DEBUG: start rating CDR ID 50864
DEBUG: 4 contract(s) locked: 61929, 61930, 61935, 61938
INFO: 1/3 - rate CDR ID 50864
DEBUG: fetching source provider info for source_provider_id #61929
DEBUG: catching up contract ID 61929 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61929 billing mapping (reseller) is profile id 1136 for time 1515794984.000 from ipv4 source ip 192.168.0.1
DEBUG: source_provider_info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1136,
                         'product_id' => 3,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => '61929',
                         'prepaid' => 0,
                         'class' => 'reseller',
                         'int_charge' => '0'
                       },
          'balances' => [
                          {
                            'id' => 77437,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '450',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: fetching destination provider info for destination_provider_id #61930
DEBUG: catching up contract ID 61930 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61930 billing mapping (reseller) is profile id 1139 for time 1515794984.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_provider_info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1139,
                         'product_id' => 3,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => '61930',
                         'prepaid' => 0,
                         'class' => 'reseller',
                         'int_charge' => '0'
                       },
          'balances' => [
                          {
                            'id' => 77438,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '270',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: ### 1. write pass ###
DEBUG: call from local subscriber, source_user_id is bb5ac4de-5a64-458b-9f69-e73a67c02594
DEBUG: call to local subscriber, destination_user_id is ab049d5b-f1b0-4f72-9ee3-ec1ae06f7d47
DEBUG: destination provider has billing profile 1139, get reseller termination cost
DEBUG: calculating call cost for profile_id 1139 with type call, direction in, src_user_domain 888151515794822@testa.com.1515794822, dst_user_domain 888281515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '1',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '^888.+',
          'off_follow_interval' => 30,
          'fee_id' => 1624,
          'use_free_time' => 0,
          'on_init_rate' => '1',
          'zone_id' => 508,
          'off_init_interval' => 60,
          'pattern' => '.',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 1 per sec to costs
DEBUG: interval is 60, so rate for this interval is 60
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77438,
          'cash_balance_interval' => 270,
          'cash_balance' => 0,
          'start_unix' => 1514761200,
          'start' => '2018-01-01 00:00:00',
          'free_time_balance_old' => 0,
          'end_unix' => 1517439599,
          'cash_balance_old' => 0,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 60 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 60
DEBUG: rating_duration = 90
DEBUG: 1 contract balance row(s) updated
DEBUG: destination reseller termination cost is 90
DEBUG: get customer termination cost for destination_user_id ab049d5b-f1b0-4f72-9ee3-ec1ae06f7d47
DEBUG: catching up contract ID 61938 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61938 billing mapping (sipaccount) is profile id 1140 for time 1515794984.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_customer info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1140,
                         'product_id' => 4,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => 61938,
                         'prepaid' => 0,
                         'class' => 'sipaccount',
                         'int_charge' => '0'
                       },
          'balances' => [
                          {
                            'id' => 77446,
                            'cash_balance' => '1000',
                            'cash_balance_interval' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '1000',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1140 with type call, direction in, src_user_domain 888151515794822@testa.com.1515794822, dst_user_domain 888281515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '5',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '^8881.+',
          'off_follow_interval' => 30,
          'fee_id' => 1626,
          'use_free_time' => 0,
          'on_init_rate' => '5',
          'zone_id' => 509,
          'off_init_interval' => 60,
          'pattern' => '.',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 5 per sec to costs
DEBUG: interval is 60, so rate for this interval is 300
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77446,
          'cash_balance' => '1000',
          'cash_balance_interval' => '0',
          'start' => '2018-01-01 00:00:00',
          'start_unix' => 1514761200,
          'free_time_balance_old' => 0,
          'cash_balance_old' => '1000',
          'end_unix' => 1517439599,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: we still have cash balance 1000 left, subtract rate 300 from that
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: we still have cash balance 700 left, subtract rate 30 from that
DEBUG: rating_duration = 90
DEBUG: got call cost 0 and free time 0
DEBUG: billing profile is post-paid, update contract balance
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 0
DEBUG: destination customer termination cost is 0
DEBUG: calculating call cost for profile_id 1136 with type call, direction out, src_user_domain 888151515794822@testa.com.1515794822, dst_user_domain 888281515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '2',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '.',
          'off_follow_interval' => 30,
          'fee_id' => 1617,
          'use_free_time' => 0,
          'on_init_rate' => '2',
          'zone_id' => 505,
          'off_init_interval' => 60,
          'pattern' => '^888.+',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 2 per sec to costs
DEBUG: interval is 60, so rate for this interval is 120
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77437,
          'cash_balance_interval' => 450,
          'cash_balance' => 0,
          'start_unix' => 1514761200,
          'start' => '2018-01-01 00:00:00',
          'free_time_balance_old' => 0,
          'end_unix' => 1517439599,
          'cash_balance_old' => 0,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 120 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 120
DEBUG: rating_duration = 90
DEBUG: 1 contract balance row(s) updated
DEBUG: catching up contract ID 61935 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61935 billing mapping (sipaccount) is profile id 1137 for time 1515794984.000 from ipv4 source ip 192.168.0.1
DEBUG: source_customer info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1137,
                         'product_id' => 4,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => 61935,
                         'prepaid' => 0,
                         'int_charge' => '0',
                         'class' => 'sipaccount'
                       },
          'balances' => [
                          {
                            'id' => 77443,
                            'cash_balance' => '1000',
                            'cash_balance_interval' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '1000',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1137 with type call, direction out, src_user_domain 888151515794822@testa.com.1515794822, dst_user_domain 888281515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '6',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '.',
          'off_follow_interval' => 30,
          'fee_id' => 1619,
          'use_free_time' => 0,
          'on_init_rate' => '6',
          'zone_id' => 506,
          'off_init_interval' => 60,
          'pattern' => '^8882.+',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 6 per sec to costs
DEBUG: interval is 60, so rate for this interval is 360
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77443,
          'cash_balance' => '1000',
          'cash_balance_interval' => '0',
          'start' => '2018-01-01 00:00:00',
          'start_unix' => 1514761200,
          'free_time_balance_old' => 0,
          'cash_balance_old' => '1000',
          'end_unix' => 1517439599,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: we still have cash balance 1000 left, subtract rate 360 from that
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: we still have cash balance 640 left, subtract rate 30 from that
DEBUG: rating_duration = 90
DEBUG: got call cost 0 and free time 0
DEBUG: billing profile is post-paid, update contract balance
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 0
DEBUG: cdr ID 50864 updated
DEBUG: empty 'source_carrier_cash_balance' local col data for cdr id 50864, skipping
DEBUG: empty 'source_carrier_free_time_balance' local col data for cdr id 50864, skipping
DEBUG: empty 'source_carrier_profile_package_id' local col data for cdr id 50864, skipping
DEBUG: empty 'source_carrier_contract_balance_id' local col data for cdr id 50864, skipping
DEBUG: local col data created or up to date for cdr id 50864, column 'source_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50864, column 'source_reseller_free_time_balance': 0, 0
DEBUG: empty 'source_reseller_profile_package_id' local col data for cdr id 50864, skipping
DEBUG: local col data created or up to date for cdr id 50864, column 'source_reseller_contract_balance_id': 77437
DEBUG: local col data created or up to date for cdr id 50864, column 'source_customer_cash_balance': 1000, 610
DEBUG: local col data created or up to date for cdr id 50864, column 'source_customer_free_time_balance': 0, 0
DEBUG: empty 'source_customer_profile_package_id' local col data for cdr id 50864, skipping
DEBUG: local col data created or up to date for cdr id 50864, column 'source_customer_contract_balance_id': 77443
DEBUG: empty 'destination_carrier_cash_balance' local col data for cdr id 50864, skipping
DEBUG: empty 'destination_carrier_free_time_balance' local col data for cdr id 50864, skipping
DEBUG: empty 'destination_carrier_profile_package_id' local col data for cdr id 50864, skipping
DEBUG: empty 'destination_carrier_contract_balance_id' local col data for cdr id 50864, skipping
DEBUG: local col data created or up to date for cdr id 50864, column 'destination_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50864, column 'destination_reseller_free_time_balance': 0, 0
DEBUG: empty 'destination_reseller_profile_package_id' local col data for cdr id 50864, skipping
DEBUG: local col data created or up to date for cdr id 50864, column 'destination_reseller_contract_balance_id': 77438
DEBUG: local col data created or up to date for cdr id 50864, column 'destination_customer_cash_balance': 1000, 670
DEBUG: local col data created or up to date for cdr id 50864, column 'destination_customer_free_time_balance': 0, 0
DEBUG: empty 'destination_customer_profile_package_id' local col data for cdr id 50864, skipping
DEBUG: local col data created or up to date for cdr id 50864, column 'destination_customer_contract_balance_id': 77446
DEBUG: rating cdr ID 50864 completed successfully in 0.177 secs
DEBUG: start rating CDR ID 50865
DEBUG: 4 contract(s) locked: 61929, 61930, 61936, 61938
INFO: 2/3 - rate CDR ID 50865
DEBUG: fetching source provider info for source_provider_id #61929
DEBUG: catching up contract ID 61929 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61929 billing mapping (reseller) is profile id 1136 for time 1515794985.000 from ipv4 source ip 192.168.0.1
DEBUG: source_provider_info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1136,
                         'product_id' => 3,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => '61929',
                         'prepaid' => 0,
                         'int_charge' => '0',
                         'class' => 'reseller'
                       },
          'balances' => [
                          {
                            'id' => 77437,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '600',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: fetching destination provider info for destination_provider_id #61930
DEBUG: catching up contract ID 61930 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61930 billing mapping (reseller) is profile id 1139 for time 1515794985.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_provider_info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1139,
                         'product_id' => 3,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => '61930',
                         'prepaid' => 0,
                         'int_charge' => '0',
                         'class' => 'reseller'
                       },
          'balances' => [
                          {
                            'id' => 77438,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '360',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: ### 1. write pass ###
DEBUG: call from local subscriber, source_user_id is a2f1a1ec-b00d-4e69-bf63-bdda65cfb7c1
DEBUG: call to local subscriber, destination_user_id is ab049d5b-f1b0-4f72-9ee3-ec1ae06f7d47
DEBUG: destination provider has billing profile 1139, get reseller termination cost
DEBUG: calculating call cost for profile_id 1139 with type call, direction in, src_user_domain 888161515794822@testa.com.1515794822, dst_user_domain 888281515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '1',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '^888.+',
          'off_follow_interval' => 30,
          'fee_id' => 1624,
          'use_free_time' => 0,
          'on_init_rate' => '1',
          'zone_id' => 508,
          'off_init_interval' => 60,
          'pattern' => '.',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 1 per sec to costs
DEBUG: interval is 60, so rate for this interval is 60
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77438,
          'cash_balance_interval' => 360,
          'cash_balance' => 0,
          'start_unix' => 1514761200,
          'start' => '2018-01-01 00:00:00',
          'free_time_balance_old' => 0,
          'end_unix' => 1517439599,
          'cash_balance_old' => 0,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 60 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 60
DEBUG: rating_duration = 90
DEBUG: 1 contract balance row(s) updated
DEBUG: destination reseller termination cost is 90
DEBUG: get customer termination cost for destination_user_id ab049d5b-f1b0-4f72-9ee3-ec1ae06f7d47
DEBUG: catching up contract ID 61938 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61938 billing mapping (sipaccount) is profile id 1140 for time 1515794985.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_customer info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1140,
                         'product_id' => 4,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => 61938,
                         'prepaid' => 0,
                         'int_charge' => '0',
                         'class' => 'sipaccount'
                       },
          'balances' => [
                          {
                            'id' => 77446,
                            'cash_balance' => '670',
                            'cash_balance_interval' => '330',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '670',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1140 with type call, direction in, src_user_domain 888161515794822@testa.com.1515794822, dst_user_domain 888281515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '5',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '^8881.+',
          'off_follow_interval' => 30,
          'fee_id' => 1626,
          'use_free_time' => 0,
          'on_init_rate' => '5',
          'zone_id' => 509,
          'off_init_interval' => 60,
          'pattern' => '.',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 5 per sec to costs
DEBUG: interval is 60, so rate for this interval is 300
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77446,
          'cash_balance' => '670',
          'cash_balance_interval' => '330',
          'start' => '2018-01-01 00:00:00',
          'start_unix' => 1514761200,
          'free_time_balance_old' => 0,
          'cash_balance_old' => '670',
          'end_unix' => 1517439599,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: we still have cash balance 670 left, subtract rate 300 from that
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: we still have cash balance 370 left, subtract rate 30 from that
DEBUG: rating_duration = 90
DEBUG: got call cost 0 and free time 0
DEBUG: billing profile is post-paid, update contract balance
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 0
DEBUG: destination customer termination cost is 0
DEBUG: calculating call cost for profile_id 1136 with type call, direction out, src_user_domain 888161515794822@testa.com.1515794822, dst_user_domain 888281515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '2',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '.',
          'off_follow_interval' => 30,
          'fee_id' => 1617,
          'use_free_time' => 0,
          'on_init_rate' => '2',
          'zone_id' => 505,
          'off_init_interval' => 60,
          'pattern' => '^888.+',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 2 per sec to costs
DEBUG: interval is 60, so rate for this interval is 120
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77437,
          'cash_balance_interval' => 600,
          'cash_balance' => 0,
          'start_unix' => 1514761200,
          'start' => '2018-01-01 00:00:00',
          'free_time_balance_old' => 0,
          'end_unix' => 1517439599,
          'cash_balance_old' => 0,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 120 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 120
DEBUG: rating_duration = 90
DEBUG: 1 contract balance row(s) updated
DEBUG: catching up contract ID 61936 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61936 billing mapping (sipaccount) is profile id 1137 for time 1515794985.000 from ipv4 source ip 192.168.0.1
DEBUG: source_customer info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1137,
                         'product_id' => 4,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => 61936,
                         'prepaid' => 0,
                         'int_charge' => '0',
                         'class' => 'sipaccount'
                       },
          'balances' => [
                          {
                            'id' => 77444,
                            'cash_balance' => '1000',
                            'cash_balance_interval' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '1000',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1137 with type call, direction out, src_user_domain 888161515794822@testa.com.1515794822, dst_user_domain 888281515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '6',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '.',
          'off_follow_interval' => 30,
          'fee_id' => 1619,
          'use_free_time' => 0,
          'on_init_rate' => '6',
          'zone_id' => 506,
          'off_init_interval' => 60,
          'pattern' => '^8882.+',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 6 per sec to costs
DEBUG: interval is 60, so rate for this interval is 360
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77444,
          'cash_balance' => '1000',
          'cash_balance_interval' => '0',
          'start' => '2018-01-01 00:00:00',
          'start_unix' => 1514761200,
          'free_time_balance_old' => 0,
          'cash_balance_old' => '1000',
          'end_unix' => 1517439599,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: we still have cash balance 1000 left, subtract rate 360 from that
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: we still have cash balance 640 left, subtract rate 30 from that
DEBUG: rating_duration = 90
DEBUG: got call cost 0 and free time 0
DEBUG: billing profile is post-paid, update contract balance
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 0
DEBUG: cdr ID 50865 updated
DEBUG: empty 'source_carrier_cash_balance' local col data for cdr id 50865, skipping
DEBUG: empty 'source_carrier_free_time_balance' local col data for cdr id 50865, skipping
DEBUG: empty 'source_carrier_profile_package_id' local col data for cdr id 50865, skipping
DEBUG: empty 'source_carrier_contract_balance_id' local col data for cdr id 50865, skipping
DEBUG: local col data created or up to date for cdr id 50865, column 'source_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50865, column 'source_reseller_free_time_balance': 0, 0
DEBUG: empty 'source_reseller_profile_package_id' local col data for cdr id 50865, skipping
DEBUG: local col data created or up to date for cdr id 50865, column 'source_reseller_contract_balance_id': 77437
DEBUG: local col data created or up to date for cdr id 50865, column 'source_customer_cash_balance': 1000, 610
DEBUG: local col data created or up to date for cdr id 50865, column 'source_customer_free_time_balance': 0, 0
DEBUG: empty 'source_customer_profile_package_id' local col data for cdr id 50865, skipping
DEBUG: local col data created or up to date for cdr id 50865, column 'source_customer_contract_balance_id': 77444
DEBUG: empty 'destination_carrier_cash_balance' local col data for cdr id 50865, skipping
DEBUG: empty 'destination_carrier_free_time_balance' local col data for cdr id 50865, skipping
DEBUG: empty 'destination_carrier_profile_package_id' local col data for cdr id 50865, skipping
DEBUG: empty 'destination_carrier_contract_balance_id' local col data for cdr id 50865, skipping
DEBUG: local col data created or up to date for cdr id 50865, column 'destination_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50865, column 'destination_reseller_free_time_balance': 0, 0
DEBUG: empty 'destination_reseller_profile_package_id' local col data for cdr id 50865, skipping
DEBUG: local col data created or up to date for cdr id 50865, column 'destination_reseller_contract_balance_id': 77438
DEBUG: local col data created or up to date for cdr id 50865, column 'destination_customer_cash_balance': 670, 340
DEBUG: local col data created or up to date for cdr id 50865, column 'destination_customer_free_time_balance': 0, 0
DEBUG: empty 'destination_customer_profile_package_id' local col data for cdr id 50865, skipping
DEBUG: local col data created or up to date for cdr id 50865, column 'destination_customer_contract_balance_id': 77446
DEBUG: rating cdr ID 50865 completed successfully in 0.149 secs
DEBUG: start rating CDR ID 50866
DEBUG: 4 contract(s) locked: 61929, 61930, 61937, 61938
INFO: 3/3 - rate CDR ID 50866
DEBUG: fetching source provider info for source_provider_id #61929
DEBUG: catching up contract ID 61929 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61929 billing mapping (reseller) is profile id 1136 for time 1515794986.000 from ipv4 source ip 192.168.0.1
DEBUG: source_provider_info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1136,
                         'product_id' => 3,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => '61929',
                         'prepaid' => 0,
                         'int_charge' => '0',
                         'class' => 'reseller'
                       },
          'balances' => [
                          {
                            'id' => 77437,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '750',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: fetching destination provider info for destination_provider_id #61930
DEBUG: catching up contract ID 61930 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61930 billing mapping (reseller) is profile id 1139 for time 1515794986.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_provider_info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1139,
                         'product_id' => 3,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => '61930',
                         'prepaid' => 0,
                         'int_charge' => '0',
                         'class' => 'reseller'
                       },
          'balances' => [
                          {
                            'id' => 77438,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '450',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: ### 1. write pass ###
DEBUG: call from local subscriber, source_user_id is 403f06f5-6f6a-4973-9f88-38de5e44c7f7
DEBUG: call to local subscriber, destination_user_id is ab049d5b-f1b0-4f72-9ee3-ec1ae06f7d47
DEBUG: destination provider has billing profile 1139, get reseller termination cost
DEBUG: calculating call cost for profile_id 1139 with type call, direction in, src_user_domain 888171515794822@testa.com.1515794822, dst_user_domain 888281515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '1',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '^888.+',
          'off_follow_interval' => 30,
          'fee_id' => 1624,
          'use_free_time' => 0,
          'on_init_rate' => '1',
          'zone_id' => 508,
          'off_init_interval' => 60,
          'pattern' => '.',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 1 per sec to costs
DEBUG: interval is 60, so rate for this interval is 60
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77438,
          'cash_balance_interval' => 450,
          'cash_balance' => 0,
          'start_unix' => 1514761200,
          'start' => '2018-01-01 00:00:00',
          'free_time_balance_old' => 0,
          'end_unix' => 1517439599,
          'cash_balance_old' => 0,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 60 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 60
DEBUG: rating_duration = 90
DEBUG: 1 contract balance row(s) updated
DEBUG: destination reseller termination cost is 90
DEBUG: get customer termination cost for destination_user_id ab049d5b-f1b0-4f72-9ee3-ec1ae06f7d47
DEBUG: catching up contract ID 61938 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61938 billing mapping (sipaccount) is profile id 1140 for time 1515794986.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_customer info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1140,
                         'product_id' => 4,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => 61938,
                         'prepaid' => 0,
                         'int_charge' => '0',
                         'class' => 'sipaccount'
                       },
          'balances' => [
                          {
                            'id' => 77446,
                            'cash_balance' => '340',
                            'cash_balance_interval' => '660',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '340',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1140 with type call, direction in, src_user_domain 888171515794822@testa.com.1515794822, dst_user_domain 888281515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '5',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '^8881.+',
          'off_follow_interval' => 30,
          'fee_id' => 1626,
          'use_free_time' => 0,
          'on_init_rate' => '5',
          'zone_id' => 509,
          'off_init_interval' => 60,
          'pattern' => '.',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 5 per sec to costs
DEBUG: interval is 60, so rate for this interval is 300
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77446,
          'cash_balance' => '340',
          'cash_balance_interval' => '660',
          'start' => '2018-01-01 00:00:00',
          'start_unix' => 1514761200,
          'free_time_balance_old' => 0,
          'cash_balance_old' => '340',
          'end_unix' => 1517439599,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: we still have cash balance 340 left, subtract rate 300 from that
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: we still have cash balance 40 left, subtract rate 30 from that
DEBUG: rating_duration = 90
DEBUG: got call cost 0 and free time 0
DEBUG: billing profile is post-paid, update contract balance
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 0
DEBUG: destination customer termination cost is 0
DEBUG: calculating call cost for profile_id 1136 with type call, direction out, src_user_domain 888171515794822@testa.com.1515794822, dst_user_domain 888281515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '2',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '.',
          'off_follow_interval' => 30,
          'fee_id' => 1617,
          'use_free_time' => 0,
          'on_init_rate' => '2',
          'zone_id' => 505,
          'off_init_interval' => 60,
          'pattern' => '^888.+',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 2 per sec to costs
DEBUG: interval is 60, so rate for this interval is 120
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77437,
          'cash_balance_interval' => 750,
          'cash_balance' => 0,
          'start_unix' => 1514761200,
          'start' => '2018-01-01 00:00:00',
          'free_time_balance_old' => 0,
          'end_unix' => 1517439599,
          'cash_balance_old' => 0,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 120 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 120
DEBUG: rating_duration = 90
DEBUG: 1 contract balance row(s) updated
DEBUG: catching up contract ID 61937 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61937 billing mapping (sipaccount) is profile id 1137 for time 1515794986.000 from ipv4 source ip 192.168.0.1
DEBUG: source_customer info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1137,
                         'product_id' => 4,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => 61937,
                         'prepaid' => 0,
                         'int_charge' => '0',
                         'class' => 'sipaccount'
                       },
          'balances' => [
                          {
                            'id' => 77445,
                            'cash_balance' => '1000',
                            'cash_balance_interval' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '1000',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1137 with type call, direction out, src_user_domain 888171515794822@testa.com.1515794822, dst_user_domain 888281515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '6',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '.',
          'off_follow_interval' => 30,
          'fee_id' => 1619,
          'use_free_time' => 0,
          'on_init_rate' => '6',
          'zone_id' => 506,
          'off_init_interval' => 60,
          'pattern' => '^8882.+',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 6 per sec to costs
DEBUG: interval is 60, so rate for this interval is 360
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77445,
          'cash_balance' => '1000',
          'cash_balance_interval' => '0',
          'start' => '2018-01-01 00:00:00',
          'start_unix' => 1514761200,
          'free_time_balance_old' => 0,
          'cash_balance_old' => '1000',
          'end_unix' => 1517439599,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: we still have cash balance 1000 left, subtract rate 360 from that
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: we still have cash balance 640 left, subtract rate 30 from that
DEBUG: rating_duration = 90
DEBUG: got call cost 0 and free time 0
DEBUG: billing profile is post-paid, update contract balance
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 0
DEBUG: cdr ID 50866 updated
DEBUG: empty 'source_carrier_cash_balance' local col data for cdr id 50866, skipping
DEBUG: empty 'source_carrier_free_time_balance' local col data for cdr id 50866, skipping
DEBUG: empty 'source_carrier_profile_package_id' local col data for cdr id 50866, skipping
DEBUG: empty 'source_carrier_contract_balance_id' local col data for cdr id 50866, skipping
DEBUG: local col data created or up to date for cdr id 50866, column 'source_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50866, column 'source_reseller_free_time_balance': 0, 0
DEBUG: empty 'source_reseller_profile_package_id' local col data for cdr id 50866, skipping
DEBUG: local col data created or up to date for cdr id 50866, column 'source_reseller_contract_balance_id': 77437
DEBUG: local col data created or up to date for cdr id 50866, column 'source_customer_cash_balance': 1000, 610
DEBUG: local col data created or up to date for cdr id 50866, column 'source_customer_free_time_balance': 0, 0
DEBUG: empty 'source_customer_profile_package_id' local col data for cdr id 50866, skipping
DEBUG: local col data created or up to date for cdr id 50866, column 'source_customer_contract_balance_id': 77445
DEBUG: empty 'destination_carrier_cash_balance' local col data for cdr id 50866, skipping
DEBUG: empty 'destination_carrier_free_time_balance' local col data for cdr id 50866, skipping
DEBUG: empty 'destination_carrier_profile_package_id' local col data for cdr id 50866, skipping
DEBUG: empty 'destination_carrier_contract_balance_id' local col data for cdr id 50866, skipping
DEBUG: local col data created or up to date for cdr id 50866, column 'destination_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50866, column 'destination_reseller_free_time_balance': 0, 0
DEBUG: empty 'destination_reseller_profile_package_id' local col data for cdr id 50866, skipping
DEBUG: local col data created or up to date for cdr id 50866, column 'destination_reseller_contract_balance_id': 77438
DEBUG: local col data created or up to date for cdr id 50866, column 'destination_customer_cash_balance': 340, 10
DEBUG: local col data created or up to date for cdr id 50866, column 'destination_customer_free_time_balance': 0, 0
DEBUG: empty 'destination_customer_profile_package_id' local col data for cdr id 50866, skipping
DEBUG: local col data created or up to date for cdr id 50866, column 'destination_customer_contract_balance_id': 77446
DEBUG: rating cdr ID 50866 completed successfully in 0.172 secs
INFO: Batch of 3 CDRs completed. 3 CDRs rated overall so far.
INFO: Less than 5 new CDRs, sleep 10
ok 270 - rate-o-mat executed
ok 271 - postpaid, balance: source_reseller_cost = 150.000000
ok 272 - postpaid, balance: destination_reseller_cost = 90.000000
ok 273 - postpaid, balance: id = 50864
ok 274 - postpaid, balance: rating_status = ok
ok 275 - postpaid, balance: destination_customer_cost = 0.000000
ok 276 - postpaid, balance: source_customer_cost = 0.000000
ok 277 - postpaid, balance: source_customer_cost = 0.000000
ok 278 - postpaid, balance: destination_customer_cost = 0.000000
ok 279 - postpaid, balance: rating_status = ok
ok 280 - postpaid, balance: id = 50865
ok 281 - postpaid, balance: source_reseller_cost = 150.000000
ok 282 - postpaid, balance: destination_reseller_cost = 90.000000
ok 283 - postpaid, balance: id = 50866
ok 284 - postpaid, balance: source_reseller_cost = 150.000000
ok 285 - postpaid, balance: destination_reseller_cost = 90.000000
ok 286 - postpaid, balance: destination_customer_cost = 0.000000
ok 287 - postpaid, balance: source_customer_cost = 0.000000
ok 288 - postpaid, balance: rating_status = ok
ok 289 - cdrs were all processed
ok 290 - postpaid, balance, caller 1: cdr id 50864 source_customer_contract_balance_id number of records 1 = 1
ok 291 - postpaid, balance, caller 1: fetch customer id 61935 balance intervals collection page
ok 292 - postpaid, balance, caller 1: check 'total_count' of collection
ok 293 - postpaid, balance, caller 1: check interval 77443 cash balance 6.1 = 6.1
ok 294 - postpaid, balance, caller 1: check interval 77443 cash balance interval 3.9 = 3.9
ok 295 - postpaid, balance, caller 1: check interval 77443 id = 77443
ok 296 - postpaid, balance, caller 1: check if all expected items are listed
ok 297 - postpaid, balance, caller 1: cdr id 50864 source_customer_cash_balance before 1000.0000 = 1000.0000
ok 298 - postpaid, balance, caller 1: cdr id 50864 source_customer_cash_balance after 610.0000 = 610.0000
ok 299 - postpaid, balance, caller 2: cdr id 50865 source_customer_contract_balance_id number of records 1 = 1
ok 300 - postpaid, balance, caller 2: fetch customer id 61936 balance intervals collection page
ok 301 - postpaid, balance, caller 2: check 'total_count' of collection
ok 302 - postpaid, balance, caller 2: check interval 77444 cash balance 6.1 = 6.1
ok 303 - postpaid, balance, caller 2: check interval 77444 cash balance interval 3.9 = 3.9
ok 304 - postpaid, balance, caller 2: check interval 77444 id = 77444
ok 305 - postpaid, balance, caller 2: check if all expected items are listed
ok 306 - postpaid, balance, caller 2: cdr id 50865 source_customer_cash_balance before 1000.0000 = 1000.0000
ok 307 - postpaid, balance, caller 2: cdr id 50865 source_customer_cash_balance after 610.0000 = 610.0000
ok 308 - postpaid, balance, caller 3: cdr id 50866 source_customer_contract_balance_id number of records 1 = 1
ok 309 - postpaid, balance, caller 3: fetch customer id 61937 balance intervals collection page
ok 310 - postpaid, balance, caller 3: check 'total_count' of collection
ok 311 - postpaid, balance, caller 3: check interval 77445 cash balance 6.1 = 6.1
ok 312 - postpaid, balance, caller 3: check interval 77445 cash balance interval 3.9 = 3.9
ok 313 - postpaid, balance, caller 3: check interval 77445 id = 77445
ok 314 - postpaid, balance, caller 3: check if all expected items are listed
ok 315 - postpaid, balance, caller 3: cdr id 50866 source_customer_cash_balance before 1000.0000 = 1000.0000
ok 316 - postpaid, balance, caller 3: cdr id 50866 source_customer_cash_balance after 610.0000 = 610.0000
ok 317 - postpaid, balance, callee: cdr id 50864 destination_customer_contract_balance_id number of records 1 = 1
ok 318 - postpaid, balance, callee: fetch customer id 61938 balance intervals collection page
ok 319 - postpaid, balance, callee: check 'total_count' of collection
ok 320 - postpaid, balance, callee: check interval 77446 cash balance 0.1 = 0.1
ok 321 - postpaid, balance, callee: check interval 77446 cash balance interval 9.9 = 9.9
ok 322 - postpaid, balance, callee: check interval 77446 id = 77446
ok 323 - postpaid, balance, callee: check if all expected items are listed
ok 324 - postpaid, balance, callee: cdr id 50864 destination_customer_contract_balance_id 77446 = 77446
ok 325 - postpaid, balance, callee: cdr id 50864 destination_customer_cash_balance before 1000.0000 = 1000.0000
ok 326 - postpaid, balance, callee: cdr id 50864 destination_customer_cash_balance after 670.0000 = 670.0000
ok 327 - postpaid, balance, callee: cdr id 50865 destination_customer_contract_balance_id 77446 = 77446
ok 328 - postpaid, balance, callee: cdr id 50865 destination_customer_cash_balance before 670.0000 = 670.0000
ok 329 - postpaid, balance, callee: cdr id 50865 destination_customer_cash_balance after 340.0000 = 340.0000
ok 330 - postpaid, balance, callee: cdr id 50866 destination_customer_contract_balance_id 77446 = 77446
ok 331 - postpaid, balance, callee: cdr id 50866 destination_customer_cash_balance before 340.0000 = 340.0000
ok 332 - postpaid, balance, callee: cdr id 50866 destination_customer_cash_balance after 10.0000 = 10.0000
ok 333 - postpaid, balance, callers' provider: cdr id 50864 source_reseller_contract_balance_id number of records 1 = 1
ok 334 - postpaid, balance, callers' provider: fetch customer id 61929 balance intervals collection page
ok 335 - postpaid, balance, callers' provider: check 'total_count' of collection
ok 336 - postpaid, balance, callers' provider: check interval 77437 cash balance interval 9 = 9
ok 337 - postpaid, balance, callers' provider: check interval 77437 id = 77437
ok 338 - postpaid, balance, callers' provider: check if all expected items are listed
ok 339 - postpaid, balance, callers' provider: cdr id 50864 source_carrier_contract_balance_id number of records 0 = 0
ok 340 - postpaid, balance, callers' provider: cdr id 50864 source_reseller_contract_balance_id 77437 = 77437
ok 341 - postpaid, balance, callers' provider: cdr id 50865 source_carrier_contract_balance_id number of records 0 = 0
ok 342 - postpaid, balance, callers' provider: cdr id 50865 source_reseller_contract_balance_id 77437 = 77437
ok 343 - postpaid, balance, callers' provider: cdr id 50866 source_carrier_contract_balance_id number of records 0 = 0
ok 344 - postpaid, balance, callers' provider: cdr id 50866 source_reseller_contract_balance_id 77437 = 77437
ok 345 - postpaid, balance, callee's provider: cdr id 50864 destination_reseller_contract_balance_id number of records 1 = 1
ok 346 - postpaid, balance, callee's provider: fetch customer id 61930 balance intervals collection page
ok 347 - postpaid, balance, callee's provider: check 'total_count' of collection
ok 348 - postpaid, balance, callee's provider: check interval 77438 cash balance interval 5.4 = 5.4
ok 349 - postpaid, balance, callee's provider: check interval 77438 id = 77438
ok 350 - postpaid, balance, callee's provider: check if all expected items are listed
ok 351 - postpaid, balance, callee's provider: cdr id 50864 destination_carrier_contract_balance_id number of records 0 = 0
ok 352 - postpaid, balance, callee's provider: cdr id 50864 destination_reseller_contract_balance_id 77438 = 77438
ok 353 - postpaid, balance, callee's provider: cdr id 50865 destination_carrier_contract_balance_id number of records 0 = 0
ok 354 - postpaid, balance, callee's provider: cdr id 50865 destination_reseller_contract_balance_id 77438 = 77438
ok 355 - postpaid, balance, callee's provider: cdr id 50866 destination_carrier_contract_balance_id number of records 0 = 0
ok 356 - postpaid, balance, callee's provider: cdr id 50866 destination_reseller_contract_balance_id 77438 = 77438
ok 357 - postpaid, balance providers and subscriber must not have a profile package: cdr id 50864 source_carrier_profile_package_id number of records 0 = 0
ok 358 - postpaid, balance providers and subscriber must not have a profile package: cdr id 50864 source_reseller_profile_package_id number of records 0 = 0
ok 359 - postpaid, balance providers and subscriber must not have a profile package: cdr id 50864 source_customer_profile_package_id number of records 0 = 0
ok 360 - postpaid, balance providers and subscriber must not have a profile package: cdr id 50864 destination_carrier_profile_package_id number of records 0 = 0
ok 361 - postpaid, balance providers and subscriber must not have a profile package: cdr id 50864 destination_reseller_profile_package_id number of records 0 = 0
ok 362 - postpaid, balance providers and subscriber must not have a profile package: cdr id 50864 destination_customer_profile_package_id number of records 0 = 0
ok 363 - postpaid, balance providers and subscriber must not have a profile package: cdr id 50865 source_carrier_profile_package_id number of records 0 = 0
ok 364 - postpaid, balance providers and subscriber must not have a profile package: cdr id 50865 source_reseller_profile_package_id number of records 0 = 0
ok 365 - postpaid, balance providers and subscriber must not have a profile package: cdr id 50865 source_customer_profile_package_id number of records 0 = 0
ok 366 - postpaid, balance providers and subscriber must not have a profile package: cdr id 50865 destination_carrier_profile_package_id number of records 0 = 0
ok 367 - postpaid, balance providers and subscriber must not have a profile package: cdr id 50865 destination_reseller_profile_package_id number of records 0 = 0
ok 368 - postpaid, balance providers and subscriber must not have a profile package: cdr id 50865 destination_customer_profile_package_id number of records 0 = 0
ok 369 - postpaid, balance providers and subscriber must not have a profile package: cdr id 50866 source_carrier_profile_package_id number of records 0 = 0
ok 370 - postpaid, balance providers and subscriber must not have a profile package: cdr id 50866 source_reseller_profile_package_id number of records 0 = 0
ok 371 - postpaid, balance providers and subscriber must not have a profile package: cdr id 50866 source_customer_profile_package_id number of records 0 = 0
ok 372 - postpaid, balance providers and subscriber must not have a profile package: cdr id 50866 destination_carrier_profile_package_id number of records 0 = 0
ok 373 - postpaid, balance providers and subscriber must not have a profile package: cdr id 50866 destination_reseller_profile_package_id number of records 0 = 0
ok 374 - postpaid, balance providers and subscriber must not have a profile package: cdr id 50866 destination_customer_profile_package_id number of records 0 = 0
ok 375 - postpaid, balance providers and subscriber must have zero free time: cdr id 50864 source_carrier_free_time_balance number of records 0 = 0
ok 376 - postpaid, balance providers and subscriber must have zero free time: cdr id 50864 source_reseller_free_time_balance before 0 = 0
ok 377 - postpaid, balance providers and subscriber must have zero free time: cdr id 50864 source_reseller_free_time_balance after 0 = 0
ok 378 - postpaid, balance providers and subscriber must have zero free time: cdr id 50864 source_customer_free_time_balance before 0 = 0
ok 379 - postpaid, balance providers and subscriber must have zero free time: cdr id 50864 source_customer_free_time_balance after 0 = 0
ok 380 - postpaid, balance providers and subscriber must have zero free time: cdr id 50864 destination_carrier_free_time_balance number of records 0 = 0
ok 381 - postpaid, balance providers and subscriber must have zero free time: cdr id 50864 destination_reseller_free_time_balance before 0 = 0
ok 382 - postpaid, balance providers and subscriber must have zero free time: cdr id 50864 destination_reseller_free_time_balance after 0 = 0
ok 383 - postpaid, balance providers and subscriber must have zero free time: cdr id 50864 destination_customer_free_time_balance before 0 = 0
ok 384 - postpaid, balance providers and subscriber must have zero free time: cdr id 50864 destination_customer_free_time_balance after 0 = 0
ok 385 - postpaid, balance providers and subscriber must have zero free time: cdr id 50865 source_carrier_free_time_balance number of records 0 = 0
ok 386 - postpaid, balance providers and subscriber must have zero free time: cdr id 50865 source_reseller_free_time_balance before 0 = 0
ok 387 - postpaid, balance providers and subscriber must have zero free time: cdr id 50865 source_reseller_free_time_balance after 0 = 0
ok 388 - postpaid, balance providers and subscriber must have zero free time: cdr id 50865 source_customer_free_time_balance before 0 = 0
ok 389 - postpaid, balance providers and subscriber must have zero free time: cdr id 50865 source_customer_free_time_balance after 0 = 0
ok 390 - postpaid, balance providers and subscriber must have zero free time: cdr id 50865 destination_carrier_free_time_balance number of records 0 = 0
ok 391 - postpaid, balance providers and subscriber must have zero free time: cdr id 50865 destination_reseller_free_time_balance before 0 = 0
ok 392 - postpaid, balance providers and subscriber must have zero free time: cdr id 50865 destination_reseller_free_time_balance after 0 = 0
ok 393 - postpaid, balance providers and subscriber must have zero free time: cdr id 50865 destination_customer_free_time_balance before 0 = 0
ok 394 - postpaid, balance providers and subscriber must have zero free time: cdr id 50865 destination_customer_free_time_balance after 0 = 0
ok 395 - postpaid, balance providers and subscriber must have zero free time: cdr id 50866 source_carrier_free_time_balance number of records 0 = 0
ok 396 - postpaid, balance providers and subscriber must have zero free time: cdr id 50866 source_reseller_free_time_balance before 0 = 0
ok 397 - postpaid, balance providers and subscriber must have zero free time: cdr id 50866 source_reseller_free_time_balance after 0 = 0
ok 398 - postpaid, balance providers and subscriber must have zero free time: cdr id 50866 source_customer_free_time_balance before 0 = 0
ok 399 - postpaid, balance providers and subscriber must have zero free time: cdr id 50866 source_customer_free_time_balance after 0 = 0
ok 400 - postpaid, balance providers and subscriber must have zero free time: cdr id 50866 destination_carrier_free_time_balance number of records 0 = 0
ok 401 - postpaid, balance providers and subscriber must have zero free time: cdr id 50866 destination_reseller_free_time_balance before 0 = 0
ok 402 - postpaid, balance providers and subscriber must have zero free time: cdr id 50866 destination_reseller_free_time_balance after 0 = 0
ok 403 - postpaid, balance providers and subscriber must have zero free time: cdr id 50866 destination_customer_free_time_balance before 0 = 0
ok 404 - postpaid, balance providers and subscriber must have zero free time: cdr id 50866 destination_customer_free_time_balance after 0 = 0
ok 405 - postpaid, balance providers must have zero balance: cdr id 50864 source_carrier_cash_balance number of records 0 = 0
ok 406 - postpaid, balance providers must have zero balance: cdr id 50864 source_reseller_cash_balance before 0.0000 = 0.0000
ok 407 - postpaid, balance providers must have zero balance: cdr id 50864 source_reseller_cash_balance after 0.0000 = 0.0000
ok 408 - postpaid, balance providers must have zero balance: cdr id 50864 destination_carrier_cash_balance number of records 0 = 0
ok 409 - postpaid, balance providers must have zero balance: cdr id 50864 destination_reseller_cash_balance before 0.0000 = 0.0000
ok 410 - postpaid, balance providers must have zero balance: cdr id 50864 destination_reseller_cash_balance after 0.0000 = 0.0000
ok 411 - postpaid, balance providers must have zero balance: cdr id 50865 source_carrier_cash_balance number of records 0 = 0
ok 412 - postpaid, balance providers must have zero balance: cdr id 50865 source_reseller_cash_balance before 0.0000 = 0.0000
ok 413 - postpaid, balance providers must have zero balance: cdr id 50865 source_reseller_cash_balance after 0.0000 = 0.0000
ok 414 - postpaid, balance providers must have zero balance: cdr id 50865 destination_carrier_cash_balance number of records 0 = 0
ok 415 - postpaid, balance providers must have zero balance: cdr id 50865 destination_reseller_cash_balance before 0.0000 = 0.0000
ok 416 - postpaid, balance providers must have zero balance: cdr id 50865 destination_reseller_cash_balance after 0.0000 = 0.0000
ok 417 - postpaid, balance providers must have zero balance: cdr id 50866 source_carrier_cash_balance number of records 0 = 0
ok 418 - postpaid, balance providers must have zero balance: cdr id 50866 source_reseller_cash_balance before 0.0000 = 0.0000
ok 419 - postpaid, balance providers must have zero balance: cdr id 50866 source_reseller_cash_balance after 0.0000 = 0.0000
ok 420 - postpaid, balance providers must have zero balance: cdr id 50866 destination_carrier_cash_balance number of records 0 = 0
ok 421 - postpaid, balance providers must have zero balance: cdr id 50866 destination_reseller_cash_balance before 0.0000 = 0.0000
ok 422 - postpaid, balance providers must have zero balance: cdr id 50866 destination_reseller_cash_balance after 0.0000 = 0.0000
ok 423 - create customercontacts 9
ok 424 - create customers 9
ok 425 - setting customer id 61939 cash_balance to 0 cents
ok 426 - create subscribers 9
ok 427 - very first balance interval: fetch customer id 61939 balance intervals collection page
ok 428 - very first balance interval: check interval 77447 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 429 - very first balance interval: check interval 77447 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 430 - very first balance interval: check interval 77447 cash balance 0 = 0
ok 431 - very first balance interval: check interval 77447 billing profile id 1138 = 1138
ok 432 - very first balance interval: check if all expected items are listed
ok 433 - create customercontacts 10
ok 434 - create customers 10
ok 435 - setting customer id 61940 cash_balance to 0 cents
ok 436 - create subscribers 10
ok 437 - very first balance interval: fetch customer id 61940 balance intervals collection page
ok 438 - very first balance interval: check interval 77448 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 439 - very first balance interval: check interval 77448 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 440 - very first balance interval: check interval 77448 cash balance 0 = 0
ok 441 - very first balance interval: check interval 77448 billing profile id 1138 = 1138
ok 442 - very first balance interval: check if all expected items are listed
ok 443 - create customercontacts 11
ok 444 - create customers 11
ok 445 - setting customer id 61941 cash_balance to 0 cents
ok 446 - create subscribers 11
ok 447 - very first balance interval: fetch customer id 61941 balance intervals collection page
ok 448 - very first balance interval: check interval 77449 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 449 - very first balance interval: check interval 77449 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 450 - very first balance interval: check interval 77449 cash balance 0 = 0
ok 451 - very first balance interval: check interval 77449 billing profile id 1138 = 1138
ok 452 - very first balance interval: check if all expected items are listed
ok 453 - create customercontacts 12
ok 454 - create customers 12
ok 455 - setting customer id 61942 cash_balance to 0 cents
ok 456 - create subscribers 12
ok 457 - very first balance interval: fetch customer id 61942 balance intervals collection page
ok 458 - very first balance interval: check interval 77450 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 459 - very first balance interval: check interval 77450 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 460 - very first balance interval: check interval 77450 cash balance 0 = 0
ok 461 - very first balance interval: check interval 77450 billing profile id 1141 = 1141
ok 462 - very first balance interval: check if all expected items are listed
ok 463 - cdrs id 50867, 50868, 50869 created
INFO: Trying to connect to billing db...
INFO: Successfully connected to duplication db...
INFO: Trying to connect to provisioning db...
INFO: Successfully connected to provisioning db...
INFO: Trying to connect to accounting db...
INFO: Successfully connected to accounting db...
WARNING: No duplication db credentials, disabled.
INFO: local cdr relation column model loaded
INFO: local cdr cash balance column model loaded
INFO: local cdr time balance column model loaded
INFO: Up and running.
INFO: Grabbed 3 CDRs
DEBUG: start rating CDR ID 50867
DEBUG: 4 contract(s) locked: 61929, 61930, 61939, 61942
INFO: 1/3 - rate CDR ID 50867
DEBUG: fetching source provider info for source_provider_id #61929
DEBUG: catching up contract ID 61929 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61929 billing mapping (reseller) is profile id 1136 for time 1515795042.000 from ipv4 source ip 192.168.0.1
DEBUG: source_provider_info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1136,
                         'product_id' => 3,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => '61929',
                         'prepaid' => 0,
                         'class' => 'reseller',
                         'int_charge' => '0'
                       },
          'balances' => [
                          {
                            'id' => 77437,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '900',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: fetching destination provider info for destination_provider_id #61930
DEBUG: catching up contract ID 61930 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61930 billing mapping (reseller) is profile id 1139 for time 1515795042.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_provider_info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1139,
                         'product_id' => 3,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => '61930',
                         'prepaid' => 0,
                         'class' => 'reseller',
                         'int_charge' => '0'
                       },
          'balances' => [
                          {
                            'id' => 77438,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '540',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: ### 1. write pass ###
DEBUG: call from local subscriber, source_user_id is 78604eb0-2179-437b-96e1-da1ddd80ed21
DEBUG: call to local subscriber, destination_user_id is d5301e70-48fe-4146-8d9a-6c2a905bf497
DEBUG: destination provider has billing profile 1139, get reseller termination cost
DEBUG: calculating call cost for profile_id 1139 with type call, direction in, src_user_domain 888191515794822@testa.com.1515794822, dst_user_domain 8882121515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '1',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '^888.+',
          'off_follow_interval' => 30,
          'fee_id' => 1624,
          'use_free_time' => 0,
          'on_init_rate' => '1',
          'zone_id' => 508,
          'off_init_interval' => 60,
          'pattern' => '.',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 1 per sec to costs
DEBUG: interval is 60, so rate for this interval is 60
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77438,
          'cash_balance_interval' => 540,
          'cash_balance' => 0,
          'start_unix' => 1514761200,
          'start' => '2018-01-01 00:00:00',
          'free_time_balance_old' => 0,
          'end_unix' => 1517439599,
          'cash_balance_old' => 0,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 60 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 60
DEBUG: rating_duration = 90
DEBUG: 1 contract balance row(s) updated
DEBUG: destination reseller termination cost is 90
DEBUG: get customer termination cost for destination_user_id d5301e70-48fe-4146-8d9a-6c2a905bf497
DEBUG: catching up contract ID 61942 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61942 billing mapping (sipaccount) is profile id 1141 for time 1515795042.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_customer info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1141,
                         'product_id' => 4,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => 61942,
                         'prepaid' => 1,
                         'class' => 'sipaccount',
                         'int_charge' => '0'
                       },
          'balances' => [
                          {
                            'id' => 77450,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1141 with type call, direction in, src_user_domain 888191515794822@testa.com.1515794822, dst_user_domain 8882121515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '3',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '^8881.+',
          'off_follow_interval' => 30,
          'fee_id' => 1628,
          'use_free_time' => 0,
          'on_init_rate' => '3',
          'zone_id' => 510,
          'off_init_interval' => 60,
          'pattern' => '.',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 3 per sec to costs
DEBUG: interval is 60, so rate for this interval is 180
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77450,
          'cash_balance' => '0',
          'cash_balance_interval' => '0',
          'start' => '2018-01-01 00:00:00',
          'start_unix' => 1514761200,
          'free_time_balance_old' => 0,
          'cash_balance_old' => '0',
          'end_unix' => 1517439599,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 180 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 180
DEBUG: rating_duration = 90
DEBUG: got call cost 210 and free time 0
DEBUG: treat pre-paid billing profile as post-paid for termination fees
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 210
DEBUG: destination customer termination cost is 210
DEBUG: calculating call cost for profile_id 1136 with type call, direction out, src_user_domain 888191515794822@testa.com.1515794822, dst_user_domain 8882121515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '2',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '.',
          'off_follow_interval' => 30,
          'fee_id' => 1617,
          'use_free_time' => 0,
          'on_init_rate' => '2',
          'zone_id' => 505,
          'off_init_interval' => 60,
          'pattern' => '^888.+',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 2 per sec to costs
DEBUG: interval is 60, so rate for this interval is 120
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77437,
          'cash_balance_interval' => 900,
          'cash_balance' => 0,
          'start_unix' => 1514761200,
          'start' => '2018-01-01 00:00:00',
          'free_time_balance_old' => 0,
          'end_unix' => 1517439599,
          'cash_balance_old' => 0,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 120 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 120
DEBUG: rating_duration = 90
DEBUG: 1 contract balance row(s) updated
DEBUG: catching up contract ID 61939 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61939 billing mapping (sipaccount) is profile id 1138 for time 1515795042.000 from ipv4 source ip 192.168.0.1
DEBUG: source_customer info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1138,
                         'product_id' => 4,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => 61939,
                         'prepaid' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount'
                       },
          'balances' => [
                          {
                            'id' => 77447,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: billing profile is prepaid
DEBUG: empty prepaid_costs cache, populate it
DEBUG: prepaid_costs cache populated, 0 records
DEBUG: calculating call cost for profile_id 1138 with type call, direction out, src_user_domain 888191515794822@testa.com.1515794822, dst_user_domain 8882121515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '4',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '.',
          'off_follow_interval' => 30,
          'fee_id' => 1621,
          'use_free_time' => 0,
          'on_init_rate' => '4',
          'zone_id' => 507,
          'off_init_interval' => 60,
          'pattern' => '^8882.+',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 4 per sec to costs
DEBUG: interval is 60, so rate for this interval is 240
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77447,
          'cash_balance' => '0',
          'cash_balance_interval' => '0',
          'start' => '2018-01-01 00:00:00',
          'start_unix' => 1514761200,
          'free_time_balance_old' => 0,
          'cash_balance_old' => '0',
          'end_unix' => 1517439599,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 240 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 240
DEBUG: rating_duration = 90
DEBUG: got call cost 270 and free time 0
WARNING: no prepaid cost record found for call ID *TEST*TGZWS-TgU4uDhFNFVMiISXTKbF, applying calculated costs
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 270
DEBUG: cdr ID 50867 updated
DEBUG: empty 'source_carrier_cash_balance' local col data for cdr id 50867, skipping
DEBUG: empty 'source_carrier_free_time_balance' local col data for cdr id 50867, skipping
DEBUG: empty 'source_carrier_profile_package_id' local col data for cdr id 50867, skipping
DEBUG: empty 'source_carrier_contract_balance_id' local col data for cdr id 50867, skipping
DEBUG: local col data created or up to date for cdr id 50867, column 'source_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50867, column 'source_reseller_free_time_balance': 0, 0
DEBUG: empty 'source_reseller_profile_package_id' local col data for cdr id 50867, skipping
DEBUG: local col data created or up to date for cdr id 50867, column 'source_reseller_contract_balance_id': 77437
DEBUG: local col data created or up to date for cdr id 50867, column 'source_customer_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50867, column 'source_customer_free_time_balance': 0, 0
DEBUG: empty 'source_customer_profile_package_id' local col data for cdr id 50867, skipping
DEBUG: local col data created or up to date for cdr id 50867, column 'source_customer_contract_balance_id': 77447
DEBUG: empty 'destination_carrier_cash_balance' local col data for cdr id 50867, skipping
DEBUG: empty 'destination_carrier_free_time_balance' local col data for cdr id 50867, skipping
DEBUG: empty 'destination_carrier_profile_package_id' local col data for cdr id 50867, skipping
DEBUG: empty 'destination_carrier_contract_balance_id' local col data for cdr id 50867, skipping
DEBUG: local col data created or up to date for cdr id 50867, column 'destination_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50867, column 'destination_reseller_free_time_balance': 0, 0
DEBUG: empty 'destination_reseller_profile_package_id' local col data for cdr id 50867, skipping
DEBUG: local col data created or up to date for cdr id 50867, column 'destination_reseller_contract_balance_id': 77438
DEBUG: local col data created or up to date for cdr id 50867, column 'destination_customer_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50867, column 'destination_customer_free_time_balance': 0, 0
DEBUG: empty 'destination_customer_profile_package_id' local col data for cdr id 50867, skipping
DEBUG: local col data created or up to date for cdr id 50867, column 'destination_customer_contract_balance_id': 77450
DEBUG: rating cdr ID 50867 completed successfully in 0.222 secs
DEBUG: start rating CDR ID 50868
DEBUG: 4 contract(s) locked: 61929, 61930, 61940, 61942
INFO: 2/3 - rate CDR ID 50868
DEBUG: fetching source provider info for source_provider_id #61929
DEBUG: catching up contract ID 61929 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61929 billing mapping (reseller) is profile id 1136 for time 1515795043.000 from ipv4 source ip 192.168.0.1
DEBUG: source_provider_info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1136,
                         'product_id' => 3,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => '61929',
                         'prepaid' => 0,
                         'int_charge' => '0',
                         'class' => 'reseller'
                       },
          'balances' => [
                          {
                            'id' => 77437,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '1050',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: fetching destination provider info for destination_provider_id #61930
DEBUG: catching up contract ID 61930 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61930 billing mapping (reseller) is profile id 1139 for time 1515795043.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_provider_info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1139,
                         'product_id' => 3,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => '61930',
                         'prepaid' => 0,
                         'int_charge' => '0',
                         'class' => 'reseller'
                       },
          'balances' => [
                          {
                            'id' => 77438,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '630',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: ### 1. write pass ###
DEBUG: call from local subscriber, source_user_id is ee931a17-32a2-4be8-8a8a-27db06644867
DEBUG: call to local subscriber, destination_user_id is d5301e70-48fe-4146-8d9a-6c2a905bf497
DEBUG: destination provider has billing profile 1139, get reseller termination cost
DEBUG: calculating call cost for profile_id 1139 with type call, direction in, src_user_domain 8881101515794822@testa.com.1515794822, dst_user_domain 8882121515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '1',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '^888.+',
          'off_follow_interval' => 30,
          'fee_id' => 1624,
          'use_free_time' => 0,
          'on_init_rate' => '1',
          'zone_id' => 508,
          'off_init_interval' => 60,
          'pattern' => '.',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 1 per sec to costs
DEBUG: interval is 60, so rate for this interval is 60
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77438,
          'cash_balance_interval' => 630,
          'cash_balance' => 0,
          'start_unix' => 1514761200,
          'start' => '2018-01-01 00:00:00',
          'free_time_balance_old' => 0,
          'end_unix' => 1517439599,
          'cash_balance_old' => 0,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 60 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 60
DEBUG: rating_duration = 90
DEBUG: 1 contract balance row(s) updated
DEBUG: destination reseller termination cost is 90
DEBUG: get customer termination cost for destination_user_id d5301e70-48fe-4146-8d9a-6c2a905bf497
DEBUG: catching up contract ID 61942 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61942 billing mapping (sipaccount) is profile id 1141 for time 1515795043.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_customer info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1141,
                         'product_id' => 4,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => 61942,
                         'prepaid' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount'
                       },
          'balances' => [
                          {
                            'id' => 77450,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '210',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1141 with type call, direction in, src_user_domain 8881101515794822@testa.com.1515794822, dst_user_domain 8882121515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '3',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '^8881.+',
          'off_follow_interval' => 30,
          'fee_id' => 1628,
          'use_free_time' => 0,
          'on_init_rate' => '3',
          'zone_id' => 510,
          'off_init_interval' => 60,
          'pattern' => '.',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 3 per sec to costs
DEBUG: interval is 60, so rate for this interval is 180
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77450,
          'cash_balance' => '0',
          'cash_balance_interval' => '210',
          'start' => '2018-01-01 00:00:00',
          'start_unix' => 1514761200,
          'free_time_balance_old' => 0,
          'cash_balance_old' => '0',
          'end_unix' => 1517439599,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 180 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 180
DEBUG: rating_duration = 90
DEBUG: got call cost 210 and free time 0
DEBUG: treat pre-paid billing profile as post-paid for termination fees
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 210
DEBUG: destination customer termination cost is 210
DEBUG: calculating call cost for profile_id 1136 with type call, direction out, src_user_domain 8881101515794822@testa.com.1515794822, dst_user_domain 8882121515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '2',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '.',
          'off_follow_interval' => 30,
          'fee_id' => 1617,
          'use_free_time' => 0,
          'on_init_rate' => '2',
          'zone_id' => 505,
          'off_init_interval' => 60,
          'pattern' => '^888.+',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 2 per sec to costs
DEBUG: interval is 60, so rate for this interval is 120
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77437,
          'cash_balance_interval' => 1050,
          'cash_balance' => 0,
          'start_unix' => 1514761200,
          'start' => '2018-01-01 00:00:00',
          'free_time_balance_old' => 0,
          'end_unix' => 1517439599,
          'cash_balance_old' => 0,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 120 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 120
DEBUG: rating_duration = 90
DEBUG: 1 contract balance row(s) updated
DEBUG: catching up contract ID 61940 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61940 billing mapping (sipaccount) is profile id 1138 for time 1515795043.000 from ipv4 source ip 192.168.0.1
DEBUG: source_customer info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1138,
                         'product_id' => 4,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => 61940,
                         'prepaid' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount'
                       },
          'balances' => [
                          {
                            'id' => 77448,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: billing profile is prepaid
DEBUG: prepaid_costs cache already populated
DEBUG: calculating call cost for profile_id 1138 with type call, direction out, src_user_domain 8881101515794822@testa.com.1515794822, dst_user_domain 8882121515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '4',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '.',
          'off_follow_interval' => 30,
          'fee_id' => 1621,
          'use_free_time' => 0,
          'on_init_rate' => '4',
          'zone_id' => 507,
          'off_init_interval' => 60,
          'pattern' => '^8882.+',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 4 per sec to costs
DEBUG: interval is 60, so rate for this interval is 240
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77448,
          'cash_balance' => '0',
          'cash_balance_interval' => '0',
          'start' => '2018-01-01 00:00:00',
          'start_unix' => 1514761200,
          'free_time_balance_old' => 0,
          'cash_balance_old' => '0',
          'end_unix' => 1517439599,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 240 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 240
DEBUG: rating_duration = 90
DEBUG: got call cost 270 and free time 0
WARNING: no prepaid cost record found for call ID *TEST*4BibBfuGf8KtDxi9drULRnebbm, applying calculated costs
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 270
DEBUG: cdr ID 50868 updated
DEBUG: empty 'source_carrier_cash_balance' local col data for cdr id 50868, skipping
DEBUG: empty 'source_carrier_free_time_balance' local col data for cdr id 50868, skipping
DEBUG: empty 'source_carrier_profile_package_id' local col data for cdr id 50868, skipping
DEBUG: empty 'source_carrier_contract_balance_id' local col data for cdr id 50868, skipping
DEBUG: local col data created or up to date for cdr id 50868, column 'source_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50868, column 'source_reseller_free_time_balance': 0, 0
DEBUG: empty 'source_reseller_profile_package_id' local col data for cdr id 50868, skipping
DEBUG: local col data created or up to date for cdr id 50868, column 'source_reseller_contract_balance_id': 77437
DEBUG: local col data created or up to date for cdr id 50868, column 'source_customer_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50868, column 'source_customer_free_time_balance': 0, 0
DEBUG: empty 'source_customer_profile_package_id' local col data for cdr id 50868, skipping
DEBUG: local col data created or up to date for cdr id 50868, column 'source_customer_contract_balance_id': 77448
DEBUG: empty 'destination_carrier_cash_balance' local col data for cdr id 50868, skipping
DEBUG: empty 'destination_carrier_free_time_balance' local col data for cdr id 50868, skipping
DEBUG: empty 'destination_carrier_profile_package_id' local col data for cdr id 50868, skipping
DEBUG: empty 'destination_carrier_contract_balance_id' local col data for cdr id 50868, skipping
DEBUG: local col data created or up to date for cdr id 50868, column 'destination_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50868, column 'destination_reseller_free_time_balance': 0, 0
DEBUG: empty 'destination_reseller_profile_package_id' local col data for cdr id 50868, skipping
DEBUG: local col data created or up to date for cdr id 50868, column 'destination_reseller_contract_balance_id': 77438
DEBUG: local col data created or up to date for cdr id 50868, column 'destination_customer_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50868, column 'destination_customer_free_time_balance': 0, 0
DEBUG: empty 'destination_customer_profile_package_id' local col data for cdr id 50868, skipping
DEBUG: local col data created or up to date for cdr id 50868, column 'destination_customer_contract_balance_id': 77450
DEBUG: rating cdr ID 50868 completed successfully in 0.194 secs
DEBUG: start rating CDR ID 50869
DEBUG: 4 contract(s) locked: 61929, 61930, 61941, 61942
INFO: 3/3 - rate CDR ID 50869
DEBUG: fetching source provider info for source_provider_id #61929
DEBUG: catching up contract ID 61929 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61929 billing mapping (reseller) is profile id 1136 for time 1515795044.000 from ipv4 source ip 192.168.0.1
DEBUG: source_provider_info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1136,
                         'product_id' => 3,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => '61929',
                         'prepaid' => 0,
                         'int_charge' => '0',
                         'class' => 'reseller'
                       },
          'balances' => [
                          {
                            'id' => 77437,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '1200',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: fetching destination provider info for destination_provider_id #61930
DEBUG: catching up contract ID 61930 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61930 billing mapping (reseller) is profile id 1139 for time 1515795044.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_provider_info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1139,
                         'product_id' => 3,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => '61930',
                         'prepaid' => 0,
                         'int_charge' => '0',
                         'class' => 'reseller'
                       },
          'balances' => [
                          {
                            'id' => 77438,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '720',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: ### 1. write pass ###
DEBUG: call from local subscriber, source_user_id is 3a16e24d-e8e8-4f26-8739-f5a3c3e3e409
DEBUG: call to local subscriber, destination_user_id is d5301e70-48fe-4146-8d9a-6c2a905bf497
DEBUG: destination provider has billing profile 1139, get reseller termination cost
DEBUG: calculating call cost for profile_id 1139 with type call, direction in, src_user_domain 8881111515794822@testa.com.1515794822, dst_user_domain 8882121515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '1',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '^888.+',
          'off_follow_interval' => 30,
          'fee_id' => 1624,
          'use_free_time' => 0,
          'on_init_rate' => '1',
          'zone_id' => 508,
          'off_init_interval' => 60,
          'pattern' => '.',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 1 per sec to costs
DEBUG: interval is 60, so rate for this interval is 60
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77438,
          'cash_balance_interval' => 720,
          'cash_balance' => 0,
          'start_unix' => 1514761200,
          'start' => '2018-01-01 00:00:00',
          'free_time_balance_old' => 0,
          'end_unix' => 1517439599,
          'cash_balance_old' => 0,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 60 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 60
DEBUG: rating_duration = 90
DEBUG: 1 contract balance row(s) updated
DEBUG: destination reseller termination cost is 90
DEBUG: get customer termination cost for destination_user_id d5301e70-48fe-4146-8d9a-6c2a905bf497
DEBUG: catching up contract ID 61942 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61942 billing mapping (sipaccount) is profile id 1141 for time 1515795044.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_customer info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1141,
                         'product_id' => 4,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => 61942,
                         'prepaid' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount'
                       },
          'balances' => [
                          {
                            'id' => 77450,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '420',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1141 with type call, direction in, src_user_domain 8881111515794822@testa.com.1515794822, dst_user_domain 8882121515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '3',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '^8881.+',
          'off_follow_interval' => 30,
          'fee_id' => 1628,
          'use_free_time' => 0,
          'on_init_rate' => '3',
          'zone_id' => 510,
          'off_init_interval' => 60,
          'pattern' => '.',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 3 per sec to costs
DEBUG: interval is 60, so rate for this interval is 180
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77450,
          'cash_balance' => '0',
          'cash_balance_interval' => '420',
          'start' => '2018-01-01 00:00:00',
          'start_unix' => 1514761200,
          'free_time_balance_old' => 0,
          'cash_balance_old' => '0',
          'end_unix' => 1517439599,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 180 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 180
DEBUG: rating_duration = 90
DEBUG: got call cost 210 and free time 0
DEBUG: treat pre-paid billing profile as post-paid for termination fees
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 210
DEBUG: destination customer termination cost is 210
DEBUG: calculating call cost for profile_id 1136 with type call, direction out, src_user_domain 8881111515794822@testa.com.1515794822, dst_user_domain 8882121515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '2',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '.',
          'off_follow_interval' => 30,
          'fee_id' => 1617,
          'use_free_time' => 0,
          'on_init_rate' => '2',
          'zone_id' => 505,
          'off_init_interval' => 60,
          'pattern' => '^888.+',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 2 per sec to costs
DEBUG: interval is 60, so rate for this interval is 120
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77437,
          'cash_balance_interval' => 1200,
          'cash_balance' => 0,
          'start_unix' => 1514761200,
          'start' => '2018-01-01 00:00:00',
          'free_time_balance_old' => 0,
          'end_unix' => 1517439599,
          'cash_balance_old' => 0,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 120 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 120
DEBUG: rating_duration = 90
DEBUG: 1 contract balance row(s) updated
DEBUG: catching up contract ID 61941 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61941 billing mapping (sipaccount) is profile id 1138 for time 1515795044.000 from ipv4 source ip 192.168.0.1
DEBUG: source_customer info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1138,
                         'product_id' => 4,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => 61941,
                         'prepaid' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount'
                       },
          'balances' => [
                          {
                            'id' => 77449,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: billing profile is prepaid
DEBUG: prepaid_costs cache already populated
DEBUG: calculating call cost for profile_id 1138 with type call, direction out, src_user_domain 8881111515794822@testa.com.1515794822, dst_user_domain 8882121515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '4',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '.',
          'off_follow_interval' => 30,
          'fee_id' => 1621,
          'use_free_time' => 0,
          'on_init_rate' => '4',
          'zone_id' => 507,
          'off_init_interval' => 60,
          'pattern' => '^8882.+',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 4 per sec to costs
DEBUG: interval is 60, so rate for this interval is 240
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77449,
          'cash_balance' => '0',
          'cash_balance_interval' => '0',
          'start' => '2018-01-01 00:00:00',
          'start_unix' => 1514761200,
          'free_time_balance_old' => 0,
          'cash_balance_old' => '0',
          'end_unix' => 1517439599,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 240 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 240
DEBUG: rating_duration = 90
DEBUG: got call cost 270 and free time 0
WARNING: no prepaid cost record found for call ID *TEST*ueDkI79w88NrehtyUfq.iN8taA, applying calculated costs
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 270
DEBUG: cdr ID 50869 updated
DEBUG: empty 'source_carrier_cash_balance' local col data for cdr id 50869, skipping
DEBUG: empty 'source_carrier_free_time_balance' local col data for cdr id 50869, skipping
DEBUG: empty 'source_carrier_profile_package_id' local col data for cdr id 50869, skipping
DEBUG: empty 'source_carrier_contract_balance_id' local col data for cdr id 50869, skipping
DEBUG: local col data created or up to date for cdr id 50869, column 'source_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50869, column 'source_reseller_free_time_balance': 0, 0
DEBUG: empty 'source_reseller_profile_package_id' local col data for cdr id 50869, skipping
DEBUG: local col data created or up to date for cdr id 50869, column 'source_reseller_contract_balance_id': 77437
DEBUG: local col data created or up to date for cdr id 50869, column 'source_customer_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50869, column 'source_customer_free_time_balance': 0, 0
DEBUG: empty 'source_customer_profile_package_id' local col data for cdr id 50869, skipping
DEBUG: local col data created or up to date for cdr id 50869, column 'source_customer_contract_balance_id': 77449
DEBUG: empty 'destination_carrier_cash_balance' local col data for cdr id 50869, skipping
DEBUG: empty 'destination_carrier_free_time_balance' local col data for cdr id 50869, skipping
DEBUG: empty 'destination_carrier_profile_package_id' local col data for cdr id 50869, skipping
DEBUG: empty 'destination_carrier_contract_balance_id' local col data for cdr id 50869, skipping
DEBUG: local col data created or up to date for cdr id 50869, column 'destination_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50869, column 'destination_reseller_free_time_balance': 0, 0
DEBUG: empty 'destination_reseller_profile_package_id' local col data for cdr id 50869, skipping
DEBUG: local col data created or up to date for cdr id 50869, column 'destination_reseller_contract_balance_id': 77438
DEBUG: local col data created or up to date for cdr id 50869, column 'destination_customer_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50869, column 'destination_customer_free_time_balance': 0, 0
DEBUG: empty 'destination_customer_profile_package_id' local col data for cdr id 50869, skipping
DEBUG: local col data created or up to date for cdr id 50869, column 'destination_customer_contract_balance_id': 77450
DEBUG: rating cdr ID 50869 completed successfully in 0.167 secs
INFO: Batch of 3 CDRs completed. 3 CDRs rated overall so far.
INFO: Less than 5 new CDRs, sleep 10
ok 464 - rate-o-mat executed
ok 465 - prepaid w/o prepaid costs, no balance: rating_status = ok
ok 466 - prepaid w/o prepaid costs, no balance: destination_customer_cost = 210.000000
ok 467 - prepaid w/o prepaid costs, no balance: source_customer_cost = 270.000000
ok 468 - prepaid w/o prepaid costs, no balance: source_reseller_cost = 150.000000
ok 469 - prepaid w/o prepaid costs, no balance: destination_reseller_cost = 90.000000
ok 470 - prepaid w/o prepaid costs, no balance: id = 50867
ok 471 - prepaid w/o prepaid costs, no balance: source_customer_cost = 270.000000
ok 472 - prepaid w/o prepaid costs, no balance: destination_customer_cost = 210.000000
ok 473 - prepaid w/o prepaid costs, no balance: rating_status = ok
ok 474 - prepaid w/o prepaid costs, no balance: id = 50868
ok 475 - prepaid w/o prepaid costs, no balance: source_reseller_cost = 150.000000
ok 476 - prepaid w/o prepaid costs, no balance: destination_reseller_cost = 90.000000
ok 477 - prepaid w/o prepaid costs, no balance: destination_reseller_cost = 90.000000
ok 478 - prepaid w/o prepaid costs, no balance: source_reseller_cost = 150.000000
ok 479 - prepaid w/o prepaid costs, no balance: id = 50869
ok 480 - prepaid w/o prepaid costs, no balance: rating_status = ok
ok 481 - prepaid w/o prepaid costs, no balance: source_customer_cost = 270.000000
ok 482 - prepaid w/o prepaid costs, no balance: destination_customer_cost = 210.000000
ok 483 - cdrs were all processed
ok 484 - prepaid w/o prepaid costs, no balance, caller 1: cdr id 50867 source_customer_contract_balance_id number of records 1 = 1
ok 485 - prepaid w/o prepaid costs, no balance, caller 1: fetch customer id 61939 balance intervals collection page
ok 486 - prepaid w/o prepaid costs, no balance, caller 1: check 'total_count' of collection
ok 487 - prepaid w/o prepaid costs, no balance, caller 1: check interval 77447 cash balance 0 = 0
ok 488 - prepaid w/o prepaid costs, no balance, caller 1: check interval 77447 cash balance interval 2.7 = 2.7
ok 489 - prepaid w/o prepaid costs, no balance, caller 1: check interval 77447 id = 77447
ok 490 - prepaid w/o prepaid costs, no balance, caller 1: check if all expected items are listed
ok 491 - prepaid w/o prepaid costs, no balance, caller 1: cdr id 50867 source_customer_cash_balance before 0.0000 = 0.0000
ok 492 - prepaid w/o prepaid costs, no balance, caller 1: cdr id 50867 source_customer_cash_balance after 0.0000 = 0.0000
ok 493 - prepaid w/o prepaid costs, no balance, caller 2: cdr id 50868 source_customer_contract_balance_id number of records 1 = 1
ok 494 - prepaid w/o prepaid costs, no balance, caller 2: fetch customer id 61940 balance intervals collection page
ok 495 - prepaid w/o prepaid costs, no balance, caller 2: check 'total_count' of collection
ok 496 - prepaid w/o prepaid costs, no balance, caller 2: check interval 77448 cash balance 0 = 0
ok 497 - prepaid w/o prepaid costs, no balance, caller 2: check interval 77448 cash balance interval 2.7 = 2.7
ok 498 - prepaid w/o prepaid costs, no balance, caller 2: check interval 77448 id = 77448
ok 499 - prepaid w/o prepaid costs, no balance, caller 2: check if all expected items are listed
ok 500 - prepaid w/o prepaid costs, no balance, caller 2: cdr id 50868 source_customer_cash_balance before 0.0000 = 0.0000
ok 501 - prepaid w/o prepaid costs, no balance, caller 2: cdr id 50868 source_customer_cash_balance after 0.0000 = 0.0000
ok 502 - prepaid w/o prepaid costs, no balance, caller 3: cdr id 50869 source_customer_contract_balance_id number of records 1 = 1
ok 503 - prepaid w/o prepaid costs, no balance, caller 3: fetch customer id 61941 balance intervals collection page
ok 504 - prepaid w/o prepaid costs, no balance, caller 3: check 'total_count' of collection
ok 505 - prepaid w/o prepaid costs, no balance, caller 3: check interval 77449 cash balance 0 = 0
ok 506 - prepaid w/o prepaid costs, no balance, caller 3: check interval 77449 cash balance interval 2.7 = 2.7
ok 507 - prepaid w/o prepaid costs, no balance, caller 3: check interval 77449 id = 77449
ok 508 - prepaid w/o prepaid costs, no balance, caller 3: check if all expected items are listed
ok 509 - prepaid w/o prepaid costs, no balance, caller 3: cdr id 50869 source_customer_cash_balance before 0.0000 = 0.0000
ok 510 - prepaid w/o prepaid costs, no balance, caller 3: cdr id 50869 source_customer_cash_balance after 0.0000 = 0.0000
ok 511 - prepaid w/o prepaid costs, no balance, callee: cdr id 50867 destination_customer_contract_balance_id number of records 1 = 1
ok 512 - prepaid w/o prepaid costs, no balance, callee: fetch customer id 61942 balance intervals collection page
ok 513 - prepaid w/o prepaid costs, no balance, callee: check 'total_count' of collection
ok 514 - prepaid w/o prepaid costs, no balance, callee: check interval 77450 cash balance 0 = 0
ok 515 - prepaid w/o prepaid costs, no balance, callee: check interval 77450 cash balance interval 6.3 = 6.3
ok 516 - prepaid w/o prepaid costs, no balance, callee: check interval 77450 id = 77450
ok 517 - prepaid w/o prepaid costs, no balance, callee: check if all expected items are listed
ok 518 - prepaid w/o prepaid costs, no balance, callee: cdr id 50867 destination_customer_contract_balance_id 77450 = 77450
ok 519 - prepaid w/o prepaid costs, no balance, callee: cdr id 50867 destination_customer_cash_balance before 0.0000 = 0.0000
ok 520 - prepaid w/o prepaid costs, no balance, callee: cdr id 50867 destination_customer_cash_balance after 0.0000 = 0.0000
ok 521 - prepaid w/o prepaid costs, no balance, callee: cdr id 50868 destination_customer_contract_balance_id 77450 = 77450
ok 522 - prepaid w/o prepaid costs, no balance, callee: cdr id 50868 destination_customer_cash_balance before 0.0000 = 0.0000
ok 523 - prepaid w/o prepaid costs, no balance, callee: cdr id 50868 destination_customer_cash_balance after 0.0000 = 0.0000
ok 524 - prepaid w/o prepaid costs, no balance, callee: cdr id 50869 destination_customer_contract_balance_id 77450 = 77450
ok 525 - prepaid w/o prepaid costs, no balance, callee: cdr id 50869 destination_customer_cash_balance before 0.0000 = 0.0000
ok 526 - prepaid w/o prepaid costs, no balance, callee: cdr id 50869 destination_customer_cash_balance after 0.0000 = 0.0000
ok 527 - prepaid w/o prepaid costs, no balance, callers' provider: cdr id 50867 source_reseller_contract_balance_id number of records 1 = 1
ok 528 - prepaid w/o prepaid costs, no balance, callers' provider: fetch customer id 61929 balance intervals collection page
ok 529 - prepaid w/o prepaid costs, no balance, callers' provider: check 'total_count' of collection
ok 530 - prepaid w/o prepaid costs, no balance, callers' provider: check interval 77437 cash balance interval 13.5 = 13.5
ok 531 - prepaid w/o prepaid costs, no balance, callers' provider: check interval 77437 id = 77437
ok 532 - prepaid w/o prepaid costs, no balance, callers' provider: check if all expected items are listed
ok 533 - prepaid w/o prepaid costs, no balance, callers' provider: cdr id 50867 source_carrier_contract_balance_id number of records 0 = 0
ok 534 - prepaid w/o prepaid costs, no balance, callers' provider: cdr id 50867 source_reseller_contract_balance_id 77437 = 77437
ok 535 - prepaid w/o prepaid costs, no balance, callers' provider: cdr id 50868 source_carrier_contract_balance_id number of records 0 = 0
ok 536 - prepaid w/o prepaid costs, no balance, callers' provider: cdr id 50868 source_reseller_contract_balance_id 77437 = 77437
ok 537 - prepaid w/o prepaid costs, no balance, callers' provider: cdr id 50869 source_carrier_contract_balance_id number of records 0 = 0
ok 538 - prepaid w/o prepaid costs, no balance, callers' provider: cdr id 50869 source_reseller_contract_balance_id 77437 = 77437
ok 539 - prepaid w/o prepaid costs, no balance, callee's provider: cdr id 50867 destination_reseller_contract_balance_id number of records 1 = 1
ok 540 - prepaid w/o prepaid costs, no balance, callee's provider: fetch customer id 61930 balance intervals collection page
ok 541 - prepaid w/o prepaid costs, no balance, callee's provider: check 'total_count' of collection
ok 542 - prepaid w/o prepaid costs, no balance, callee's provider: check interval 77438 cash balance interval 8.1 = 8.1
ok 543 - prepaid w/o prepaid costs, no balance, callee's provider: check interval 77438 id = 77438
ok 544 - prepaid w/o prepaid costs, no balance, callee's provider: check if all expected items are listed
ok 545 - prepaid w/o prepaid costs, no balance, callee's provider: cdr id 50867 destination_carrier_contract_balance_id number of records 0 = 0
ok 546 - prepaid w/o prepaid costs, no balance, callee's provider: cdr id 50867 destination_reseller_contract_balance_id 77438 = 77438
ok 547 - prepaid w/o prepaid costs, no balance, callee's provider: cdr id 50868 destination_carrier_contract_balance_id number of records 0 = 0
ok 548 - prepaid w/o prepaid costs, no balance, callee's provider: cdr id 50868 destination_reseller_contract_balance_id 77438 = 77438
ok 549 - prepaid w/o prepaid costs, no balance, callee's provider: cdr id 50869 destination_carrier_contract_balance_id number of records 0 = 0
ok 550 - prepaid w/o prepaid costs, no balance, callee's provider: cdr id 50869 destination_reseller_contract_balance_id 77438 = 77438
ok 551 - prepaid w/o prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50867 source_carrier_profile_package_id number of records 0 = 0
ok 552 - prepaid w/o prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50867 source_reseller_profile_package_id number of records 0 = 0
ok 553 - prepaid w/o prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50867 source_customer_profile_package_id number of records 0 = 0
ok 554 - prepaid w/o prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50867 destination_carrier_profile_package_id number of records 0 = 0
ok 555 - prepaid w/o prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50867 destination_reseller_profile_package_id number of records 0 = 0
ok 556 - prepaid w/o prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50867 destination_customer_profile_package_id number of records 0 = 0
ok 557 - prepaid w/o prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50868 source_carrier_profile_package_id number of records 0 = 0
ok 558 - prepaid w/o prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50868 source_reseller_profile_package_id number of records 0 = 0
ok 559 - prepaid w/o prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50868 source_customer_profile_package_id number of records 0 = 0
ok 560 - prepaid w/o prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50868 destination_carrier_profile_package_id number of records 0 = 0
ok 561 - prepaid w/o prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50868 destination_reseller_profile_package_id number of records 0 = 0
ok 562 - prepaid w/o prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50868 destination_customer_profile_package_id number of records 0 = 0
ok 563 - prepaid w/o prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50869 source_carrier_profile_package_id number of records 0 = 0
ok 564 - prepaid w/o prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50869 source_reseller_profile_package_id number of records 0 = 0
ok 565 - prepaid w/o prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50869 source_customer_profile_package_id number of records 0 = 0
ok 566 - prepaid w/o prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50869 destination_carrier_profile_package_id number of records 0 = 0
ok 567 - prepaid w/o prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50869 destination_reseller_profile_package_id number of records 0 = 0
ok 568 - prepaid w/o prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50869 destination_customer_profile_package_id number of records 0 = 0
ok 569 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50867 source_carrier_free_time_balance number of records 0 = 0
ok 570 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50867 source_reseller_free_time_balance before 0 = 0
ok 571 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50867 source_reseller_free_time_balance after 0 = 0
ok 572 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50867 source_customer_free_time_balance before 0 = 0
ok 573 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50867 source_customer_free_time_balance after 0 = 0
ok 574 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50867 destination_carrier_free_time_balance number of records 0 = 0
ok 575 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50867 destination_reseller_free_time_balance before 0 = 0
ok 576 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50867 destination_reseller_free_time_balance after 0 = 0
ok 577 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50867 destination_customer_free_time_balance before 0 = 0
ok 578 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50867 destination_customer_free_time_balance after 0 = 0
ok 579 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50868 source_carrier_free_time_balance number of records 0 = 0
ok 580 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50868 source_reseller_free_time_balance before 0 = 0
ok 581 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50868 source_reseller_free_time_balance after 0 = 0
ok 582 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50868 source_customer_free_time_balance before 0 = 0
ok 583 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50868 source_customer_free_time_balance after 0 = 0
ok 584 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50868 destination_carrier_free_time_balance number of records 0 = 0
ok 585 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50868 destination_reseller_free_time_balance before 0 = 0
ok 586 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50868 destination_reseller_free_time_balance after 0 = 0
ok 587 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50868 destination_customer_free_time_balance before 0 = 0
ok 588 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50868 destination_customer_free_time_balance after 0 = 0
ok 589 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50869 source_carrier_free_time_balance number of records 0 = 0
ok 590 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50869 source_reseller_free_time_balance before 0 = 0
ok 591 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50869 source_reseller_free_time_balance after 0 = 0
ok 592 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50869 source_customer_free_time_balance before 0 = 0
ok 593 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50869 source_customer_free_time_balance after 0 = 0
ok 594 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50869 destination_carrier_free_time_balance number of records 0 = 0
ok 595 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50869 destination_reseller_free_time_balance before 0 = 0
ok 596 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50869 destination_reseller_free_time_balance after 0 = 0
ok 597 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50869 destination_customer_free_time_balance before 0 = 0
ok 598 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50869 destination_customer_free_time_balance after 0 = 0
ok 599 - prepaid w/o prepaid costs, no balance providers must have zero balance: cdr id 50867 source_carrier_cash_balance number of records 0 = 0
ok 600 - prepaid w/o prepaid costs, no balance providers must have zero balance: cdr id 50867 source_reseller_cash_balance before 0.0000 = 0.0000
ok 601 - prepaid w/o prepaid costs, no balance providers must have zero balance: cdr id 50867 source_reseller_cash_balance after 0.0000 = 0.0000
ok 602 - prepaid w/o prepaid costs, no balance providers must have zero balance: cdr id 50867 destination_carrier_cash_balance number of records 0 = 0
ok 603 - prepaid w/o prepaid costs, no balance providers must have zero balance: cdr id 50867 destination_reseller_cash_balance before 0.0000 = 0.0000
ok 604 - prepaid w/o prepaid costs, no balance providers must have zero balance: cdr id 50867 destination_reseller_cash_balance after 0.0000 = 0.0000
ok 605 - prepaid w/o prepaid costs, no balance providers must have zero balance: cdr id 50868 source_carrier_cash_balance number of records 0 = 0
ok 606 - prepaid w/o prepaid costs, no balance providers must have zero balance: cdr id 50868 source_reseller_cash_balance before 0.0000 = 0.0000
ok 607 - prepaid w/o prepaid costs, no balance providers must have zero balance: cdr id 50868 source_reseller_cash_balance after 0.0000 = 0.0000
ok 608 - prepaid w/o prepaid costs, no balance providers must have zero balance: cdr id 50868 destination_carrier_cash_balance number of records 0 = 0
ok 609 - prepaid w/o prepaid costs, no balance providers must have zero balance: cdr id 50868 destination_reseller_cash_balance before 0.0000 = 0.0000
ok 610 - prepaid w/o prepaid costs, no balance providers must have zero balance: cdr id 50868 destination_reseller_cash_balance after 0.0000 = 0.0000
ok 611 - prepaid w/o prepaid costs, no balance providers must have zero balance: cdr id 50869 source_carrier_cash_balance number of records 0 = 0
ok 612 - prepaid w/o prepaid costs, no balance providers must have zero balance: cdr id 50869 source_reseller_cash_balance before 0.0000 = 0.0000
ok 613 - prepaid w/o prepaid costs, no balance providers must have zero balance: cdr id 50869 source_reseller_cash_balance after 0.0000 = 0.0000
ok 614 - prepaid w/o prepaid costs, no balance providers must have zero balance: cdr id 50869 destination_carrier_cash_balance number of records 0 = 0
ok 615 - prepaid w/o prepaid costs, no balance providers must have zero balance: cdr id 50869 destination_reseller_cash_balance before 0.0000 = 0.0000
ok 616 - prepaid w/o prepaid costs, no balance providers must have zero balance: cdr id 50869 destination_reseller_cash_balance after 0.0000 = 0.0000
ok 617 - create customercontacts 13
ok 618 - create customers 13
ok 619 - setting customer id 61943 cash_balance to 0 cents
ok 620 - create subscribers 13
ok 621 - very first balance interval: fetch customer id 61943 balance intervals collection page
ok 622 - very first balance interval: check interval 77451 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 623 - very first balance interval: check interval 77451 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 624 - very first balance interval: check interval 77451 cash balance 0 = 0
ok 625 - very first balance interval: check interval 77451 billing profile id 1138 = 1138
ok 626 - very first balance interval: check if all expected items are listed
ok 627 - create customercontacts 14
ok 628 - create customers 14
ok 629 - setting customer id 61944 cash_balance to 0 cents
ok 630 - create subscribers 14
ok 631 - very first balance interval: fetch customer id 61944 balance intervals collection page
ok 632 - very first balance interval: check interval 77452 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 633 - very first balance interval: check interval 77452 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 634 - very first balance interval: check interval 77452 cash balance 0 = 0
ok 635 - very first balance interval: check interval 77452 billing profile id 1138 = 1138
ok 636 - very first balance interval: check if all expected items are listed
ok 637 - create customercontacts 15
ok 638 - create customers 15
ok 639 - setting customer id 61945 cash_balance to 0 cents
ok 640 - create subscribers 15
ok 641 - very first balance interval: fetch customer id 61945 balance intervals collection page
ok 642 - very first balance interval: check interval 77453 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 643 - very first balance interval: check interval 77453 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 644 - very first balance interval: check interval 77453 cash balance 0 = 0
ok 645 - very first balance interval: check interval 77453 billing profile id 1138 = 1138
ok 646 - very first balance interval: check if all expected items are listed
ok 647 - create customercontacts 16
ok 648 - create customers 16
ok 649 - setting customer id 61946 cash_balance to 0 cents
ok 650 - create subscribers 16
ok 651 - very first balance interval: fetch customer id 61946 balance intervals collection page
ok 652 - very first balance interval: check interval 77454 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 653 - very first balance interval: check interval 77454 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 654 - very first balance interval: check interval 77454 cash balance 0 = 0
ok 655 - very first balance interval: check interval 77454 billing profile id 1141 = 1141
ok 656 - very first balance interval: check if all expected items are listed
ok 657 - cdrs id 50870, 50871, 50872 with prepaid costs records created
INFO: Trying to connect to billing db...
INFO: Successfully connected to duplication db...
INFO: Trying to connect to provisioning db...
INFO: Successfully connected to provisioning db...
INFO: Trying to connect to accounting db...
INFO: Successfully connected to accounting db...
WARNING: No duplication db credentials, disabled.
INFO: local cdr relation column model loaded
INFO: local cdr cash balance column model loaded
INFO: local cdr time balance column model loaded
INFO: Up and running.
INFO: Grabbed 3 CDRs
DEBUG: start rating CDR ID 50870
DEBUG: 4 contract(s) locked: 61929, 61930, 61943, 61946
INFO: 1/3 - rate CDR ID 50870
DEBUG: fetching source provider info for source_provider_id #61929
DEBUG: catching up contract ID 61929 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61929 billing mapping (reseller) is profile id 1136 for time 1515795100.000 from ipv4 source ip 192.168.0.1
DEBUG: source_provider_info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1136,
                         'product_id' => 3,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => '61929',
                         'prepaid' => 0,
                         'class' => 'reseller',
                         'int_charge' => '0'
                       },
          'balances' => [
                          {
                            'id' => 77437,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '1350',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: fetching destination provider info for destination_provider_id #61930
DEBUG: catching up contract ID 61930 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61930 billing mapping (reseller) is profile id 1139 for time 1515795100.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_provider_info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1139,
                         'product_id' => 3,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => '61930',
                         'prepaid' => 0,
                         'class' => 'reseller',
                         'int_charge' => '0'
                       },
          'balances' => [
                          {
                            'id' => 77438,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '810',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: ### 1. write pass ###
DEBUG: call from local subscriber, source_user_id is 3e4c1b94-b01a-485f-9ac2-9317245a3a87
DEBUG: call to local subscriber, destination_user_id is f8ad8f9c-dfcd-4c49-93fa-9f86bd51a88f
DEBUG: destination provider has billing profile 1139, get reseller termination cost
DEBUG: calculating call cost for profile_id 1139 with type call, direction in, src_user_domain 8881131515794822@testa.com.1515794822, dst_user_domain 8882161515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '1',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '^888.+',
          'off_follow_interval' => 30,
          'fee_id' => 1624,
          'use_free_time' => 0,
          'on_init_rate' => '1',
          'zone_id' => 508,
          'off_init_interval' => 60,
          'pattern' => '.',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 1 per sec to costs
DEBUG: interval is 60, so rate for this interval is 60
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77438,
          'cash_balance_interval' => 810,
          'cash_balance' => 0,
          'start_unix' => 1514761200,
          'start' => '2018-01-01 00:00:00',
          'free_time_balance_old' => 0,
          'end_unix' => 1517439599,
          'cash_balance_old' => 0,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 60 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 60
DEBUG: rating_duration = 90
DEBUG: 1 contract balance row(s) updated
DEBUG: destination reseller termination cost is 90
DEBUG: get customer termination cost for destination_user_id f8ad8f9c-dfcd-4c49-93fa-9f86bd51a88f
DEBUG: catching up contract ID 61946 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61946 billing mapping (sipaccount) is profile id 1141 for time 1515795100.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_customer info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1141,
                         'product_id' => 4,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => 61946,
                         'prepaid' => 1,
                         'class' => 'sipaccount',
                         'int_charge' => '0'
                       },
          'balances' => [
                          {
                            'id' => 77454,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1141 with type call, direction in, src_user_domain 8881131515794822@testa.com.1515794822, dst_user_domain 8882161515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '3',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '^8881.+',
          'off_follow_interval' => 30,
          'fee_id' => 1628,
          'use_free_time' => 0,
          'on_init_rate' => '3',
          'zone_id' => 510,
          'off_init_interval' => 60,
          'pattern' => '.',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 3 per sec to costs
DEBUG: interval is 60, so rate for this interval is 180
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77454,
          'cash_balance' => '0',
          'cash_balance_interval' => '0',
          'start' => '2018-01-01 00:00:00',
          'start_unix' => 1514761200,
          'free_time_balance_old' => 0,
          'cash_balance_old' => '0',
          'end_unix' => 1517439599,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 180 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 180
DEBUG: rating_duration = 90
DEBUG: got call cost 210 and free time 0
DEBUG: treat pre-paid billing profile as post-paid for termination fees
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 210
DEBUG: destination customer termination cost is 210
DEBUG: calculating call cost for profile_id 1136 with type call, direction out, src_user_domain 8881131515794822@testa.com.1515794822, dst_user_domain 8882161515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '2',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '.',
          'off_follow_interval' => 30,
          'fee_id' => 1617,
          'use_free_time' => 0,
          'on_init_rate' => '2',
          'zone_id' => 505,
          'off_init_interval' => 60,
          'pattern' => '^888.+',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 2 per sec to costs
DEBUG: interval is 60, so rate for this interval is 120
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77437,
          'cash_balance_interval' => 1350,
          'cash_balance' => 0,
          'start_unix' => 1514761200,
          'start' => '2018-01-01 00:00:00',
          'free_time_balance_old' => 0,
          'end_unix' => 1517439599,
          'cash_balance_old' => 0,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 120 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 120
DEBUG: rating_duration = 90
DEBUG: 1 contract balance row(s) updated
DEBUG: catching up contract ID 61943 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61943 billing mapping (sipaccount) is profile id 1138 for time 1515795100.000 from ipv4 source ip 192.168.0.1
DEBUG: source_customer info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1138,
                         'product_id' => 4,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => 61943,
                         'prepaid' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount'
                       },
          'balances' => [
                          {
                            'id' => 77451,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: billing profile is prepaid
DEBUG: empty prepaid_costs cache, populate it
DEBUG: prepaid_costs cache populated, 3 records
DEBUG: prepaid_costs call_id = *TEST*khshGxcWcx4qMx7TOFJDcKHNNt, source_user_id = 3e4c1b94-b01a-485f-9ac2-9317245a3a87, destination_user_id = f8ad8f9c-dfcd-4c49-93fa-9f86bd51a88f found in cache
DEBUG: calculating call cost for profile_id 1138 with type call, direction out, src_user_domain 8881131515794822@testa.com.1515794822, dst_user_domain 8882161515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '4',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '.',
          'off_follow_interval' => 30,
          'fee_id' => 1621,
          'use_free_time' => 0,
          'on_init_rate' => '4',
          'zone_id' => 507,
          'off_init_interval' => 60,
          'pattern' => '^8882.+',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 4 per sec to costs
DEBUG: interval is 60, so rate for this interval is 240
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77451,
          'cash_balance' => '0',
          'cash_balance_interval' => '0',
          'start' => '2018-01-01 00:00:00',
          'start_unix' => 1514761200,
          'free_time_balance_old' => 0,
          'cash_balance_old' => '0',
          'end_unix' => 1517439599,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 240 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 240
DEBUG: rating_duration = 90
DEBUG: got call cost 270 and free time 0
DEBUG: prepaid_costs call_id = *TEST*khshGxcWcx4qMx7TOFJDcKHNNt, source_user_id = 3e4c1b94-b01a-485f-9ac2-9317245a3a87, destination_user_id = f8ad8f9c-dfcd-4c49-93fa-9f86bd51a88f deleted
DEBUG: dropped prepaid_costs call_id = *TEST*khshGxcWcx4qMx7TOFJDcKHNNt, source_user_id = 3e4c1b94-b01a-485f-9ac2-9317245a3a87, destination_user_id = f8ad8f9c-dfcd-4c49-93fa-9f86bd51a88f from cache
DEBUG: cost for this call is 270
DEBUG: cdr ID 50870 updated
DEBUG: empty 'source_carrier_cash_balance' local col data for cdr id 50870, skipping
DEBUG: empty 'source_carrier_free_time_balance' local col data for cdr id 50870, skipping
DEBUG: empty 'source_carrier_profile_package_id' local col data for cdr id 50870, skipping
DEBUG: empty 'source_carrier_contract_balance_id' local col data for cdr id 50870, skipping
DEBUG: local col data created or up to date for cdr id 50870, column 'source_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50870, column 'source_reseller_free_time_balance': 0, 0
DEBUG: empty 'source_reseller_profile_package_id' local col data for cdr id 50870, skipping
DEBUG: local col data created or up to date for cdr id 50870, column 'source_reseller_contract_balance_id': 77437
DEBUG: local col data created or up to date for cdr id 50870, column 'source_customer_cash_balance': 270.0000, 0
DEBUG: local col data created or up to date for cdr id 50870, column 'source_customer_free_time_balance': 0, 0
DEBUG: empty 'source_customer_profile_package_id' local col data for cdr id 50870, skipping
DEBUG: local col data created or up to date for cdr id 50870, column 'source_customer_contract_balance_id': 77451
DEBUG: empty 'destination_carrier_cash_balance' local col data for cdr id 50870, skipping
DEBUG: empty 'destination_carrier_free_time_balance' local col data for cdr id 50870, skipping
DEBUG: empty 'destination_carrier_profile_package_id' local col data for cdr id 50870, skipping
DEBUG: empty 'destination_carrier_contract_balance_id' local col data for cdr id 50870, skipping
DEBUG: local col data created or up to date for cdr id 50870, column 'destination_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50870, column 'destination_reseller_free_time_balance': 0, 0
DEBUG: empty 'destination_reseller_profile_package_id' local col data for cdr id 50870, skipping
DEBUG: local col data created or up to date for cdr id 50870, column 'destination_reseller_contract_balance_id': 77438
DEBUG: local col data created or up to date for cdr id 50870, column 'destination_customer_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50870, column 'destination_customer_free_time_balance': 0, 0
DEBUG: empty 'destination_customer_profile_package_id' local col data for cdr id 50870, skipping
DEBUG: local col data created or up to date for cdr id 50870, column 'destination_customer_contract_balance_id': 77454
DEBUG: rating cdr ID 50870 completed successfully in 0.184 secs
DEBUG: start rating CDR ID 50871
DEBUG: 4 contract(s) locked: 61929, 61930, 61944, 61946
INFO: 2/3 - rate CDR ID 50871
DEBUG: fetching source provider info for source_provider_id #61929
DEBUG: catching up contract ID 61929 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61929 billing mapping (reseller) is profile id 1136 for time 1515795101.000 from ipv4 source ip 192.168.0.1
DEBUG: source_provider_info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1136,
                         'product_id' => 3,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => '61929',
                         'prepaid' => 0,
                         'int_charge' => '0',
                         'class' => 'reseller'
                       },
          'balances' => [
                          {
                            'id' => 77437,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '1500',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: fetching destination provider info for destination_provider_id #61930
DEBUG: catching up contract ID 61930 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61930 billing mapping (reseller) is profile id 1139 for time 1515795101.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_provider_info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1139,
                         'product_id' => 3,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => '61930',
                         'prepaid' => 0,
                         'int_charge' => '0',
                         'class' => 'reseller'
                       },
          'balances' => [
                          {
                            'id' => 77438,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '900',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: ### 1. write pass ###
DEBUG: call from local subscriber, source_user_id is 06d9c2a0-952d-4d27-9b3e-61813d9c8777
DEBUG: call to local subscriber, destination_user_id is f8ad8f9c-dfcd-4c49-93fa-9f86bd51a88f
DEBUG: destination provider has billing profile 1139, get reseller termination cost
DEBUG: calculating call cost for profile_id 1139 with type call, direction in, src_user_domain 8881141515794822@testa.com.1515794822, dst_user_domain 8882161515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '1',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '^888.+',
          'off_follow_interval' => 30,
          'fee_id' => 1624,
          'use_free_time' => 0,
          'on_init_rate' => '1',
          'zone_id' => 508,
          'off_init_interval' => 60,
          'pattern' => '.',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 1 per sec to costs
DEBUG: interval is 60, so rate for this interval is 60
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77438,
          'cash_balance_interval' => 900,
          'cash_balance' => 0,
          'start_unix' => 1514761200,
          'start' => '2018-01-01 00:00:00',
          'free_time_balance_old' => 0,
          'end_unix' => 1517439599,
          'cash_balance_old' => 0,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 60 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 60
DEBUG: rating_duration = 90
DEBUG: 1 contract balance row(s) updated
DEBUG: destination reseller termination cost is 90
DEBUG: get customer termination cost for destination_user_id f8ad8f9c-dfcd-4c49-93fa-9f86bd51a88f
DEBUG: catching up contract ID 61946 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61946 billing mapping (sipaccount) is profile id 1141 for time 1515795101.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_customer info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1141,
                         'product_id' => 4,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => 61946,
                         'prepaid' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount'
                       },
          'balances' => [
                          {
                            'id' => 77454,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '210',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1141 with type call, direction in, src_user_domain 8881141515794822@testa.com.1515794822, dst_user_domain 8882161515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '3',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '^8881.+',
          'off_follow_interval' => 30,
          'fee_id' => 1628,
          'use_free_time' => 0,
          'on_init_rate' => '3',
          'zone_id' => 510,
          'off_init_interval' => 60,
          'pattern' => '.',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 3 per sec to costs
DEBUG: interval is 60, so rate for this interval is 180
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77454,
          'cash_balance' => '0',
          'cash_balance_interval' => '210',
          'start' => '2018-01-01 00:00:00',
          'start_unix' => 1514761200,
          'free_time_balance_old' => 0,
          'cash_balance_old' => '0',
          'end_unix' => 1517439599,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 180 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 180
DEBUG: rating_duration = 90
DEBUG: got call cost 210 and free time 0
DEBUG: treat pre-paid billing profile as post-paid for termination fees
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 210
DEBUG: destination customer termination cost is 210
DEBUG: calculating call cost for profile_id 1136 with type call, direction out, src_user_domain 8881141515794822@testa.com.1515794822, dst_user_domain 8882161515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '2',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '.',
          'off_follow_interval' => 30,
          'fee_id' => 1617,
          'use_free_time' => 0,
          'on_init_rate' => '2',
          'zone_id' => 505,
          'off_init_interval' => 60,
          'pattern' => '^888.+',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 2 per sec to costs
DEBUG: interval is 60, so rate for this interval is 120
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77437,
          'cash_balance_interval' => 1500,
          'cash_balance' => 0,
          'start_unix' => 1514761200,
          'start' => '2018-01-01 00:00:00',
          'free_time_balance_old' => 0,
          'end_unix' => 1517439599,
          'cash_balance_old' => 0,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 120 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 120
DEBUG: rating_duration = 90
DEBUG: 1 contract balance row(s) updated
DEBUG: catching up contract ID 61944 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61944 billing mapping (sipaccount) is profile id 1138 for time 1515795101.000 from ipv4 source ip 192.168.0.1
DEBUG: source_customer info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1138,
                         'product_id' => 4,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => 61944,
                         'prepaid' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount'
                       },
          'balances' => [
                          {
                            'id' => 77452,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: billing profile is prepaid
DEBUG: prepaid_costs cache already populated
DEBUG: prepaid_costs call_id = *TEST*c75.YNEgxAOIpL8FqfATlbV-Tc, source_user_id = 06d9c2a0-952d-4d27-9b3e-61813d9c8777, destination_user_id = f8ad8f9c-dfcd-4c49-93fa-9f86bd51a88f found in cache
DEBUG: calculating call cost for profile_id 1138 with type call, direction out, src_user_domain 8881141515794822@testa.com.1515794822, dst_user_domain 8882161515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '4',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '.',
          'off_follow_interval' => 30,
          'fee_id' => 1621,
          'use_free_time' => 0,
          'on_init_rate' => '4',
          'zone_id' => 507,
          'off_init_interval' => 60,
          'pattern' => '^8882.+',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 4 per sec to costs
DEBUG: interval is 60, so rate for this interval is 240
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77452,
          'cash_balance' => '0',
          'cash_balance_interval' => '0',
          'start' => '2018-01-01 00:00:00',
          'start_unix' => 1514761200,
          'free_time_balance_old' => 0,
          'cash_balance_old' => '0',
          'end_unix' => 1517439599,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 240 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 240
DEBUG: rating_duration = 90
DEBUG: got call cost 270 and free time 0
DEBUG: prepaid_costs call_id = *TEST*c75.YNEgxAOIpL8FqfATlbV-Tc, source_user_id = 06d9c2a0-952d-4d27-9b3e-61813d9c8777, destination_user_id = f8ad8f9c-dfcd-4c49-93fa-9f86bd51a88f deleted
DEBUG: dropped prepaid_costs call_id = *TEST*c75.YNEgxAOIpL8FqfATlbV-Tc, source_user_id = 06d9c2a0-952d-4d27-9b3e-61813d9c8777, destination_user_id = f8ad8f9c-dfcd-4c49-93fa-9f86bd51a88f from cache
DEBUG: cost for this call is 270
DEBUG: cdr ID 50871 updated
DEBUG: empty 'source_carrier_cash_balance' local col data for cdr id 50871, skipping
DEBUG: empty 'source_carrier_free_time_balance' local col data for cdr id 50871, skipping
DEBUG: empty 'source_carrier_profile_package_id' local col data for cdr id 50871, skipping
DEBUG: empty 'source_carrier_contract_balance_id' local col data for cdr id 50871, skipping
DEBUG: local col data created or up to date for cdr id 50871, column 'source_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50871, column 'source_reseller_free_time_balance': 0, 0
DEBUG: empty 'source_reseller_profile_package_id' local col data for cdr id 50871, skipping
DEBUG: local col data created or up to date for cdr id 50871, column 'source_reseller_contract_balance_id': 77437
DEBUG: local col data created or up to date for cdr id 50871, column 'source_customer_cash_balance': 270.0000, 0
DEBUG: local col data created or up to date for cdr id 50871, column 'source_customer_free_time_balance': 0, 0
DEBUG: empty 'source_customer_profile_package_id' local col data for cdr id 50871, skipping
DEBUG: local col data created or up to date for cdr id 50871, column 'source_customer_contract_balance_id': 77452
DEBUG: empty 'destination_carrier_cash_balance' local col data for cdr id 50871, skipping
DEBUG: empty 'destination_carrier_free_time_balance' local col data for cdr id 50871, skipping
DEBUG: empty 'destination_carrier_profile_package_id' local col data for cdr id 50871, skipping
DEBUG: empty 'destination_carrier_contract_balance_id' local col data for cdr id 50871, skipping
DEBUG: local col data created or up to date for cdr id 50871, column 'destination_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50871, column 'destination_reseller_free_time_balance': 0, 0
DEBUG: empty 'destination_reseller_profile_package_id' local col data for cdr id 50871, skipping
DEBUG: local col data created or up to date for cdr id 50871, column 'destination_reseller_contract_balance_id': 77438
DEBUG: local col data created or up to date for cdr id 50871, column 'destination_customer_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50871, column 'destination_customer_free_time_balance': 0, 0
DEBUG: empty 'destination_customer_profile_package_id' local col data for cdr id 50871, skipping
DEBUG: local col data created or up to date for cdr id 50871, column 'destination_customer_contract_balance_id': 77454
DEBUG: rating cdr ID 50871 completed successfully in 0.162 secs
DEBUG: start rating CDR ID 50872
DEBUG: 4 contract(s) locked: 61929, 61930, 61945, 61946
INFO: 3/3 - rate CDR ID 50872
DEBUG: fetching source provider info for source_provider_id #61929
DEBUG: catching up contract ID 61929 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61929 billing mapping (reseller) is profile id 1136 for time 1515795102.000 from ipv4 source ip 192.168.0.1
DEBUG: source_provider_info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1136,
                         'product_id' => 3,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => '61929',
                         'prepaid' => 0,
                         'int_charge' => '0',
                         'class' => 'reseller'
                       },
          'balances' => [
                          {
                            'id' => 77437,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '1650',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: fetching destination provider info for destination_provider_id #61930
DEBUG: catching up contract ID 61930 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61930 billing mapping (reseller) is profile id 1139 for time 1515795102.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_provider_info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1139,
                         'product_id' => 3,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => '61930',
                         'prepaid' => 0,
                         'int_charge' => '0',
                         'class' => 'reseller'
                       },
          'balances' => [
                          {
                            'id' => 77438,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '990',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: ### 1. write pass ###
DEBUG: call from local subscriber, source_user_id is 19356ecb-44a8-4b90-ae5f-c223b49a4307
DEBUG: call to local subscriber, destination_user_id is f8ad8f9c-dfcd-4c49-93fa-9f86bd51a88f
DEBUG: destination provider has billing profile 1139, get reseller termination cost
DEBUG: calculating call cost for profile_id 1139 with type call, direction in, src_user_domain 8881151515794822@testa.com.1515794822, dst_user_domain 8882161515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '1',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '^888.+',
          'off_follow_interval' => 30,
          'fee_id' => 1624,
          'use_free_time' => 0,
          'on_init_rate' => '1',
          'zone_id' => 508,
          'off_init_interval' => 60,
          'pattern' => '.',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 1 per sec to costs
DEBUG: interval is 60, so rate for this interval is 60
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77438,
          'cash_balance_interval' => 990,
          'cash_balance' => 0,
          'start_unix' => 1514761200,
          'start' => '2018-01-01 00:00:00',
          'free_time_balance_old' => 0,
          'end_unix' => 1517439599,
          'cash_balance_old' => 0,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 60 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 60
DEBUG: rating_duration = 90
DEBUG: 1 contract balance row(s) updated
DEBUG: destination reseller termination cost is 90
DEBUG: get customer termination cost for destination_user_id f8ad8f9c-dfcd-4c49-93fa-9f86bd51a88f
DEBUG: catching up contract ID 61946 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61946 billing mapping (sipaccount) is profile id 1141 for time 1515795102.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_customer info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1141,
                         'product_id' => 4,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => 61946,
                         'prepaid' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount'
                       },
          'balances' => [
                          {
                            'id' => 77454,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '420',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1141 with type call, direction in, src_user_domain 8881151515794822@testa.com.1515794822, dst_user_domain 8882161515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '3',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '^8881.+',
          'off_follow_interval' => 30,
          'fee_id' => 1628,
          'use_free_time' => 0,
          'on_init_rate' => '3',
          'zone_id' => 510,
          'off_init_interval' => 60,
          'pattern' => '.',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 3 per sec to costs
DEBUG: interval is 60, so rate for this interval is 180
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77454,
          'cash_balance' => '0',
          'cash_balance_interval' => '420',
          'start' => '2018-01-01 00:00:00',
          'start_unix' => 1514761200,
          'free_time_balance_old' => 0,
          'cash_balance_old' => '0',
          'end_unix' => 1517439599,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 180 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 180
DEBUG: rating_duration = 90
DEBUG: got call cost 210 and free time 0
DEBUG: treat pre-paid billing profile as post-paid for termination fees
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 210
DEBUG: destination customer termination cost is 210
DEBUG: calculating call cost for profile_id 1136 with type call, direction out, src_user_domain 8881151515794822@testa.com.1515794822, dst_user_domain 8882161515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '2',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '.',
          'off_follow_interval' => 30,
          'fee_id' => 1617,
          'use_free_time' => 0,
          'on_init_rate' => '2',
          'zone_id' => 505,
          'off_init_interval' => 60,
          'pattern' => '^888.+',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 2 per sec to costs
DEBUG: interval is 60, so rate for this interval is 120
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77437,
          'cash_balance_interval' => 1650,
          'cash_balance' => 0,
          'start_unix' => 1514761200,
          'start' => '2018-01-01 00:00:00',
          'free_time_balance_old' => 0,
          'end_unix' => 1517439599,
          'cash_balance_old' => 0,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 120 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 120
DEBUG: rating_duration = 90
DEBUG: 1 contract balance row(s) updated
DEBUG: catching up contract ID 61945 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61945 billing mapping (sipaccount) is profile id 1138 for time 1515795102.000 from ipv4 source ip 192.168.0.1
DEBUG: source_customer info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1138,
                         'product_id' => 4,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => 61945,
                         'prepaid' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount'
                       },
          'balances' => [
                          {
                            'id' => 77453,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: billing profile is prepaid
DEBUG: prepaid_costs cache already populated
DEBUG: prepaid_costs call_id = *TEST*tbtl2Kbq1jiiWTEdjSHeVoiRTT, source_user_id = 19356ecb-44a8-4b90-ae5f-c223b49a4307, destination_user_id = f8ad8f9c-dfcd-4c49-93fa-9f86bd51a88f found in cache
DEBUG: calculating call cost for profile_id 1138 with type call, direction out, src_user_domain 8881151515794822@testa.com.1515794822, dst_user_domain 8882161515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '4',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '.',
          'off_follow_interval' => 30,
          'fee_id' => 1621,
          'use_free_time' => 0,
          'on_init_rate' => '4',
          'zone_id' => 507,
          'off_init_interval' => 60,
          'pattern' => '^8882.+',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 4 per sec to costs
DEBUG: interval is 60, so rate for this interval is 240
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77453,
          'cash_balance' => '0',
          'cash_balance_interval' => '0',
          'start' => '2018-01-01 00:00:00',
          'start_unix' => 1514761200,
          'free_time_balance_old' => 0,
          'cash_balance_old' => '0',
          'end_unix' => 1517439599,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 240 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 240
DEBUG: rating_duration = 90
DEBUG: got call cost 270 and free time 0
DEBUG: prepaid_costs call_id = *TEST*tbtl2Kbq1jiiWTEdjSHeVoiRTT, source_user_id = 19356ecb-44a8-4b90-ae5f-c223b49a4307, destination_user_id = f8ad8f9c-dfcd-4c49-93fa-9f86bd51a88f deleted
DEBUG: dropped prepaid_costs call_id = *TEST*tbtl2Kbq1jiiWTEdjSHeVoiRTT, source_user_id = 19356ecb-44a8-4b90-ae5f-c223b49a4307, destination_user_id = f8ad8f9c-dfcd-4c49-93fa-9f86bd51a88f from cache
DEBUG: cost for this call is 270
DEBUG: cdr ID 50872 updated
DEBUG: empty 'source_carrier_cash_balance' local col data for cdr id 50872, skipping
DEBUG: empty 'source_carrier_free_time_balance' local col data for cdr id 50872, skipping
DEBUG: empty 'source_carrier_profile_package_id' local col data for cdr id 50872, skipping
DEBUG: empty 'source_carrier_contract_balance_id' local col data for cdr id 50872, skipping
DEBUG: local col data created or up to date for cdr id 50872, column 'source_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50872, column 'source_reseller_free_time_balance': 0, 0
DEBUG: empty 'source_reseller_profile_package_id' local col data for cdr id 50872, skipping
DEBUG: local col data created or up to date for cdr id 50872, column 'source_reseller_contract_balance_id': 77437
DEBUG: local col data created or up to date for cdr id 50872, column 'source_customer_cash_balance': 270.0000, 0
DEBUG: local col data created or up to date for cdr id 50872, column 'source_customer_free_time_balance': 0, 0
DEBUG: empty 'source_customer_profile_package_id' local col data for cdr id 50872, skipping
DEBUG: local col data created or up to date for cdr id 50872, column 'source_customer_contract_balance_id': 77453
DEBUG: empty 'destination_carrier_cash_balance' local col data for cdr id 50872, skipping
DEBUG: empty 'destination_carrier_free_time_balance' local col data for cdr id 50872, skipping
DEBUG: empty 'destination_carrier_profile_package_id' local col data for cdr id 50872, skipping
DEBUG: empty 'destination_carrier_contract_balance_id' local col data for cdr id 50872, skipping
DEBUG: local col data created or up to date for cdr id 50872, column 'destination_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50872, column 'destination_reseller_free_time_balance': 0, 0
DEBUG: empty 'destination_reseller_profile_package_id' local col data for cdr id 50872, skipping
DEBUG: local col data created or up to date for cdr id 50872, column 'destination_reseller_contract_balance_id': 77438
DEBUG: local col data created or up to date for cdr id 50872, column 'destination_customer_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50872, column 'destination_customer_free_time_balance': 0, 0
DEBUG: empty 'destination_customer_profile_package_id' local col data for cdr id 50872, skipping
DEBUG: local col data created or up to date for cdr id 50872, column 'destination_customer_contract_balance_id': 77454
DEBUG: rating cdr ID 50872 completed successfully in 0.148 secs
INFO: Batch of 3 CDRs completed. 3 CDRs rated overall so far.
INFO: Less than 5 new CDRs, sleep 10
ok 658 - rate-o-mat executed
ok 659 - prepaid w prepaid costs, no balance: id = 50871
ok 660 - prepaid w prepaid costs, no balance: source_reseller_cost = 150.000000
ok 661 - prepaid w prepaid costs, no balance: destination_reseller_cost = 90.000000
ok 662 - prepaid w prepaid costs, no balance: source_customer_cost = 270.000000
ok 663 - prepaid w prepaid costs, no balance: destination_customer_cost = 210.000000
ok 664 - prepaid w prepaid costs, no balance: rating_status = ok
ok 665 - prepaid w prepaid costs, no balance: id = 50870
ok 666 - prepaid w prepaid costs, no balance: destination_reseller_cost = 90.000000
ok 667 - prepaid w prepaid costs, no balance: source_reseller_cost = 150.000000
ok 668 - prepaid w prepaid costs, no balance: source_customer_cost = 270.000000
ok 669 - prepaid w prepaid costs, no balance: destination_customer_cost = 210.000000
ok 670 - prepaid w prepaid costs, no balance: rating_status = ok
ok 671 - prepaid w prepaid costs, no balance: source_reseller_cost = 150.000000
ok 672 - prepaid w prepaid costs, no balance: destination_reseller_cost = 90.000000
ok 673 - prepaid w prepaid costs, no balance: id = 50872
ok 674 - prepaid w prepaid costs, no balance: rating_status = ok
ok 675 - prepaid w prepaid costs, no balance: source_customer_cost = 270.000000
ok 676 - prepaid w prepaid costs, no balance: destination_customer_cost = 210.000000
ok 677 - cdrs were all processed
ok 678 - prepaid w prepaid costs, no balance, caller 1: cdr id 50870 source_customer_contract_balance_id number of records 1 = 1
ok 679 - prepaid w prepaid costs, no balance, caller 1: fetch customer id 61943 balance intervals collection page
ok 680 - prepaid w prepaid costs, no balance, caller 1: check 'total_count' of collection
ok 681 - prepaid w prepaid costs, no balance, caller 1: check interval 77451 cash balance 0 = 0
ok 682 - prepaid w prepaid costs, no balance, caller 1: check interval 77451 cash balance interval 0 = 0
ok 683 - prepaid w prepaid costs, no balance, caller 1: check interval 77451 id = 77451
ok 684 - prepaid w prepaid costs, no balance, caller 1: check if all expected items are listed
ok 685 - prepaid w prepaid costs, no balance, caller 1: cdr id 50870 source_customer_cash_balance before 270.0000 = 270.0000
ok 686 - prepaid w prepaid costs, no balance, caller 1: cdr id 50870 source_customer_cash_balance after 0.0000 = 0.0000
ok 687 - prepaid w prepaid costs, no balance, caller 2: cdr id 50871 source_customer_contract_balance_id number of records 1 = 1
ok 688 - prepaid w prepaid costs, no balance, caller 2: fetch customer id 61944 balance intervals collection page
ok 689 - prepaid w prepaid costs, no balance, caller 2: check 'total_count' of collection
ok 690 - prepaid w prepaid costs, no balance, caller 2: check interval 77452 cash balance 0 = 0
ok 691 - prepaid w prepaid costs, no balance, caller 2: check interval 77452 cash balance interval 0 = 0
ok 692 - prepaid w prepaid costs, no balance, caller 2: check interval 77452 id = 77452
ok 693 - prepaid w prepaid costs, no balance, caller 2: check if all expected items are listed
ok 694 - prepaid w prepaid costs, no balance, caller 2: cdr id 50871 source_customer_cash_balance before 270.0000 = 270.0000
ok 695 - prepaid w prepaid costs, no balance, caller 2: cdr id 50871 source_customer_cash_balance after 0.0000 = 0.0000
ok 696 - prepaid w prepaid costs, no balance, caller 3: cdr id 50872 source_customer_contract_balance_id number of records 1 = 1
ok 697 - prepaid w prepaid costs, no balance, caller 3: fetch customer id 61945 balance intervals collection page
ok 698 - prepaid w prepaid costs, no balance, caller 3: check 'total_count' of collection
ok 699 - prepaid w prepaid costs, no balance, caller 3: check interval 77453 cash balance 0 = 0
ok 700 - prepaid w prepaid costs, no balance, caller 3: check interval 77453 cash balance interval 0 = 0
ok 701 - prepaid w prepaid costs, no balance, caller 3: check interval 77453 id = 77453
ok 702 - prepaid w prepaid costs, no balance, caller 3: check if all expected items are listed
ok 703 - prepaid w prepaid costs, no balance, caller 3: cdr id 50872 source_customer_cash_balance before 270.0000 = 270.0000
ok 704 - prepaid w prepaid costs, no balance, caller 3: cdr id 50872 source_customer_cash_balance after 0.0000 = 0.0000
ok 705 - prepaid w prepaid costs, no balance, callee: cdr id 50870 destination_customer_contract_balance_id number of records 1 = 1
ok 706 - prepaid w prepaid costs, no balance, callee: fetch customer id 61946 balance intervals collection page
ok 707 - prepaid w prepaid costs, no balance, callee: check 'total_count' of collection
ok 708 - prepaid w prepaid costs, no balance, callee: check interval 77454 cash balance 0 = 0
ok 709 - prepaid w prepaid costs, no balance, callee: check interval 77454 cash balance interval 6.3 = 6.3
ok 710 - prepaid w prepaid costs, no balance, callee: check interval 77454 id = 77454
ok 711 - prepaid w prepaid costs, no balance, callee: check if all expected items are listed
ok 712 - prepaid w prepaid costs, no balance, callee: cdr id 50870 destination_customer_contract_balance_id 77454 = 77454
ok 713 - prepaid w prepaid costs, no balance, callee: cdr id 50870 destination_customer_cash_balance before 0.0000 = 0.0000
ok 714 - prepaid w prepaid costs, no balance, callee: cdr id 50870 destination_customer_cash_balance after 0.0000 = 0.0000
ok 715 - prepaid w prepaid costs, no balance, callee: cdr id 50871 destination_customer_contract_balance_id 77454 = 77454
ok 716 - prepaid w prepaid costs, no balance, callee: cdr id 50871 destination_customer_cash_balance before 0.0000 = 0.0000
ok 717 - prepaid w prepaid costs, no balance, callee: cdr id 50871 destination_customer_cash_balance after 0.0000 = 0.0000
ok 718 - prepaid w prepaid costs, no balance, callee: cdr id 50872 destination_customer_contract_balance_id 77454 = 77454
ok 719 - prepaid w prepaid costs, no balance, callee: cdr id 50872 destination_customer_cash_balance before 0.0000 = 0.0000
ok 720 - prepaid w prepaid costs, no balance, callee: cdr id 50872 destination_customer_cash_balance after 0.0000 = 0.0000
ok 721 - prepaid w prepaid costs, no balance, callers' provider: cdr id 50870 source_reseller_contract_balance_id number of records 1 = 1
ok 722 - prepaid w prepaid costs, no balance, callers' provider: fetch customer id 61929 balance intervals collection page
ok 723 - prepaid w prepaid costs, no balance, callers' provider: check 'total_count' of collection
ok 724 - prepaid w prepaid costs, no balance, callers' provider: check interval 77437 cash balance interval 18 = 18
ok 725 - prepaid w prepaid costs, no balance, callers' provider: check interval 77437 id = 77437
ok 726 - prepaid w prepaid costs, no balance, callers' provider: check if all expected items are listed
ok 727 - prepaid w prepaid costs, no balance, callers' provider: cdr id 50870 source_carrier_contract_balance_id number of records 0 = 0
ok 728 - prepaid w prepaid costs, no balance, callers' provider: cdr id 50870 source_reseller_contract_balance_id 77437 = 77437
ok 729 - prepaid w prepaid costs, no balance, callers' provider: cdr id 50871 source_carrier_contract_balance_id number of records 0 = 0
ok 730 - prepaid w prepaid costs, no balance, callers' provider: cdr id 50871 source_reseller_contract_balance_id 77437 = 77437
ok 731 - prepaid w prepaid costs, no balance, callers' provider: cdr id 50872 source_carrier_contract_balance_id number of records 0 = 0
ok 732 - prepaid w prepaid costs, no balance, callers' provider: cdr id 50872 source_reseller_contract_balance_id 77437 = 77437
ok 733 - prepaid w prepaid costs, no balance, callee's provider: cdr id 50870 destination_reseller_contract_balance_id number of records 1 = 1
ok 734 - prepaid w prepaid costs, no balance, callee's provider: fetch customer id 61930 balance intervals collection page
ok 735 - prepaid w prepaid costs, no balance, callee's provider: check 'total_count' of collection
ok 736 - prepaid w prepaid costs, no balance, callee's provider: check interval 77438 cash balance interval 10.8 = 10.8
ok 737 - prepaid w prepaid costs, no balance, callee's provider: check interval 77438 id = 77438
ok 738 - prepaid w prepaid costs, no balance, callee's provider: check if all expected items are listed
ok 739 - prepaid w prepaid costs, no balance, callee's provider: cdr id 50870 destination_carrier_contract_balance_id number of records 0 = 0
ok 740 - prepaid w prepaid costs, no balance, callee's provider: cdr id 50870 destination_reseller_contract_balance_id 77438 = 77438
ok 741 - prepaid w prepaid costs, no balance, callee's provider: cdr id 50871 destination_carrier_contract_balance_id number of records 0 = 0
ok 742 - prepaid w prepaid costs, no balance, callee's provider: cdr id 50871 destination_reseller_contract_balance_id 77438 = 77438
ok 743 - prepaid w prepaid costs, no balance, callee's provider: cdr id 50872 destination_carrier_contract_balance_id number of records 0 = 0
ok 744 - prepaid w prepaid costs, no balance, callee's provider: cdr id 50872 destination_reseller_contract_balance_id 77438 = 77438
ok 745 - prepaid w prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50870 source_carrier_profile_package_id number of records 0 = 0
ok 746 - prepaid w prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50870 source_reseller_profile_package_id number of records 0 = 0
ok 747 - prepaid w prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50870 source_customer_profile_package_id number of records 0 = 0
ok 748 - prepaid w prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50870 destination_carrier_profile_package_id number of records 0 = 0
ok 749 - prepaid w prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50870 destination_reseller_profile_package_id number of records 0 = 0
ok 750 - prepaid w prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50870 destination_customer_profile_package_id number of records 0 = 0
ok 751 - prepaid w prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50871 source_carrier_profile_package_id number of records 0 = 0
ok 752 - prepaid w prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50871 source_reseller_profile_package_id number of records 0 = 0
ok 753 - prepaid w prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50871 source_customer_profile_package_id number of records 0 = 0
ok 754 - prepaid w prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50871 destination_carrier_profile_package_id number of records 0 = 0
ok 755 - prepaid w prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50871 destination_reseller_profile_package_id number of records 0 = 0
ok 756 - prepaid w prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50871 destination_customer_profile_package_id number of records 0 = 0
ok 757 - prepaid w prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50872 source_carrier_profile_package_id number of records 0 = 0
ok 758 - prepaid w prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50872 source_reseller_profile_package_id number of records 0 = 0
ok 759 - prepaid w prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50872 source_customer_profile_package_id number of records 0 = 0
ok 760 - prepaid w prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50872 destination_carrier_profile_package_id number of records 0 = 0
ok 761 - prepaid w prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50872 destination_reseller_profile_package_id number of records 0 = 0
ok 762 - prepaid w prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50872 destination_customer_profile_package_id number of records 0 = 0
ok 763 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50870 source_carrier_free_time_balance number of records 0 = 0
ok 764 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50870 source_reseller_free_time_balance before 0 = 0
ok 765 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50870 source_reseller_free_time_balance after 0 = 0
ok 766 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50870 source_customer_free_time_balance before 0 = 0
ok 767 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50870 source_customer_free_time_balance after 0 = 0
ok 768 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50870 destination_carrier_free_time_balance number of records 0 = 0
ok 769 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50870 destination_reseller_free_time_balance before 0 = 0
ok 770 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50870 destination_reseller_free_time_balance after 0 = 0
ok 771 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50870 destination_customer_free_time_balance before 0 = 0
ok 772 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50870 destination_customer_free_time_balance after 0 = 0
ok 773 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50871 source_carrier_free_time_balance number of records 0 = 0
ok 774 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50871 source_reseller_free_time_balance before 0 = 0
ok 775 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50871 source_reseller_free_time_balance after 0 = 0
ok 776 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50871 source_customer_free_time_balance before 0 = 0
ok 777 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50871 source_customer_free_time_balance after 0 = 0
ok 778 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50871 destination_carrier_free_time_balance number of records 0 = 0
ok 779 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50871 destination_reseller_free_time_balance before 0 = 0
ok 780 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50871 destination_reseller_free_time_balance after 0 = 0
ok 781 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50871 destination_customer_free_time_balance before 0 = 0
ok 782 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50871 destination_customer_free_time_balance after 0 = 0
ok 783 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50872 source_carrier_free_time_balance number of records 0 = 0
ok 784 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50872 source_reseller_free_time_balance before 0 = 0
ok 785 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50872 source_reseller_free_time_balance after 0 = 0
ok 786 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50872 source_customer_free_time_balance before 0 = 0
ok 787 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50872 source_customer_free_time_balance after 0 = 0
ok 788 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50872 destination_carrier_free_time_balance number of records 0 = 0
ok 789 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50872 destination_reseller_free_time_balance before 0 = 0
ok 790 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50872 destination_reseller_free_time_balance after 0 = 0
ok 791 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50872 destination_customer_free_time_balance before 0 = 0
ok 792 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50872 destination_customer_free_time_balance after 0 = 0
ok 793 - prepaid w prepaid costs, no balance providers must have zero balance: cdr id 50870 source_carrier_cash_balance number of records 0 = 0
ok 794 - prepaid w prepaid costs, no balance providers must have zero balance: cdr id 50870 source_reseller_cash_balance before 0.0000 = 0.0000
ok 795 - prepaid w prepaid costs, no balance providers must have zero balance: cdr id 50870 source_reseller_cash_balance after 0.0000 = 0.0000
ok 796 - prepaid w prepaid costs, no balance providers must have zero balance: cdr id 50870 destination_carrier_cash_balance number of records 0 = 0
ok 797 - prepaid w prepaid costs, no balance providers must have zero balance: cdr id 50870 destination_reseller_cash_balance before 0.0000 = 0.0000
ok 798 - prepaid w prepaid costs, no balance providers must have zero balance: cdr id 50870 destination_reseller_cash_balance after 0.0000 = 0.0000
ok 799 - prepaid w prepaid costs, no balance providers must have zero balance: cdr id 50871 source_carrier_cash_balance number of records 0 = 0
ok 800 - prepaid w prepaid costs, no balance providers must have zero balance: cdr id 50871 source_reseller_cash_balance before 0.0000 = 0.0000
ok 801 - prepaid w prepaid costs, no balance providers must have zero balance: cdr id 50871 source_reseller_cash_balance after 0.0000 = 0.0000
ok 802 - prepaid w prepaid costs, no balance providers must have zero balance: cdr id 50871 destination_carrier_cash_balance number of records 0 = 0
ok 803 - prepaid w prepaid costs, no balance providers must have zero balance: cdr id 50871 destination_reseller_cash_balance before 0.0000 = 0.0000
ok 804 - prepaid w prepaid costs, no balance providers must have zero balance: cdr id 50871 destination_reseller_cash_balance after 0.0000 = 0.0000
ok 805 - prepaid w prepaid costs, no balance providers must have zero balance: cdr id 50872 source_carrier_cash_balance number of records 0 = 0
ok 806 - prepaid w prepaid costs, no balance providers must have zero balance: cdr id 50872 source_reseller_cash_balance before 0.0000 = 0.0000
ok 807 - prepaid w prepaid costs, no balance providers must have zero balance: cdr id 50872 source_reseller_cash_balance after 0.0000 = 0.0000
ok 808 - prepaid w prepaid costs, no balance providers must have zero balance: cdr id 50872 destination_carrier_cash_balance number of records 0 = 0
ok 809 - prepaid w prepaid costs, no balance providers must have zero balance: cdr id 50872 destination_reseller_cash_balance before 0.0000 = 0.0000
ok 810 - prepaid w prepaid costs, no balance providers must have zero balance: cdr id 50872 destination_reseller_cash_balance after 0.0000 = 0.0000
ok 811 - create customercontacts 17
ok 812 - create customers 17
ok 813 - setting customer id 61947 cash_balance to 1000 cents
ok 814 - create subscribers 17
ok 815 - very first balance interval: fetch customer id 61947 balance intervals collection page
ok 816 - very first balance interval: check interval 77455 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 817 - very first balance interval: check interval 77455 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 818 - very first balance interval: check interval 77455 cash balance 10 = 10
ok 819 - very first balance interval: check interval 77455 billing profile id 1138 = 1138
ok 820 - very first balance interval: check if all expected items are listed
ok 821 - create customercontacts 18
ok 822 - create customers 18
ok 823 - setting customer id 61948 cash_balance to 1000 cents
ok 824 - create subscribers 18
ok 825 - very first balance interval: fetch customer id 61948 balance intervals collection page
ok 826 - very first balance interval: check interval 77456 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 827 - very first balance interval: check interval 77456 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 828 - very first balance interval: check interval 77456 cash balance 10 = 10
ok 829 - very first balance interval: check interval 77456 billing profile id 1138 = 1138
ok 830 - very first balance interval: check if all expected items are listed
ok 831 - create customercontacts 19
ok 832 - create customers 19
ok 833 - setting customer id 61949 cash_balance to 1000 cents
ok 834 - create subscribers 19
ok 835 - very first balance interval: fetch customer id 61949 balance intervals collection page
ok 836 - very first balance interval: check interval 77457 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 837 - very first balance interval: check interval 77457 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 838 - very first balance interval: check interval 77457 cash balance 10 = 10
ok 839 - very first balance interval: check interval 77457 billing profile id 1138 = 1138
ok 840 - very first balance interval: check if all expected items are listed
ok 841 - create customercontacts 20
ok 842 - create customers 20
ok 843 - setting customer id 61950 cash_balance to 1000 cents
ok 844 - create subscribers 20
ok 845 - very first balance interval: fetch customer id 61950 balance intervals collection page
ok 846 - very first balance interval: check interval 77458 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 847 - very first balance interval: check interval 77458 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 848 - very first balance interval: check interval 77458 cash balance 10 = 10
ok 849 - very first balance interval: check interval 77458 billing profile id 1141 = 1141
ok 850 - very first balance interval: check if all expected items are listed
ok 851 - cdrs id 50873, 50874, 50875 created
INFO: Trying to connect to billing db...
INFO: Successfully connected to duplication db...
INFO: Trying to connect to provisioning db...
INFO: Successfully connected to provisioning db...
INFO: Trying to connect to accounting db...
INFO: Successfully connected to accounting db...
WARNING: No duplication db credentials, disabled.
INFO: local cdr relation column model loaded
INFO: local cdr cash balance column model loaded
INFO: local cdr time balance column model loaded
INFO: Up and running.
INFO: Grabbed 3 CDRs
DEBUG: start rating CDR ID 50873
DEBUG: 4 contract(s) locked: 61929, 61930, 61947, 61950
INFO: 1/3 - rate CDR ID 50873
DEBUG: fetching source provider info for source_provider_id #61929
DEBUG: catching up contract ID 61929 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61929 billing mapping (reseller) is profile id 1136 for time 1515795160.000 from ipv4 source ip 192.168.0.1
DEBUG: source_provider_info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1136,
                         'product_id' => 3,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => '61929',
                         'prepaid' => 0,
                         'class' => 'reseller',
                         'int_charge' => '0'
                       },
          'balances' => [
                          {
                            'id' => 77437,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '1800',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: fetching destination provider info for destination_provider_id #61930
DEBUG: catching up contract ID 61930 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61930 billing mapping (reseller) is profile id 1139 for time 1515795160.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_provider_info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1139,
                         'product_id' => 3,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => '61930',
                         'prepaid' => 0,
                         'class' => 'reseller',
                         'int_charge' => '0'
                       },
          'balances' => [
                          {
                            'id' => 77438,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '1080',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: ### 1. write pass ###
DEBUG: call from local subscriber, source_user_id is 658ed762-d856-4325-801a-eafe9121f024
DEBUG: call to local subscriber, destination_user_id is 80589325-8108-42d0-8474-8b5748ff25e9
DEBUG: destination provider has billing profile 1139, get reseller termination cost
DEBUG: calculating call cost for profile_id 1139 with type call, direction in, src_user_domain 8881171515794822@testa.com.1515794822, dst_user_domain 8882201515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '1',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '^888.+',
          'off_follow_interval' => 30,
          'fee_id' => 1624,
          'use_free_time' => 0,
          'on_init_rate' => '1',
          'zone_id' => 508,
          'off_init_interval' => 60,
          'pattern' => '.',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 1 per sec to costs
DEBUG: interval is 60, so rate for this interval is 60
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77438,
          'cash_balance_interval' => 1080,
          'cash_balance' => 0,
          'start_unix' => 1514761200,
          'start' => '2018-01-01 00:00:00',
          'free_time_balance_old' => 0,
          'end_unix' => 1517439599,
          'cash_balance_old' => 0,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 60 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 60
DEBUG: rating_duration = 90
DEBUG: 1 contract balance row(s) updated
DEBUG: destination reseller termination cost is 90
DEBUG: get customer termination cost for destination_user_id 80589325-8108-42d0-8474-8b5748ff25e9
DEBUG: catching up contract ID 61950 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61950 billing mapping (sipaccount) is profile id 1141 for time 1515795160.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_customer info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1141,
                         'product_id' => 4,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => 61950,
                         'prepaid' => 1,
                         'class' => 'sipaccount',
                         'int_charge' => '0'
                       },
          'balances' => [
                          {
                            'id' => 77458,
                            'cash_balance' => '1000',
                            'cash_balance_interval' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '1000',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1141 with type call, direction in, src_user_domain 8881171515794822@testa.com.1515794822, dst_user_domain 8882201515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '3',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '^8881.+',
          'off_follow_interval' => 30,
          'fee_id' => 1628,
          'use_free_time' => 0,
          'on_init_rate' => '3',
          'zone_id' => 510,
          'off_init_interval' => 60,
          'pattern' => '.',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 3 per sec to costs
DEBUG: interval is 60, so rate for this interval is 180
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77458,
          'cash_balance' => '1000',
          'cash_balance_interval' => '0',
          'start' => '2018-01-01 00:00:00',
          'start_unix' => 1514761200,
          'free_time_balance_old' => 0,
          'cash_balance_old' => '1000',
          'end_unix' => 1517439599,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: we still have cash balance 1000 left, subtract rate 180 from that
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: we still have cash balance 820 left, subtract rate 30 from that
DEBUG: rating_duration = 90
DEBUG: got call cost 0 and free time 0
DEBUG: treat pre-paid billing profile as post-paid for termination fees
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 210
DEBUG: destination customer termination cost is 210
DEBUG: calculating call cost for profile_id 1136 with type call, direction out, src_user_domain 8881171515794822@testa.com.1515794822, dst_user_domain 8882201515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '2',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '.',
          'off_follow_interval' => 30,
          'fee_id' => 1617,
          'use_free_time' => 0,
          'on_init_rate' => '2',
          'zone_id' => 505,
          'off_init_interval' => 60,
          'pattern' => '^888.+',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 2 per sec to costs
DEBUG: interval is 60, so rate for this interval is 120
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77437,
          'cash_balance_interval' => 1800,
          'cash_balance' => 0,
          'start_unix' => 1514761200,
          'start' => '2018-01-01 00:00:00',
          'free_time_balance_old' => 0,
          'end_unix' => 1517439599,
          'cash_balance_old' => 0,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 120 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 120
DEBUG: rating_duration = 90
DEBUG: 1 contract balance row(s) updated
DEBUG: catching up contract ID 61947 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61947 billing mapping (sipaccount) is profile id 1138 for time 1515795160.000 from ipv4 source ip 192.168.0.1
DEBUG: source_customer info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1138,
                         'product_id' => 4,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => 61947,
                         'prepaid' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount'
                       },
          'balances' => [
                          {
                            'id' => 77455,
                            'cash_balance' => '1000',
                            'cash_balance_interval' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '1000',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: billing profile is prepaid
DEBUG: empty prepaid_costs cache, populate it
DEBUG: prepaid_costs cache populated, 0 records
DEBUG: calculating call cost for profile_id 1138 with type call, direction out, src_user_domain 8881171515794822@testa.com.1515794822, dst_user_domain 8882201515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '4',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '.',
          'off_follow_interval' => 30,
          'fee_id' => 1621,
          'use_free_time' => 0,
          'on_init_rate' => '4',
          'zone_id' => 507,
          'off_init_interval' => 60,
          'pattern' => '^8882.+',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 4 per sec to costs
DEBUG: interval is 60, so rate for this interval is 240
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77455,
          'cash_balance' => '1000',
          'cash_balance_interval' => '0',
          'start' => '2018-01-01 00:00:00',
          'start_unix' => 1514761200,
          'free_time_balance_old' => 0,
          'cash_balance_old' => '1000',
          'end_unix' => 1517439599,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: we still have cash balance 1000 left, subtract rate 240 from that
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: we still have cash balance 760 left, subtract rate 30 from that
DEBUG: rating_duration = 90
DEBUG: got call cost 0 and free time 0
WARNING: no prepaid cost record found for call ID *TEST*R-nkGFAm7MCOl6XtHLCClz045z, applying calculated costs
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 270
DEBUG: cdr ID 50873 updated
DEBUG: empty 'source_carrier_cash_balance' local col data for cdr id 50873, skipping
DEBUG: empty 'source_carrier_free_time_balance' local col data for cdr id 50873, skipping
DEBUG: empty 'source_carrier_profile_package_id' local col data for cdr id 50873, skipping
DEBUG: empty 'source_carrier_contract_balance_id' local col data for cdr id 50873, skipping
DEBUG: local col data created or up to date for cdr id 50873, column 'source_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50873, column 'source_reseller_free_time_balance': 0, 0
DEBUG: empty 'source_reseller_profile_package_id' local col data for cdr id 50873, skipping
DEBUG: local col data created or up to date for cdr id 50873, column 'source_reseller_contract_balance_id': 77437
DEBUG: local col data created or up to date for cdr id 50873, column 'source_customer_cash_balance': 1000, 730
DEBUG: local col data created or up to date for cdr id 50873, column 'source_customer_free_time_balance': 0, 0
DEBUG: empty 'source_customer_profile_package_id' local col data for cdr id 50873, skipping
DEBUG: local col data created or up to date for cdr id 50873, column 'source_customer_contract_balance_id': 77455
DEBUG: empty 'destination_carrier_cash_balance' local col data for cdr id 50873, skipping
DEBUG: empty 'destination_carrier_free_time_balance' local col data for cdr id 50873, skipping
DEBUG: empty 'destination_carrier_profile_package_id' local col data for cdr id 50873, skipping
DEBUG: empty 'destination_carrier_contract_balance_id' local col data for cdr id 50873, skipping
DEBUG: local col data created or up to date for cdr id 50873, column 'destination_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50873, column 'destination_reseller_free_time_balance': 0, 0
DEBUG: empty 'destination_reseller_profile_package_id' local col data for cdr id 50873, skipping
DEBUG: local col data created or up to date for cdr id 50873, column 'destination_reseller_contract_balance_id': 77438
DEBUG: local col data created or up to date for cdr id 50873, column 'destination_customer_cash_balance': 1000, 790
DEBUG: local col data created or up to date for cdr id 50873, column 'destination_customer_free_time_balance': 0, 0
DEBUG: empty 'destination_customer_profile_package_id' local col data for cdr id 50873, skipping
DEBUG: local col data created or up to date for cdr id 50873, column 'destination_customer_contract_balance_id': 77458
DEBUG: rating cdr ID 50873 completed successfully in 0.256 secs
DEBUG: start rating CDR ID 50874
DEBUG: 4 contract(s) locked: 61929, 61930, 61948, 61950
INFO: 2/3 - rate CDR ID 50874
DEBUG: fetching source provider info for source_provider_id #61929
DEBUG: catching up contract ID 61929 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61929 billing mapping (reseller) is profile id 1136 for time 1515795161.000 from ipv4 source ip 192.168.0.1
DEBUG: source_provider_info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1136,
                         'product_id' => 3,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => '61929',
                         'prepaid' => 0,
                         'int_charge' => '0',
                         'class' => 'reseller'
                       },
          'balances' => [
                          {
                            'id' => 77437,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '1950',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: fetching destination provider info for destination_provider_id #61930
DEBUG: catching up contract ID 61930 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61930 billing mapping (reseller) is profile id 1139 for time 1515795161.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_provider_info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1139,
                         'product_id' => 3,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => '61930',
                         'prepaid' => 0,
                         'int_charge' => '0',
                         'class' => 'reseller'
                       },
          'balances' => [
                          {
                            'id' => 77438,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '1170',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: ### 1. write pass ###
DEBUG: call from local subscriber, source_user_id is 6933dc39-2a5e-4563-88f7-82a84188d5e4
DEBUG: call to local subscriber, destination_user_id is 80589325-8108-42d0-8474-8b5748ff25e9
DEBUG: destination provider has billing profile 1139, get reseller termination cost
DEBUG: calculating call cost for profile_id 1139 with type call, direction in, src_user_domain 8881181515794822@testa.com.1515794822, dst_user_domain 8882201515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '1',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '^888.+',
          'off_follow_interval' => 30,
          'fee_id' => 1624,
          'use_free_time' => 0,
          'on_init_rate' => '1',
          'zone_id' => 508,
          'off_init_interval' => 60,
          'pattern' => '.',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 1 per sec to costs
DEBUG: interval is 60, so rate for this interval is 60
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77438,
          'cash_balance_interval' => 1170,
          'cash_balance' => 0,
          'start_unix' => 1514761200,
          'start' => '2018-01-01 00:00:00',
          'free_time_balance_old' => 0,
          'end_unix' => 1517439599,
          'cash_balance_old' => 0,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 60 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 60
DEBUG: rating_duration = 90
DEBUG: 1 contract balance row(s) updated
DEBUG: destination reseller termination cost is 90
DEBUG: get customer termination cost for destination_user_id 80589325-8108-42d0-8474-8b5748ff25e9
DEBUG: catching up contract ID 61950 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61950 billing mapping (sipaccount) is profile id 1141 for time 1515795161.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_customer info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1141,
                         'product_id' => 4,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => 61950,
                         'prepaid' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount'
                       },
          'balances' => [
                          {
                            'id' => 77458,
                            'cash_balance' => '790',
                            'cash_balance_interval' => '210',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '790',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1141 with type call, direction in, src_user_domain 8881181515794822@testa.com.1515794822, dst_user_domain 8882201515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '3',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '^8881.+',
          'off_follow_interval' => 30,
          'fee_id' => 1628,
          'use_free_time' => 0,
          'on_init_rate' => '3',
          'zone_id' => 510,
          'off_init_interval' => 60,
          'pattern' => '.',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 3 per sec to costs
DEBUG: interval is 60, so rate for this interval is 180
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77458,
          'cash_balance' => '790',
          'cash_balance_interval' => '210',
          'start' => '2018-01-01 00:00:00',
          'start_unix' => 1514761200,
          'free_time_balance_old' => 0,
          'cash_balance_old' => '790',
          'end_unix' => 1517439599,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: we still have cash balance 790 left, subtract rate 180 from that
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: we still have cash balance 610 left, subtract rate 30 from that
DEBUG: rating_duration = 90
DEBUG: got call cost 0 and free time 0
DEBUG: treat pre-paid billing profile as post-paid for termination fees
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 210
DEBUG: destination customer termination cost is 210
DEBUG: calculating call cost for profile_id 1136 with type call, direction out, src_user_domain 8881181515794822@testa.com.1515794822, dst_user_domain 8882201515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '2',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '.',
          'off_follow_interval' => 30,
          'fee_id' => 1617,
          'use_free_time' => 0,
          'on_init_rate' => '2',
          'zone_id' => 505,
          'off_init_interval' => 60,
          'pattern' => '^888.+',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 2 per sec to costs
DEBUG: interval is 60, so rate for this interval is 120
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77437,
          'cash_balance_interval' => 1950,
          'cash_balance' => 0,
          'start_unix' => 1514761200,
          'start' => '2018-01-01 00:00:00',
          'free_time_balance_old' => 0,
          'end_unix' => 1517439599,
          'cash_balance_old' => 0,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 120 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 120
DEBUG: rating_duration = 90
DEBUG: 1 contract balance row(s) updated
DEBUG: catching up contract ID 61948 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61948 billing mapping (sipaccount) is profile id 1138 for time 1515795161.000 from ipv4 source ip 192.168.0.1
DEBUG: source_customer info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1138,
                         'product_id' => 4,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => 61948,
                         'prepaid' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount'
                       },
          'balances' => [
                          {
                            'id' => 77456,
                            'cash_balance' => '1000',
                            'cash_balance_interval' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '1000',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: billing profile is prepaid
DEBUG: prepaid_costs cache already populated
DEBUG: calculating call cost for profile_id 1138 with type call, direction out, src_user_domain 8881181515794822@testa.com.1515794822, dst_user_domain 8882201515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '4',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '.',
          'off_follow_interval' => 30,
          'fee_id' => 1621,
          'use_free_time' => 0,
          'on_init_rate' => '4',
          'zone_id' => 507,
          'off_init_interval' => 60,
          'pattern' => '^8882.+',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 4 per sec to costs
DEBUG: interval is 60, so rate for this interval is 240
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77456,
          'cash_balance' => '1000',
          'cash_balance_interval' => '0',
          'start' => '2018-01-01 00:00:00',
          'start_unix' => 1514761200,
          'free_time_balance_old' => 0,
          'cash_balance_old' => '1000',
          'end_unix' => 1517439599,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: we still have cash balance 1000 left, subtract rate 240 from that
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: we still have cash balance 760 left, subtract rate 30 from that
DEBUG: rating_duration = 90
DEBUG: got call cost 0 and free time 0
WARNING: no prepaid cost record found for call ID *TEST*tLxWb7Wn3r5V0DRiv971jpKTWq, applying calculated costs
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 270
DEBUG: cdr ID 50874 updated
DEBUG: empty 'source_carrier_cash_balance' local col data for cdr id 50874, skipping
DEBUG: empty 'source_carrier_free_time_balance' local col data for cdr id 50874, skipping
DEBUG: empty 'source_carrier_profile_package_id' local col data for cdr id 50874, skipping
DEBUG: empty 'source_carrier_contract_balance_id' local col data for cdr id 50874, skipping
DEBUG: local col data created or up to date for cdr id 50874, column 'source_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50874, column 'source_reseller_free_time_balance': 0, 0
DEBUG: empty 'source_reseller_profile_package_id' local col data for cdr id 50874, skipping
DEBUG: local col data created or up to date for cdr id 50874, column 'source_reseller_contract_balance_id': 77437
DEBUG: local col data created or up to date for cdr id 50874, column 'source_customer_cash_balance': 1000, 730
DEBUG: local col data created or up to date for cdr id 50874, column 'source_customer_free_time_balance': 0, 0
DEBUG: empty 'source_customer_profile_package_id' local col data for cdr id 50874, skipping
DEBUG: local col data created or up to date for cdr id 50874, column 'source_customer_contract_balance_id': 77456
DEBUG: empty 'destination_carrier_cash_balance' local col data for cdr id 50874, skipping
DEBUG: empty 'destination_carrier_free_time_balance' local col data for cdr id 50874, skipping
DEBUG: empty 'destination_carrier_profile_package_id' local col data for cdr id 50874, skipping
DEBUG: empty 'destination_carrier_contract_balance_id' local col data for cdr id 50874, skipping
DEBUG: local col data created or up to date for cdr id 50874, column 'destination_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50874, column 'destination_reseller_free_time_balance': 0, 0
DEBUG: empty 'destination_reseller_profile_package_id' local col data for cdr id 50874, skipping
DEBUG: local col data created or up to date for cdr id 50874, column 'destination_reseller_contract_balance_id': 77438
DEBUG: local col data created or up to date for cdr id 50874, column 'destination_customer_cash_balance': 790, 580
DEBUG: local col data created or up to date for cdr id 50874, column 'destination_customer_free_time_balance': 0, 0
DEBUG: empty 'destination_customer_profile_package_id' local col data for cdr id 50874, skipping
DEBUG: local col data created or up to date for cdr id 50874, column 'destination_customer_contract_balance_id': 77458
DEBUG: rating cdr ID 50874 completed successfully in 0.181 secs
DEBUG: start rating CDR ID 50875
DEBUG: 4 contract(s) locked: 61929, 61930, 61949, 61950
INFO: 3/3 - rate CDR ID 50875
DEBUG: fetching source provider info for source_provider_id #61929
DEBUG: catching up contract ID 61929 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61929 billing mapping (reseller) is profile id 1136 for time 1515795162.000 from ipv4 source ip 192.168.0.1
DEBUG: source_provider_info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1136,
                         'product_id' => 3,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => '61929',
                         'prepaid' => 0,
                         'int_charge' => '0',
                         'class' => 'reseller'
                       },
          'balances' => [
                          {
                            'id' => 77437,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '2100',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: fetching destination provider info for destination_provider_id #61930
DEBUG: catching up contract ID 61930 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61930 billing mapping (reseller) is profile id 1139 for time 1515795162.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_provider_info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1139,
                         'product_id' => 3,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => '61930',
                         'prepaid' => 0,
                         'int_charge' => '0',
                         'class' => 'reseller'
                       },
          'balances' => [
                          {
                            'id' => 77438,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '1260',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: ### 1. write pass ###
DEBUG: call from local subscriber, source_user_id is e2de0abf-5dee-48fe-a540-35af7747b531
DEBUG: call to local subscriber, destination_user_id is 80589325-8108-42d0-8474-8b5748ff25e9
DEBUG: destination provider has billing profile 1139, get reseller termination cost
DEBUG: calculating call cost for profile_id 1139 with type call, direction in, src_user_domain 8881191515794822@testa.com.1515794822, dst_user_domain 8882201515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '1',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '^888.+',
          'off_follow_interval' => 30,
          'fee_id' => 1624,
          'use_free_time' => 0,
          'on_init_rate' => '1',
          'zone_id' => 508,
          'off_init_interval' => 60,
          'pattern' => '.',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 1 per sec to costs
DEBUG: interval is 60, so rate for this interval is 60
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77438,
          'cash_balance_interval' => 1260,
          'cash_balance' => 0,
          'start_unix' => 1514761200,
          'start' => '2018-01-01 00:00:00',
          'free_time_balance_old' => 0,
          'end_unix' => 1517439599,
          'cash_balance_old' => 0,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 60 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 60
DEBUG: rating_duration = 90
DEBUG: 1 contract balance row(s) updated
DEBUG: destination reseller termination cost is 90
DEBUG: get customer termination cost for destination_user_id 80589325-8108-42d0-8474-8b5748ff25e9
DEBUG: catching up contract ID 61950 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61950 billing mapping (sipaccount) is profile id 1141 for time 1515795162.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_customer info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1141,
                         'product_id' => 4,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => 61950,
                         'prepaid' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount'
                       },
          'balances' => [
                          {
                            'id' => 77458,
                            'cash_balance' => '580',
                            'cash_balance_interval' => '420',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '580',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1141 with type call, direction in, src_user_domain 8881191515794822@testa.com.1515794822, dst_user_domain 8882201515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '3',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '^8881.+',
          'off_follow_interval' => 30,
          'fee_id' => 1628,
          'use_free_time' => 0,
          'on_init_rate' => '3',
          'zone_id' => 510,
          'off_init_interval' => 60,
          'pattern' => '.',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 3 per sec to costs
DEBUG: interval is 60, so rate for this interval is 180
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77458,
          'cash_balance' => '580',
          'cash_balance_interval' => '420',
          'start' => '2018-01-01 00:00:00',
          'start_unix' => 1514761200,
          'free_time_balance_old' => 0,
          'cash_balance_old' => '580',
          'end_unix' => 1517439599,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: we still have cash balance 580 left, subtract rate 180 from that
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: we still have cash balance 400 left, subtract rate 30 from that
DEBUG: rating_duration = 90
DEBUG: got call cost 0 and free time 0
DEBUG: treat pre-paid billing profile as post-paid for termination fees
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 210
DEBUG: destination customer termination cost is 210
DEBUG: calculating call cost for profile_id 1136 with type call, direction out, src_user_domain 8881191515794822@testa.com.1515794822, dst_user_domain 8882201515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '2',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '.',
          'off_follow_interval' => 30,
          'fee_id' => 1617,
          'use_free_time' => 0,
          'on_init_rate' => '2',
          'zone_id' => 505,
          'off_init_interval' => 60,
          'pattern' => '^888.+',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 2 per sec to costs
DEBUG: interval is 60, so rate for this interval is 120
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77437,
          'cash_balance_interval' => 2100,
          'cash_balance' => 0,
          'start_unix' => 1514761200,
          'start' => '2018-01-01 00:00:00',
          'free_time_balance_old' => 0,
          'end_unix' => 1517439599,
          'cash_balance_old' => 0,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 120 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 120
DEBUG: rating_duration = 90
DEBUG: 1 contract balance row(s) updated
DEBUG: catching up contract ID 61949 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61949 billing mapping (sipaccount) is profile id 1138 for time 1515795162.000 from ipv4 source ip 192.168.0.1
DEBUG: source_customer info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1138,
                         'product_id' => 4,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => 61949,
                         'prepaid' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount'
                       },
          'balances' => [
                          {
                            'id' => 77457,
                            'cash_balance' => '1000',
                            'cash_balance_interval' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '1000',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: billing profile is prepaid
DEBUG: prepaid_costs cache already populated
DEBUG: calculating call cost for profile_id 1138 with type call, direction out, src_user_domain 8881191515794822@testa.com.1515794822, dst_user_domain 8882201515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '4',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '.',
          'off_follow_interval' => 30,
          'fee_id' => 1621,
          'use_free_time' => 0,
          'on_init_rate' => '4',
          'zone_id' => 507,
          'off_init_interval' => 60,
          'pattern' => '^8882.+',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 4 per sec to costs
DEBUG: interval is 60, so rate for this interval is 240
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77457,
          'cash_balance' => '1000',
          'cash_balance_interval' => '0',
          'start' => '2018-01-01 00:00:00',
          'start_unix' => 1514761200,
          'free_time_balance_old' => 0,
          'cash_balance_old' => '1000',
          'end_unix' => 1517439599,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: we still have cash balance 1000 left, subtract rate 240 from that
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: we still have cash balance 760 left, subtract rate 30 from that
DEBUG: rating_duration = 90
DEBUG: got call cost 0 and free time 0
WARNING: no prepaid cost record found for call ID *TEST*qCrzJ8hXhXCAncRyGn76cnAZE6, applying calculated costs
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 270
DEBUG: cdr ID 50875 updated
DEBUG: empty 'source_carrier_cash_balance' local col data for cdr id 50875, skipping
DEBUG: empty 'source_carrier_free_time_balance' local col data for cdr id 50875, skipping
DEBUG: empty 'source_carrier_profile_package_id' local col data for cdr id 50875, skipping
DEBUG: empty 'source_carrier_contract_balance_id' local col data for cdr id 50875, skipping
DEBUG: local col data created or up to date for cdr id 50875, column 'source_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50875, column 'source_reseller_free_time_balance': 0, 0
DEBUG: empty 'source_reseller_profile_package_id' local col data for cdr id 50875, skipping
DEBUG: local col data created or up to date for cdr id 50875, column 'source_reseller_contract_balance_id': 77437
DEBUG: local col data created or up to date for cdr id 50875, column 'source_customer_cash_balance': 1000, 730
DEBUG: local col data created or up to date for cdr id 50875, column 'source_customer_free_time_balance': 0, 0
DEBUG: empty 'source_customer_profile_package_id' local col data for cdr id 50875, skipping
DEBUG: local col data created or up to date for cdr id 50875, column 'source_customer_contract_balance_id': 77457
DEBUG: empty 'destination_carrier_cash_balance' local col data for cdr id 50875, skipping
DEBUG: empty 'destination_carrier_free_time_balance' local col data for cdr id 50875, skipping
DEBUG: empty 'destination_carrier_profile_package_id' local col data for cdr id 50875, skipping
DEBUG: empty 'destination_carrier_contract_balance_id' local col data for cdr id 50875, skipping
DEBUG: local col data created or up to date for cdr id 50875, column 'destination_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50875, column 'destination_reseller_free_time_balance': 0, 0
DEBUG: empty 'destination_reseller_profile_package_id' local col data for cdr id 50875, skipping
DEBUG: local col data created or up to date for cdr id 50875, column 'destination_reseller_contract_balance_id': 77438
DEBUG: local col data created or up to date for cdr id 50875, column 'destination_customer_cash_balance': 580, 370
DEBUG: local col data created or up to date for cdr id 50875, column 'destination_customer_free_time_balance': 0, 0
DEBUG: empty 'destination_customer_profile_package_id' local col data for cdr id 50875, skipping
DEBUG: local col data created or up to date for cdr id 50875, column 'destination_customer_contract_balance_id': 77458
DEBUG: rating cdr ID 50875 completed successfully in 0.166 secs
INFO: Batch of 3 CDRs completed. 3 CDRs rated overall so far.
INFO: Less than 5 new CDRs, sleep 10
ok 852 - rate-o-mat executed
ok 853 - prepaid w/o prepaid costs, balance: destination_customer_cost = 210.000000
ok 854 - prepaid w/o prepaid costs, balance: source_customer_cost = 270.000000
ok 855 - prepaid w/o prepaid costs, balance: rating_status = ok
ok 856 - prepaid w/o prepaid costs, balance: id = 50873
ok 857 - prepaid w/o prepaid costs, balance: destination_reseller_cost = 90.000000
ok 858 - prepaid w/o prepaid costs, balance: source_reseller_cost = 150.000000
ok 859 - prepaid w/o prepaid costs, balance: id = 50874
ok 860 - prepaid w/o prepaid costs, balance: source_reseller_cost = 150.000000
ok 861 - prepaid w/o prepaid costs, balance: destination_reseller_cost = 90.000000
ok 862 - prepaid w/o prepaid costs, balance: source_customer_cost = 270.000000
ok 863 - prepaid w/o prepaid costs, balance: destination_customer_cost = 210.000000
ok 864 - prepaid w/o prepaid costs, balance: rating_status = ok
ok 865 - prepaid w/o prepaid costs, balance: source_customer_cost = 270.000000
ok 866 - prepaid w/o prepaid costs, balance: destination_customer_cost = 210.000000
ok 867 - prepaid w/o prepaid costs, balance: rating_status = ok
ok 868 - prepaid w/o prepaid costs, balance: id = 50875
ok 869 - prepaid w/o prepaid costs, balance: source_reseller_cost = 150.000000
ok 870 - prepaid w/o prepaid costs, balance: destination_reseller_cost = 90.000000
ok 871 - cdrs were all processed
ok 872 - prepaid w/o prepaid costs, balance, caller 1: cdr id 50873 source_customer_contract_balance_id number of records 1 = 1
ok 873 - prepaid w/o prepaid costs, balance, caller 1: fetch customer id 61947 balance intervals collection page
ok 874 - prepaid w/o prepaid costs, balance, caller 1: check 'total_count' of collection
ok 875 - prepaid w/o prepaid costs, balance, caller 1: check interval 77455 cash balance 7.3 = 7.3
ok 876 - prepaid w/o prepaid costs, balance, caller 1: check interval 77455 cash balance interval 2.7 = 2.7
ok 877 - prepaid w/o prepaid costs, balance, caller 1: check interval 77455 id = 77455
ok 878 - prepaid w/o prepaid costs, balance, caller 1: check if all expected items are listed
ok 879 - prepaid w/o prepaid costs, balance, caller 1: cdr id 50873 source_customer_cash_balance before 1000.0000 = 1000.0000
ok 880 - prepaid w/o prepaid costs, balance, caller 1: cdr id 50873 source_customer_cash_balance after 730.0000 = 730.0000
ok 881 - prepaid w/o prepaid costs, balance, caller 2: cdr id 50874 source_customer_contract_balance_id number of records 1 = 1
ok 882 - prepaid w/o prepaid costs, balance, caller 2: fetch customer id 61948 balance intervals collection page
ok 883 - prepaid w/o prepaid costs, balance, caller 2: check 'total_count' of collection
ok 884 - prepaid w/o prepaid costs, balance, caller 2: check interval 77456 cash balance 7.3 = 7.3
ok 885 - prepaid w/o prepaid costs, balance, caller 2: check interval 77456 cash balance interval 2.7 = 2.7
ok 886 - prepaid w/o prepaid costs, balance, caller 2: check interval 77456 id = 77456
ok 887 - prepaid w/o prepaid costs, balance, caller 2: check if all expected items are listed
ok 888 - prepaid w/o prepaid costs, balance, caller 2: cdr id 50874 source_customer_cash_balance before 1000.0000 = 1000.0000
ok 889 - prepaid w/o prepaid costs, balance, caller 2: cdr id 50874 source_customer_cash_balance after 730.0000 = 730.0000
ok 890 - prepaid w/o prepaid costs, balance, caller 3: cdr id 50875 source_customer_contract_balance_id number of records 1 = 1
ok 891 - prepaid w/o prepaid costs, balance, caller 3: fetch customer id 61949 balance intervals collection page
ok 892 - prepaid w/o prepaid costs, balance, caller 3: check 'total_count' of collection
ok 893 - prepaid w/o prepaid costs, balance, caller 3: check interval 77457 cash balance 7.3 = 7.3
ok 894 - prepaid w/o prepaid costs, balance, caller 3: check interval 77457 cash balance interval 2.7 = 2.7
ok 895 - prepaid w/o prepaid costs, balance, caller 3: check interval 77457 id = 77457
ok 896 - prepaid w/o prepaid costs, balance, caller 3: check if all expected items are listed
ok 897 - prepaid w/o prepaid costs, balance, caller 3: cdr id 50875 source_customer_cash_balance before 1000.0000 = 1000.0000
ok 898 - prepaid w/o prepaid costs, balance, caller 3: cdr id 50875 source_customer_cash_balance after 730.0000 = 730.0000
ok 899 - prepaid w/o prepaid costs, balance, callee: cdr id 50873 destination_customer_contract_balance_id number of records 1 = 1
ok 900 - prepaid w/o prepaid costs, balance, callee: fetch customer id 61950 balance intervals collection page
ok 901 - prepaid w/o prepaid costs, balance, callee: check 'total_count' of collection
ok 902 - prepaid w/o prepaid costs, balance, callee: check interval 77458 cash balance 3.7 = 3.7
ok 903 - prepaid w/o prepaid costs, balance, callee: check interval 77458 cash balance interval 6.3 = 6.3
ok 904 - prepaid w/o prepaid costs, balance, callee: check interval 77458 id = 77458
ok 905 - prepaid w/o prepaid costs, balance, callee: check if all expected items are listed
ok 906 - prepaid w/o prepaid costs, balance, callee: cdr id 50873 destination_customer_contract_balance_id 77458 = 77458
ok 907 - prepaid w/o prepaid costs, balance, callee: cdr id 50873 destination_customer_cash_balance before 1000.0000 = 1000.0000
ok 908 - prepaid w/o prepaid costs, balance, callee: cdr id 50873 destination_customer_cash_balance after 790.0000 = 790.0000
ok 909 - prepaid w/o prepaid costs, balance, callee: cdr id 50874 destination_customer_contract_balance_id 77458 = 77458
ok 910 - prepaid w/o prepaid costs, balance, callee: cdr id 50874 destination_customer_cash_balance before 790.0000 = 790.0000
ok 911 - prepaid w/o prepaid costs, balance, callee: cdr id 50874 destination_customer_cash_balance after 580.0000 = 580.0000
ok 912 - prepaid w/o prepaid costs, balance, callee: cdr id 50875 destination_customer_contract_balance_id 77458 = 77458
ok 913 - prepaid w/o prepaid costs, balance, callee: cdr id 50875 destination_customer_cash_balance before 580.0000 = 580.0000
ok 914 - prepaid w/o prepaid costs, balance, callee: cdr id 50875 destination_customer_cash_balance after 370.0000 = 370.0000
ok 915 - prepaid w/o prepaid costs, balance, callers' provider: cdr id 50873 source_reseller_contract_balance_id number of records 1 = 1
ok 916 - prepaid w/o prepaid costs, balance, callers' provider: fetch customer id 61929 balance intervals collection page
ok 917 - prepaid w/o prepaid costs, balance, callers' provider: check 'total_count' of collection
ok 918 - prepaid w/o prepaid costs, balance, callers' provider: check interval 77437 cash balance interval 22.5 = 22.5
ok 919 - prepaid w/o prepaid costs, balance, callers' provider: check interval 77437 id = 77437
ok 920 - prepaid w/o prepaid costs, balance, callers' provider: check if all expected items are listed
ok 921 - prepaid w/o prepaid costs, balance, callers' provider: cdr id 50873 source_carrier_contract_balance_id number of records 0 = 0
ok 922 - prepaid w/o prepaid costs, balance, callers' provider: cdr id 50873 source_reseller_contract_balance_id 77437 = 77437
ok 923 - prepaid w/o prepaid costs, balance, callers' provider: cdr id 50874 source_carrier_contract_balance_id number of records 0 = 0
ok 924 - prepaid w/o prepaid costs, balance, callers' provider: cdr id 50874 source_reseller_contract_balance_id 77437 = 77437
ok 925 - prepaid w/o prepaid costs, balance, callers' provider: cdr id 50875 source_carrier_contract_balance_id number of records 0 = 0
ok 926 - prepaid w/o prepaid costs, balance, callers' provider: cdr id 50875 source_reseller_contract_balance_id 77437 = 77437
ok 927 - prepaid w/o prepaid costs, balance, callee's provider: cdr id 50873 destination_reseller_contract_balance_id number of records 1 = 1
ok 928 - prepaid w/o prepaid costs, balance, callee's provider: fetch customer id 61930 balance intervals collection page
ok 929 - prepaid w/o prepaid costs, balance, callee's provider: check 'total_count' of collection
ok 930 - prepaid w/o prepaid costs, balance, callee's provider: check interval 77438 cash balance interval 13.5 = 13.5
ok 931 - prepaid w/o prepaid costs, balance, callee's provider: check interval 77438 id = 77438
ok 932 - prepaid w/o prepaid costs, balance, callee's provider: check if all expected items are listed
ok 933 - prepaid w/o prepaid costs, balance, callee's provider: cdr id 50873 destination_carrier_contract_balance_id number of records 0 = 0
ok 934 - prepaid w/o prepaid costs, balance, callee's provider: cdr id 50873 destination_reseller_contract_balance_id 77438 = 77438
ok 935 - prepaid w/o prepaid costs, balance, callee's provider: cdr id 50874 destination_carrier_contract_balance_id number of records 0 = 0
ok 936 - prepaid w/o prepaid costs, balance, callee's provider: cdr id 50874 destination_reseller_contract_balance_id 77438 = 77438
ok 937 - prepaid w/o prepaid costs, balance, callee's provider: cdr id 50875 destination_carrier_contract_balance_id number of records 0 = 0
ok 938 - prepaid w/o prepaid costs, balance, callee's provider: cdr id 50875 destination_reseller_contract_balance_id 77438 = 77438
ok 939 - prepaid w/o prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50873 source_carrier_profile_package_id number of records 0 = 0
ok 940 - prepaid w/o prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50873 source_reseller_profile_package_id number of records 0 = 0
ok 941 - prepaid w/o prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50873 source_customer_profile_package_id number of records 0 = 0
ok 942 - prepaid w/o prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50873 destination_carrier_profile_package_id number of records 0 = 0
ok 943 - prepaid w/o prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50873 destination_reseller_profile_package_id number of records 0 = 0
ok 944 - prepaid w/o prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50873 destination_customer_profile_package_id number of records 0 = 0
ok 945 - prepaid w/o prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50874 source_carrier_profile_package_id number of records 0 = 0
ok 946 - prepaid w/o prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50874 source_reseller_profile_package_id number of records 0 = 0
ok 947 - prepaid w/o prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50874 source_customer_profile_package_id number of records 0 = 0
ok 948 - prepaid w/o prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50874 destination_carrier_profile_package_id number of records 0 = 0
ok 949 - prepaid w/o prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50874 destination_reseller_profile_package_id number of records 0 = 0
ok 950 - prepaid w/o prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50874 destination_customer_profile_package_id number of records 0 = 0
ok 951 - prepaid w/o prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50875 source_carrier_profile_package_id number of records 0 = 0
ok 952 - prepaid w/o prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50875 source_reseller_profile_package_id number of records 0 = 0
ok 953 - prepaid w/o prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50875 source_customer_profile_package_id number of records 0 = 0
ok 954 - prepaid w/o prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50875 destination_carrier_profile_package_id number of records 0 = 0
ok 955 - prepaid w/o prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50875 destination_reseller_profile_package_id number of records 0 = 0
ok 956 - prepaid w/o prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50875 destination_customer_profile_package_id number of records 0 = 0
ok 957 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50873 source_carrier_free_time_balance number of records 0 = 0
ok 958 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50873 source_reseller_free_time_balance before 0 = 0
ok 959 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50873 source_reseller_free_time_balance after 0 = 0
ok 960 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50873 source_customer_free_time_balance before 0 = 0
ok 961 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50873 source_customer_free_time_balance after 0 = 0
ok 962 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50873 destination_carrier_free_time_balance number of records 0 = 0
ok 963 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50873 destination_reseller_free_time_balance before 0 = 0
ok 964 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50873 destination_reseller_free_time_balance after 0 = 0
ok 965 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50873 destination_customer_free_time_balance before 0 = 0
ok 966 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50873 destination_customer_free_time_balance after 0 = 0
ok 967 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50874 source_carrier_free_time_balance number of records 0 = 0
ok 968 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50874 source_reseller_free_time_balance before 0 = 0
ok 969 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50874 source_reseller_free_time_balance after 0 = 0
ok 970 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50874 source_customer_free_time_balance before 0 = 0
ok 971 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50874 source_customer_free_time_balance after 0 = 0
ok 972 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50874 destination_carrier_free_time_balance number of records 0 = 0
ok 973 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50874 destination_reseller_free_time_balance before 0 = 0
ok 974 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50874 destination_reseller_free_time_balance after 0 = 0
ok 975 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50874 destination_customer_free_time_balance before 0 = 0
ok 976 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50874 destination_customer_free_time_balance after 0 = 0
ok 977 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50875 source_carrier_free_time_balance number of records 0 = 0
ok 978 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50875 source_reseller_free_time_balance before 0 = 0
ok 979 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50875 source_reseller_free_time_balance after 0 = 0
ok 980 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50875 source_customer_free_time_balance before 0 = 0
ok 981 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50875 source_customer_free_time_balance after 0 = 0
ok 982 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50875 destination_carrier_free_time_balance number of records 0 = 0
ok 983 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50875 destination_reseller_free_time_balance before 0 = 0
ok 984 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50875 destination_reseller_free_time_balance after 0 = 0
ok 985 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50875 destination_customer_free_time_balance before 0 = 0
ok 986 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50875 destination_customer_free_time_balance after 0 = 0
ok 987 - prepaid w/o prepaid costs, balance providers must have zero balance: cdr id 50873 source_carrier_cash_balance number of records 0 = 0
ok 988 - prepaid w/o prepaid costs, balance providers must have zero balance: cdr id 50873 source_reseller_cash_balance before 0.0000 = 0.0000
ok 989 - prepaid w/o prepaid costs, balance providers must have zero balance: cdr id 50873 source_reseller_cash_balance after 0.0000 = 0.0000
ok 990 - prepaid w/o prepaid costs, balance providers must have zero balance: cdr id 50873 destination_carrier_cash_balance number of records 0 = 0
ok 991 - prepaid w/o prepaid costs, balance providers must have zero balance: cdr id 50873 destination_reseller_cash_balance before 0.0000 = 0.0000
ok 992 - prepaid w/o prepaid costs, balance providers must have zero balance: cdr id 50873 destination_reseller_cash_balance after 0.0000 = 0.0000
ok 993 - prepaid w/o prepaid costs, balance providers must have zero balance: cdr id 50874 source_carrier_cash_balance number of records 0 = 0
ok 994 - prepaid w/o prepaid costs, balance providers must have zero balance: cdr id 50874 source_reseller_cash_balance before 0.0000 = 0.0000
ok 995 - prepaid w/o prepaid costs, balance providers must have zero balance: cdr id 50874 source_reseller_cash_balance after 0.0000 = 0.0000
ok 996 - prepaid w/o prepaid costs, balance providers must have zero balance: cdr id 50874 destination_carrier_cash_balance number of records 0 = 0
ok 997 - prepaid w/o prepaid costs, balance providers must have zero balance: cdr id 50874 destination_reseller_cash_balance before 0.0000 = 0.0000
ok 998 - prepaid w/o prepaid costs, balance providers must have zero balance: cdr id 50874 destination_reseller_cash_balance after 0.0000 = 0.0000
ok 999 - prepaid w/o prepaid costs, balance providers must have zero balance: cdr id 50875 source_carrier_cash_balance number of records 0 = 0
ok 1000 - prepaid w/o prepaid costs, balance providers must have zero balance: cdr id 50875 source_reseller_cash_balance before 0.0000 = 0.0000
ok 1001 - prepaid w/o prepaid costs, balance providers must have zero balance: cdr id 50875 source_reseller_cash_balance after 0.0000 = 0.0000
ok 1002 - prepaid w/o prepaid costs, balance providers must have zero balance: cdr id 50875 destination_carrier_cash_balance number of records 0 = 0
ok 1003 - prepaid w/o prepaid costs, balance providers must have zero balance: cdr id 50875 destination_reseller_cash_balance before 0.0000 = 0.0000
ok 1004 - prepaid w/o prepaid costs, balance providers must have zero balance: cdr id 50875 destination_reseller_cash_balance after 0.0000 = 0.0000
ok 1005 - create customercontacts 21
ok 1006 - create customers 21
ok 1007 - setting customer id 61951 cash_balance to 1000 cents
ok 1008 - create subscribers 21
ok 1009 - very first balance interval: fetch customer id 61951 balance intervals collection page
ok 1010 - very first balance interval: check interval 77459 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 1011 - very first balance interval: check interval 77459 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 1012 - very first balance interval: check interval 77459 cash balance 10 = 10
ok 1013 - very first balance interval: check interval 77459 billing profile id 1138 = 1138
ok 1014 - very first balance interval: check if all expected items are listed
ok 1015 - create customercontacts 22
ok 1016 - create customers 22
ok 1017 - setting customer id 61952 cash_balance to 1000 cents
ok 1018 - create subscribers 22
ok 1019 - very first balance interval: fetch customer id 61952 balance intervals collection page
ok 1020 - very first balance interval: check interval 77460 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 1021 - very first balance interval: check interval 77460 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 1022 - very first balance interval: check interval 77460 cash balance 10 = 10
ok 1023 - very first balance interval: check interval 77460 billing profile id 1138 = 1138
ok 1024 - very first balance interval: check if all expected items are listed
ok 1025 - create customercontacts 23
ok 1026 - create customers 23
ok 1027 - setting customer id 61953 cash_balance to 1000 cents
ok 1028 - create subscribers 23
ok 1029 - very first balance interval: fetch customer id 61953 balance intervals collection page
ok 1030 - very first balance interval: check interval 77461 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 1031 - very first balance interval: check interval 77461 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 1032 - very first balance interval: check interval 77461 cash balance 10 = 10
ok 1033 - very first balance interval: check interval 77461 billing profile id 1138 = 1138
ok 1034 - very first balance interval: check if all expected items are listed
ok 1035 - create customercontacts 24
ok 1036 - create customers 24
ok 1037 - setting customer id 61954 cash_balance to 1000 cents
ok 1038 - create subscribers 24
ok 1039 - very first balance interval: fetch customer id 61954 balance intervals collection page
ok 1040 - very first balance interval: check interval 77462 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 1041 - very first balance interval: check interval 77462 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 1042 - very first balance interval: check interval 77462 cash balance 10 = 10
ok 1043 - very first balance interval: check interval 77462 billing profile id 1141 = 1141
ok 1044 - very first balance interval: check if all expected items are listed
ok 1045 - cdrs id 50876, 50877, 50878 with prepaid costs records created
INFO: Trying to connect to billing db...
INFO: Successfully connected to duplication db...
INFO: Trying to connect to provisioning db...
INFO: Successfully connected to provisioning db...
INFO: Trying to connect to accounting db...
INFO: Successfully connected to accounting db...
WARNING: No duplication db credentials, disabled.
INFO: local cdr relation column model loaded
INFO: local cdr cash balance column model loaded
INFO: local cdr time balance column model loaded
INFO: Up and running.
INFO: Grabbed 3 CDRs
DEBUG: start rating CDR ID 50876
DEBUG: 4 contract(s) locked: 61929, 61930, 61951, 61954
INFO: 1/3 - rate CDR ID 50876
DEBUG: fetching source provider info for source_provider_id #61929
DEBUG: catching up contract ID 61929 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61929 billing mapping (reseller) is profile id 1136 for time 1515795217.000 from ipv4 source ip 192.168.0.1
DEBUG: source_provider_info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1136,
                         'product_id' => 3,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => '61929',
                         'prepaid' => 0,
                         'class' => 'reseller',
                         'int_charge' => '0'
                       },
          'balances' => [
                          {
                            'id' => 77437,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '2250',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: fetching destination provider info for destination_provider_id #61930
DEBUG: catching up contract ID 61930 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61930 billing mapping (reseller) is profile id 1139 for time 1515795217.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_provider_info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1139,
                         'product_id' => 3,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => '61930',
                         'prepaid' => 0,
                         'class' => 'reseller',
                         'int_charge' => '0'
                       },
          'balances' => [
                          {
                            'id' => 77438,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '1350',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: ### 1. write pass ###
DEBUG: call from local subscriber, source_user_id is 228c2391-6937-4d24-b10e-65bb650c30c4
DEBUG: call to local subscriber, destination_user_id is 7cc41576-ab3d-458d-b4c4-d20997cb3240
DEBUG: destination provider has billing profile 1139, get reseller termination cost
DEBUG: calculating call cost for profile_id 1139 with type call, direction in, src_user_domain 8881211515794822@testa.com.1515794822, dst_user_domain 8882241515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '1',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '^888.+',
          'off_follow_interval' => 30,
          'fee_id' => 1624,
          'use_free_time' => 0,
          'on_init_rate' => '1',
          'zone_id' => 508,
          'off_init_interval' => 60,
          'pattern' => '.',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 1 per sec to costs
DEBUG: interval is 60, so rate for this interval is 60
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77438,
          'cash_balance_interval' => 1350,
          'cash_balance' => 0,
          'start_unix' => 1514761200,
          'start' => '2018-01-01 00:00:00',
          'free_time_balance_old' => 0,
          'end_unix' => 1517439599,
          'cash_balance_old' => 0,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 60 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 60
DEBUG: rating_duration = 90
DEBUG: 1 contract balance row(s) updated
DEBUG: destination reseller termination cost is 90
DEBUG: get customer termination cost for destination_user_id 7cc41576-ab3d-458d-b4c4-d20997cb3240
DEBUG: catching up contract ID 61954 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61954 billing mapping (sipaccount) is profile id 1141 for time 1515795217.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_customer info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1141,
                         'product_id' => 4,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => 61954,
                         'prepaid' => 1,
                         'class' => 'sipaccount',
                         'int_charge' => '0'
                       },
          'balances' => [
                          {
                            'id' => 77462,
                            'cash_balance' => '1000',
                            'cash_balance_interval' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '1000',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1141 with type call, direction in, src_user_domain 8881211515794822@testa.com.1515794822, dst_user_domain 8882241515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '3',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '^8881.+',
          'off_follow_interval' => 30,
          'fee_id' => 1628,
          'use_free_time' => 0,
          'on_init_rate' => '3',
          'zone_id' => 510,
          'off_init_interval' => 60,
          'pattern' => '.',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 3 per sec to costs
DEBUG: interval is 60, so rate for this interval is 180
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77462,
          'cash_balance' => '1000',
          'cash_balance_interval' => '0',
          'start' => '2018-01-01 00:00:00',
          'start_unix' => 1514761200,
          'free_time_balance_old' => 0,
          'cash_balance_old' => '1000',
          'end_unix' => 1517439599,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: we still have cash balance 1000 left, subtract rate 180 from that
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: we still have cash balance 820 left, subtract rate 30 from that
DEBUG: rating_duration = 90
DEBUG: got call cost 0 and free time 0
DEBUG: treat pre-paid billing profile as post-paid for termination fees
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 210
DEBUG: destination customer termination cost is 210
DEBUG: calculating call cost for profile_id 1136 with type call, direction out, src_user_domain 8881211515794822@testa.com.1515794822, dst_user_domain 8882241515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '2',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '.',
          'off_follow_interval' => 30,
          'fee_id' => 1617,
          'use_free_time' => 0,
          'on_init_rate' => '2',
          'zone_id' => 505,
          'off_init_interval' => 60,
          'pattern' => '^888.+',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 2 per sec to costs
DEBUG: interval is 60, so rate for this interval is 120
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77437,
          'cash_balance_interval' => 2250,
          'cash_balance' => 0,
          'start_unix' => 1514761200,
          'start' => '2018-01-01 00:00:00',
          'free_time_balance_old' => 0,
          'end_unix' => 1517439599,
          'cash_balance_old' => 0,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 120 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 120
DEBUG: rating_duration = 90
DEBUG: 1 contract balance row(s) updated
DEBUG: catching up contract ID 61951 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61951 billing mapping (sipaccount) is profile id 1138 for time 1515795217.000 from ipv4 source ip 192.168.0.1
DEBUG: source_customer info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1138,
                         'product_id' => 4,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => 61951,
                         'prepaid' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount'
                       },
          'balances' => [
                          {
                            'id' => 77459,
                            'cash_balance' => '1000',
                            'cash_balance_interval' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '1000',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: billing profile is prepaid
DEBUG: empty prepaid_costs cache, populate it
DEBUG: prepaid_costs cache populated, 3 records
DEBUG: prepaid_costs call_id = *TEST*aRZeM2ICO1XVhw554NWGfyWH9H, source_user_id = 228c2391-6937-4d24-b10e-65bb650c30c4, destination_user_id = 7cc41576-ab3d-458d-b4c4-d20997cb3240 found in cache
DEBUG: calculating call cost for profile_id 1138 with type call, direction out, src_user_domain 8881211515794822@testa.com.1515794822, dst_user_domain 8882241515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '4',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '.',
          'off_follow_interval' => 30,
          'fee_id' => 1621,
          'use_free_time' => 0,
          'on_init_rate' => '4',
          'zone_id' => 507,
          'off_init_interval' => 60,
          'pattern' => '^8882.+',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 4 per sec to costs
DEBUG: interval is 60, so rate for this interval is 240
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77459,
          'cash_balance' => '1000',
          'cash_balance_interval' => '0',
          'start' => '2018-01-01 00:00:00',
          'start_unix' => 1514761200,
          'free_time_balance_old' => 0,
          'cash_balance_old' => '1000',
          'end_unix' => 1517439599,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: we still have cash balance 1000 left, subtract rate 240 from that
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: we still have cash balance 760 left, subtract rate 30 from that
DEBUG: rating_duration = 90
DEBUG: got call cost 0 and free time 0
DEBUG: prepaid_costs call_id = *TEST*aRZeM2ICO1XVhw554NWGfyWH9H, source_user_id = 228c2391-6937-4d24-b10e-65bb650c30c4, destination_user_id = 7cc41576-ab3d-458d-b4c4-d20997cb3240 deleted
DEBUG: dropped prepaid_costs call_id = *TEST*aRZeM2ICO1XVhw554NWGfyWH9H, source_user_id = 228c2391-6937-4d24-b10e-65bb650c30c4, destination_user_id = 7cc41576-ab3d-458d-b4c4-d20997cb3240 from cache
DEBUG: cost for this call is 270
DEBUG: cdr ID 50876 updated
DEBUG: empty 'source_carrier_cash_balance' local col data for cdr id 50876, skipping
DEBUG: empty 'source_carrier_free_time_balance' local col data for cdr id 50876, skipping
DEBUG: empty 'source_carrier_profile_package_id' local col data for cdr id 50876, skipping
DEBUG: empty 'source_carrier_contract_balance_id' local col data for cdr id 50876, skipping
DEBUG: local col data created or up to date for cdr id 50876, column 'source_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50876, column 'source_reseller_free_time_balance': 0, 0
DEBUG: empty 'source_reseller_profile_package_id' local col data for cdr id 50876, skipping
DEBUG: local col data created or up to date for cdr id 50876, column 'source_reseller_contract_balance_id': 77437
DEBUG: local col data created or up to date for cdr id 50876, column 'source_customer_cash_balance': 1270.0000, 1000
DEBUG: local col data created or up to date for cdr id 50876, column 'source_customer_free_time_balance': 0, 0
DEBUG: empty 'source_customer_profile_package_id' local col data for cdr id 50876, skipping
DEBUG: local col data created or up to date for cdr id 50876, column 'source_customer_contract_balance_id': 77459
DEBUG: empty 'destination_carrier_cash_balance' local col data for cdr id 50876, skipping
DEBUG: empty 'destination_carrier_free_time_balance' local col data for cdr id 50876, skipping
DEBUG: empty 'destination_carrier_profile_package_id' local col data for cdr id 50876, skipping
DEBUG: empty 'destination_carrier_contract_balance_id' local col data for cdr id 50876, skipping
DEBUG: local col data created or up to date for cdr id 50876, column 'destination_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50876, column 'destination_reseller_free_time_balance': 0, 0
DEBUG: empty 'destination_reseller_profile_package_id' local col data for cdr id 50876, skipping
DEBUG: local col data created or up to date for cdr id 50876, column 'destination_reseller_contract_balance_id': 77438
DEBUG: local col data created or up to date for cdr id 50876, column 'destination_customer_cash_balance': 1000, 790
DEBUG: local col data created or up to date for cdr id 50876, column 'destination_customer_free_time_balance': 0, 0
DEBUG: empty 'destination_customer_profile_package_id' local col data for cdr id 50876, skipping
DEBUG: local col data created or up to date for cdr id 50876, column 'destination_customer_contract_balance_id': 77462
DEBUG: rating cdr ID 50876 completed successfully in 0.196 secs
DEBUG: start rating CDR ID 50877
DEBUG: 4 contract(s) locked: 61929, 61930, 61952, 61954
INFO: 2/3 - rate CDR ID 50877
DEBUG: fetching source provider info for source_provider_id #61929
DEBUG: catching up contract ID 61929 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61929 billing mapping (reseller) is profile id 1136 for time 1515795218.000 from ipv4 source ip 192.168.0.1
DEBUG: source_provider_info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1136,
                         'product_id' => 3,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => '61929',
                         'prepaid' => 0,
                         'int_charge' => '0',
                         'class' => 'reseller'
                       },
          'balances' => [
                          {
                            'id' => 77437,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '2400',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: fetching destination provider info for destination_provider_id #61930
DEBUG: catching up contract ID 61930 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61930 billing mapping (reseller) is profile id 1139 for time 1515795218.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_provider_info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1139,
                         'product_id' => 3,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => '61930',
                         'prepaid' => 0,
                         'int_charge' => '0',
                         'class' => 'reseller'
                       },
          'balances' => [
                          {
                            'id' => 77438,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '1440',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: ### 1. write pass ###
DEBUG: call from local subscriber, source_user_id is fae6ecee-433f-430f-a979-a9c6905b317c
DEBUG: call to local subscriber, destination_user_id is 7cc41576-ab3d-458d-b4c4-d20997cb3240
DEBUG: destination provider has billing profile 1139, get reseller termination cost
DEBUG: calculating call cost for profile_id 1139 with type call, direction in, src_user_domain 8881221515794822@testa.com.1515794822, dst_user_domain 8882241515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '1',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '^888.+',
          'off_follow_interval' => 30,
          'fee_id' => 1624,
          'use_free_time' => 0,
          'on_init_rate' => '1',
          'zone_id' => 508,
          'off_init_interval' => 60,
          'pattern' => '.',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 1 per sec to costs
DEBUG: interval is 60, so rate for this interval is 60
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77438,
          'cash_balance_interval' => 1440,
          'cash_balance' => 0,
          'start_unix' => 1514761200,
          'start' => '2018-01-01 00:00:00',
          'free_time_balance_old' => 0,
          'end_unix' => 1517439599,
          'cash_balance_old' => 0,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 60 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 60
DEBUG: rating_duration = 90
DEBUG: 1 contract balance row(s) updated
DEBUG: destination reseller termination cost is 90
DEBUG: get customer termination cost for destination_user_id 7cc41576-ab3d-458d-b4c4-d20997cb3240
DEBUG: catching up contract ID 61954 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61954 billing mapping (sipaccount) is profile id 1141 for time 1515795218.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_customer info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1141,
                         'product_id' => 4,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => 61954,
                         'prepaid' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount'
                       },
          'balances' => [
                          {
                            'id' => 77462,
                            'cash_balance' => '790',
                            'cash_balance_interval' => '210',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '790',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1141 with type call, direction in, src_user_domain 8881221515794822@testa.com.1515794822, dst_user_domain 8882241515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '3',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '^8881.+',
          'off_follow_interval' => 30,
          'fee_id' => 1628,
          'use_free_time' => 0,
          'on_init_rate' => '3',
          'zone_id' => 510,
          'off_init_interval' => 60,
          'pattern' => '.',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 3 per sec to costs
DEBUG: interval is 60, so rate for this interval is 180
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77462,
          'cash_balance' => '790',
          'cash_balance_interval' => '210',
          'start' => '2018-01-01 00:00:00',
          'start_unix' => 1514761200,
          'free_time_balance_old' => 0,
          'cash_balance_old' => '790',
          'end_unix' => 1517439599,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: we still have cash balance 790 left, subtract rate 180 from that
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: we still have cash balance 610 left, subtract rate 30 from that
DEBUG: rating_duration = 90
DEBUG: got call cost 0 and free time 0
DEBUG: treat pre-paid billing profile as post-paid for termination fees
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 210
DEBUG: destination customer termination cost is 210
DEBUG: calculating call cost for profile_id 1136 with type call, direction out, src_user_domain 8881221515794822@testa.com.1515794822, dst_user_domain 8882241515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '2',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '.',
          'off_follow_interval' => 30,
          'fee_id' => 1617,
          'use_free_time' => 0,
          'on_init_rate' => '2',
          'zone_id' => 505,
          'off_init_interval' => 60,
          'pattern' => '^888.+',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 2 per sec to costs
DEBUG: interval is 60, so rate for this interval is 120
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77437,
          'cash_balance_interval' => 2400,
          'cash_balance' => 0,
          'start_unix' => 1514761200,
          'start' => '2018-01-01 00:00:00',
          'free_time_balance_old' => 0,
          'end_unix' => 1517439599,
          'cash_balance_old' => 0,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 120 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 120
DEBUG: rating_duration = 90
DEBUG: 1 contract balance row(s) updated
DEBUG: catching up contract ID 61952 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61952 billing mapping (sipaccount) is profile id 1138 for time 1515795218.000 from ipv4 source ip 192.168.0.1
DEBUG: source_customer info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1138,
                         'product_id' => 4,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => 61952,
                         'prepaid' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount'
                       },
          'balances' => [
                          {
                            'id' => 77460,
                            'cash_balance' => '1000',
                            'cash_balance_interval' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '1000',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: billing profile is prepaid
DEBUG: prepaid_costs cache already populated
DEBUG: prepaid_costs call_id = *TEST*7wXaQEK81VBbuq33HKOmyJ.CiA, source_user_id = fae6ecee-433f-430f-a979-a9c6905b317c, destination_user_id = 7cc41576-ab3d-458d-b4c4-d20997cb3240 found in cache
DEBUG: calculating call cost for profile_id 1138 with type call, direction out, src_user_domain 8881221515794822@testa.com.1515794822, dst_user_domain 8882241515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '4',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '.',
          'off_follow_interval' => 30,
          'fee_id' => 1621,
          'use_free_time' => 0,
          'on_init_rate' => '4',
          'zone_id' => 507,
          'off_init_interval' => 60,
          'pattern' => '^8882.+',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 4 per sec to costs
DEBUG: interval is 60, so rate for this interval is 240
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77460,
          'cash_balance' => '1000',
          'cash_balance_interval' => '0',
          'start' => '2018-01-01 00:00:00',
          'start_unix' => 1514761200,
          'free_time_balance_old' => 0,
          'cash_balance_old' => '1000',
          'end_unix' => 1517439599,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: we still have cash balance 1000 left, subtract rate 240 from that
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: we still have cash balance 760 left, subtract rate 30 from that
DEBUG: rating_duration = 90
DEBUG: got call cost 0 and free time 0
DEBUG: prepaid_costs call_id = *TEST*7wXaQEK81VBbuq33HKOmyJ.CiA, source_user_id = fae6ecee-433f-430f-a979-a9c6905b317c, destination_user_id = 7cc41576-ab3d-458d-b4c4-d20997cb3240 deleted
DEBUG: dropped prepaid_costs call_id = *TEST*7wXaQEK81VBbuq33HKOmyJ.CiA, source_user_id = fae6ecee-433f-430f-a979-a9c6905b317c, destination_user_id = 7cc41576-ab3d-458d-b4c4-d20997cb3240 from cache
DEBUG: cost for this call is 270
DEBUG: cdr ID 50877 updated
DEBUG: empty 'source_carrier_cash_balance' local col data for cdr id 50877, skipping
DEBUG: empty 'source_carrier_free_time_balance' local col data for cdr id 50877, skipping
DEBUG: empty 'source_carrier_profile_package_id' local col data for cdr id 50877, skipping
DEBUG: empty 'source_carrier_contract_balance_id' local col data for cdr id 50877, skipping
DEBUG: local col data created or up to date for cdr id 50877, column 'source_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50877, column 'source_reseller_free_time_balance': 0, 0
DEBUG: empty 'source_reseller_profile_package_id' local col data for cdr id 50877, skipping
DEBUG: local col data created or up to date for cdr id 50877, column 'source_reseller_contract_balance_id': 77437
DEBUG: local col data created or up to date for cdr id 50877, column 'source_customer_cash_balance': 1270.0000, 1000
DEBUG: local col data created or up to date for cdr id 50877, column 'source_customer_free_time_balance': 0, 0
DEBUG: empty 'source_customer_profile_package_id' local col data for cdr id 50877, skipping
DEBUG: local col data created or up to date for cdr id 50877, column 'source_customer_contract_balance_id': 77460
DEBUG: empty 'destination_carrier_cash_balance' local col data for cdr id 50877, skipping
DEBUG: empty 'destination_carrier_free_time_balance' local col data for cdr id 50877, skipping
DEBUG: empty 'destination_carrier_profile_package_id' local col data for cdr id 50877, skipping
DEBUG: empty 'destination_carrier_contract_balance_id' local col data for cdr id 50877, skipping
DEBUG: local col data created or up to date for cdr id 50877, column 'destination_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50877, column 'destination_reseller_free_time_balance': 0, 0
DEBUG: empty 'destination_reseller_profile_package_id' local col data for cdr id 50877, skipping
DEBUG: local col data created or up to date for cdr id 50877, column 'destination_reseller_contract_balance_id': 77438
DEBUG: local col data created or up to date for cdr id 50877, column 'destination_customer_cash_balance': 790, 580
DEBUG: local col data created or up to date for cdr id 50877, column 'destination_customer_free_time_balance': 0, 0
DEBUG: empty 'destination_customer_profile_package_id' local col data for cdr id 50877, skipping
DEBUG: local col data created or up to date for cdr id 50877, column 'destination_customer_contract_balance_id': 77462
DEBUG: rating cdr ID 50877 completed successfully in 0.139 secs
DEBUG: start rating CDR ID 50878
DEBUG: 4 contract(s) locked: 61929, 61930, 61953, 61954
INFO: 3/3 - rate CDR ID 50878
DEBUG: fetching source provider info for source_provider_id #61929
DEBUG: catching up contract ID 61929 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61929 billing mapping (reseller) is profile id 1136 for time 1515795219.000 from ipv4 source ip 192.168.0.1
DEBUG: source_provider_info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1136,
                         'product_id' => 3,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => '61929',
                         'prepaid' => 0,
                         'int_charge' => '0',
                         'class' => 'reseller'
                       },
          'balances' => [
                          {
                            'id' => 77437,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '2550',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: fetching destination provider info for destination_provider_id #61930
DEBUG: catching up contract ID 61930 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61930 billing mapping (reseller) is profile id 1139 for time 1515795219.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_provider_info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1139,
                         'product_id' => 3,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => '61930',
                         'prepaid' => 0,
                         'int_charge' => '0',
                         'class' => 'reseller'
                       },
          'balances' => [
                          {
                            'id' => 77438,
                            'cash_balance' => '0',
                            'cash_balance_interval' => '1530',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '0',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: ### 1. write pass ###
DEBUG: call from local subscriber, source_user_id is acea17f1-2ddb-405b-99a2-2611f21d460c
DEBUG: call to local subscriber, destination_user_id is 7cc41576-ab3d-458d-b4c4-d20997cb3240
DEBUG: destination provider has billing profile 1139, get reseller termination cost
DEBUG: calculating call cost for profile_id 1139 with type call, direction in, src_user_domain 8881231515794822@testa.com.1515794822, dst_user_domain 8882241515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '1',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '^888.+',
          'off_follow_interval' => 30,
          'fee_id' => 1624,
          'use_free_time' => 0,
          'on_init_rate' => '1',
          'zone_id' => 508,
          'off_init_interval' => 60,
          'pattern' => '.',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 1 per sec to costs
DEBUG: interval is 60, so rate for this interval is 60
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77438,
          'cash_balance_interval' => 1530,
          'cash_balance' => 0,
          'start_unix' => 1514761200,
          'start' => '2018-01-01 00:00:00',
          'free_time_balance_old' => 0,
          'end_unix' => 1517439599,
          'cash_balance_old' => 0,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 60 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 60
DEBUG: rating_duration = 90
DEBUG: 1 contract balance row(s) updated
DEBUG: destination reseller termination cost is 90
DEBUG: get customer termination cost for destination_user_id 7cc41576-ab3d-458d-b4c4-d20997cb3240
DEBUG: catching up contract ID 61954 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61954 billing mapping (sipaccount) is profile id 1141 for time 1515795219.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_customer info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1141,
                         'product_id' => 4,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => 61954,
                         'prepaid' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount'
                       },
          'balances' => [
                          {
                            'id' => 77462,
                            'cash_balance' => '580',
                            'cash_balance_interval' => '420',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '580',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1141 with type call, direction in, src_user_domain 8881231515794822@testa.com.1515794822, dst_user_domain 8882241515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '3',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '^8881.+',
          'off_follow_interval' => 30,
          'fee_id' => 1628,
          'use_free_time' => 0,
          'on_init_rate' => '3',
          'zone_id' => 510,
          'off_init_interval' => 60,
          'pattern' => '.',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 3 per sec to costs
DEBUG: interval is 60, so rate for this interval is 180
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77462,
          'cash_balance' => '580',
          'cash_balance_interval' => '420',
          'start' => '2018-01-01 00:00:00',
          'start_unix' => 1514761200,
          'free_time_balance_old' => 0,
          'cash_balance_old' => '580',
          'end_unix' => 1517439599,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: we still have cash balance 580 left, subtract rate 180 from that
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: we still have cash balance 400 left, subtract rate 30 from that
DEBUG: rating_duration = 90
DEBUG: got call cost 0 and free time 0
DEBUG: treat pre-paid billing profile as post-paid for termination fees
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 210
DEBUG: destination customer termination cost is 210
DEBUG: calculating call cost for profile_id 1136 with type call, direction out, src_user_domain 8881231515794822@testa.com.1515794822, dst_user_domain 8882241515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '2',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '.',
          'off_follow_interval' => 30,
          'fee_id' => 1617,
          'use_free_time' => 0,
          'on_init_rate' => '2',
          'zone_id' => 505,
          'off_init_interval' => 60,
          'pattern' => '^888.+',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 2 per sec to costs
DEBUG: interval is 60, so rate for this interval is 120
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77437,
          'cash_balance_interval' => 2550,
          'cash_balance' => 0,
          'start_unix' => 1514761200,
          'start' => '2018-01-01 00:00:00',
          'free_time_balance_old' => 0,
          'end_unix' => 1517439599,
          'cash_balance_old' => 0,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: add current interval cost 120 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 120
DEBUG: rating_duration = 90
DEBUG: 1 contract balance row(s) updated
DEBUG: catching up contract ID 61953 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61953 billing mapping (sipaccount) is profile id 1138 for time 1515795219.000 from ipv4 source ip 192.168.0.1
DEBUG: source_customer info is $VAR1 = {
          'billing' => {
                         'int_count' => 1,
                         'int_free_time' => 0,
                         'profile_id' => 1138,
                         'product_id' => 4,
                         'int_free_cash' => '0',
                         'int_unit' => 'month',
                         'contract_id' => 61953,
                         'prepaid' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount'
                       },
          'balances' => [
                          {
                            'id' => 77461,
                            'cash_balance' => '1000',
                            'cash_balance_interval' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'start_unix' => 1514761200,
                            'free_time_balance_old' => 0,
                            'cash_balance_old' => '1000',
                            'end_unix' => 1517439599,
                            'free_time_balance' => 0,
                            'free_time_balance_interval' => 0
                          }
                        ],
          'package' => {
                         'underrun_lock_applied' => 0,
                         'underrun_profile_threshold' => undef,
                         'id' => undef,
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_level' => undef,
                         'underrun_lock_threshold' => undef
                       }
        };
DEBUG: billing profile is prepaid
DEBUG: prepaid_costs cache already populated
DEBUG: prepaid_costs call_id = *TEST*EHWkM8U8x3WuShKGDZ3a30ieQ3, source_user_id = acea17f1-2ddb-405b-99a2-2611f21d460c, destination_user_id = 7cc41576-ab3d-458d-b4c4-d20997cb3240 found in cache
DEBUG: calculating call cost for profile_id 1138 with type call, direction out, src_user_domain 8881231515794822@testa.com.1515794822, dst_user_domain 8882241515794822@testb.com.1515794822
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '4',
          'on_follow_interval' => 30,
          'on_follow_rate' => '1',
          'on_init_interval' => 60,
          'source_pattern' => '.',
          'off_follow_interval' => 30,
          'fee_id' => 1621,
          'use_free_time' => 0,
          'on_init_rate' => '4',
          'zone_id' => 507,
          'off_init_interval' => 60,
          'pattern' => '^8882.+',
          'off_follow_rate' => '1'
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 4 per sec to costs
DEBUG: interval is 60, so rate for this interval is 240
DEBUG: starting with contract balance: $VAR1 = {
          'id' => 77461,
          'cash_balance' => '1000',
          'cash_balance_interval' => '0',
          'start' => '2018-01-01 00:00:00',
          'start_unix' => 1514761200,
          'free_time_balance_old' => 0,
          'cash_balance_old' => '1000',
          'end_unix' => 1517439599,
          'free_time_balance' => 0,
          'free_time_balance_interval' => 0
        };
DEBUG: we still have cash balance 1000 left, subtract rate 240 from that
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: we still have cash balance 760 left, subtract rate 30 from that
DEBUG: rating_duration = 90
DEBUG: got call cost 0 and free time 0
DEBUG: prepaid_costs call_id = *TEST*EHWkM8U8x3WuShKGDZ3a30ieQ3, source_user_id = acea17f1-2ddb-405b-99a2-2611f21d460c, destination_user_id = 7cc41576-ab3d-458d-b4c4-d20997cb3240 deleted
DEBUG: dropped prepaid_costs call_id = *TEST*EHWkM8U8x3WuShKGDZ3a30ieQ3, source_user_id = acea17f1-2ddb-405b-99a2-2611f21d460c, destination_user_id = 7cc41576-ab3d-458d-b4c4-d20997cb3240 from cache
DEBUG: cost for this call is 270
DEBUG: cdr ID 50878 updated
DEBUG: empty 'source_carrier_cash_balance' local col data for cdr id 50878, skipping
DEBUG: empty 'source_carrier_free_time_balance' local col data for cdr id 50878, skipping
DEBUG: empty 'source_carrier_profile_package_id' local col data for cdr id 50878, skipping
DEBUG: empty 'source_carrier_contract_balance_id' local col data for cdr id 50878, skipping
DEBUG: local col data created or up to date for cdr id 50878, column 'source_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50878, column 'source_reseller_free_time_balance': 0, 0
DEBUG: empty 'source_reseller_profile_package_id' local col data for cdr id 50878, skipping
DEBUG: local col data created or up to date for cdr id 50878, column 'source_reseller_contract_balance_id': 77437
DEBUG: local col data created or up to date for cdr id 50878, column 'source_customer_cash_balance': 1270.0000, 1000
DEBUG: local col data created or up to date for cdr id 50878, column 'source_customer_free_time_balance': 0, 0
DEBUG: empty 'source_customer_profile_package_id' local col data for cdr id 50878, skipping
DEBUG: local col data created or up to date for cdr id 50878, column 'source_customer_contract_balance_id': 77461
DEBUG: empty 'destination_carrier_cash_balance' local col data for cdr id 50878, skipping
DEBUG: empty 'destination_carrier_free_time_balance' local col data for cdr id 50878, skipping
DEBUG: empty 'destination_carrier_profile_package_id' local col data for cdr id 50878, skipping
DEBUG: empty 'destination_carrier_contract_balance_id' local col data for cdr id 50878, skipping
DEBUG: local col data created or up to date for cdr id 50878, column 'destination_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50878, column 'destination_reseller_free_time_balance': 0, 0
DEBUG: empty 'destination_reseller_profile_package_id' local col data for cdr id 50878, skipping
DEBUG: local col data created or up to date for cdr id 50878, column 'destination_reseller_contract_balance_id': 77438
DEBUG: local col data created or up to date for cdr id 50878, column 'destination_customer_cash_balance': 580, 370
DEBUG: local col data created or up to date for cdr id 50878, column 'destination_customer_free_time_balance': 0, 0
DEBUG: empty 'destination_customer_profile_package_id' local col data for cdr id 50878, skipping
DEBUG: local col data created or up to date for cdr id 50878, column 'destination_customer_contract_balance_id': 77462
DEBUG: rating cdr ID 50878 completed successfully in 0.156 secs
INFO: Batch of 3 CDRs completed. 3 CDRs rated overall so far.
INFO: Less than 5 new CDRs, sleep 10
ok 1046 - rate-o-mat executed
ok 1047 - prepaid w prepaid costs, balance: source_reseller_cost = 150.000000
ok 1048 - prepaid w prepaid costs, balance: destination_reseller_cost = 90.000000
ok 1049 - prepaid w prepaid costs, balance: id = 50876
ok 1050 - prepaid w prepaid costs, balance: rating_status = ok
ok 1051 - prepaid w prepaid costs, balance: source_customer_cost = 270.000000
ok 1052 - prepaid w prepaid costs, balance: destination_customer_cost = 210.000000
ok 1053 - prepaid w prepaid costs, balance: source_customer_cost = 270.000000
ok 1054 - prepaid w prepaid costs, balance: destination_customer_cost = 210.000000
ok 1055 - prepaid w prepaid costs, balance: rating_status = ok
ok 1056 - prepaid w prepaid costs, balance: id = 50877
ok 1057 - prepaid w prepaid costs, balance: destination_reseller_cost = 90.000000
ok 1058 - prepaid w prepaid costs, balance: source_reseller_cost = 150.000000
ok 1059 - prepaid w prepaid costs, balance: source_customer_cost = 270.000000
ok 1060 - prepaid w prepaid costs, balance: destination_customer_cost = 210.000000
ok 1061 - prepaid w prepaid costs, balance: rating_status = ok
ok 1062 - prepaid w prepaid costs, balance: id = 50878
ok 1063 - prepaid w prepaid costs, balance: destination_reseller_cost = 90.000000
ok 1064 - prepaid w prepaid costs, balance: source_reseller_cost = 150.000000
ok 1065 - cdrs were all processed
ok 1066 - prepaid w prepaid costs, balance, caller 1: cdr id 50876 source_customer_contract_balance_id number of records 1 = 1
ok 1067 - prepaid w prepaid costs, balance, caller 1: fetch customer id 61951 balance intervals collection page
ok 1068 - prepaid w prepaid costs, balance, caller 1: check 'total_count' of collection
ok 1069 - prepaid w prepaid costs, balance, caller 1: check interval 77459 cash balance 10 = 10
ok 1070 - prepaid w prepaid costs, balance, caller 1: check interval 77459 cash balance interval 0 = 0
ok 1071 - prepaid w prepaid costs, balance, caller 1: check interval 77459 id = 77459
ok 1072 - prepaid w prepaid costs, balance, caller 1: check if all expected items are listed
ok 1073 - prepaid w prepaid costs, balance, caller 1: cdr id 50876 source_customer_cash_balance before 1270.0000 = 1270.0000
ok 1074 - prepaid w prepaid costs, balance, caller 1: cdr id 50876 source_customer_cash_balance after 1000.0000 = 1000.0000
ok 1075 - prepaid w prepaid costs, balance, caller 2: cdr id 50877 source_customer_contract_balance_id number of records 1 = 1
ok 1076 - prepaid w prepaid costs, balance, caller 2: fetch customer id 61952 balance intervals collection page
ok 1077 - prepaid w prepaid costs, balance, caller 2: check 'total_count' of collection
ok 1078 - prepaid w prepaid costs, balance, caller 2: check interval 77460 cash balance 10 = 10
ok 1079 - prepaid w prepaid costs, balance, caller 2: check interval 77460 cash balance interval 0 = 0
ok 1080 - prepaid w prepaid costs, balance, caller 2: check interval 77460 id = 77460
ok 1081 - prepaid w prepaid costs, balance, caller 2: check if all expected items are listed
ok 1082 - prepaid w prepaid costs, balance, caller 2: cdr id 50877 source_customer_cash_balance before 1270.0000 = 1270.0000
ok 1083 - prepaid w prepaid costs, balance, caller 2: cdr id 50877 source_customer_cash_balance after 1000.0000 = 1000.0000
ok 1084 - prepaid w prepaid costs, balance, caller 3: cdr id 50878 source_customer_contract_balance_id number of records 1 = 1
ok 1085 - prepaid w prepaid costs, balance, caller 3: fetch customer id 61953 balance intervals collection page
ok 1086 - prepaid w prepaid costs, balance, caller 3: check 'total_count' of collection
ok 1087 - prepaid w prepaid costs, balance, caller 3: check interval 77461 cash balance 10 = 10
ok 1088 - prepaid w prepaid costs, balance, caller 3: check interval 77461 cash balance interval 0 = 0
ok 1089 - prepaid w prepaid costs, balance, caller 3: check interval 77461 id = 77461
ok 1090 - prepaid w prepaid costs, balance, caller 3: check if all expected items are listed
ok 1091 - prepaid w prepaid costs, balance, caller 3: cdr id 50878 source_customer_cash_balance before 1270.0000 = 1270.0000
ok 1092 - prepaid w prepaid costs, balance, caller 3: cdr id 50878 source_customer_cash_balance after 1000.0000 = 1000.0000
ok 1093 - prepaid w prepaid costs, balance, callee: cdr id 50876 destination_customer_contract_balance_id number of records 1 = 1
ok 1094 - prepaid w prepaid costs, balance, callee: fetch customer id 61954 balance intervals collection page
ok 1095 - prepaid w prepaid costs, balance, callee: check 'total_count' of collection
ok 1096 - prepaid w prepaid costs, balance, callee: check interval 77462 cash balance 3.7 = 3.7
ok 1097 - prepaid w prepaid costs, balance, callee: check interval 77462 cash balance interval 6.3 = 6.3
ok 1098 - prepaid w prepaid costs, balance, callee: check interval 77462 id = 77462
ok 1099 - prepaid w prepaid costs, balance, callee: check if all expected items are listed
ok 1100 - prepaid w prepaid costs, balance, callee: cdr id 50876 destination_customer_contract_balance_id 77462 = 77462
ok 1101 - prepaid w prepaid costs, balance, callee: cdr id 50876 destination_customer_cash_balance before 1000.0000 = 1000.0000
ok 1102 - prepaid w prepaid costs, balance, callee: cdr id 50876 destination_customer_cash_balance after 790.0000 = 790.0000
ok 1103 - prepaid w prepaid costs, balance, callee: cdr id 50877 destination_customer_contract_balance_id 77462 = 77462
ok 1104 - prepaid w prepaid costs, balance, callee: cdr id 50877 destination_customer_cash_balance before 790.0000 = 790.0000
ok 1105 - prepaid w prepaid costs, balance, callee: cdr id 50877 destination_customer_cash_balance after 580.0000 = 580.0000
ok 1106 - prepaid w prepaid costs, balance, callee: cdr id 50878 destination_customer_contract_balance_id 77462 = 77462
ok 1107 - prepaid w prepaid costs, balance, callee: cdr id 50878 destination_customer_cash_balance before 580.0000 = 580.0000
ok 1108 - prepaid w prepaid costs, balance, callee: cdr id 50878 destination_customer_cash_balance after 370.0000 = 370.0000
ok 1109 - prepaid w prepaid costs, balance, callers' provider: cdr id 50876 source_reseller_contract_balance_id number of records 1 = 1
ok 1110 - prepaid w prepaid costs, balance, callers' provider: fetch customer id 61929 balance intervals collection page
ok 1111 - prepaid w prepaid costs, balance, callers' provider: check 'total_count' of collection
ok 1112 - prepaid w prepaid costs, balance, callers' provider: check interval 77437 cash balance interval 27 = 27
ok 1113 - prepaid w prepaid costs, balance, callers' provider: check interval 77437 id = 77437
ok 1114 - prepaid w prepaid costs, balance, callers' provider: check if all expected items are listed
ok 1115 - prepaid w prepaid costs, balance, callers' provider: cdr id 50876 source_carrier_contract_balance_id number of records 0 = 0
ok 1116 - prepaid w prepaid costs, balance, callers' provider: cdr id 50876 source_reseller_contract_balance_id 77437 = 77437
ok 1117 - prepaid w prepaid costs, balance, callers' provider: cdr id 50877 source_carrier_contract_balance_id number of records 0 = 0
ok 1118 - prepaid w prepaid costs, balance, callers' provider: cdr id 50877 source_reseller_contract_balance_id 77437 = 77437
ok 1119 - prepaid w prepaid costs, balance, callers' provider: cdr id 50878 source_carrier_contract_balance_id number of records 0 = 0
ok 1120 - prepaid w prepaid costs, balance, callers' provider: cdr id 50878 source_reseller_contract_balance_id 77437 = 77437
ok 1121 - prepaid w prepaid costs, balance, callee's provider: cdr id 50876 destination_reseller_contract_balance_id number of records 1 = 1
ok 1122 - prepaid w prepaid costs, balance, callee's provider: fetch customer id 61930 balance intervals collection page
ok 1123 - prepaid w prepaid costs, balance, callee's provider: check 'total_count' of collection
ok 1124 - prepaid w prepaid costs, balance, callee's provider: check interval 77438 cash balance interval 16.2 = 16.2
ok 1125 - prepaid w prepaid costs, balance, callee's provider: check interval 77438 id = 77438
ok 1126 - prepaid w prepaid costs, balance, callee's provider: check if all expected items are listed
ok 1127 - prepaid w prepaid costs, balance, callee's provider: cdr id 50876 destination_carrier_contract_balance_id number of records 0 = 0
ok 1128 - prepaid w prepaid costs, balance, callee's provider: cdr id 50876 destination_reseller_contract_balance_id 77438 = 77438
ok 1129 - prepaid w prepaid costs, balance, callee's provider: cdr id 50877 destination_carrier_contract_balance_id number of records 0 = 0
ok 1130 - prepaid w prepaid costs, balance, callee's provider: cdr id 50877 destination_reseller_contract_balance_id 77438 = 77438
ok 1131 - prepaid w prepaid costs, balance, callee's provider: cdr id 50878 destination_carrier_contract_balance_id number of records 0 = 0
ok 1132 - prepaid w prepaid costs, balance, callee's provider: cdr id 50878 destination_reseller_contract_balance_id 77438 = 77438
ok 1133 - prepaid w prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50876 source_carrier_profile_package_id number of records 0 = 0
ok 1134 - prepaid w prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50876 source_reseller_profile_package_id number of records 0 = 0
ok 1135 - prepaid w prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50876 source_customer_profile_package_id number of records 0 = 0
ok 1136 - prepaid w prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50876 destination_carrier_profile_package_id number of records 0 = 0
ok 1137 - prepaid w prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50876 destination_reseller_profile_package_id number of records 0 = 0
ok 1138 - prepaid w prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50876 destination_customer_profile_package_id number of records 0 = 0
ok 1139 - prepaid w prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50877 source_carrier_profile_package_id number of records 0 = 0
ok 1140 - prepaid w prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50877 source_reseller_profile_package_id number of records 0 = 0
ok 1141 - prepaid w prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50877 source_customer_profile_package_id number of records 0 = 0
ok 1142 - prepaid w prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50877 destination_carrier_profile_package_id number of records 0 = 0
ok 1143 - prepaid w prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50877 destination_reseller_profile_package_id number of records 0 = 0
ok 1144 - prepaid w prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50877 destination_customer_profile_package_id number of records 0 = 0
ok 1145 - prepaid w prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50878 source_carrier_profile_package_id number of records 0 = 0
ok 1146 - prepaid w prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50878 source_reseller_profile_package_id number of records 0 = 0
ok 1147 - prepaid w prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50878 source_customer_profile_package_id number of records 0 = 0
ok 1148 - prepaid w prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50878 destination_carrier_profile_package_id number of records 0 = 0
ok 1149 - prepaid w prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50878 destination_reseller_profile_package_id number of records 0 = 0
ok 1150 - prepaid w prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50878 destination_customer_profile_package_id number of records 0 = 0
ok 1151 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50876 source_carrier_free_time_balance number of records 0 = 0
ok 1152 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50876 source_reseller_free_time_balance before 0 = 0
ok 1153 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50876 source_reseller_free_time_balance after 0 = 0
ok 1154 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50876 source_customer_free_time_balance before 0 = 0
ok 1155 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50876 source_customer_free_time_balance after 0 = 0
ok 1156 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50876 destination_carrier_free_time_balance number of records 0 = 0
ok 1157 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50876 destination_reseller_free_time_balance before 0 = 0
ok 1158 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50876 destination_reseller_free_time_balance after 0 = 0
ok 1159 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50876 destination_customer_free_time_balance before 0 = 0
ok 1160 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50876 destination_customer_free_time_balance after 0 = 0
ok 1161 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50877 source_carrier_free_time_balance number of records 0 = 0
ok 1162 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50877 source_reseller_free_time_balance before 0 = 0
ok 1163 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50877 source_reseller_free_time_balance after 0 = 0
ok 1164 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50877 source_customer_free_time_balance before 0 = 0
ok 1165 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50877 source_customer_free_time_balance after 0 = 0
ok 1166 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50877 destination_carrier_free_time_balance number of records 0 = 0
ok 1167 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50877 destination_reseller_free_time_balance before 0 = 0
ok 1168 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50877 destination_reseller_free_time_balance after 0 = 0
ok 1169 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50877 destination_customer_free_time_balance before 0 = 0
ok 1170 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50877 destination_customer_free_time_balance after 0 = 0
ok 1171 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50878 source_carrier_free_time_balance number of records 0 = 0
ok 1172 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50878 source_reseller_free_time_balance before 0 = 0
ok 1173 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50878 source_reseller_free_time_balance after 0 = 0
ok 1174 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50878 source_customer_free_time_balance before 0 = 0
ok 1175 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50878 source_customer_free_time_balance after 0 = 0
ok 1176 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50878 destination_carrier_free_time_balance number of records 0 = 0
ok 1177 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50878 destination_reseller_free_time_balance before 0 = 0
ok 1178 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50878 destination_reseller_free_time_balance after 0 = 0
ok 1179 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50878 destination_customer_free_time_balance before 0 = 0
ok 1180 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50878 destination_customer_free_time_balance after 0 = 0
ok 1181 - prepaid w prepaid costs, balance providers must have zero balance: cdr id 50876 source_carrier_cash_balance number of records 0 = 0
ok 1182 - prepaid w prepaid costs, balance providers must have zero balance: cdr id 50876 source_reseller_cash_balance before 0.0000 = 0.0000
ok 1183 - prepaid w prepaid costs, balance providers must have zero balance: cdr id 50876 source_reseller_cash_balance after 0.0000 = 0.0000
ok 1184 - prepaid w prepaid costs, balance providers must have zero balance: cdr id 50876 destination_carrier_cash_balance number of records 0 = 0
ok 1185 - prepaid w prepaid costs, balance providers must have zero balance: cdr id 50876 destination_reseller_cash_balance before 0.0000 = 0.0000
ok 1186 - prepaid w prepaid costs, balance providers must have zero balance: cdr id 50876 destination_reseller_cash_balance after 0.0000 = 0.0000
ok 1187 - prepaid w prepaid costs, balance providers must have zero balance: cdr id 50877 source_carrier_cash_balance number of records 0 = 0
ok 1188 - prepaid w prepaid costs, balance providers must have zero balance: cdr id 50877 source_reseller_cash_balance before 0.0000 = 0.0000
ok 1189 - prepaid w prepaid costs, balance providers must have zero balance: cdr id 50877 source_reseller_cash_balance after 0.0000 = 0.0000
ok 1190 - prepaid w prepaid costs, balance providers must have zero balance: cdr id 50877 destination_carrier_cash_balance number of records 0 = 0
ok 1191 - prepaid w prepaid costs, balance providers must have zero balance: cdr id 50877 destination_reseller_cash_balance before 0.0000 = 0.0000
ok 1192 - prepaid w prepaid costs, balance providers must have zero balance: cdr id 50877 destination_reseller_cash_balance after 0.0000 = 0.0000
ok 1193 - prepaid w prepaid costs, balance providers must have zero balance: cdr id 50878 source_carrier_cash_balance number of records 0 = 0
ok 1194 - prepaid w prepaid costs, balance providers must have zero balance: cdr id 50878 source_reseller_cash_balance before 0.0000 = 0.0000
ok 1195 - prepaid w prepaid costs, balance providers must have zero balance: cdr id 50878 source_reseller_cash_balance after 0.0000 = 0.0000
ok 1196 - prepaid w prepaid costs, balance providers must have zero balance: cdr id 50878 destination_carrier_cash_balance number of records 0 = 0
ok 1197 - prepaid w prepaid costs, balance providers must have zero balance: cdr id 50878 destination_reseller_cash_balance before 0.0000 = 0.0000
ok 1198 - prepaid w prepaid costs, balance providers must have zero balance: cdr id 50878 destination_reseller_cash_balance after 0.0000 = 0.0000
1..1198
