ok 1 - create systemcontacts 1
ok 2 - create contracts 1
ok 3 - create resellers 1
ok 4 - create billingprofiles 1
ok 5 - create billingzones 1
ok 6 - create billingfees 1
ok 7 - create billingfees 2
ok 8 - patch contracts id 61903
ok 9 - create domains 1
ok 10 - create billingprofiles 2
ok 11 - create billingzones 2
ok 12 - create billingfees 3
ok 13 - create billingfees 4
ok 14 - create billingprofiles 3
ok 15 - create billingzones 3
ok 16 - create billingfees 5
ok 17 - create billingfees 6
ok 18 - create systemcontacts 2
ok 19 - create contracts 2
ok 20 - create resellers 2
ok 21 - create billingprofiles 4
ok 22 - create billingzones 4
ok 23 - create billingfees 7
ok 24 - create billingfees 8
ok 25 - patch contracts id 61904
ok 26 - create domains 2
ok 27 - create billingprofiles 5
ok 28 - create billingzones 5
ok 29 - create billingfees 9
ok 30 - create billingfees 10
ok 31 - create billingprofiles 6
ok 32 - create billingzones 6
ok 33 - create billingfees 11
ok 34 - create billingfees 12
ok 35 - create customercontacts 1
ok 36 - create customers 1
ok 37 - setting customer id 61905 cash_balance to 0 cents
ok 38 - create subscribers 1
ok 39 - very first balance interval: fetch customer id 61905 balance intervals collection page
ok 40 - very first balance interval: check interval 77413 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 41 - very first balance interval: check interval 77413 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 42 - very first balance interval: check interval 77413 cash balance 0 = 0
ok 43 - very first balance interval: check interval 77413 billing profile id 1131 = 1131
ok 44 - very first balance interval: check if all expected items are listed
ok 45 - create customercontacts 2
ok 46 - create customers 2
ok 47 - setting customer id 61906 cash_balance to 0 cents
ok 48 - create subscribers 2
ok 49 - very first balance interval: fetch customer id 61906 balance intervals collection page
ok 50 - very first balance interval: check interval 77414 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 51 - very first balance interval: check interval 77414 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 52 - very first balance interval: check interval 77414 cash balance 0 = 0
ok 53 - very first balance interval: check interval 77414 billing profile id 1131 = 1131
ok 54 - very first balance interval: check if all expected items are listed
ok 55 - create customercontacts 3
ok 56 - create customers 3
ok 57 - setting customer id 61907 cash_balance to 0 cents
ok 58 - create subscribers 3
ok 59 - very first balance interval: fetch customer id 61907 balance intervals collection page
ok 60 - very first balance interval: check interval 77415 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 61 - very first balance interval: check interval 77415 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 62 - very first balance interval: check interval 77415 cash balance 0 = 0
ok 63 - very first balance interval: check interval 77415 billing profile id 1131 = 1131
ok 64 - very first balance interval: check if all expected items are listed
ok 65 - create customercontacts 4
ok 66 - create customers 4
ok 67 - setting customer id 61908 cash_balance to 0 cents
ok 68 - create subscribers 4
ok 69 - very first balance interval: fetch customer id 61908 balance intervals collection page
ok 70 - very first balance interval: check interval 77416 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 71 - very first balance interval: check interval 77416 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 72 - very first balance interval: check interval 77416 cash balance 0 = 0
ok 73 - very first balance interval: check interval 77416 billing profile id 1134 = 1134
ok 74 - very first balance interval: check if all expected items are listed
ok 75 - cdrs id 50843, 50844, 50845 created
INFO: Trying to connect to billing db...
INFO: Successfully connected to duplication db...
INFO: Trying to connect to provisioning db...
INFO: Successfully connected to provisioning db...
INFO: Trying to connect to accounting db...
INFO: Successfully connected to accounting db...
WARNING: No duplication db credentials, disabled.
INFO: local cdr relation column model loaded
INFO: local cdr cash balance column model loaded
INFO: local cdr time balance column model loaded
INFO: Up and running.
INFO: Grabbed 3 CDRs
DEBUG: start rating CDR ID 50843
DEBUG: 4 contract(s) locked: 61903, 61904, 61905, 61908
INFO: 1/3 - rate CDR ID 50843
DEBUG: fetching source provider info for source_provider_id #61903
DEBUG: catching up contract ID 61903 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61903 billing mapping (reseller) is profile id 1 for time 1515762809.000 from ipv4 source ip 192.168.0.1
DEBUG: source_provider_info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'id' => 77411,
                            'start' => '2018-01-01 00:00:00'
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'reseller',
                         'product_id' => 3,
                         'prepaid' => 0,
                         'profile_id' => 1,
                         'int_unit' => 'month',
                         'contract_id' => '61903'
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: fetching destination provider info for destination_provider_id #61904
DEBUG: catching up contract ID 61904 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61904 billing mapping (reseller) is profile id 1 for time 1515762809.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_provider_info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77412
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'reseller',
                         'product_id' => 3,
                         'prepaid' => 0,
                         'profile_id' => 1,
                         'int_unit' => 'month',
                         'contract_id' => '61904'
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: ### 1. write pass ###
DEBUG: call from local subscriber, source_user_id is 67a5587a-864d-422c-a4f7-9d9628260cec
DEBUG: call to local subscriber, destination_user_id is 9a175600-af41-43c8-bae0-7b41c24b3552
DEBUG: destination provider has billing profile 1, get reseller termination cost
DEBUG: calculating call cost for profile_id 1 with type call, direction in, src_user_domain 888111515762707@testa.com.1515762707, dst_user_domain 888241515762707@testb.com.1515762707
DEBUG: no match for full uris, trying user only for profile_id 1 with type call, direction in, src_user_domain 888111515762707, dst_user_domain 888241515762707
DEBUG: 1 contract balance row(s) updated
DEBUG: destination reseller termination cost is 0
DEBUG: get customer termination cost for destination_user_id 9a175600-af41-43c8-bae0-7b41c24b3552
DEBUG: catching up contract ID 61908 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61908 billing mapping (sipaccount) is profile id 1134 for time 1515762809.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_customer info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77416
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount',
                         'product_id' => 4,
                         'prepaid' => 0,
                         'profile_id' => 1134,
                         'int_unit' => 'month',
                         'contract_id' => 61908
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1134 with type call, direction in, src_user_domain 888111515762707@testa.com.1515762707, dst_user_domain 888241515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '5',
          'on_follow_interval' => 30,
          'on_init_interval' => 60,
          'on_init_rate' => '5',
          'fee_id' => 1614,
          'off_follow_rate' => '1',
          'source_pattern' => '^8881.+',
          'pattern' => '.',
          'use_free_time' => 0,
          'zone_id' => 503,
          'on_follow_rate' => '1',
          'off_follow_interval' => 30,
          'off_init_interval' => 60
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 5 per sec to costs
DEBUG: interval is 60, so rate for this interval is 300
DEBUG: starting with contract balance: $VAR1 = {
          'free_time_balance_interval' => 0,
          'end_unix' => 1517443199,
          'start_unix' => 1514764800,
          'cash_balance_interval' => '0',
          'free_time_balance_old' => 0,
          'free_time_balance' => 0,
          'cash_balance' => '0',
          'cash_balance_old' => '0',
          'start' => '2018-01-01 00:00:00',
          'id' => 77416
        };
DEBUG: add current interval cost 300 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 300
DEBUG: rating_duration = 90
DEBUG: got call cost 330 and free time 0
DEBUG: billing profile is post-paid, update contract balance
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 330
DEBUG: destination customer termination cost is 330
DEBUG: calculating call cost for profile_id 1 with type call, direction out, src_user_domain 888111515762707@testa.com.1515762707, dst_user_domain 888241515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '0',
          'on_follow_interval' => 600,
          'on_init_interval' => 600,
          'on_init_rate' => '0',
          'fee_id' => 1000,
          'off_follow_rate' => '0',
          'source_pattern' => '.',
          'pattern' => '.*',
          'use_free_time' => 0,
          'zone_id' => 1,
          'on_follow_rate' => '0',
          'off_follow_interval' => 600,
          'off_init_interval' => 600
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 0 per sec to costs
DEBUG: interval is 600, so rate for this interval is 0
DEBUG: starting with contract balance: $VAR1 = {
          'end_unix' => 1517443199,
          'free_time_balance_interval' => 0,
          'start_unix' => 1514764800,
          'cash_balance_interval' => 0,
          'free_time_balance' => 0,
          'free_time_balance_old' => 0,
          'cash_balance' => 0,
          'cash_balance_old' => 0,
          'start' => '2018-01-01 00:00:00',
          'id' => 77411
        };
DEBUG: add current interval cost 0 to total cost 0
DEBUG: rating_duration = 600
DEBUG: 1 contract balance row(s) updated
DEBUG: catching up contract ID 61905 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61905 billing mapping (sipaccount) is profile id 1131 for time 1515762809.000 from ipv4 source ip 192.168.0.1
DEBUG: source_customer info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77413
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount',
                         'product_id' => 4,
                         'prepaid' => 0,
                         'profile_id' => 1131,
                         'int_unit' => 'month',
                         'contract_id' => 61905
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1131 with type call, direction out, src_user_domain 888111515762707@testa.com.1515762707, dst_user_domain 888241515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '6',
          'on_follow_interval' => 30,
          'on_init_interval' => 60,
          'on_init_rate' => '6',
          'fee_id' => 1607,
          'off_follow_rate' => '1',
          'source_pattern' => '.',
          'pattern' => '^8882.+',
          'use_free_time' => 0,
          'zone_id' => 500,
          'on_follow_rate' => '1',
          'off_follow_interval' => 30,
          'off_init_interval' => 60
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 6 per sec to costs
DEBUG: interval is 60, so rate for this interval is 360
DEBUG: starting with contract balance: $VAR1 = {
          'free_time_balance_interval' => 0,
          'end_unix' => 1517443199,
          'start_unix' => 1514764800,
          'cash_balance_interval' => '0',
          'free_time_balance_old' => 0,
          'free_time_balance' => 0,
          'cash_balance' => '0',
          'cash_balance_old' => '0',
          'start' => '2018-01-01 00:00:00',
          'id' => 77413
        };
DEBUG: add current interval cost 360 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 360
DEBUG: rating_duration = 90
DEBUG: got call cost 390 and free time 0
DEBUG: billing profile is post-paid, update contract balance
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 390
DEBUG: cdr ID 50843 updated
DEBUG: empty 'source_carrier_cash_balance' local col data for cdr id 50843, skipping
DEBUG: empty 'source_carrier_free_time_balance' local col data for cdr id 50843, skipping
DEBUG: empty 'source_carrier_profile_package_id' local col data for cdr id 50843, skipping
DEBUG: empty 'source_carrier_contract_balance_id' local col data for cdr id 50843, skipping
DEBUG: local col data created or up to date for cdr id 50843, column 'source_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50843, column 'source_reseller_free_time_balance': 0, 0
DEBUG: empty 'source_reseller_profile_package_id' local col data for cdr id 50843, skipping
DEBUG: local col data created or up to date for cdr id 50843, column 'source_reseller_contract_balance_id': 77411
DEBUG: local col data created or up to date for cdr id 50843, column 'source_customer_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50843, column 'source_customer_free_time_balance': 0, 0
DEBUG: empty 'source_customer_profile_package_id' local col data for cdr id 50843, skipping
DEBUG: local col data created or up to date for cdr id 50843, column 'source_customer_contract_balance_id': 77413
DEBUG: empty 'destination_carrier_cash_balance' local col data for cdr id 50843, skipping
DEBUG: empty 'destination_carrier_free_time_balance' local col data for cdr id 50843, skipping
DEBUG: empty 'destination_carrier_profile_package_id' local col data for cdr id 50843, skipping
DEBUG: empty 'destination_carrier_contract_balance_id' local col data for cdr id 50843, skipping
DEBUG: local col data created or up to date for cdr id 50843, column 'destination_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50843, column 'destination_reseller_free_time_balance': 0, 0
DEBUG: empty 'destination_reseller_profile_package_id' local col data for cdr id 50843, skipping
DEBUG: local col data created or up to date for cdr id 50843, column 'destination_reseller_contract_balance_id': 77412
DEBUG: local col data created or up to date for cdr id 50843, column 'destination_customer_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50843, column 'destination_customer_free_time_balance': 0, 0
DEBUG: empty 'destination_customer_profile_package_id' local col data for cdr id 50843, skipping
DEBUG: local col data created or up to date for cdr id 50843, column 'destination_customer_contract_balance_id': 77416
DEBUG: rating cdr ID 50843 completed successfully in 0.194 secs
DEBUG: start rating CDR ID 50844
DEBUG: 4 contract(s) locked: 61903, 61904, 61906, 61908
INFO: 2/3 - rate CDR ID 50844
DEBUG: fetching source provider info for source_provider_id #61903
DEBUG: catching up contract ID 61903 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61903 billing mapping (reseller) is profile id 1 for time 1515762810.000 from ipv4 source ip 192.168.0.1
DEBUG: source_provider_info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77411
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'reseller',
                         'product_id' => 3,
                         'prepaid' => 0,
                         'profile_id' => 1,
                         'int_unit' => 'month',
                         'contract_id' => '61903'
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: fetching destination provider info for destination_provider_id #61904
DEBUG: catching up contract ID 61904 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61904 billing mapping (reseller) is profile id 1 for time 1515762810.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_provider_info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77412
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'reseller',
                         'product_id' => 3,
                         'prepaid' => 0,
                         'profile_id' => 1,
                         'int_unit' => 'month',
                         'contract_id' => '61904'
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: ### 1. write pass ###
DEBUG: call from local subscriber, source_user_id is c2c30d94-31eb-4268-88a0-2c996a325354
DEBUG: call to local subscriber, destination_user_id is 9a175600-af41-43c8-bae0-7b41c24b3552
DEBUG: destination provider has billing profile 1, get reseller termination cost
DEBUG: calculating call cost for profile_id 1 with type call, direction in, src_user_domain 888121515762707@testa.com.1515762707, dst_user_domain 888241515762707@testb.com.1515762707
DEBUG: no match for full uris, trying user only for profile_id 1 with type call, direction in, src_user_domain 888121515762707, dst_user_domain 888241515762707
DEBUG: 1 contract balance row(s) updated
DEBUG: destination reseller termination cost is 0
DEBUG: get customer termination cost for destination_user_id 9a175600-af41-43c8-bae0-7b41c24b3552
DEBUG: catching up contract ID 61908 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61908 billing mapping (sipaccount) is profile id 1134 for time 1515762810.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_customer info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '330',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77416
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount',
                         'product_id' => 4,
                         'prepaid' => 0,
                         'profile_id' => 1134,
                         'int_unit' => 'month',
                         'contract_id' => 61908
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1134 with type call, direction in, src_user_domain 888121515762707@testa.com.1515762707, dst_user_domain 888241515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '5',
          'on_follow_interval' => 30,
          'on_init_interval' => 60,
          'on_init_rate' => '5',
          'fee_id' => 1614,
          'off_follow_rate' => '1',
          'source_pattern' => '^8881.+',
          'pattern' => '.',
          'use_free_time' => 0,
          'zone_id' => 503,
          'on_follow_rate' => '1',
          'off_follow_interval' => 30,
          'off_init_interval' => 60
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 5 per sec to costs
DEBUG: interval is 60, so rate for this interval is 300
DEBUG: starting with contract balance: $VAR1 = {
          'free_time_balance_interval' => 0,
          'end_unix' => 1517443199,
          'start_unix' => 1514764800,
          'cash_balance_interval' => '330',
          'free_time_balance_old' => 0,
          'free_time_balance' => 0,
          'cash_balance' => '0',
          'cash_balance_old' => '0',
          'start' => '2018-01-01 00:00:00',
          'id' => 77416
        };
DEBUG: add current interval cost 300 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 300
DEBUG: rating_duration = 90
DEBUG: got call cost 330 and free time 0
DEBUG: billing profile is post-paid, update contract balance
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 330
DEBUG: destination customer termination cost is 330
DEBUG: calculating call cost for profile_id 1 with type call, direction out, src_user_domain 888121515762707@testa.com.1515762707, dst_user_domain 888241515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '0',
          'on_follow_interval' => 600,
          'on_init_interval' => 600,
          'on_init_rate' => '0',
          'fee_id' => 1000,
          'off_follow_rate' => '0',
          'source_pattern' => '.',
          'pattern' => '.*',
          'use_free_time' => 0,
          'zone_id' => 1,
          'on_follow_rate' => '0',
          'off_follow_interval' => 600,
          'off_init_interval' => 600
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 0 per sec to costs
DEBUG: interval is 600, so rate for this interval is 0
DEBUG: starting with contract balance: $VAR1 = {
          'end_unix' => 1517443199,
          'free_time_balance_interval' => 0,
          'start_unix' => 1514764800,
          'cash_balance_interval' => 0,
          'free_time_balance' => 0,
          'free_time_balance_old' => 0,
          'cash_balance' => 0,
          'cash_balance_old' => 0,
          'id' => 77411,
          'start' => '2018-01-01 00:00:00'
        };
DEBUG: add current interval cost 0 to total cost 0
DEBUG: rating_duration = 600
DEBUG: 1 contract balance row(s) updated
DEBUG: catching up contract ID 61906 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61906 billing mapping (sipaccount) is profile id 1131 for time 1515762810.000 from ipv4 source ip 192.168.0.1
DEBUG: source_customer info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77414
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount',
                         'product_id' => 4,
                         'prepaid' => 0,
                         'profile_id' => 1131,
                         'int_unit' => 'month',
                         'contract_id' => 61906
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1131 with type call, direction out, src_user_domain 888121515762707@testa.com.1515762707, dst_user_domain 888241515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '6',
          'on_follow_interval' => 30,
          'on_init_interval' => 60,
          'on_init_rate' => '6',
          'fee_id' => 1607,
          'off_follow_rate' => '1',
          'source_pattern' => '.',
          'pattern' => '^8882.+',
          'use_free_time' => 0,
          'zone_id' => 500,
          'on_follow_rate' => '1',
          'off_follow_interval' => 30,
          'off_init_interval' => 60
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 6 per sec to costs
DEBUG: interval is 60, so rate for this interval is 360
DEBUG: starting with contract balance: $VAR1 = {
          'free_time_balance_interval' => 0,
          'end_unix' => 1517443199,
          'start_unix' => 1514764800,
          'cash_balance_interval' => '0',
          'free_time_balance_old' => 0,
          'free_time_balance' => 0,
          'cash_balance' => '0',
          'cash_balance_old' => '0',
          'start' => '2018-01-01 00:00:00',
          'id' => 77414
        };
DEBUG: add current interval cost 360 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 360
DEBUG: rating_duration = 90
DEBUG: got call cost 390 and free time 0
DEBUG: billing profile is post-paid, update contract balance
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 390
DEBUG: cdr ID 50844 updated
DEBUG: empty 'source_carrier_cash_balance' local col data for cdr id 50844, skipping
DEBUG: empty 'source_carrier_free_time_balance' local col data for cdr id 50844, skipping
DEBUG: empty 'source_carrier_profile_package_id' local col data for cdr id 50844, skipping
DEBUG: empty 'source_carrier_contract_balance_id' local col data for cdr id 50844, skipping
DEBUG: local col data created or up to date for cdr id 50844, column 'source_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50844, column 'source_reseller_free_time_balance': 0, 0
DEBUG: empty 'source_reseller_profile_package_id' local col data for cdr id 50844, skipping
DEBUG: local col data created or up to date for cdr id 50844, column 'source_reseller_contract_balance_id': 77411
DEBUG: local col data created or up to date for cdr id 50844, column 'source_customer_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50844, column 'source_customer_free_time_balance': 0, 0
DEBUG: empty 'source_customer_profile_package_id' local col data for cdr id 50844, skipping
DEBUG: local col data created or up to date for cdr id 50844, column 'source_customer_contract_balance_id': 77414
DEBUG: empty 'destination_carrier_cash_balance' local col data for cdr id 50844, skipping
DEBUG: empty 'destination_carrier_free_time_balance' local col data for cdr id 50844, skipping
DEBUG: empty 'destination_carrier_profile_package_id' local col data for cdr id 50844, skipping
DEBUG: empty 'destination_carrier_contract_balance_id' local col data for cdr id 50844, skipping
DEBUG: local col data created or up to date for cdr id 50844, column 'destination_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50844, column 'destination_reseller_free_time_balance': 0, 0
DEBUG: empty 'destination_reseller_profile_package_id' local col data for cdr id 50844, skipping
DEBUG: local col data created or up to date for cdr id 50844, column 'destination_reseller_contract_balance_id': 77412
DEBUG: local col data created or up to date for cdr id 50844, column 'destination_customer_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50844, column 'destination_customer_free_time_balance': 0, 0
DEBUG: empty 'destination_customer_profile_package_id' local col data for cdr id 50844, skipping
DEBUG: local col data created or up to date for cdr id 50844, column 'destination_customer_contract_balance_id': 77416
DEBUG: rating cdr ID 50844 completed successfully in 0.142 secs
DEBUG: start rating CDR ID 50845
DEBUG: 4 contract(s) locked: 61903, 61904, 61907, 61908
INFO: 3/3 - rate CDR ID 50845
DEBUG: fetching source provider info for source_provider_id #61903
DEBUG: catching up contract ID 61903 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61903 billing mapping (reseller) is profile id 1 for time 1515762811.000 from ipv4 source ip 192.168.0.1
DEBUG: source_provider_info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77411
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'reseller',
                         'product_id' => 3,
                         'prepaid' => 0,
                         'profile_id' => 1,
                         'int_unit' => 'month',
                         'contract_id' => '61903'
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: fetching destination provider info for destination_provider_id #61904
DEBUG: catching up contract ID 61904 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61904 billing mapping (reseller) is profile id 1 for time 1515762811.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_provider_info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77412
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'reseller',
                         'product_id' => 3,
                         'prepaid' => 0,
                         'profile_id' => 1,
                         'int_unit' => 'month',
                         'contract_id' => '61904'
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: ### 1. write pass ###
DEBUG: call from local subscriber, source_user_id is c32864ff-5ec1-40d4-93f5-bcdf28b9df53
DEBUG: call to local subscriber, destination_user_id is 9a175600-af41-43c8-bae0-7b41c24b3552
DEBUG: destination provider has billing profile 1, get reseller termination cost
DEBUG: calculating call cost for profile_id 1 with type call, direction in, src_user_domain 888131515762707@testa.com.1515762707, dst_user_domain 888241515762707@testb.com.1515762707
DEBUG: no match for full uris, trying user only for profile_id 1 with type call, direction in, src_user_domain 888131515762707, dst_user_domain 888241515762707
DEBUG: 1 contract balance row(s) updated
DEBUG: destination reseller termination cost is 0
DEBUG: get customer termination cost for destination_user_id 9a175600-af41-43c8-bae0-7b41c24b3552
DEBUG: catching up contract ID 61908 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61908 billing mapping (sipaccount) is profile id 1134 for time 1515762811.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_customer info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '660',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77416
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount',
                         'product_id' => 4,
                         'prepaid' => 0,
                         'profile_id' => 1134,
                         'int_unit' => 'month',
                         'contract_id' => 61908
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1134 with type call, direction in, src_user_domain 888131515762707@testa.com.1515762707, dst_user_domain 888241515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '5',
          'on_follow_interval' => 30,
          'on_init_interval' => 60,
          'on_init_rate' => '5',
          'fee_id' => 1614,
          'off_follow_rate' => '1',
          'source_pattern' => '^8881.+',
          'pattern' => '.',
          'use_free_time' => 0,
          'zone_id' => 503,
          'on_follow_rate' => '1',
          'off_follow_interval' => 30,
          'off_init_interval' => 60
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 5 per sec to costs
DEBUG: interval is 60, so rate for this interval is 300
DEBUG: starting with contract balance: $VAR1 = {
          'free_time_balance_interval' => 0,
          'end_unix' => 1517443199,
          'start_unix' => 1514764800,
          'cash_balance_interval' => '660',
          'free_time_balance_old' => 0,
          'free_time_balance' => 0,
          'cash_balance' => '0',
          'cash_balance_old' => '0',
          'start' => '2018-01-01 00:00:00',
          'id' => 77416
        };
DEBUG: add current interval cost 300 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 300
DEBUG: rating_duration = 90
DEBUG: got call cost 330 and free time 0
DEBUG: billing profile is post-paid, update contract balance
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 330
DEBUG: destination customer termination cost is 330
DEBUG: calculating call cost for profile_id 1 with type call, direction out, src_user_domain 888131515762707@testa.com.1515762707, dst_user_domain 888241515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '0',
          'on_follow_interval' => 600,
          'on_init_interval' => 600,
          'on_init_rate' => '0',
          'fee_id' => 1000,
          'off_follow_rate' => '0',
          'source_pattern' => '.',
          'pattern' => '.*',
          'use_free_time' => 0,
          'zone_id' => 1,
          'on_follow_rate' => '0',
          'off_follow_interval' => 600,
          'off_init_interval' => 600
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 0 per sec to costs
DEBUG: interval is 600, so rate for this interval is 0
DEBUG: starting with contract balance: $VAR1 = {
          'end_unix' => 1517443199,
          'free_time_balance_interval' => 0,
          'start_unix' => 1514764800,
          'cash_balance_interval' => 0,
          'free_time_balance' => 0,
          'free_time_balance_old' => 0,
          'cash_balance' => 0,
          'cash_balance_old' => 0,
          'id' => 77411,
          'start' => '2018-01-01 00:00:00'
        };
DEBUG: add current interval cost 0 to total cost 0
DEBUG: rating_duration = 600
DEBUG: 1 contract balance row(s) updated
DEBUG: catching up contract ID 61907 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61907 billing mapping (sipaccount) is profile id 1131 for time 1515762811.000 from ipv4 source ip 192.168.0.1
DEBUG: source_customer info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77415
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount',
                         'product_id' => 4,
                         'prepaid' => 0,
                         'profile_id' => 1131,
                         'int_unit' => 'month',
                         'contract_id' => 61907
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1131 with type call, direction out, src_user_domain 888131515762707@testa.com.1515762707, dst_user_domain 888241515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '6',
          'on_follow_interval' => 30,
          'on_init_interval' => 60,
          'on_init_rate' => '6',
          'fee_id' => 1607,
          'off_follow_rate' => '1',
          'source_pattern' => '.',
          'pattern' => '^8882.+',
          'use_free_time' => 0,
          'zone_id' => 500,
          'on_follow_rate' => '1',
          'off_follow_interval' => 30,
          'off_init_interval' => 60
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 6 per sec to costs
DEBUG: interval is 60, so rate for this interval is 360
DEBUG: starting with contract balance: $VAR1 = {
          'free_time_balance_interval' => 0,
          'end_unix' => 1517443199,
          'start_unix' => 1514764800,
          'cash_balance_interval' => '0',
          'free_time_balance_old' => 0,
          'free_time_balance' => 0,
          'cash_balance' => '0',
          'cash_balance_old' => '0',
          'start' => '2018-01-01 00:00:00',
          'id' => 77415
        };
DEBUG: add current interval cost 360 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 360
DEBUG: rating_duration = 90
DEBUG: got call cost 390 and free time 0
DEBUG: billing profile is post-paid, update contract balance
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 390
DEBUG: cdr ID 50845 updated
DEBUG: empty 'source_carrier_cash_balance' local col data for cdr id 50845, skipping
DEBUG: empty 'source_carrier_free_time_balance' local col data for cdr id 50845, skipping
DEBUG: empty 'source_carrier_profile_package_id' local col data for cdr id 50845, skipping
DEBUG: empty 'source_carrier_contract_balance_id' local col data for cdr id 50845, skipping
DEBUG: local col data created or up to date for cdr id 50845, column 'source_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50845, column 'source_reseller_free_time_balance': 0, 0
DEBUG: empty 'source_reseller_profile_package_id' local col data for cdr id 50845, skipping
DEBUG: local col data created or up to date for cdr id 50845, column 'source_reseller_contract_balance_id': 77411
DEBUG: local col data created or up to date for cdr id 50845, column 'source_customer_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50845, column 'source_customer_free_time_balance': 0, 0
DEBUG: empty 'source_customer_profile_package_id' local col data for cdr id 50845, skipping
DEBUG: local col data created or up to date for cdr id 50845, column 'source_customer_contract_balance_id': 77415
DEBUG: empty 'destination_carrier_cash_balance' local col data for cdr id 50845, skipping
DEBUG: empty 'destination_carrier_free_time_balance' local col data for cdr id 50845, skipping
DEBUG: empty 'destination_carrier_profile_package_id' local col data for cdr id 50845, skipping
DEBUG: empty 'destination_carrier_contract_balance_id' local col data for cdr id 50845, skipping
DEBUG: local col data created or up to date for cdr id 50845, column 'destination_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50845, column 'destination_reseller_free_time_balance': 0, 0
DEBUG: empty 'destination_reseller_profile_package_id' local col data for cdr id 50845, skipping
DEBUG: local col data created or up to date for cdr id 50845, column 'destination_reseller_contract_balance_id': 77412
DEBUG: local col data created or up to date for cdr id 50845, column 'destination_customer_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50845, column 'destination_customer_free_time_balance': 0, 0
DEBUG: empty 'destination_customer_profile_package_id' local col data for cdr id 50845, skipping
DEBUG: local col data created or up to date for cdr id 50845, column 'destination_customer_contract_balance_id': 77416
DEBUG: rating cdr ID 50845 completed successfully in 0.158 secs
INFO: Batch of 3 CDRs completed. 3 CDRs rated overall so far.
INFO: Less than 5 new CDRs, sleep 10
ok 76 - rate-o-mat executed
ok 77 - postpaid, no balance: rating_status = ok
not ok 78 - postpaid, no balance: source_reseller_cost = 150.000000
ok 79 - postpaid, no balance: id = 50845
not ok 80 - postpaid, no balance: destination_reseller_cost = 90.000000
ok 81 - postpaid, no balance: source_customer_cost = 390.000000
ok 82 - postpaid, no balance: destination_customer_cost = 330.000000
not ok 83 - postpaid, no balance: destination_reseller_cost = 90.000000
ok 84 - postpaid, no balance: rating_status = ok
not ok 85 - postpaid, no balance: source_reseller_cost = 150.000000
ok 86 - postpaid, no balance: id = 50844
ok 87 - postpaid, no balance: destination_customer_cost = 330.000000
ok 88 - postpaid, no balance: source_customer_cost = 390.000000
ok 89 - postpaid, no balance: source_customer_cost = 390.000000
ok 90 - postpaid, no balance: destination_customer_cost = 330.000000
not ok 91 - postpaid, no balance: destination_reseller_cost = 90.000000
not ok 92 - postpaid, no balance: source_reseller_cost = 150.000000
ok 93 - postpaid, no balance: rating_status = ok
ok 94 - postpaid, no balance: id = 50843
not ok 95 - cdrs were all processed
ok 96 - postpaid, no balance, caller 1: cdr id 50843 source_customer_contract_balance_id number of records 1 = 1
ok 97 - postpaid, no balance, caller 1: fetch customer id 61905 balance intervals collection page
ok 98 - postpaid, no balance, caller 1: check 'total_count' of collection
ok 99 - postpaid, no balance, caller 1: check interval 77413 cash balance 0 = 0
ok 100 - postpaid, no balance, caller 1: check interval 77413 cash balance interval 3.9 = 3.9
ok 101 - postpaid, no balance, caller 1: check interval 77413 id = 77413
ok 102 - postpaid, no balance, caller 1: check if all expected items are listed
ok 103 - postpaid, no balance, caller 1: cdr id 50843 source_customer_cash_balance before 0.0000 = 0.0000
ok 104 - postpaid, no balance, caller 1: cdr id 50843 source_customer_cash_balance after 0.0000 = 0.0000
ok 105 - postpaid, no balance, caller 2: cdr id 50844 source_customer_contract_balance_id number of records 1 = 1
ok 106 - postpaid, no balance, caller 2: fetch customer id 61906 balance intervals collection page
ok 107 - postpaid, no balance, caller 2: check 'total_count' of collection
ok 108 - postpaid, no balance, caller 2: check interval 77414 cash balance 0 = 0
ok 109 - postpaid, no balance, caller 2: check interval 77414 cash balance interval 3.9 = 3.9
ok 110 - postpaid, no balance, caller 2: check interval 77414 id = 77414
ok 111 - postpaid, no balance, caller 2: check if all expected items are listed
ok 112 - postpaid, no balance, caller 2: cdr id 50844 source_customer_cash_balance before 0.0000 = 0.0000
ok 113 - postpaid, no balance, caller 2: cdr id 50844 source_customer_cash_balance after 0.0000 = 0.0000
ok 114 - postpaid, no balance, caller 3: cdr id 50845 source_customer_contract_balance_id number of records 1 = 1
ok 115 - postpaid, no balance, caller 3: fetch customer id 61907 balance intervals collection page
ok 116 - postpaid, no balance, caller 3: check 'total_count' of collection
ok 117 - postpaid, no balance, caller 3: check interval 77415 cash balance 0 = 0
ok 118 - postpaid, no balance, caller 3: check interval 77415 cash balance interval 3.9 = 3.9
ok 119 - postpaid, no balance, caller 3: check interval 77415 id = 77415
ok 120 - postpaid, no balance, caller 3: check if all expected items are listed
ok 121 - postpaid, no balance, caller 3: cdr id 50845 source_customer_cash_balance before 0.0000 = 0.0000
ok 122 - postpaid, no balance, caller 3: cdr id 50845 source_customer_cash_balance after 0.0000 = 0.0000
ok 123 - postpaid, no balance, callee: cdr id 50843 destination_customer_contract_balance_id number of records 1 = 1
ok 124 - postpaid, no balance, callee: fetch customer id 61908 balance intervals collection page
ok 125 - postpaid, no balance, callee: check 'total_count' of collection
ok 126 - postpaid, no balance, callee: check interval 77416 cash balance 0 = 0
ok 127 - postpaid, no balance, callee: check interval 77416 cash balance interval 9.9 = 9.9
ok 128 - postpaid, no balance, callee: check interval 77416 id = 77416
ok 129 - postpaid, no balance, callee: check if all expected items are listed
ok 130 - postpaid, no balance, callee: cdr id 50843 destination_customer_contract_balance_id 77416 = 77416
ok 131 - postpaid, no balance, callee: cdr id 50843 destination_customer_cash_balance before 0.0000 = 0.0000
ok 132 - postpaid, no balance, callee: cdr id 50843 destination_customer_cash_balance after 0.0000 = 0.0000
ok 133 - postpaid, no balance, callee: cdr id 50844 destination_customer_contract_balance_id 77416 = 77416
ok 134 - postpaid, no balance, callee: cdr id 50844 destination_customer_cash_balance before 0.0000 = 0.0000
ok 135 - postpaid, no balance, callee: cdr id 50844 destination_customer_cash_balance after 0.0000 = 0.0000
ok 136 - postpaid, no balance, callee: cdr id 50845 destination_customer_contract_balance_id 77416 = 77416
ok 137 - postpaid, no balance, callee: cdr id 50845 destination_customer_cash_balance before 0.0000 = 0.0000
ok 138 - postpaid, no balance, callee: cdr id 50845 destination_customer_cash_balance after 0.0000 = 0.0000
ok 139 - postpaid, no balance, callers' provider: cdr id 50843 source_reseller_contract_balance_id number of records 1 = 1
ok 140 - postpaid, no balance, callers' provider: fetch customer id 61903 balance intervals collection page
ok 141 - postpaid, no balance, callers' provider: check 'total_count' of collection
not ok 142 - postpaid, no balance, callers' provider: check interval 77411 cash balance interval 0 = 4.5
ok 143 - postpaid, no balance, callers' provider: check interval 77411 id = 77411
ok 144 - postpaid, no balance, callers' provider: check if all expected items are listed
ok 145 - postpaid, no balance, callers' provider: cdr id 50843 source_carrier_contract_balance_id number of records 0 = 0
ok 146 - postpaid, no balance, callers' provider: cdr id 50843 source_reseller_contract_balance_id 77411 = 77411
ok 147 - postpaid, no balance, callers' provider: cdr id 50844 source_carrier_contract_balance_id number of records 0 = 0
ok 148 - postpaid, no balance, callers' provider: cdr id 50844 source_reseller_contract_balance_id 77411 = 77411
ok 149 - postpaid, no balance, callers' provider: cdr id 50845 source_carrier_contract_balance_id number of records 0 = 0
ok 150 - postpaid, no balance, callers' provider: cdr id 50845 source_reseller_contract_balance_id 77411 = 77411
ok 151 - postpaid, no balance, callee's provider: cdr id 50843 destination_reseller_contract_balance_id number of records 1 = 1
ok 152 - postpaid, no balance, callee's provider: fetch customer id 61904 balance intervals collection page
ok 153 - postpaid, no balance, callee's provider: check 'total_count' of collection
not ok 154 - postpaid, no balance, callee's provider: check interval 77412 cash balance interval 0 = 2.7
ok 155 - postpaid, no balance, callee's provider: check interval 77412 id = 77412
ok 156 - postpaid, no balance, callee's provider: check if all expected items are listed
ok 157 - postpaid, no balance, callee's provider: cdr id 50843 destination_carrier_contract_balance_id number of records 0 = 0
ok 158 - postpaid, no balance, callee's provider: cdr id 50843 destination_reseller_contract_balance_id 77412 = 77412
ok 159 - postpaid, no balance, callee's provider: cdr id 50844 destination_carrier_contract_balance_id number of records 0 = 0
ok 160 - postpaid, no balance, callee's provider: cdr id 50844 destination_reseller_contract_balance_id 77412 = 77412
ok 161 - postpaid, no balance, callee's provider: cdr id 50845 destination_carrier_contract_balance_id number of records 0 = 0
ok 162 - postpaid, no balance, callee's provider: cdr id 50845 destination_reseller_contract_balance_id 77412 = 77412
ok 163 - postpaid, no balance providers and subscriber must not have a profile package: cdr id 50843 source_carrier_profile_package_id number of records 0 = 0
ok 164 - postpaid, no balance providers and subscriber must not have a profile package: cdr id 50843 source_reseller_profile_package_id number of records 0 = 0
ok 165 - postpaid, no balance providers and subscriber must not have a profile package: cdr id 50843 source_customer_profile_package_id number of records 0 = 0
ok 166 - postpaid, no balance providers and subscriber must not have a profile package: cdr id 50843 destination_carrier_profile_package_id number of records 0 = 0
ok 167 - postpaid, no balance providers and subscriber must not have a profile package: cdr id 50843 destination_reseller_profile_package_id number of records 0 = 0
ok 168 - postpaid, no balance providers and subscriber must not have a profile package: cdr id 50843 destination_customer_profile_package_id number of records 0 = 0
ok 169 - postpaid, no balance providers and subscriber must not have a profile package: cdr id 50844 source_carrier_profile_package_id number of records 0 = 0
ok 170 - postpaid, no balance providers and subscriber must not have a profile package: cdr id 50844 source_reseller_profile_package_id number of records 0 = 0
ok 171 - postpaid, no balance providers and subscriber must not have a profile package: cdr id 50844 source_customer_profile_package_id number of records 0 = 0
ok 172 - postpaid, no balance providers and subscriber must not have a profile package: cdr id 50844 destination_carrier_profile_package_id number of records 0 = 0
ok 173 - postpaid, no balance providers and subscriber must not have a profile package: cdr id 50844 destination_reseller_profile_package_id number of records 0 = 0
ok 174 - postpaid, no balance providers and subscriber must not have a profile package: cdr id 50844 destination_customer_profile_package_id number of records 0 = 0
ok 175 - postpaid, no balance providers and subscriber must not have a profile package: cdr id 50845 source_carrier_profile_package_id number of records 0 = 0
ok 176 - postpaid, no balance providers and subscriber must not have a profile package: cdr id 50845 source_reseller_profile_package_id number of records 0 = 0
ok 177 - postpaid, no balance providers and subscriber must not have a profile package: cdr id 50845 source_customer_profile_package_id number of records 0 = 0
ok 178 - postpaid, no balance providers and subscriber must not have a profile package: cdr id 50845 destination_carrier_profile_package_id number of records 0 = 0
ok 179 - postpaid, no balance providers and subscriber must not have a profile package: cdr id 50845 destination_reseller_profile_package_id number of records 0 = 0
ok 180 - postpaid, no balance providers and subscriber must not have a profile package: cdr id 50845 destination_customer_profile_package_id number of records 0 = 0
ok 181 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50843 source_carrier_free_time_balance number of records 0 = 0
ok 182 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50843 source_reseller_free_time_balance before 0 = 0
ok 183 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50843 source_reseller_free_time_balance after 0 = 0
ok 184 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50843 source_customer_free_time_balance before 0 = 0
ok 185 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50843 source_customer_free_time_balance after 0 = 0
ok 186 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50843 destination_carrier_free_time_balance number of records 0 = 0
ok 187 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50843 destination_reseller_free_time_balance before 0 = 0
ok 188 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50843 destination_reseller_free_time_balance after 0 = 0
ok 189 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50843 destination_customer_free_time_balance before 0 = 0
ok 190 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50843 destination_customer_free_time_balance after 0 = 0
ok 191 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50844 source_carrier_free_time_balance number of records 0 = 0
ok 192 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50844 source_reseller_free_time_balance before 0 = 0
ok 193 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50844 source_reseller_free_time_balance after 0 = 0
ok 194 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50844 source_customer_free_time_balance before 0 = 0
ok 195 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50844 source_customer_free_time_balance after 0 = 0
ok 196 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50844 destination_carrier_free_time_balance number of records 0 = 0
ok 197 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50844 destination_reseller_free_time_balance before 0 = 0
ok 198 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50844 destination_reseller_free_time_balance after 0 = 0
ok 199 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50844 destination_customer_free_time_balance before 0 = 0
ok 200 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50844 destination_customer_free_time_balance after 0 = 0
ok 201 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50845 source_carrier_free_time_balance number of records 0 = 0
ok 202 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50845 source_reseller_free_time_balance before 0 = 0
ok 203 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50845 source_reseller_free_time_balance after 0 = 0
ok 204 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50845 source_customer_free_time_balance before 0 = 0
ok 205 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50845 source_customer_free_time_balance after 0 = 0
ok 206 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50845 destination_carrier_free_time_balance number of records 0 = 0
ok 207 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50845 destination_reseller_free_time_balance before 0 = 0
ok 208 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50845 destination_reseller_free_time_balance after 0 = 0
ok 209 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50845 destination_customer_free_time_balance before 0 = 0
ok 210 - postpaid, no balance providers and subscriber must have zero free time: cdr id 50845 destination_customer_free_time_balance after 0 = 0
ok 211 - postpaid, no balance providers must have zero balance: cdr id 50843 source_carrier_cash_balance number of records 0 = 0
ok 212 - postpaid, no balance providers must have zero balance: cdr id 50843 source_reseller_cash_balance before 0.0000 = 0.0000
ok 213 - postpaid, no balance providers must have zero balance: cdr id 50843 source_reseller_cash_balance after 0.0000 = 0.0000
ok 214 - postpaid, no balance providers must have zero balance: cdr id 50843 destination_carrier_cash_balance number of records 0 = 0
ok 215 - postpaid, no balance providers must have zero balance: cdr id 50843 destination_reseller_cash_balance before 0.0000 = 0.0000
ok 216 - postpaid, no balance providers must have zero balance: cdr id 50843 destination_reseller_cash_balance after 0.0000 = 0.0000
ok 217 - postpaid, no balance providers must have zero balance: cdr id 50844 source_carrier_cash_balance number of records 0 = 0
ok 218 - postpaid, no balance providers must have zero balance: cdr id 50844 source_reseller_cash_balance before 0.0000 = 0.0000
ok 219 - postpaid, no balance providers must have zero balance: cdr id 50844 source_reseller_cash_balance after 0.0000 = 0.0000
ok 220 - postpaid, no balance providers must have zero balance: cdr id 50844 destination_carrier_cash_balance number of records 0 = 0
ok 221 - postpaid, no balance providers must have zero balance: cdr id 50844 destination_reseller_cash_balance before 0.0000 = 0.0000
ok 222 - postpaid, no balance providers must have zero balance: cdr id 50844 destination_reseller_cash_balance after 0.0000 = 0.0000
ok 223 - postpaid, no balance providers must have zero balance: cdr id 50845 source_carrier_cash_balance number of records 0 = 0
ok 224 - postpaid, no balance providers must have zero balance: cdr id 50845 source_reseller_cash_balance before 0.0000 = 0.0000
ok 225 - postpaid, no balance providers must have zero balance: cdr id 50845 source_reseller_cash_balance after 0.0000 = 0.0000
ok 226 - postpaid, no balance providers must have zero balance: cdr id 50845 destination_carrier_cash_balance number of records 0 = 0
ok 227 - postpaid, no balance providers must have zero balance: cdr id 50845 destination_reseller_cash_balance before 0.0000 = 0.0000
ok 228 - postpaid, no balance providers must have zero balance: cdr id 50845 destination_reseller_cash_balance after 0.0000 = 0.0000
ok 229 - create customercontacts 5
ok 230 - create customers 5
ok 231 - setting customer id 61909 cash_balance to 1000 cents
ok 232 - create subscribers 5
ok 233 - very first balance interval: fetch customer id 61909 balance intervals collection page
ok 234 - very first balance interval: check interval 77417 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 235 - very first balance interval: check interval 77417 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 236 - very first balance interval: check interval 77417 cash balance 10 = 10
ok 237 - very first balance interval: check interval 77417 billing profile id 1131 = 1131
ok 238 - very first balance interval: check if all expected items are listed
ok 239 - create customercontacts 6
ok 240 - create customers 6
ok 241 - setting customer id 61910 cash_balance to 1000 cents
ok 242 - create subscribers 6
ok 243 - very first balance interval: fetch customer id 61910 balance intervals collection page
ok 244 - very first balance interval: check interval 77418 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 245 - very first balance interval: check interval 77418 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 246 - very first balance interval: check interval 77418 cash balance 10 = 10
ok 247 - very first balance interval: check interval 77418 billing profile id 1131 = 1131
ok 248 - very first balance interval: check if all expected items are listed
ok 249 - create customercontacts 7
ok 250 - create customers 7
ok 251 - setting customer id 61911 cash_balance to 1000 cents
ok 252 - create subscribers 7
ok 253 - very first balance interval: fetch customer id 61911 balance intervals collection page
ok 254 - very first balance interval: check interval 77419 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 255 - very first balance interval: check interval 77419 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 256 - very first balance interval: check interval 77419 cash balance 10 = 10
ok 257 - very first balance interval: check interval 77419 billing profile id 1131 = 1131
ok 258 - very first balance interval: check if all expected items are listed
ok 259 - create customercontacts 8
ok 260 - create customers 8
ok 261 - setting customer id 61912 cash_balance to 1000 cents
ok 262 - create subscribers 8
ok 263 - very first balance interval: fetch customer id 61912 balance intervals collection page
ok 264 - very first balance interval: check interval 77420 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 265 - very first balance interval: check interval 77420 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 266 - very first balance interval: check interval 77420 cash balance 10 = 10
ok 267 - very first balance interval: check interval 77420 billing profile id 1134 = 1134
ok 268 - very first balance interval: check if all expected items are listed
ok 269 - cdrs id 50846, 50847, 50848 created
INFO: Trying to connect to billing db...
INFO: Successfully connected to duplication db...
INFO: Trying to connect to provisioning db...
INFO: Successfully connected to provisioning db...
INFO: Trying to connect to accounting db...
INFO: Successfully connected to accounting db...
WARNING: No duplication db credentials, disabled.
INFO: local cdr relation column model loaded
INFO: local cdr cash balance column model loaded
INFO: local cdr time balance column model loaded
INFO: Up and running.
INFO: Grabbed 3 CDRs
DEBUG: start rating CDR ID 50846
DEBUG: 4 contract(s) locked: 61903, 61904, 61909, 61912
INFO: 1/3 - rate CDR ID 50846
DEBUG: fetching source provider info for source_provider_id #61903
DEBUG: catching up contract ID 61903 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61903 billing mapping (reseller) is profile id 1 for time 1515762867.000 from ipv4 source ip 192.168.0.1
DEBUG: source_provider_info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'id' => 77411,
                            'start' => '2018-01-01 00:00:00'
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'reseller',
                         'product_id' => 3,
                         'prepaid' => 0,
                         'profile_id' => 1,
                         'int_unit' => 'month',
                         'contract_id' => '61903'
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: fetching destination provider info for destination_provider_id #61904
DEBUG: catching up contract ID 61904 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61904 billing mapping (reseller) is profile id 1 for time 1515762867.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_provider_info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77412
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'reseller',
                         'product_id' => 3,
                         'prepaid' => 0,
                         'profile_id' => 1,
                         'int_unit' => 'month',
                         'contract_id' => '61904'
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: ### 1. write pass ###
DEBUG: call from local subscriber, source_user_id is 2959f6ff-b8e8-458a-a88e-f08d3f5060c9
DEBUG: call to local subscriber, destination_user_id is 971a0f23-9836-4a06-8c1d-f88ab3892695
DEBUG: destination provider has billing profile 1, get reseller termination cost
DEBUG: calculating call cost for profile_id 1 with type call, direction in, src_user_domain 888151515762707@testa.com.1515762707, dst_user_domain 888281515762707@testb.com.1515762707
DEBUG: no match for full uris, trying user only for profile_id 1 with type call, direction in, src_user_domain 888151515762707, dst_user_domain 888281515762707
DEBUG: 1 contract balance row(s) updated
DEBUG: destination reseller termination cost is 0
DEBUG: get customer termination cost for destination_user_id 971a0f23-9836-4a06-8c1d-f88ab3892695
DEBUG: catching up contract ID 61912 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61912 billing mapping (sipaccount) is profile id 1134 for time 1515762867.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_customer info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '1000',
                            'cash_balance_old' => '1000',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77420
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount',
                         'product_id' => 4,
                         'prepaid' => 0,
                         'profile_id' => 1134,
                         'int_unit' => 'month',
                         'contract_id' => 61912
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1134 with type call, direction in, src_user_domain 888151515762707@testa.com.1515762707, dst_user_domain 888281515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '5',
          'on_follow_interval' => 30,
          'on_init_interval' => 60,
          'on_init_rate' => '5',
          'fee_id' => 1614,
          'off_follow_rate' => '1',
          'source_pattern' => '^8881.+',
          'pattern' => '.',
          'use_free_time' => 0,
          'zone_id' => 503,
          'on_follow_rate' => '1',
          'off_follow_interval' => 30,
          'off_init_interval' => 60
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 5 per sec to costs
DEBUG: interval is 60, so rate for this interval is 300
DEBUG: starting with contract balance: $VAR1 = {
          'free_time_balance_interval' => 0,
          'end_unix' => 1517443199,
          'start_unix' => 1514764800,
          'cash_balance_interval' => '0',
          'free_time_balance_old' => 0,
          'free_time_balance' => 0,
          'cash_balance' => '1000',
          'cash_balance_old' => '1000',
          'start' => '2018-01-01 00:00:00',
          'id' => 77420
        };
DEBUG: we still have cash balance 1000 left, subtract rate 300 from that
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: we still have cash balance 700 left, subtract rate 30 from that
DEBUG: rating_duration = 90
DEBUG: got call cost 0 and free time 0
DEBUG: billing profile is post-paid, update contract balance
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 0
DEBUG: destination customer termination cost is 0
DEBUG: calculating call cost for profile_id 1 with type call, direction out, src_user_domain 888151515762707@testa.com.1515762707, dst_user_domain 888281515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '0',
          'on_follow_interval' => 600,
          'on_init_interval' => 600,
          'on_init_rate' => '0',
          'fee_id' => 1000,
          'off_follow_rate' => '0',
          'source_pattern' => '.',
          'pattern' => '.*',
          'use_free_time' => 0,
          'zone_id' => 1,
          'on_follow_rate' => '0',
          'off_follow_interval' => 600,
          'off_init_interval' => 600
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 0 per sec to costs
DEBUG: interval is 600, so rate for this interval is 0
DEBUG: starting with contract balance: $VAR1 = {
          'end_unix' => 1517443199,
          'free_time_balance_interval' => 0,
          'start_unix' => 1514764800,
          'cash_balance_interval' => 0,
          'free_time_balance' => 0,
          'free_time_balance_old' => 0,
          'cash_balance' => 0,
          'cash_balance_old' => 0,
          'start' => '2018-01-01 00:00:00',
          'id' => 77411
        };
DEBUG: add current interval cost 0 to total cost 0
DEBUG: rating_duration = 600
DEBUG: 1 contract balance row(s) updated
DEBUG: catching up contract ID 61909 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61909 billing mapping (sipaccount) is profile id 1131 for time 1515762867.000 from ipv4 source ip 192.168.0.1
DEBUG: source_customer info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '1000',
                            'cash_balance_old' => '1000',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77417
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount',
                         'product_id' => 4,
                         'prepaid' => 0,
                         'profile_id' => 1131,
                         'int_unit' => 'month',
                         'contract_id' => 61909
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1131 with type call, direction out, src_user_domain 888151515762707@testa.com.1515762707, dst_user_domain 888281515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '6',
          'on_follow_interval' => 30,
          'on_init_interval' => 60,
          'on_init_rate' => '6',
          'fee_id' => 1607,
          'off_follow_rate' => '1',
          'source_pattern' => '.',
          'pattern' => '^8882.+',
          'use_free_time' => 0,
          'zone_id' => 500,
          'on_follow_rate' => '1',
          'off_follow_interval' => 30,
          'off_init_interval' => 60
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 6 per sec to costs
DEBUG: interval is 60, so rate for this interval is 360
DEBUG: starting with contract balance: $VAR1 = {
          'free_time_balance_interval' => 0,
          'end_unix' => 1517443199,
          'start_unix' => 1514764800,
          'cash_balance_interval' => '0',
          'free_time_balance_old' => 0,
          'free_time_balance' => 0,
          'cash_balance' => '1000',
          'cash_balance_old' => '1000',
          'start' => '2018-01-01 00:00:00',
          'id' => 77417
        };
DEBUG: we still have cash balance 1000 left, subtract rate 360 from that
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: we still have cash balance 640 left, subtract rate 30 from that
DEBUG: rating_duration = 90
DEBUG: got call cost 0 and free time 0
DEBUG: billing profile is post-paid, update contract balance
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 0
DEBUG: cdr ID 50846 updated
DEBUG: empty 'source_carrier_cash_balance' local col data for cdr id 50846, skipping
DEBUG: empty 'source_carrier_free_time_balance' local col data for cdr id 50846, skipping
DEBUG: empty 'source_carrier_profile_package_id' local col data for cdr id 50846, skipping
DEBUG: empty 'source_carrier_contract_balance_id' local col data for cdr id 50846, skipping
DEBUG: local col data created or up to date for cdr id 50846, column 'source_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50846, column 'source_reseller_free_time_balance': 0, 0
DEBUG: empty 'source_reseller_profile_package_id' local col data for cdr id 50846, skipping
DEBUG: local col data created or up to date for cdr id 50846, column 'source_reseller_contract_balance_id': 77411
DEBUG: local col data created or up to date for cdr id 50846, column 'source_customer_cash_balance': 1000, 610
DEBUG: local col data created or up to date for cdr id 50846, column 'source_customer_free_time_balance': 0, 0
DEBUG: empty 'source_customer_profile_package_id' local col data for cdr id 50846, skipping
DEBUG: local col data created or up to date for cdr id 50846, column 'source_customer_contract_balance_id': 77417
DEBUG: empty 'destination_carrier_cash_balance' local col data for cdr id 50846, skipping
DEBUG: empty 'destination_carrier_free_time_balance' local col data for cdr id 50846, skipping
DEBUG: empty 'destination_carrier_profile_package_id' local col data for cdr id 50846, skipping
DEBUG: empty 'destination_carrier_contract_balance_id' local col data for cdr id 50846, skipping
DEBUG: local col data created or up to date for cdr id 50846, column 'destination_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50846, column 'destination_reseller_free_time_balance': 0, 0
DEBUG: empty 'destination_reseller_profile_package_id' local col data for cdr id 50846, skipping
DEBUG: local col data created or up to date for cdr id 50846, column 'destination_reseller_contract_balance_id': 77412
DEBUG: local col data created or up to date for cdr id 50846, column 'destination_customer_cash_balance': 1000, 670
DEBUG: local col data created or up to date for cdr id 50846, column 'destination_customer_free_time_balance': 0, 0
DEBUG: empty 'destination_customer_profile_package_id' local col data for cdr id 50846, skipping
DEBUG: local col data created or up to date for cdr id 50846, column 'destination_customer_contract_balance_id': 77420
DEBUG: rating cdr ID 50846 completed successfully in 0.204 secs
DEBUG: start rating CDR ID 50847
DEBUG: 4 contract(s) locked: 61903, 61904, 61910, 61912
INFO: 2/3 - rate CDR ID 50847
DEBUG: fetching source provider info for source_provider_id #61903
DEBUG: catching up contract ID 61903 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61903 billing mapping (reseller) is profile id 1 for time 1515762868.000 from ipv4 source ip 192.168.0.1
DEBUG: source_provider_info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77411
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'reseller',
                         'product_id' => 3,
                         'prepaid' => 0,
                         'profile_id' => 1,
                         'int_unit' => 'month',
                         'contract_id' => '61903'
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: fetching destination provider info for destination_provider_id #61904
DEBUG: catching up contract ID 61904 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61904 billing mapping (reseller) is profile id 1 for time 1515762868.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_provider_info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77412
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'reseller',
                         'product_id' => 3,
                         'prepaid' => 0,
                         'profile_id' => 1,
                         'int_unit' => 'month',
                         'contract_id' => '61904'
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: ### 1. write pass ###
DEBUG: call from local subscriber, source_user_id is 8e60a682-286c-4514-b797-14c58f43ac31
DEBUG: call to local subscriber, destination_user_id is 971a0f23-9836-4a06-8c1d-f88ab3892695
DEBUG: destination provider has billing profile 1, get reseller termination cost
DEBUG: calculating call cost for profile_id 1 with type call, direction in, src_user_domain 888161515762707@testa.com.1515762707, dst_user_domain 888281515762707@testb.com.1515762707
DEBUG: no match for full uris, trying user only for profile_id 1 with type call, direction in, src_user_domain 888161515762707, dst_user_domain 888281515762707
DEBUG: 1 contract balance row(s) updated
DEBUG: destination reseller termination cost is 0
DEBUG: get customer termination cost for destination_user_id 971a0f23-9836-4a06-8c1d-f88ab3892695
DEBUG: catching up contract ID 61912 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61912 billing mapping (sipaccount) is profile id 1134 for time 1515762868.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_customer info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '330',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '670',
                            'cash_balance_old' => '670',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77420
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount',
                         'product_id' => 4,
                         'prepaid' => 0,
                         'profile_id' => 1134,
                         'int_unit' => 'month',
                         'contract_id' => 61912
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1134 with type call, direction in, src_user_domain 888161515762707@testa.com.1515762707, dst_user_domain 888281515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '5',
          'on_follow_interval' => 30,
          'on_init_interval' => 60,
          'on_init_rate' => '5',
          'fee_id' => 1614,
          'off_follow_rate' => '1',
          'source_pattern' => '^8881.+',
          'pattern' => '.',
          'use_free_time' => 0,
          'zone_id' => 503,
          'on_follow_rate' => '1',
          'off_follow_interval' => 30,
          'off_init_interval' => 60
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 5 per sec to costs
DEBUG: interval is 60, so rate for this interval is 300
DEBUG: starting with contract balance: $VAR1 = {
          'free_time_balance_interval' => 0,
          'end_unix' => 1517443199,
          'start_unix' => 1514764800,
          'cash_balance_interval' => '330',
          'free_time_balance_old' => 0,
          'free_time_balance' => 0,
          'cash_balance' => '670',
          'cash_balance_old' => '670',
          'start' => '2018-01-01 00:00:00',
          'id' => 77420
        };
DEBUG: we still have cash balance 670 left, subtract rate 300 from that
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: we still have cash balance 370 left, subtract rate 30 from that
DEBUG: rating_duration = 90
DEBUG: got call cost 0 and free time 0
DEBUG: billing profile is post-paid, update contract balance
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 0
DEBUG: destination customer termination cost is 0
DEBUG: calculating call cost for profile_id 1 with type call, direction out, src_user_domain 888161515762707@testa.com.1515762707, dst_user_domain 888281515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '0',
          'on_follow_interval' => 600,
          'on_init_interval' => 600,
          'on_init_rate' => '0',
          'fee_id' => 1000,
          'off_follow_rate' => '0',
          'source_pattern' => '.',
          'pattern' => '.*',
          'use_free_time' => 0,
          'zone_id' => 1,
          'on_follow_rate' => '0',
          'off_follow_interval' => 600,
          'off_init_interval' => 600
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 0 per sec to costs
DEBUG: interval is 600, so rate for this interval is 0
DEBUG: starting with contract balance: $VAR1 = {
          'end_unix' => 1517443199,
          'free_time_balance_interval' => 0,
          'start_unix' => 1514764800,
          'cash_balance_interval' => 0,
          'free_time_balance' => 0,
          'free_time_balance_old' => 0,
          'cash_balance' => 0,
          'cash_balance_old' => 0,
          'id' => 77411,
          'start' => '2018-01-01 00:00:00'
        };
DEBUG: add current interval cost 0 to total cost 0
DEBUG: rating_duration = 600
DEBUG: 1 contract balance row(s) updated
DEBUG: catching up contract ID 61910 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61910 billing mapping (sipaccount) is profile id 1131 for time 1515762868.000 from ipv4 source ip 192.168.0.1
DEBUG: source_customer info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '1000',
                            'cash_balance_old' => '1000',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77418
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount',
                         'product_id' => 4,
                         'prepaid' => 0,
                         'profile_id' => 1131,
                         'int_unit' => 'month',
                         'contract_id' => 61910
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1131 with type call, direction out, src_user_domain 888161515762707@testa.com.1515762707, dst_user_domain 888281515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '6',
          'on_follow_interval' => 30,
          'on_init_interval' => 60,
          'on_init_rate' => '6',
          'fee_id' => 1607,
          'off_follow_rate' => '1',
          'source_pattern' => '.',
          'pattern' => '^8882.+',
          'use_free_time' => 0,
          'zone_id' => 500,
          'on_follow_rate' => '1',
          'off_follow_interval' => 30,
          'off_init_interval' => 60
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 6 per sec to costs
DEBUG: interval is 60, so rate for this interval is 360
DEBUG: starting with contract balance: $VAR1 = {
          'free_time_balance_interval' => 0,
          'end_unix' => 1517443199,
          'start_unix' => 1514764800,
          'cash_balance_interval' => '0',
          'free_time_balance_old' => 0,
          'free_time_balance' => 0,
          'cash_balance' => '1000',
          'cash_balance_old' => '1000',
          'start' => '2018-01-01 00:00:00',
          'id' => 77418
        };
DEBUG: we still have cash balance 1000 left, subtract rate 360 from that
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: we still have cash balance 640 left, subtract rate 30 from that
DEBUG: rating_duration = 90
DEBUG: got call cost 0 and free time 0
DEBUG: billing profile is post-paid, update contract balance
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 0
DEBUG: cdr ID 50847 updated
DEBUG: empty 'source_carrier_cash_balance' local col data for cdr id 50847, skipping
DEBUG: empty 'source_carrier_free_time_balance' local col data for cdr id 50847, skipping
DEBUG: empty 'source_carrier_profile_package_id' local col data for cdr id 50847, skipping
DEBUG: empty 'source_carrier_contract_balance_id' local col data for cdr id 50847, skipping
DEBUG: local col data created or up to date for cdr id 50847, column 'source_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50847, column 'source_reseller_free_time_balance': 0, 0
DEBUG: empty 'source_reseller_profile_package_id' local col data for cdr id 50847, skipping
DEBUG: local col data created or up to date for cdr id 50847, column 'source_reseller_contract_balance_id': 77411
DEBUG: local col data created or up to date for cdr id 50847, column 'source_customer_cash_balance': 1000, 610
DEBUG: local col data created or up to date for cdr id 50847, column 'source_customer_free_time_balance': 0, 0
DEBUG: empty 'source_customer_profile_package_id' local col data for cdr id 50847, skipping
DEBUG: local col data created or up to date for cdr id 50847, column 'source_customer_contract_balance_id': 77418
DEBUG: empty 'destination_carrier_cash_balance' local col data for cdr id 50847, skipping
DEBUG: empty 'destination_carrier_free_time_balance' local col data for cdr id 50847, skipping
DEBUG: empty 'destination_carrier_profile_package_id' local col data for cdr id 50847, skipping
DEBUG: empty 'destination_carrier_contract_balance_id' local col data for cdr id 50847, skipping
DEBUG: local col data created or up to date for cdr id 50847, column 'destination_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50847, column 'destination_reseller_free_time_balance': 0, 0
DEBUG: empty 'destination_reseller_profile_package_id' local col data for cdr id 50847, skipping
DEBUG: local col data created or up to date for cdr id 50847, column 'destination_reseller_contract_balance_id': 77412
DEBUG: local col data created or up to date for cdr id 50847, column 'destination_customer_cash_balance': 670, 340
DEBUG: local col data created or up to date for cdr id 50847, column 'destination_customer_free_time_balance': 0, 0
DEBUG: empty 'destination_customer_profile_package_id' local col data for cdr id 50847, skipping
DEBUG: local col data created or up to date for cdr id 50847, column 'destination_customer_contract_balance_id': 77420
DEBUG: rating cdr ID 50847 completed successfully in 0.170 secs
DEBUG: start rating CDR ID 50848
DEBUG: 4 contract(s) locked: 61903, 61904, 61911, 61912
INFO: 3/3 - rate CDR ID 50848
DEBUG: fetching source provider info for source_provider_id #61903
DEBUG: catching up contract ID 61903 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61903 billing mapping (reseller) is profile id 1 for time 1515762869.000 from ipv4 source ip 192.168.0.1
DEBUG: source_provider_info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77411
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'reseller',
                         'product_id' => 3,
                         'prepaid' => 0,
                         'profile_id' => 1,
                         'int_unit' => 'month',
                         'contract_id' => '61903'
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: fetching destination provider info for destination_provider_id #61904
DEBUG: catching up contract ID 61904 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61904 billing mapping (reseller) is profile id 1 for time 1515762869.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_provider_info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77412
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'reseller',
                         'product_id' => 3,
                         'prepaid' => 0,
                         'profile_id' => 1,
                         'int_unit' => 'month',
                         'contract_id' => '61904'
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: ### 1. write pass ###
DEBUG: call from local subscriber, source_user_id is aead0db9-be5f-480b-9801-50d0af0dbd84
DEBUG: call to local subscriber, destination_user_id is 971a0f23-9836-4a06-8c1d-f88ab3892695
DEBUG: destination provider has billing profile 1, get reseller termination cost
DEBUG: calculating call cost for profile_id 1 with type call, direction in, src_user_domain 888171515762707@testa.com.1515762707, dst_user_domain 888281515762707@testb.com.1515762707
DEBUG: no match for full uris, trying user only for profile_id 1 with type call, direction in, src_user_domain 888171515762707, dst_user_domain 888281515762707
DEBUG: 1 contract balance row(s) updated
DEBUG: destination reseller termination cost is 0
DEBUG: get customer termination cost for destination_user_id 971a0f23-9836-4a06-8c1d-f88ab3892695
DEBUG: catching up contract ID 61912 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61912 billing mapping (sipaccount) is profile id 1134 for time 1515762869.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_customer info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '660',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '340',
                            'cash_balance_old' => '340',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77420
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount',
                         'product_id' => 4,
                         'prepaid' => 0,
                         'profile_id' => 1134,
                         'int_unit' => 'month',
                         'contract_id' => 61912
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1134 with type call, direction in, src_user_domain 888171515762707@testa.com.1515762707, dst_user_domain 888281515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '5',
          'on_follow_interval' => 30,
          'on_init_interval' => 60,
          'on_init_rate' => '5',
          'fee_id' => 1614,
          'off_follow_rate' => '1',
          'source_pattern' => '^8881.+',
          'pattern' => '.',
          'use_free_time' => 0,
          'zone_id' => 503,
          'on_follow_rate' => '1',
          'off_follow_interval' => 30,
          'off_init_interval' => 60
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 5 per sec to costs
DEBUG: interval is 60, so rate for this interval is 300
DEBUG: starting with contract balance: $VAR1 = {
          'free_time_balance_interval' => 0,
          'end_unix' => 1517443199,
          'start_unix' => 1514764800,
          'cash_balance_interval' => '660',
          'free_time_balance_old' => 0,
          'free_time_balance' => 0,
          'cash_balance' => '340',
          'cash_balance_old' => '340',
          'start' => '2018-01-01 00:00:00',
          'id' => 77420
        };
DEBUG: we still have cash balance 340 left, subtract rate 300 from that
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: we still have cash balance 40 left, subtract rate 30 from that
DEBUG: rating_duration = 90
DEBUG: got call cost 0 and free time 0
DEBUG: billing profile is post-paid, update contract balance
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 0
DEBUG: destination customer termination cost is 0
DEBUG: calculating call cost for profile_id 1 with type call, direction out, src_user_domain 888171515762707@testa.com.1515762707, dst_user_domain 888281515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '0',
          'on_follow_interval' => 600,
          'on_init_interval' => 600,
          'on_init_rate' => '0',
          'fee_id' => 1000,
          'off_follow_rate' => '0',
          'source_pattern' => '.',
          'pattern' => '.*',
          'use_free_time' => 0,
          'zone_id' => 1,
          'on_follow_rate' => '0',
          'off_follow_interval' => 600,
          'off_init_interval' => 600
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 0 per sec to costs
DEBUG: interval is 600, so rate for this interval is 0
DEBUG: starting with contract balance: $VAR1 = {
          'end_unix' => 1517443199,
          'free_time_balance_interval' => 0,
          'start_unix' => 1514764800,
          'cash_balance_interval' => 0,
          'free_time_balance' => 0,
          'free_time_balance_old' => 0,
          'cash_balance' => 0,
          'cash_balance_old' => 0,
          'id' => 77411,
          'start' => '2018-01-01 00:00:00'
        };
DEBUG: add current interval cost 0 to total cost 0
DEBUG: rating_duration = 600
DEBUG: 1 contract balance row(s) updated
DEBUG: catching up contract ID 61911 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61911 billing mapping (sipaccount) is profile id 1131 for time 1515762869.000 from ipv4 source ip 192.168.0.1
DEBUG: source_customer info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '1000',
                            'cash_balance_old' => '1000',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77419
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount',
                         'product_id' => 4,
                         'prepaid' => 0,
                         'profile_id' => 1131,
                         'int_unit' => 'month',
                         'contract_id' => 61911
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1131 with type call, direction out, src_user_domain 888171515762707@testa.com.1515762707, dst_user_domain 888281515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '6',
          'on_follow_interval' => 30,
          'on_init_interval' => 60,
          'on_init_rate' => '6',
          'fee_id' => 1607,
          'off_follow_rate' => '1',
          'source_pattern' => '.',
          'pattern' => '^8882.+',
          'use_free_time' => 0,
          'zone_id' => 500,
          'on_follow_rate' => '1',
          'off_follow_interval' => 30,
          'off_init_interval' => 60
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 6 per sec to costs
DEBUG: interval is 60, so rate for this interval is 360
DEBUG: starting with contract balance: $VAR1 = {
          'free_time_balance_interval' => 0,
          'end_unix' => 1517443199,
          'start_unix' => 1514764800,
          'cash_balance_interval' => '0',
          'free_time_balance_old' => 0,
          'free_time_balance' => 0,
          'cash_balance' => '1000',
          'cash_balance_old' => '1000',
          'start' => '2018-01-01 00:00:00',
          'id' => 77419
        };
DEBUG: we still have cash balance 1000 left, subtract rate 360 from that
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: we still have cash balance 640 left, subtract rate 30 from that
DEBUG: rating_duration = 90
DEBUG: got call cost 0 and free time 0
DEBUG: billing profile is post-paid, update contract balance
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 0
DEBUG: cdr ID 50848 updated
DEBUG: empty 'source_carrier_cash_balance' local col data for cdr id 50848, skipping
DEBUG: empty 'source_carrier_free_time_balance' local col data for cdr id 50848, skipping
DEBUG: empty 'source_carrier_profile_package_id' local col data for cdr id 50848, skipping
DEBUG: empty 'source_carrier_contract_balance_id' local col data for cdr id 50848, skipping
DEBUG: local col data created or up to date for cdr id 50848, column 'source_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50848, column 'source_reseller_free_time_balance': 0, 0
DEBUG: empty 'source_reseller_profile_package_id' local col data for cdr id 50848, skipping
DEBUG: local col data created or up to date for cdr id 50848, column 'source_reseller_contract_balance_id': 77411
DEBUG: local col data created or up to date for cdr id 50848, column 'source_customer_cash_balance': 1000, 610
DEBUG: local col data created or up to date for cdr id 50848, column 'source_customer_free_time_balance': 0, 0
DEBUG: empty 'source_customer_profile_package_id' local col data for cdr id 50848, skipping
DEBUG: local col data created or up to date for cdr id 50848, column 'source_customer_contract_balance_id': 77419
DEBUG: empty 'destination_carrier_cash_balance' local col data for cdr id 50848, skipping
DEBUG: empty 'destination_carrier_free_time_balance' local col data for cdr id 50848, skipping
DEBUG: empty 'destination_carrier_profile_package_id' local col data for cdr id 50848, skipping
DEBUG: empty 'destination_carrier_contract_balance_id' local col data for cdr id 50848, skipping
DEBUG: local col data created or up to date for cdr id 50848, column 'destination_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50848, column 'destination_reseller_free_time_balance': 0, 0
DEBUG: empty 'destination_reseller_profile_package_id' local col data for cdr id 50848, skipping
DEBUG: local col data created or up to date for cdr id 50848, column 'destination_reseller_contract_balance_id': 77412
DEBUG: local col data created or up to date for cdr id 50848, column 'destination_customer_cash_balance': 340, 10
DEBUG: local col data created or up to date for cdr id 50848, column 'destination_customer_free_time_balance': 0, 0
DEBUG: empty 'destination_customer_profile_package_id' local col data for cdr id 50848, skipping
DEBUG: local col data created or up to date for cdr id 50848, column 'destination_customer_contract_balance_id': 77420
DEBUG: rating cdr ID 50848 completed successfully in 0.169 secs
INFO: Batch of 3 CDRs completed. 3 CDRs rated overall so far.
INFO: Less than 5 new CDRs, sleep 10
ok 270 - rate-o-mat executed
not ok 271 - postpaid, balance: destination_reseller_cost = 90.000000
ok 272 - postpaid, balance: id = 50848
not ok 273 - postpaid, balance: source_reseller_cost = 150.000000
ok 274 - postpaid, balance: rating_status = ok
ok 275 - postpaid, balance: source_customer_cost = 0.000000
ok 276 - postpaid, balance: destination_customer_cost = 0.000000
ok 277 - postpaid, balance: destination_customer_cost = 0.000000
ok 278 - postpaid, balance: source_customer_cost = 0.000000
not ok 279 - postpaid, balance: source_reseller_cost = 150.000000
ok 280 - postpaid, balance: rating_status = ok
ok 281 - postpaid, balance: id = 50846
not ok 282 - postpaid, balance: destination_reseller_cost = 90.000000
not ok 283 - postpaid, balance: destination_reseller_cost = 90.000000
not ok 284 - postpaid, balance: source_reseller_cost = 150.000000
ok 285 - postpaid, balance: id = 50847
ok 286 - postpaid, balance: rating_status = ok
ok 287 - postpaid, balance: destination_customer_cost = 0.000000
ok 288 - postpaid, balance: source_customer_cost = 0.000000
not ok 289 - cdrs were all processed
ok 290 - postpaid, balance, caller 1: cdr id 50846 source_customer_contract_balance_id number of records 1 = 1
ok 291 - postpaid, balance, caller 1: fetch customer id 61909 balance intervals collection page
ok 292 - postpaid, balance, caller 1: check 'total_count' of collection
ok 293 - postpaid, balance, caller 1: check interval 77417 cash balance 6.1 = 6.1
ok 294 - postpaid, balance, caller 1: check interval 77417 cash balance interval 3.9 = 3.9
ok 295 - postpaid, balance, caller 1: check interval 77417 id = 77417
ok 296 - postpaid, balance, caller 1: check if all expected items are listed
ok 297 - postpaid, balance, caller 1: cdr id 50846 source_customer_cash_balance before 1000.0000 = 1000.0000
ok 298 - postpaid, balance, caller 1: cdr id 50846 source_customer_cash_balance after 610.0000 = 610.0000
ok 299 - postpaid, balance, caller 2: cdr id 50847 source_customer_contract_balance_id number of records 1 = 1
ok 300 - postpaid, balance, caller 2: fetch customer id 61910 balance intervals collection page
ok 301 - postpaid, balance, caller 2: check 'total_count' of collection
ok 302 - postpaid, balance, caller 2: check interval 77418 cash balance 6.1 = 6.1
ok 303 - postpaid, balance, caller 2: check interval 77418 cash balance interval 3.9 = 3.9
ok 304 - postpaid, balance, caller 2: check interval 77418 id = 77418
ok 305 - postpaid, balance, caller 2: check if all expected items are listed
ok 306 - postpaid, balance, caller 2: cdr id 50847 source_customer_cash_balance before 1000.0000 = 1000.0000
ok 307 - postpaid, balance, caller 2: cdr id 50847 source_customer_cash_balance after 610.0000 = 610.0000
ok 308 - postpaid, balance, caller 3: cdr id 50848 source_customer_contract_balance_id number of records 1 = 1
ok 309 - postpaid, balance, caller 3: fetch customer id 61911 balance intervals collection page
ok 310 - postpaid, balance, caller 3: check 'total_count' of collection
ok 311 - postpaid, balance, caller 3: check interval 77419 cash balance 6.1 = 6.1
ok 312 - postpaid, balance, caller 3: check interval 77419 cash balance interval 3.9 = 3.9
ok 313 - postpaid, balance, caller 3: check interval 77419 id = 77419
ok 314 - postpaid, balance, caller 3: check if all expected items are listed
ok 315 - postpaid, balance, caller 3: cdr id 50848 source_customer_cash_balance before 1000.0000 = 1000.0000
ok 316 - postpaid, balance, caller 3: cdr id 50848 source_customer_cash_balance after 610.0000 = 610.0000
ok 317 - postpaid, balance, callee: cdr id 50846 destination_customer_contract_balance_id number of records 1 = 1
ok 318 - postpaid, balance, callee: fetch customer id 61912 balance intervals collection page
ok 319 - postpaid, balance, callee: check 'total_count' of collection
ok 320 - postpaid, balance, callee: check interval 77420 cash balance 0.1 = 0.1
ok 321 - postpaid, balance, callee: check interval 77420 cash balance interval 9.9 = 9.9
ok 322 - postpaid, balance, callee: check interval 77420 id = 77420
ok 323 - postpaid, balance, callee: check if all expected items are listed
ok 324 - postpaid, balance, callee: cdr id 50846 destination_customer_contract_balance_id 77420 = 77420
ok 325 - postpaid, balance, callee: cdr id 50846 destination_customer_cash_balance before 1000.0000 = 1000.0000
ok 326 - postpaid, balance, callee: cdr id 50846 destination_customer_cash_balance after 670.0000 = 670.0000
ok 327 - postpaid, balance, callee: cdr id 50847 destination_customer_contract_balance_id 77420 = 77420
ok 328 - postpaid, balance, callee: cdr id 50847 destination_customer_cash_balance before 670.0000 = 670.0000
ok 329 - postpaid, balance, callee: cdr id 50847 destination_customer_cash_balance after 340.0000 = 340.0000
ok 330 - postpaid, balance, callee: cdr id 50848 destination_customer_contract_balance_id 77420 = 77420
ok 331 - postpaid, balance, callee: cdr id 50848 destination_customer_cash_balance before 340.0000 = 340.0000
ok 332 - postpaid, balance, callee: cdr id 50848 destination_customer_cash_balance after 10.0000 = 10.0000
ok 333 - postpaid, balance, callers' provider: cdr id 50846 source_reseller_contract_balance_id number of records 1 = 1
ok 334 - postpaid, balance, callers' provider: fetch customer id 61903 balance intervals collection page
ok 335 - postpaid, balance, callers' provider: check 'total_count' of collection
not ok 336 - postpaid, balance, callers' provider: check interval 77411 cash balance interval 0 = 9
ok 337 - postpaid, balance, callers' provider: check interval 77411 id = 77411
ok 338 - postpaid, balance, callers' provider: check if all expected items are listed
ok 339 - postpaid, balance, callers' provider: cdr id 50846 source_carrier_contract_balance_id number of records 0 = 0
ok 340 - postpaid, balance, callers' provider: cdr id 50846 source_reseller_contract_balance_id 77411 = 77411
ok 341 - postpaid, balance, callers' provider: cdr id 50847 source_carrier_contract_balance_id number of records 0 = 0
ok 342 - postpaid, balance, callers' provider: cdr id 50847 source_reseller_contract_balance_id 77411 = 77411
ok 343 - postpaid, balance, callers' provider: cdr id 50848 source_carrier_contract_balance_id number of records 0 = 0
ok 344 - postpaid, balance, callers' provider: cdr id 50848 source_reseller_contract_balance_id 77411 = 77411
ok 345 - postpaid, balance, callee's provider: cdr id 50846 destination_reseller_contract_balance_id number of records 1 = 1
ok 346 - postpaid, balance, callee's provider: fetch customer id 61904 balance intervals collection page
ok 347 - postpaid, balance, callee's provider: check 'total_count' of collection
not ok 348 - postpaid, balance, callee's provider: check interval 77412 cash balance interval 0 = 5.4
ok 349 - postpaid, balance, callee's provider: check interval 77412 id = 77412
ok 350 - postpaid, balance, callee's provider: check if all expected items are listed
ok 351 - postpaid, balance, callee's provider: cdr id 50846 destination_carrier_contract_balance_id number of records 0 = 0
ok 352 - postpaid, balance, callee's provider: cdr id 50846 destination_reseller_contract_balance_id 77412 = 77412
ok 353 - postpaid, balance, callee's provider: cdr id 50847 destination_carrier_contract_balance_id number of records 0 = 0
ok 354 - postpaid, balance, callee's provider: cdr id 50847 destination_reseller_contract_balance_id 77412 = 77412
ok 355 - postpaid, balance, callee's provider: cdr id 50848 destination_carrier_contract_balance_id number of records 0 = 0
ok 356 - postpaid, balance, callee's provider: cdr id 50848 destination_reseller_contract_balance_id 77412 = 77412
ok 357 - postpaid, balance providers and subscriber must not have a profile package: cdr id 50846 source_carrier_profile_package_id number of records 0 = 0
ok 358 - postpaid, balance providers and subscriber must not have a profile package: cdr id 50846 source_reseller_profile_package_id number of records 0 = 0
ok 359 - postpaid, balance providers and subscriber must not have a profile package: cdr id 50846 source_customer_profile_package_id number of records 0 = 0
ok 360 - postpaid, balance providers and subscriber must not have a profile package: cdr id 50846 destination_carrier_profile_package_id number of records 0 = 0
ok 361 - postpaid, balance providers and subscriber must not have a profile package: cdr id 50846 destination_reseller_profile_package_id number of records 0 = 0
ok 362 - postpaid, balance providers and subscriber must not have a profile package: cdr id 50846 destination_customer_profile_package_id number of records 0 = 0
ok 363 - postpaid, balance providers and subscriber must not have a profile package: cdr id 50847 source_carrier_profile_package_id number of records 0 = 0
ok 364 - postpaid, balance providers and subscriber must not have a profile package: cdr id 50847 source_reseller_profile_package_id number of records 0 = 0
ok 365 - postpaid, balance providers and subscriber must not have a profile package: cdr id 50847 source_customer_profile_package_id number of records 0 = 0
ok 366 - postpaid, balance providers and subscriber must not have a profile package: cdr id 50847 destination_carrier_profile_package_id number of records 0 = 0
ok 367 - postpaid, balance providers and subscriber must not have a profile package: cdr id 50847 destination_reseller_profile_package_id number of records 0 = 0
ok 368 - postpaid, balance providers and subscriber must not have a profile package: cdr id 50847 destination_customer_profile_package_id number of records 0 = 0
ok 369 - postpaid, balance providers and subscriber must not have a profile package: cdr id 50848 source_carrier_profile_package_id number of records 0 = 0
ok 370 - postpaid, balance providers and subscriber must not have a profile package: cdr id 50848 source_reseller_profile_package_id number of records 0 = 0
ok 371 - postpaid, balance providers and subscriber must not have a profile package: cdr id 50848 source_customer_profile_package_id number of records 0 = 0
ok 372 - postpaid, balance providers and subscriber must not have a profile package: cdr id 50848 destination_carrier_profile_package_id number of records 0 = 0
ok 373 - postpaid, balance providers and subscriber must not have a profile package: cdr id 50848 destination_reseller_profile_package_id number of records 0 = 0
ok 374 - postpaid, balance providers and subscriber must not have a profile package: cdr id 50848 destination_customer_profile_package_id number of records 0 = 0
ok 375 - postpaid, balance providers and subscriber must have zero free time: cdr id 50846 source_carrier_free_time_balance number of records 0 = 0
ok 376 - postpaid, balance providers and subscriber must have zero free time: cdr id 50846 source_reseller_free_time_balance before 0 = 0
ok 377 - postpaid, balance providers and subscriber must have zero free time: cdr id 50846 source_reseller_free_time_balance after 0 = 0
ok 378 - postpaid, balance providers and subscriber must have zero free time: cdr id 50846 source_customer_free_time_balance before 0 = 0
ok 379 - postpaid, balance providers and subscriber must have zero free time: cdr id 50846 source_customer_free_time_balance after 0 = 0
ok 380 - postpaid, balance providers and subscriber must have zero free time: cdr id 50846 destination_carrier_free_time_balance number of records 0 = 0
ok 381 - postpaid, balance providers and subscriber must have zero free time: cdr id 50846 destination_reseller_free_time_balance before 0 = 0
ok 382 - postpaid, balance providers and subscriber must have zero free time: cdr id 50846 destination_reseller_free_time_balance after 0 = 0
ok 383 - postpaid, balance providers and subscriber must have zero free time: cdr id 50846 destination_customer_free_time_balance before 0 = 0
ok 384 - postpaid, balance providers and subscriber must have zero free time: cdr id 50846 destination_customer_free_time_balance after 0 = 0
ok 385 - postpaid, balance providers and subscriber must have zero free time: cdr id 50847 source_carrier_free_time_balance number of records 0 = 0
ok 386 - postpaid, balance providers and subscriber must have zero free time: cdr id 50847 source_reseller_free_time_balance before 0 = 0
ok 387 - postpaid, balance providers and subscriber must have zero free time: cdr id 50847 source_reseller_free_time_balance after 0 = 0
ok 388 - postpaid, balance providers and subscriber must have zero free time: cdr id 50847 source_customer_free_time_balance before 0 = 0
ok 389 - postpaid, balance providers and subscriber must have zero free time: cdr id 50847 source_customer_free_time_balance after 0 = 0
ok 390 - postpaid, balance providers and subscriber must have zero free time: cdr id 50847 destination_carrier_free_time_balance number of records 0 = 0
ok 391 - postpaid, balance providers and subscriber must have zero free time: cdr id 50847 destination_reseller_free_time_balance before 0 = 0
ok 392 - postpaid, balance providers and subscriber must have zero free time: cdr id 50847 destination_reseller_free_time_balance after 0 = 0
ok 393 - postpaid, balance providers and subscriber must have zero free time: cdr id 50847 destination_customer_free_time_balance before 0 = 0
ok 394 - postpaid, balance providers and subscriber must have zero free time: cdr id 50847 destination_customer_free_time_balance after 0 = 0
ok 395 - postpaid, balance providers and subscriber must have zero free time: cdr id 50848 source_carrier_free_time_balance number of records 0 = 0
ok 396 - postpaid, balance providers and subscriber must have zero free time: cdr id 50848 source_reseller_free_time_balance before 0 = 0
ok 397 - postpaid, balance providers and subscriber must have zero free time: cdr id 50848 source_reseller_free_time_balance after 0 = 0
ok 398 - postpaid, balance providers and subscriber must have zero free time: cdr id 50848 source_customer_free_time_balance before 0 = 0
ok 399 - postpaid, balance providers and subscriber must have zero free time: cdr id 50848 source_customer_free_time_balance after 0 = 0
ok 400 - postpaid, balance providers and subscriber must have zero free time: cdr id 50848 destination_carrier_free_time_balance number of records 0 = 0
ok 401 - postpaid, balance providers and subscriber must have zero free time: cdr id 50848 destination_reseller_free_time_balance before 0 = 0
ok 402 - postpaid, balance providers and subscriber must have zero free time: cdr id 50848 destination_reseller_free_time_balance after 0 = 0
ok 403 - postpaid, balance providers and subscriber must have zero free time: cdr id 50848 destination_customer_free_time_balance before 0 = 0
ok 404 - postpaid, balance providers and subscriber must have zero free time: cdr id 50848 destination_customer_free_time_balance after 0 = 0
ok 405 - postpaid, balance providers must have zero balance: cdr id 50846 source_carrier_cash_balance number of records 0 = 0
ok 406 - postpaid, balance providers must have zero balance: cdr id 50846 source_reseller_cash_balance before 0.0000 = 0.0000
ok 407 - postpaid, balance providers must have zero balance: cdr id 50846 source_reseller_cash_balance after 0.0000 = 0.0000
ok 408 - postpaid, balance providers must have zero balance: cdr id 50846 destination_carrier_cash_balance number of records 0 = 0
ok 409 - postpaid, balance providers must have zero balance: cdr id 50846 destination_reseller_cash_balance before 0.0000 = 0.0000
ok 410 - postpaid, balance providers must have zero balance: cdr id 50846 destination_reseller_cash_balance after 0.0000 = 0.0000
ok 411 - postpaid, balance providers must have zero balance: cdr id 50847 source_carrier_cash_balance number of records 0 = 0
ok 412 - postpaid, balance providers must have zero balance: cdr id 50847 source_reseller_cash_balance before 0.0000 = 0.0000
ok 413 - postpaid, balance providers must have zero balance: cdr id 50847 source_reseller_cash_balance after 0.0000 = 0.0000
ok 414 - postpaid, balance providers must have zero balance: cdr id 50847 destination_carrier_cash_balance number of records 0 = 0
ok 415 - postpaid, balance providers must have zero balance: cdr id 50847 destination_reseller_cash_balance before 0.0000 = 0.0000
ok 416 - postpaid, balance providers must have zero balance: cdr id 50847 destination_reseller_cash_balance after 0.0000 = 0.0000
ok 417 - postpaid, balance providers must have zero balance: cdr id 50848 source_carrier_cash_balance number of records 0 = 0
ok 418 - postpaid, balance providers must have zero balance: cdr id 50848 source_reseller_cash_balance before 0.0000 = 0.0000
ok 419 - postpaid, balance providers must have zero balance: cdr id 50848 source_reseller_cash_balance after 0.0000 = 0.0000
ok 420 - postpaid, balance providers must have zero balance: cdr id 50848 destination_carrier_cash_balance number of records 0 = 0
ok 421 - postpaid, balance providers must have zero balance: cdr id 50848 destination_reseller_cash_balance before 0.0000 = 0.0000
ok 422 - postpaid, balance providers must have zero balance: cdr id 50848 destination_reseller_cash_balance after 0.0000 = 0.0000
ok 423 - create customercontacts 9
ok 424 - create customers 9
ok 425 - setting customer id 61913 cash_balance to 0 cents
ok 426 - create subscribers 9
ok 427 - very first balance interval: fetch customer id 61913 balance intervals collection page
ok 428 - very first balance interval: check interval 77421 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 429 - very first balance interval: check interval 77421 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 430 - very first balance interval: check interval 77421 cash balance 0 = 0
ok 431 - very first balance interval: check interval 77421 billing profile id 1132 = 1132
ok 432 - very first balance interval: check if all expected items are listed
ok 433 - create customercontacts 10
ok 434 - create customers 10
ok 435 - setting customer id 61914 cash_balance to 0 cents
ok 436 - create subscribers 10
ok 437 - very first balance interval: fetch customer id 61914 balance intervals collection page
ok 438 - very first balance interval: check interval 77422 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 439 - very first balance interval: check interval 77422 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 440 - very first balance interval: check interval 77422 cash balance 0 = 0
ok 441 - very first balance interval: check interval 77422 billing profile id 1132 = 1132
ok 442 - very first balance interval: check if all expected items are listed
ok 443 - create customercontacts 11
ok 444 - create customers 11
ok 445 - setting customer id 61915 cash_balance to 0 cents
ok 446 - create subscribers 11
ok 447 - very first balance interval: fetch customer id 61915 balance intervals collection page
ok 448 - very first balance interval: check interval 77423 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 449 - very first balance interval: check interval 77423 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 450 - very first balance interval: check interval 77423 cash balance 0 = 0
ok 451 - very first balance interval: check interval 77423 billing profile id 1132 = 1132
ok 452 - very first balance interval: check if all expected items are listed
ok 453 - create customercontacts 12
ok 454 - create customers 12
ok 455 - setting customer id 61916 cash_balance to 0 cents
ok 456 - create subscribers 12
ok 457 - very first balance interval: fetch customer id 61916 balance intervals collection page
ok 458 - very first balance interval: check interval 77424 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 459 - very first balance interval: check interval 77424 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 460 - very first balance interval: check interval 77424 cash balance 0 = 0
ok 461 - very first balance interval: check interval 77424 billing profile id 1135 = 1135
ok 462 - very first balance interval: check if all expected items are listed
ok 463 - cdrs id 50849, 50850, 50851 created
INFO: Trying to connect to billing db...
INFO: Successfully connected to duplication db...
INFO: Trying to connect to provisioning db...
INFO: Successfully connected to provisioning db...
INFO: Trying to connect to accounting db...
INFO: Successfully connected to accounting db...
WARNING: No duplication db credentials, disabled.
INFO: local cdr relation column model loaded
INFO: local cdr cash balance column model loaded
INFO: local cdr time balance column model loaded
INFO: Up and running.
INFO: Grabbed 3 CDRs
DEBUG: start rating CDR ID 50849
DEBUG: 4 contract(s) locked: 61903, 61904, 61913, 61916
INFO: 1/3 - rate CDR ID 50849
DEBUG: fetching source provider info for source_provider_id #61903
DEBUG: catching up contract ID 61903 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61903 billing mapping (reseller) is profile id 1 for time 1515762925.000 from ipv4 source ip 192.168.0.1
DEBUG: source_provider_info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'id' => 77411,
                            'start' => '2018-01-01 00:00:00'
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'reseller',
                         'product_id' => 3,
                         'prepaid' => 0,
                         'profile_id' => 1,
                         'int_unit' => 'month',
                         'contract_id' => '61903'
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: fetching destination provider info for destination_provider_id #61904
DEBUG: catching up contract ID 61904 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61904 billing mapping (reseller) is profile id 1 for time 1515762925.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_provider_info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77412
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'reseller',
                         'product_id' => 3,
                         'prepaid' => 0,
                         'profile_id' => 1,
                         'int_unit' => 'month',
                         'contract_id' => '61904'
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: ### 1. write pass ###
DEBUG: call from local subscriber, source_user_id is 264795ee-8673-4c91-952d-83f919320323
DEBUG: call to local subscriber, destination_user_id is 21494937-f9a1-4080-8474-5654dbbd82ff
DEBUG: destination provider has billing profile 1, get reseller termination cost
DEBUG: calculating call cost for profile_id 1 with type call, direction in, src_user_domain 888191515762707@testa.com.1515762707, dst_user_domain 8882121515762707@testb.com.1515762707
DEBUG: no match for full uris, trying user only for profile_id 1 with type call, direction in, src_user_domain 888191515762707, dst_user_domain 8882121515762707
DEBUG: 1 contract balance row(s) updated
DEBUG: destination reseller termination cost is 0
DEBUG: get customer termination cost for destination_user_id 21494937-f9a1-4080-8474-5654dbbd82ff
DEBUG: catching up contract ID 61916 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61916 billing mapping (sipaccount) is profile id 1135 for time 1515762925.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_customer info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77424
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount',
                         'product_id' => 4,
                         'prepaid' => 1,
                         'profile_id' => 1135,
                         'int_unit' => 'month',
                         'contract_id' => 61916
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1135 with type call, direction in, src_user_domain 888191515762707@testa.com.1515762707, dst_user_domain 8882121515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '3',
          'on_follow_interval' => 30,
          'on_init_interval' => 60,
          'on_init_rate' => '3',
          'fee_id' => 1616,
          'off_follow_rate' => '1',
          'source_pattern' => '^8881.+',
          'pattern' => '.',
          'use_free_time' => 0,
          'zone_id' => 504,
          'on_follow_rate' => '1',
          'off_follow_interval' => 30,
          'off_init_interval' => 60
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 3 per sec to costs
DEBUG: interval is 60, so rate for this interval is 180
DEBUG: starting with contract balance: $VAR1 = {
          'free_time_balance_interval' => 0,
          'end_unix' => 1517443199,
          'start_unix' => 1514764800,
          'cash_balance_interval' => '0',
          'free_time_balance_old' => 0,
          'free_time_balance' => 0,
          'cash_balance' => '0',
          'cash_balance_old' => '0',
          'start' => '2018-01-01 00:00:00',
          'id' => 77424
        };
DEBUG: add current interval cost 180 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 180
DEBUG: rating_duration = 90
DEBUG: got call cost 210 and free time 0
DEBUG: treat pre-paid billing profile as post-paid for termination fees
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 210
DEBUG: destination customer termination cost is 210
DEBUG: calculating call cost for profile_id 1 with type call, direction out, src_user_domain 888191515762707@testa.com.1515762707, dst_user_domain 8882121515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '0',
          'on_follow_interval' => 600,
          'on_init_interval' => 600,
          'on_init_rate' => '0',
          'fee_id' => 1000,
          'off_follow_rate' => '0',
          'source_pattern' => '.',
          'pattern' => '.*',
          'use_free_time' => 0,
          'zone_id' => 1,
          'on_follow_rate' => '0',
          'off_follow_interval' => 600,
          'off_init_interval' => 600
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 0 per sec to costs
DEBUG: interval is 600, so rate for this interval is 0
DEBUG: starting with contract balance: $VAR1 = {
          'end_unix' => 1517443199,
          'free_time_balance_interval' => 0,
          'start_unix' => 1514764800,
          'cash_balance_interval' => 0,
          'free_time_balance' => 0,
          'free_time_balance_old' => 0,
          'cash_balance' => 0,
          'cash_balance_old' => 0,
          'start' => '2018-01-01 00:00:00',
          'id' => 77411
        };
DEBUG: add current interval cost 0 to total cost 0
DEBUG: rating_duration = 600
DEBUG: 1 contract balance row(s) updated
DEBUG: catching up contract ID 61913 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61913 billing mapping (sipaccount) is profile id 1132 for time 1515762925.000 from ipv4 source ip 192.168.0.1
DEBUG: source_customer info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77421
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount',
                         'product_id' => 4,
                         'prepaid' => 1,
                         'profile_id' => 1132,
                         'int_unit' => 'month',
                         'contract_id' => 61913
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: billing profile is prepaid
DEBUG: empty prepaid_costs cache, populate it
DEBUG: prepaid_costs cache populated, 0 records
DEBUG: calculating call cost for profile_id 1132 with type call, direction out, src_user_domain 888191515762707@testa.com.1515762707, dst_user_domain 8882121515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '4',
          'on_follow_interval' => 30,
          'on_init_interval' => 60,
          'on_init_rate' => '4',
          'fee_id' => 1609,
          'off_follow_rate' => '1',
          'source_pattern' => '.',
          'pattern' => '^8882.+',
          'use_free_time' => 0,
          'zone_id' => 501,
          'on_follow_rate' => '1',
          'off_follow_interval' => 30,
          'off_init_interval' => 60
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 4 per sec to costs
DEBUG: interval is 60, so rate for this interval is 240
DEBUG: starting with contract balance: $VAR1 = {
          'free_time_balance_interval' => 0,
          'end_unix' => 1517443199,
          'start_unix' => 1514764800,
          'cash_balance_interval' => '0',
          'free_time_balance_old' => 0,
          'free_time_balance' => 0,
          'cash_balance' => '0',
          'cash_balance_old' => '0',
          'start' => '2018-01-01 00:00:00',
          'id' => 77421
        };
DEBUG: add current interval cost 240 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 240
DEBUG: rating_duration = 90
DEBUG: got call cost 270 and free time 0
WARNING: no prepaid cost record found for call ID *TEST*XnARyguNbKfgnX0zc3Lc6PWdCa, applying calculated costs
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 270
DEBUG: cdr ID 50849 updated
DEBUG: empty 'source_carrier_cash_balance' local col data for cdr id 50849, skipping
DEBUG: empty 'source_carrier_free_time_balance' local col data for cdr id 50849, skipping
DEBUG: empty 'source_carrier_profile_package_id' local col data for cdr id 50849, skipping
DEBUG: empty 'source_carrier_contract_balance_id' local col data for cdr id 50849, skipping
DEBUG: local col data created or up to date for cdr id 50849, column 'source_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50849, column 'source_reseller_free_time_balance': 0, 0
DEBUG: empty 'source_reseller_profile_package_id' local col data for cdr id 50849, skipping
DEBUG: local col data created or up to date for cdr id 50849, column 'source_reseller_contract_balance_id': 77411
DEBUG: local col data created or up to date for cdr id 50849, column 'source_customer_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50849, column 'source_customer_free_time_balance': 0, 0
DEBUG: empty 'source_customer_profile_package_id' local col data for cdr id 50849, skipping
DEBUG: local col data created or up to date for cdr id 50849, column 'source_customer_contract_balance_id': 77421
DEBUG: empty 'destination_carrier_cash_balance' local col data for cdr id 50849, skipping
DEBUG: empty 'destination_carrier_free_time_balance' local col data for cdr id 50849, skipping
DEBUG: empty 'destination_carrier_profile_package_id' local col data for cdr id 50849, skipping
DEBUG: empty 'destination_carrier_contract_balance_id' local col data for cdr id 50849, skipping
DEBUG: local col data created or up to date for cdr id 50849, column 'destination_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50849, column 'destination_reseller_free_time_balance': 0, 0
DEBUG: empty 'destination_reseller_profile_package_id' local col data for cdr id 50849, skipping
DEBUG: local col data created or up to date for cdr id 50849, column 'destination_reseller_contract_balance_id': 77412
DEBUG: local col data created or up to date for cdr id 50849, column 'destination_customer_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50849, column 'destination_customer_free_time_balance': 0, 0
DEBUG: empty 'destination_customer_profile_package_id' local col data for cdr id 50849, skipping
DEBUG: local col data created or up to date for cdr id 50849, column 'destination_customer_contract_balance_id': 77424
DEBUG: rating cdr ID 50849 completed successfully in 0.221 secs
DEBUG: start rating CDR ID 50850
DEBUG: 4 contract(s) locked: 61903, 61904, 61914, 61916
INFO: 2/3 - rate CDR ID 50850
DEBUG: fetching source provider info for source_provider_id #61903
DEBUG: catching up contract ID 61903 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61903 billing mapping (reseller) is profile id 1 for time 1515762926.000 from ipv4 source ip 192.168.0.1
DEBUG: source_provider_info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77411
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'reseller',
                         'product_id' => 3,
                         'prepaid' => 0,
                         'profile_id' => 1,
                         'int_unit' => 'month',
                         'contract_id' => '61903'
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: fetching destination provider info for destination_provider_id #61904
DEBUG: catching up contract ID 61904 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61904 billing mapping (reseller) is profile id 1 for time 1515762926.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_provider_info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77412
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'reseller',
                         'product_id' => 3,
                         'prepaid' => 0,
                         'profile_id' => 1,
                         'int_unit' => 'month',
                         'contract_id' => '61904'
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: ### 1. write pass ###
DEBUG: call from local subscriber, source_user_id is d038649d-1d95-4a43-9a03-535ddfa0ce93
DEBUG: call to local subscriber, destination_user_id is 21494937-f9a1-4080-8474-5654dbbd82ff
DEBUG: destination provider has billing profile 1, get reseller termination cost
DEBUG: calculating call cost for profile_id 1 with type call, direction in, src_user_domain 8881101515762707@testa.com.1515762707, dst_user_domain 8882121515762707@testb.com.1515762707
DEBUG: no match for full uris, trying user only for profile_id 1 with type call, direction in, src_user_domain 8881101515762707, dst_user_domain 8882121515762707
DEBUG: 1 contract balance row(s) updated
DEBUG: destination reseller termination cost is 0
DEBUG: get customer termination cost for destination_user_id 21494937-f9a1-4080-8474-5654dbbd82ff
DEBUG: catching up contract ID 61916 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61916 billing mapping (sipaccount) is profile id 1135 for time 1515762926.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_customer info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '210',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77424
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount',
                         'product_id' => 4,
                         'prepaid' => 1,
                         'profile_id' => 1135,
                         'int_unit' => 'month',
                         'contract_id' => 61916
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1135 with type call, direction in, src_user_domain 8881101515762707@testa.com.1515762707, dst_user_domain 8882121515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '3',
          'on_follow_interval' => 30,
          'on_init_interval' => 60,
          'on_init_rate' => '3',
          'fee_id' => 1616,
          'off_follow_rate' => '1',
          'source_pattern' => '^8881.+',
          'pattern' => '.',
          'use_free_time' => 0,
          'zone_id' => 504,
          'on_follow_rate' => '1',
          'off_follow_interval' => 30,
          'off_init_interval' => 60
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 3 per sec to costs
DEBUG: interval is 60, so rate for this interval is 180
DEBUG: starting with contract balance: $VAR1 = {
          'free_time_balance_interval' => 0,
          'end_unix' => 1517443199,
          'start_unix' => 1514764800,
          'cash_balance_interval' => '210',
          'free_time_balance_old' => 0,
          'free_time_balance' => 0,
          'cash_balance' => '0',
          'cash_balance_old' => '0',
          'start' => '2018-01-01 00:00:00',
          'id' => 77424
        };
DEBUG: add current interval cost 180 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 180
DEBUG: rating_duration = 90
DEBUG: got call cost 210 and free time 0
DEBUG: treat pre-paid billing profile as post-paid for termination fees
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 210
DEBUG: destination customer termination cost is 210
DEBUG: calculating call cost for profile_id 1 with type call, direction out, src_user_domain 8881101515762707@testa.com.1515762707, dst_user_domain 8882121515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '0',
          'on_follow_interval' => 600,
          'on_init_interval' => 600,
          'on_init_rate' => '0',
          'fee_id' => 1000,
          'off_follow_rate' => '0',
          'source_pattern' => '.',
          'pattern' => '.*',
          'use_free_time' => 0,
          'zone_id' => 1,
          'on_follow_rate' => '0',
          'off_follow_interval' => 600,
          'off_init_interval' => 600
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 0 per sec to costs
DEBUG: interval is 600, so rate for this interval is 0
DEBUG: starting with contract balance: $VAR1 = {
          'end_unix' => 1517443199,
          'free_time_balance_interval' => 0,
          'start_unix' => 1514764800,
          'cash_balance_interval' => 0,
          'free_time_balance' => 0,
          'free_time_balance_old' => 0,
          'cash_balance' => 0,
          'cash_balance_old' => 0,
          'id' => 77411,
          'start' => '2018-01-01 00:00:00'
        };
DEBUG: add current interval cost 0 to total cost 0
DEBUG: rating_duration = 600
DEBUG: 1 contract balance row(s) updated
DEBUG: catching up contract ID 61914 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61914 billing mapping (sipaccount) is profile id 1132 for time 1515762926.000 from ipv4 source ip 192.168.0.1
DEBUG: source_customer info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77422
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount',
                         'product_id' => 4,
                         'prepaid' => 1,
                         'profile_id' => 1132,
                         'int_unit' => 'month',
                         'contract_id' => 61914
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: billing profile is prepaid
DEBUG: prepaid_costs cache already populated
DEBUG: calculating call cost for profile_id 1132 with type call, direction out, src_user_domain 8881101515762707@testa.com.1515762707, dst_user_domain 8882121515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '4',
          'on_follow_interval' => 30,
          'on_init_interval' => 60,
          'on_init_rate' => '4',
          'fee_id' => 1609,
          'off_follow_rate' => '1',
          'source_pattern' => '.',
          'pattern' => '^8882.+',
          'use_free_time' => 0,
          'zone_id' => 501,
          'on_follow_rate' => '1',
          'off_follow_interval' => 30,
          'off_init_interval' => 60
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 4 per sec to costs
DEBUG: interval is 60, so rate for this interval is 240
DEBUG: starting with contract balance: $VAR1 = {
          'free_time_balance_interval' => 0,
          'end_unix' => 1517443199,
          'start_unix' => 1514764800,
          'cash_balance_interval' => '0',
          'free_time_balance_old' => 0,
          'free_time_balance' => 0,
          'cash_balance' => '0',
          'cash_balance_old' => '0',
          'start' => '2018-01-01 00:00:00',
          'id' => 77422
        };
DEBUG: add current interval cost 240 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 240
DEBUG: rating_duration = 90
DEBUG: got call cost 270 and free time 0
WARNING: no prepaid cost record found for call ID *TEST*L8Kuav0-igCu-ECrcORsevADX-, applying calculated costs
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 270
DEBUG: cdr ID 50850 updated
DEBUG: empty 'source_carrier_cash_balance' local col data for cdr id 50850, skipping
DEBUG: empty 'source_carrier_free_time_balance' local col data for cdr id 50850, skipping
DEBUG: empty 'source_carrier_profile_package_id' local col data for cdr id 50850, skipping
DEBUG: empty 'source_carrier_contract_balance_id' local col data for cdr id 50850, skipping
DEBUG: local col data created or up to date for cdr id 50850, column 'source_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50850, column 'source_reseller_free_time_balance': 0, 0
DEBUG: empty 'source_reseller_profile_package_id' local col data for cdr id 50850, skipping
DEBUG: local col data created or up to date for cdr id 50850, column 'source_reseller_contract_balance_id': 77411
DEBUG: local col data created or up to date for cdr id 50850, column 'source_customer_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50850, column 'source_customer_free_time_balance': 0, 0
DEBUG: empty 'source_customer_profile_package_id' local col data for cdr id 50850, skipping
DEBUG: local col data created or up to date for cdr id 50850, column 'source_customer_contract_balance_id': 77422
DEBUG: empty 'destination_carrier_cash_balance' local col data for cdr id 50850, skipping
DEBUG: empty 'destination_carrier_free_time_balance' local col data for cdr id 50850, skipping
DEBUG: empty 'destination_carrier_profile_package_id' local col data for cdr id 50850, skipping
DEBUG: empty 'destination_carrier_contract_balance_id' local col data for cdr id 50850, skipping
DEBUG: local col data created or up to date for cdr id 50850, column 'destination_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50850, column 'destination_reseller_free_time_balance': 0, 0
DEBUG: empty 'destination_reseller_profile_package_id' local col data for cdr id 50850, skipping
DEBUG: local col data created or up to date for cdr id 50850, column 'destination_reseller_contract_balance_id': 77412
DEBUG: local col data created or up to date for cdr id 50850, column 'destination_customer_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50850, column 'destination_customer_free_time_balance': 0, 0
DEBUG: empty 'destination_customer_profile_package_id' local col data for cdr id 50850, skipping
DEBUG: local col data created or up to date for cdr id 50850, column 'destination_customer_contract_balance_id': 77424
DEBUG: rating cdr ID 50850 completed successfully in 0.129 secs
DEBUG: start rating CDR ID 50851
DEBUG: 4 contract(s) locked: 61903, 61904, 61915, 61916
INFO: 3/3 - rate CDR ID 50851
DEBUG: fetching source provider info for source_provider_id #61903
DEBUG: catching up contract ID 61903 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61903 billing mapping (reseller) is profile id 1 for time 1515762927.000 from ipv4 source ip 192.168.0.1
DEBUG: source_provider_info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77411
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'reseller',
                         'product_id' => 3,
                         'prepaid' => 0,
                         'profile_id' => 1,
                         'int_unit' => 'month',
                         'contract_id' => '61903'
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: fetching destination provider info for destination_provider_id #61904
DEBUG: catching up contract ID 61904 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61904 billing mapping (reseller) is profile id 1 for time 1515762927.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_provider_info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77412
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'reseller',
                         'product_id' => 3,
                         'prepaid' => 0,
                         'profile_id' => 1,
                         'int_unit' => 'month',
                         'contract_id' => '61904'
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: ### 1. write pass ###
DEBUG: call from local subscriber, source_user_id is 480c3be1-90e7-4229-9369-5e5a45b6ee8a
DEBUG: call to local subscriber, destination_user_id is 21494937-f9a1-4080-8474-5654dbbd82ff
DEBUG: destination provider has billing profile 1, get reseller termination cost
DEBUG: calculating call cost for profile_id 1 with type call, direction in, src_user_domain 8881111515762707@testa.com.1515762707, dst_user_domain 8882121515762707@testb.com.1515762707
DEBUG: no match for full uris, trying user only for profile_id 1 with type call, direction in, src_user_domain 8881111515762707, dst_user_domain 8882121515762707
DEBUG: 1 contract balance row(s) updated
DEBUG: destination reseller termination cost is 0
DEBUG: get customer termination cost for destination_user_id 21494937-f9a1-4080-8474-5654dbbd82ff
DEBUG: catching up contract ID 61916 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61916 billing mapping (sipaccount) is profile id 1135 for time 1515762927.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_customer info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '420',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77424
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount',
                         'product_id' => 4,
                         'prepaid' => 1,
                         'profile_id' => 1135,
                         'int_unit' => 'month',
                         'contract_id' => 61916
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1135 with type call, direction in, src_user_domain 8881111515762707@testa.com.1515762707, dst_user_domain 8882121515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '3',
          'on_follow_interval' => 30,
          'on_init_interval' => 60,
          'on_init_rate' => '3',
          'fee_id' => 1616,
          'off_follow_rate' => '1',
          'source_pattern' => '^8881.+',
          'pattern' => '.',
          'use_free_time' => 0,
          'zone_id' => 504,
          'on_follow_rate' => '1',
          'off_follow_interval' => 30,
          'off_init_interval' => 60
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 3 per sec to costs
DEBUG: interval is 60, so rate for this interval is 180
DEBUG: starting with contract balance: $VAR1 = {
          'free_time_balance_interval' => 0,
          'end_unix' => 1517443199,
          'start_unix' => 1514764800,
          'cash_balance_interval' => '420',
          'free_time_balance_old' => 0,
          'free_time_balance' => 0,
          'cash_balance' => '0',
          'cash_balance_old' => '0',
          'start' => '2018-01-01 00:00:00',
          'id' => 77424
        };
DEBUG: add current interval cost 180 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 180
DEBUG: rating_duration = 90
DEBUG: got call cost 210 and free time 0
DEBUG: treat pre-paid billing profile as post-paid for termination fees
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 210
DEBUG: destination customer termination cost is 210
DEBUG: calculating call cost for profile_id 1 with type call, direction out, src_user_domain 8881111515762707@testa.com.1515762707, dst_user_domain 8882121515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '0',
          'on_follow_interval' => 600,
          'on_init_interval' => 600,
          'on_init_rate' => '0',
          'fee_id' => 1000,
          'off_follow_rate' => '0',
          'source_pattern' => '.',
          'pattern' => '.*',
          'use_free_time' => 0,
          'zone_id' => 1,
          'on_follow_rate' => '0',
          'off_follow_interval' => 600,
          'off_init_interval' => 600
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 0 per sec to costs
DEBUG: interval is 600, so rate for this interval is 0
DEBUG: starting with contract balance: $VAR1 = {
          'end_unix' => 1517443199,
          'free_time_balance_interval' => 0,
          'start_unix' => 1514764800,
          'cash_balance_interval' => 0,
          'free_time_balance' => 0,
          'free_time_balance_old' => 0,
          'cash_balance' => 0,
          'cash_balance_old' => 0,
          'id' => 77411,
          'start' => '2018-01-01 00:00:00'
        };
DEBUG: add current interval cost 0 to total cost 0
DEBUG: rating_duration = 600
DEBUG: 1 contract balance row(s) updated
DEBUG: catching up contract ID 61915 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61915 billing mapping (sipaccount) is profile id 1132 for time 1515762927.000 from ipv4 source ip 192.168.0.1
DEBUG: source_customer info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77423
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount',
                         'product_id' => 4,
                         'prepaid' => 1,
                         'profile_id' => 1132,
                         'int_unit' => 'month',
                         'contract_id' => 61915
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: billing profile is prepaid
DEBUG: prepaid_costs cache already populated
DEBUG: calculating call cost for profile_id 1132 with type call, direction out, src_user_domain 8881111515762707@testa.com.1515762707, dst_user_domain 8882121515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '4',
          'on_follow_interval' => 30,
          'on_init_interval' => 60,
          'on_init_rate' => '4',
          'fee_id' => 1609,
          'off_follow_rate' => '1',
          'source_pattern' => '.',
          'pattern' => '^8882.+',
          'use_free_time' => 0,
          'zone_id' => 501,
          'on_follow_rate' => '1',
          'off_follow_interval' => 30,
          'off_init_interval' => 60
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 4 per sec to costs
DEBUG: interval is 60, so rate for this interval is 240
DEBUG: starting with contract balance: $VAR1 = {
          'free_time_balance_interval' => 0,
          'end_unix' => 1517443199,
          'start_unix' => 1514764800,
          'cash_balance_interval' => '0',
          'free_time_balance_old' => 0,
          'free_time_balance' => 0,
          'cash_balance' => '0',
          'cash_balance_old' => '0',
          'start' => '2018-01-01 00:00:00',
          'id' => 77423
        };
DEBUG: add current interval cost 240 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 240
DEBUG: rating_duration = 90
DEBUG: got call cost 270 and free time 0
WARNING: no prepaid cost record found for call ID *TEST*yyTU2N1mho2s6DgplQGJm-DG8t, applying calculated costs
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 270
DEBUG: cdr ID 50851 updated
DEBUG: empty 'source_carrier_cash_balance' local col data for cdr id 50851, skipping
DEBUG: empty 'source_carrier_free_time_balance' local col data for cdr id 50851, skipping
DEBUG: empty 'source_carrier_profile_package_id' local col data for cdr id 50851, skipping
DEBUG: empty 'source_carrier_contract_balance_id' local col data for cdr id 50851, skipping
DEBUG: local col data created or up to date for cdr id 50851, column 'source_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50851, column 'source_reseller_free_time_balance': 0, 0
DEBUG: empty 'source_reseller_profile_package_id' local col data for cdr id 50851, skipping
DEBUG: local col data created or up to date for cdr id 50851, column 'source_reseller_contract_balance_id': 77411
DEBUG: local col data created or up to date for cdr id 50851, column 'source_customer_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50851, column 'source_customer_free_time_balance': 0, 0
DEBUG: empty 'source_customer_profile_package_id' local col data for cdr id 50851, skipping
DEBUG: local col data created or up to date for cdr id 50851, column 'source_customer_contract_balance_id': 77423
DEBUG: empty 'destination_carrier_cash_balance' local col data for cdr id 50851, skipping
DEBUG: empty 'destination_carrier_free_time_balance' local col data for cdr id 50851, skipping
DEBUG: empty 'destination_carrier_profile_package_id' local col data for cdr id 50851, skipping
DEBUG: empty 'destination_carrier_contract_balance_id' local col data for cdr id 50851, skipping
DEBUG: local col data created or up to date for cdr id 50851, column 'destination_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50851, column 'destination_reseller_free_time_balance': 0, 0
DEBUG: empty 'destination_reseller_profile_package_id' local col data for cdr id 50851, skipping
DEBUG: local col data created or up to date for cdr id 50851, column 'destination_reseller_contract_balance_id': 77412
DEBUG: local col data created or up to date for cdr id 50851, column 'destination_customer_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50851, column 'destination_customer_free_time_balance': 0, 0
DEBUG: empty 'destination_customer_profile_package_id' local col data for cdr id 50851, skipping
DEBUG: local col data created or up to date for cdr id 50851, column 'destination_customer_contract_balance_id': 77424
DEBUG: rating cdr ID 50851 completed successfully in 0.136 secs
INFO: Batch of 3 CDRs completed. 3 CDRs rated overall so far.
INFO: Less than 5 new CDRs, sleep 10
ok 464 - rate-o-mat executed
ok 465 - prepaid w/o prepaid costs, no balance: source_customer_cost = 270.000000
ok 466 - prepaid w/o prepaid costs, no balance: destination_customer_cost = 210.000000
not ok 467 - prepaid w/o prepaid costs, no balance: destination_reseller_cost = 90.000000
not ok 468 - prepaid w/o prepaid costs, no balance: source_reseller_cost = 150.000000
ok 469 - prepaid w/o prepaid costs, no balance: rating_status = ok
ok 470 - prepaid w/o prepaid costs, no balance: id = 50849
ok 471 - prepaid w/o prepaid costs, no balance: source_customer_cost = 270.000000
ok 472 - prepaid w/o prepaid costs, no balance: destination_customer_cost = 210.000000
not ok 473 - prepaid w/o prepaid costs, no balance: destination_reseller_cost = 90.000000
not ok 474 - prepaid w/o prepaid costs, no balance: source_reseller_cost = 150.000000
ok 475 - prepaid w/o prepaid costs, no balance: rating_status = ok
ok 476 - prepaid w/o prepaid costs, no balance: id = 50850
not ok 477 - prepaid w/o prepaid costs, no balance: destination_reseller_cost = 90.000000
ok 478 - prepaid w/o prepaid costs, no balance: id = 50851
not ok 479 - prepaid w/o prepaid costs, no balance: source_reseller_cost = 150.000000
ok 480 - prepaid w/o prepaid costs, no balance: rating_status = ok
ok 481 - prepaid w/o prepaid costs, no balance: source_customer_cost = 270.000000
ok 482 - prepaid w/o prepaid costs, no balance: destination_customer_cost = 210.000000
not ok 483 - cdrs were all processed
ok 484 - prepaid w/o prepaid costs, no balance, caller 1: cdr id 50849 source_customer_contract_balance_id number of records 1 = 1
ok 485 - prepaid w/o prepaid costs, no balance, caller 1: fetch customer id 61913 balance intervals collection page
ok 486 - prepaid w/o prepaid costs, no balance, caller 1: check 'total_count' of collection
ok 487 - prepaid w/o prepaid costs, no balance, caller 1: check interval 77421 cash balance 0 = 0
ok 488 - prepaid w/o prepaid costs, no balance, caller 1: check interval 77421 cash balance interval 2.7 = 2.7
ok 489 - prepaid w/o prepaid costs, no balance, caller 1: check interval 77421 id = 77421
ok 490 - prepaid w/o prepaid costs, no balance, caller 1: check if all expected items are listed
ok 491 - prepaid w/o prepaid costs, no balance, caller 1: cdr id 50849 source_customer_cash_balance before 0.0000 = 0.0000
ok 492 - prepaid w/o prepaid costs, no balance, caller 1: cdr id 50849 source_customer_cash_balance after 0.0000 = 0.0000
ok 493 - prepaid w/o prepaid costs, no balance, caller 2: cdr id 50850 source_customer_contract_balance_id number of records 1 = 1
ok 494 - prepaid w/o prepaid costs, no balance, caller 2: fetch customer id 61914 balance intervals collection page
ok 495 - prepaid w/o prepaid costs, no balance, caller 2: check 'total_count' of collection
ok 496 - prepaid w/o prepaid costs, no balance, caller 2: check interval 77422 cash balance 0 = 0
ok 497 - prepaid w/o prepaid costs, no balance, caller 2: check interval 77422 cash balance interval 2.7 = 2.7
ok 498 - prepaid w/o prepaid costs, no balance, caller 2: check interval 77422 id = 77422
ok 499 - prepaid w/o prepaid costs, no balance, caller 2: check if all expected items are listed
ok 500 - prepaid w/o prepaid costs, no balance, caller 2: cdr id 50850 source_customer_cash_balance before 0.0000 = 0.0000
ok 501 - prepaid w/o prepaid costs, no balance, caller 2: cdr id 50850 source_customer_cash_balance after 0.0000 = 0.0000
ok 502 - prepaid w/o prepaid costs, no balance, caller 3: cdr id 50851 source_customer_contract_balance_id number of records 1 = 1
ok 503 - prepaid w/o prepaid costs, no balance, caller 3: fetch customer id 61915 balance intervals collection page
ok 504 - prepaid w/o prepaid costs, no balance, caller 3: check 'total_count' of collection
ok 505 - prepaid w/o prepaid costs, no balance, caller 3: check interval 77423 cash balance 0 = 0
ok 506 - prepaid w/o prepaid costs, no balance, caller 3: check interval 77423 cash balance interval 2.7 = 2.7
ok 507 - prepaid w/o prepaid costs, no balance, caller 3: check interval 77423 id = 77423
ok 508 - prepaid w/o prepaid costs, no balance, caller 3: check if all expected items are listed
ok 509 - prepaid w/o prepaid costs, no balance, caller 3: cdr id 50851 source_customer_cash_balance before 0.0000 = 0.0000
ok 510 - prepaid w/o prepaid costs, no balance, caller 3: cdr id 50851 source_customer_cash_balance after 0.0000 = 0.0000
ok 511 - prepaid w/o prepaid costs, no balance, callee: cdr id 50849 destination_customer_contract_balance_id number of records 1 = 1
ok 512 - prepaid w/o prepaid costs, no balance, callee: fetch customer id 61916 balance intervals collection page
ok 513 - prepaid w/o prepaid costs, no balance, callee: check 'total_count' of collection
ok 514 - prepaid w/o prepaid costs, no balance, callee: check interval 77424 cash balance 0 = 0
ok 515 - prepaid w/o prepaid costs, no balance, callee: check interval 77424 cash balance interval 6.3 = 6.3
ok 516 - prepaid w/o prepaid costs, no balance, callee: check interval 77424 id = 77424
ok 517 - prepaid w/o prepaid costs, no balance, callee: check if all expected items are listed
ok 518 - prepaid w/o prepaid costs, no balance, callee: cdr id 50849 destination_customer_contract_balance_id 77424 = 77424
ok 519 - prepaid w/o prepaid costs, no balance, callee: cdr id 50849 destination_customer_cash_balance before 0.0000 = 0.0000
ok 520 - prepaid w/o prepaid costs, no balance, callee: cdr id 50849 destination_customer_cash_balance after 0.0000 = 0.0000
ok 521 - prepaid w/o prepaid costs, no balance, callee: cdr id 50850 destination_customer_contract_balance_id 77424 = 77424
ok 522 - prepaid w/o prepaid costs, no balance, callee: cdr id 50850 destination_customer_cash_balance before 0.0000 = 0.0000
ok 523 - prepaid w/o prepaid costs, no balance, callee: cdr id 50850 destination_customer_cash_balance after 0.0000 = 0.0000
ok 524 - prepaid w/o prepaid costs, no balance, callee: cdr id 50851 destination_customer_contract_balance_id 77424 = 77424
ok 525 - prepaid w/o prepaid costs, no balance, callee: cdr id 50851 destination_customer_cash_balance before 0.0000 = 0.0000
ok 526 - prepaid w/o prepaid costs, no balance, callee: cdr id 50851 destination_customer_cash_balance after 0.0000 = 0.0000
ok 527 - prepaid w/o prepaid costs, no balance, callers' provider: cdr id 50849 source_reseller_contract_balance_id number of records 1 = 1
ok 528 - prepaid w/o prepaid costs, no balance, callers' provider: fetch customer id 61903 balance intervals collection page
ok 529 - prepaid w/o prepaid costs, no balance, callers' provider: check 'total_count' of collection
not ok 530 - prepaid w/o prepaid costs, no balance, callers' provider: check interval 77411 cash balance interval 0 = 13.5
ok 531 - prepaid w/o prepaid costs, no balance, callers' provider: check interval 77411 id = 77411
ok 532 - prepaid w/o prepaid costs, no balance, callers' provider: check if all expected items are listed
ok 533 - prepaid w/o prepaid costs, no balance, callers' provider: cdr id 50849 source_carrier_contract_balance_id number of records 0 = 0
ok 534 - prepaid w/o prepaid costs, no balance, callers' provider: cdr id 50849 source_reseller_contract_balance_id 77411 = 77411
ok 535 - prepaid w/o prepaid costs, no balance, callers' provider: cdr id 50850 source_carrier_contract_balance_id number of records 0 = 0
ok 536 - prepaid w/o prepaid costs, no balance, callers' provider: cdr id 50850 source_reseller_contract_balance_id 77411 = 77411
ok 537 - prepaid w/o prepaid costs, no balance, callers' provider: cdr id 50851 source_carrier_contract_balance_id number of records 0 = 0
ok 538 - prepaid w/o prepaid costs, no balance, callers' provider: cdr id 50851 source_reseller_contract_balance_id 77411 = 77411
ok 539 - prepaid w/o prepaid costs, no balance, callee's provider: cdr id 50849 destination_reseller_contract_balance_id number of records 1 = 1
ok 540 - prepaid w/o prepaid costs, no balance, callee's provider: fetch customer id 61904 balance intervals collection page
ok 541 - prepaid w/o prepaid costs, no balance, callee's provider: check 'total_count' of collection
not ok 542 - prepaid w/o prepaid costs, no balance, callee's provider: check interval 77412 cash balance interval 0 = 8.1
ok 543 - prepaid w/o prepaid costs, no balance, callee's provider: check interval 77412 id = 77412
ok 544 - prepaid w/o prepaid costs, no balance, callee's provider: check if all expected items are listed
ok 545 - prepaid w/o prepaid costs, no balance, callee's provider: cdr id 50849 destination_carrier_contract_balance_id number of records 0 = 0
ok 546 - prepaid w/o prepaid costs, no balance, callee's provider: cdr id 50849 destination_reseller_contract_balance_id 77412 = 77412
ok 547 - prepaid w/o prepaid costs, no balance, callee's provider: cdr id 50850 destination_carrier_contract_balance_id number of records 0 = 0
ok 548 - prepaid w/o prepaid costs, no balance, callee's provider: cdr id 50850 destination_reseller_contract_balance_id 77412 = 77412
ok 549 - prepaid w/o prepaid costs, no balance, callee's provider: cdr id 50851 destination_carrier_contract_balance_id number of records 0 = 0
ok 550 - prepaid w/o prepaid costs, no balance, callee's provider: cdr id 50851 destination_reseller_contract_balance_id 77412 = 77412
ok 551 - prepaid w/o prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50849 source_carrier_profile_package_id number of records 0 = 0
ok 552 - prepaid w/o prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50849 source_reseller_profile_package_id number of records 0 = 0
ok 553 - prepaid w/o prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50849 source_customer_profile_package_id number of records 0 = 0
ok 554 - prepaid w/o prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50849 destination_carrier_profile_package_id number of records 0 = 0
ok 555 - prepaid w/o prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50849 destination_reseller_profile_package_id number of records 0 = 0
ok 556 - prepaid w/o prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50849 destination_customer_profile_package_id number of records 0 = 0
ok 557 - prepaid w/o prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50850 source_carrier_profile_package_id number of records 0 = 0
ok 558 - prepaid w/o prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50850 source_reseller_profile_package_id number of records 0 = 0
ok 559 - prepaid w/o prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50850 source_customer_profile_package_id number of records 0 = 0
ok 560 - prepaid w/o prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50850 destination_carrier_profile_package_id number of records 0 = 0
ok 561 - prepaid w/o prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50850 destination_reseller_profile_package_id number of records 0 = 0
ok 562 - prepaid w/o prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50850 destination_customer_profile_package_id number of records 0 = 0
ok 563 - prepaid w/o prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50851 source_carrier_profile_package_id number of records 0 = 0
ok 564 - prepaid w/o prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50851 source_reseller_profile_package_id number of records 0 = 0
ok 565 - prepaid w/o prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50851 source_customer_profile_package_id number of records 0 = 0
ok 566 - prepaid w/o prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50851 destination_carrier_profile_package_id number of records 0 = 0
ok 567 - prepaid w/o prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50851 destination_reseller_profile_package_id number of records 0 = 0
ok 568 - prepaid w/o prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50851 destination_customer_profile_package_id number of records 0 = 0
ok 569 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50849 source_carrier_free_time_balance number of records 0 = 0
ok 570 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50849 source_reseller_free_time_balance before 0 = 0
ok 571 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50849 source_reseller_free_time_balance after 0 = 0
ok 572 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50849 source_customer_free_time_balance before 0 = 0
ok 573 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50849 source_customer_free_time_balance after 0 = 0
ok 574 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50849 destination_carrier_free_time_balance number of records 0 = 0
ok 575 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50849 destination_reseller_free_time_balance before 0 = 0
ok 576 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50849 destination_reseller_free_time_balance after 0 = 0
ok 577 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50849 destination_customer_free_time_balance before 0 = 0
ok 578 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50849 destination_customer_free_time_balance after 0 = 0
ok 579 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50850 source_carrier_free_time_balance number of records 0 = 0
ok 580 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50850 source_reseller_free_time_balance before 0 = 0
ok 581 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50850 source_reseller_free_time_balance after 0 = 0
ok 582 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50850 source_customer_free_time_balance before 0 = 0
ok 583 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50850 source_customer_free_time_balance after 0 = 0
ok 584 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50850 destination_carrier_free_time_balance number of records 0 = 0
ok 585 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50850 destination_reseller_free_time_balance before 0 = 0
ok 586 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50850 destination_reseller_free_time_balance after 0 = 0
ok 587 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50850 destination_customer_free_time_balance before 0 = 0
ok 588 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50850 destination_customer_free_time_balance after 0 = 0
ok 589 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50851 source_carrier_free_time_balance number of records 0 = 0
ok 590 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50851 source_reseller_free_time_balance before 0 = 0
ok 591 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50851 source_reseller_free_time_balance after 0 = 0
ok 592 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50851 source_customer_free_time_balance before 0 = 0
ok 593 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50851 source_customer_free_time_balance after 0 = 0
ok 594 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50851 destination_carrier_free_time_balance number of records 0 = 0
ok 595 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50851 destination_reseller_free_time_balance before 0 = 0
ok 596 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50851 destination_reseller_free_time_balance after 0 = 0
ok 597 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50851 destination_customer_free_time_balance before 0 = 0
ok 598 - prepaid w/o prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50851 destination_customer_free_time_balance after 0 = 0
ok 599 - prepaid w/o prepaid costs, no balance providers must have zero balance: cdr id 50849 source_carrier_cash_balance number of records 0 = 0
ok 600 - prepaid w/o prepaid costs, no balance providers must have zero balance: cdr id 50849 source_reseller_cash_balance before 0.0000 = 0.0000
ok 601 - prepaid w/o prepaid costs, no balance providers must have zero balance: cdr id 50849 source_reseller_cash_balance after 0.0000 = 0.0000
ok 602 - prepaid w/o prepaid costs, no balance providers must have zero balance: cdr id 50849 destination_carrier_cash_balance number of records 0 = 0
ok 603 - prepaid w/o prepaid costs, no balance providers must have zero balance: cdr id 50849 destination_reseller_cash_balance before 0.0000 = 0.0000
ok 604 - prepaid w/o prepaid costs, no balance providers must have zero balance: cdr id 50849 destination_reseller_cash_balance after 0.0000 = 0.0000
ok 605 - prepaid w/o prepaid costs, no balance providers must have zero balance: cdr id 50850 source_carrier_cash_balance number of records 0 = 0
ok 606 - prepaid w/o prepaid costs, no balance providers must have zero balance: cdr id 50850 source_reseller_cash_balance before 0.0000 = 0.0000
ok 607 - prepaid w/o prepaid costs, no balance providers must have zero balance: cdr id 50850 source_reseller_cash_balance after 0.0000 = 0.0000
ok 608 - prepaid w/o prepaid costs, no balance providers must have zero balance: cdr id 50850 destination_carrier_cash_balance number of records 0 = 0
ok 609 - prepaid w/o prepaid costs, no balance providers must have zero balance: cdr id 50850 destination_reseller_cash_balance before 0.0000 = 0.0000
ok 610 - prepaid w/o prepaid costs, no balance providers must have zero balance: cdr id 50850 destination_reseller_cash_balance after 0.0000 = 0.0000
ok 611 - prepaid w/o prepaid costs, no balance providers must have zero balance: cdr id 50851 source_carrier_cash_balance number of records 0 = 0
ok 612 - prepaid w/o prepaid costs, no balance providers must have zero balance: cdr id 50851 source_reseller_cash_balance before 0.0000 = 0.0000
ok 613 - prepaid w/o prepaid costs, no balance providers must have zero balance: cdr id 50851 source_reseller_cash_balance after 0.0000 = 0.0000
ok 614 - prepaid w/o prepaid costs, no balance providers must have zero balance: cdr id 50851 destination_carrier_cash_balance number of records 0 = 0
ok 615 - prepaid w/o prepaid costs, no balance providers must have zero balance: cdr id 50851 destination_reseller_cash_balance before 0.0000 = 0.0000
ok 616 - prepaid w/o prepaid costs, no balance providers must have zero balance: cdr id 50851 destination_reseller_cash_balance after 0.0000 = 0.0000
ok 617 - create customercontacts 13
ok 618 - create customers 13
ok 619 - setting customer id 61917 cash_balance to 0 cents
ok 620 - create subscribers 13
ok 621 - very first balance interval: fetch customer id 61917 balance intervals collection page
ok 622 - very first balance interval: check interval 77425 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 623 - very first balance interval: check interval 77425 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 624 - very first balance interval: check interval 77425 cash balance 0 = 0
ok 625 - very first balance interval: check interval 77425 billing profile id 1132 = 1132
ok 626 - very first balance interval: check if all expected items are listed
ok 627 - create customercontacts 14
ok 628 - create customers 14
ok 629 - setting customer id 61918 cash_balance to 0 cents
ok 630 - create subscribers 14
ok 631 - very first balance interval: fetch customer id 61918 balance intervals collection page
ok 632 - very first balance interval: check interval 77426 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 633 - very first balance interval: check interval 77426 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 634 - very first balance interval: check interval 77426 cash balance 0 = 0
ok 635 - very first balance interval: check interval 77426 billing profile id 1132 = 1132
ok 636 - very first balance interval: check if all expected items are listed
ok 637 - create customercontacts 15
ok 638 - create customers 15
ok 639 - setting customer id 61919 cash_balance to 0 cents
ok 640 - create subscribers 15
ok 641 - very first balance interval: fetch customer id 61919 balance intervals collection page
ok 642 - very first balance interval: check interval 77427 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 643 - very first balance interval: check interval 77427 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 644 - very first balance interval: check interval 77427 cash balance 0 = 0
ok 645 - very first balance interval: check interval 77427 billing profile id 1132 = 1132
ok 646 - very first balance interval: check if all expected items are listed
ok 647 - create customercontacts 16
ok 648 - create customers 16
ok 649 - setting customer id 61920 cash_balance to 0 cents
ok 650 - create subscribers 16
ok 651 - very first balance interval: fetch customer id 61920 balance intervals collection page
ok 652 - very first balance interval: check interval 77428 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 653 - very first balance interval: check interval 77428 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 654 - very first balance interval: check interval 77428 cash balance 0 = 0
ok 655 - very first balance interval: check interval 77428 billing profile id 1135 = 1135
ok 656 - very first balance interval: check if all expected items are listed
ok 657 - cdrs id 50852, 50853, 50854 with prepaid costs records created
INFO: Trying to connect to billing db...
INFO: Successfully connected to duplication db...
INFO: Trying to connect to provisioning db...
INFO: Successfully connected to provisioning db...
INFO: Trying to connect to accounting db...
INFO: Successfully connected to accounting db...
WARNING: No duplication db credentials, disabled.
INFO: local cdr relation column model loaded
INFO: local cdr cash balance column model loaded
INFO: local cdr time balance column model loaded
INFO: Up and running.
INFO: Grabbed 3 CDRs
DEBUG: start rating CDR ID 50852
DEBUG: 4 contract(s) locked: 61903, 61904, 61917, 61920
INFO: 1/3 - rate CDR ID 50852
DEBUG: fetching source provider info for source_provider_id #61903
DEBUG: catching up contract ID 61903 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61903 billing mapping (reseller) is profile id 1 for time 1515762983.000 from ipv4 source ip 192.168.0.1
DEBUG: source_provider_info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'id' => 77411,
                            'start' => '2018-01-01 00:00:00'
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'reseller',
                         'product_id' => 3,
                         'prepaid' => 0,
                         'profile_id' => 1,
                         'int_unit' => 'month',
                         'contract_id' => '61903'
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: fetching destination provider info for destination_provider_id #61904
DEBUG: catching up contract ID 61904 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61904 billing mapping (reseller) is profile id 1 for time 1515762983.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_provider_info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77412
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'reseller',
                         'product_id' => 3,
                         'prepaid' => 0,
                         'profile_id' => 1,
                         'int_unit' => 'month',
                         'contract_id' => '61904'
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: ### 1. write pass ###
DEBUG: call from local subscriber, source_user_id is f4761ffb-1bde-4d21-8ec2-9844ca6a316b
DEBUG: call to local subscriber, destination_user_id is 36fcbf8c-a88d-447c-a5a5-7353dfb85f74
DEBUG: destination provider has billing profile 1, get reseller termination cost
DEBUG: calculating call cost for profile_id 1 with type call, direction in, src_user_domain 8881131515762707@testa.com.1515762707, dst_user_domain 8882161515762707@testb.com.1515762707
DEBUG: no match for full uris, trying user only for profile_id 1 with type call, direction in, src_user_domain 8881131515762707, dst_user_domain 8882161515762707
DEBUG: 1 contract balance row(s) updated
DEBUG: destination reseller termination cost is 0
DEBUG: get customer termination cost for destination_user_id 36fcbf8c-a88d-447c-a5a5-7353dfb85f74
DEBUG: catching up contract ID 61920 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61920 billing mapping (sipaccount) is profile id 1135 for time 1515762983.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_customer info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77428
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount',
                         'product_id' => 4,
                         'prepaid' => 1,
                         'profile_id' => 1135,
                         'int_unit' => 'month',
                         'contract_id' => 61920
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1135 with type call, direction in, src_user_domain 8881131515762707@testa.com.1515762707, dst_user_domain 8882161515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '3',
          'on_follow_interval' => 30,
          'on_init_interval' => 60,
          'on_init_rate' => '3',
          'fee_id' => 1616,
          'off_follow_rate' => '1',
          'source_pattern' => '^8881.+',
          'pattern' => '.',
          'use_free_time' => 0,
          'zone_id' => 504,
          'on_follow_rate' => '1',
          'off_follow_interval' => 30,
          'off_init_interval' => 60
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 3 per sec to costs
DEBUG: interval is 60, so rate for this interval is 180
DEBUG: starting with contract balance: $VAR1 = {
          'free_time_balance_interval' => 0,
          'end_unix' => 1517443199,
          'start_unix' => 1514764800,
          'cash_balance_interval' => '0',
          'free_time_balance_old' => 0,
          'free_time_balance' => 0,
          'cash_balance' => '0',
          'cash_balance_old' => '0',
          'start' => '2018-01-01 00:00:00',
          'id' => 77428
        };
DEBUG: add current interval cost 180 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 180
DEBUG: rating_duration = 90
DEBUG: got call cost 210 and free time 0
DEBUG: treat pre-paid billing profile as post-paid for termination fees
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 210
DEBUG: destination customer termination cost is 210
DEBUG: calculating call cost for profile_id 1 with type call, direction out, src_user_domain 8881131515762707@testa.com.1515762707, dst_user_domain 8882161515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '0',
          'on_follow_interval' => 600,
          'on_init_interval' => 600,
          'on_init_rate' => '0',
          'fee_id' => 1000,
          'off_follow_rate' => '0',
          'source_pattern' => '.',
          'pattern' => '.*',
          'use_free_time' => 0,
          'zone_id' => 1,
          'on_follow_rate' => '0',
          'off_follow_interval' => 600,
          'off_init_interval' => 600
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 0 per sec to costs
DEBUG: interval is 600, so rate for this interval is 0
DEBUG: starting with contract balance: $VAR1 = {
          'end_unix' => 1517443199,
          'free_time_balance_interval' => 0,
          'start_unix' => 1514764800,
          'cash_balance_interval' => 0,
          'free_time_balance' => 0,
          'free_time_balance_old' => 0,
          'cash_balance' => 0,
          'cash_balance_old' => 0,
          'start' => '2018-01-01 00:00:00',
          'id' => 77411
        };
DEBUG: add current interval cost 0 to total cost 0
DEBUG: rating_duration = 600
DEBUG: 1 contract balance row(s) updated
DEBUG: catching up contract ID 61917 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61917 billing mapping (sipaccount) is profile id 1132 for time 1515762983.000 from ipv4 source ip 192.168.0.1
DEBUG: source_customer info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77425
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount',
                         'product_id' => 4,
                         'prepaid' => 1,
                         'profile_id' => 1132,
                         'int_unit' => 'month',
                         'contract_id' => 61917
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: billing profile is prepaid
DEBUG: empty prepaid_costs cache, populate it
DEBUG: prepaid_costs cache populated, 3 records
DEBUG: prepaid_costs call_id = *TEST*TaKJRXiCAXAyxPzin22EUL0n4r, source_user_id = f4761ffb-1bde-4d21-8ec2-9844ca6a316b, destination_user_id = 36fcbf8c-a88d-447c-a5a5-7353dfb85f74 found in cache
DEBUG: calculating call cost for profile_id 1132 with type call, direction out, src_user_domain 8881131515762707@testa.com.1515762707, dst_user_domain 8882161515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '4',
          'on_follow_interval' => 30,
          'on_init_interval' => 60,
          'on_init_rate' => '4',
          'fee_id' => 1609,
          'off_follow_rate' => '1',
          'source_pattern' => '.',
          'pattern' => '^8882.+',
          'use_free_time' => 0,
          'zone_id' => 501,
          'on_follow_rate' => '1',
          'off_follow_interval' => 30,
          'off_init_interval' => 60
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 4 per sec to costs
DEBUG: interval is 60, so rate for this interval is 240
DEBUG: starting with contract balance: $VAR1 = {
          'free_time_balance_interval' => 0,
          'end_unix' => 1517443199,
          'start_unix' => 1514764800,
          'cash_balance_interval' => '0',
          'free_time_balance_old' => 0,
          'free_time_balance' => 0,
          'cash_balance' => '0',
          'cash_balance_old' => '0',
          'start' => '2018-01-01 00:00:00',
          'id' => 77425
        };
DEBUG: add current interval cost 240 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 240
DEBUG: rating_duration = 90
DEBUG: got call cost 270 and free time 0
DEBUG: prepaid_costs call_id = *TEST*TaKJRXiCAXAyxPzin22EUL0n4r, source_user_id = f4761ffb-1bde-4d21-8ec2-9844ca6a316b, destination_user_id = 36fcbf8c-a88d-447c-a5a5-7353dfb85f74 deleted
DEBUG: dropped prepaid_costs call_id = *TEST*TaKJRXiCAXAyxPzin22EUL0n4r, source_user_id = f4761ffb-1bde-4d21-8ec2-9844ca6a316b, destination_user_id = 36fcbf8c-a88d-447c-a5a5-7353dfb85f74 from cache
DEBUG: cost for this call is 270
DEBUG: cdr ID 50852 updated
DEBUG: empty 'source_carrier_cash_balance' local col data for cdr id 50852, skipping
DEBUG: empty 'source_carrier_free_time_balance' local col data for cdr id 50852, skipping
DEBUG: empty 'source_carrier_profile_package_id' local col data for cdr id 50852, skipping
DEBUG: empty 'source_carrier_contract_balance_id' local col data for cdr id 50852, skipping
DEBUG: local col data created or up to date for cdr id 50852, column 'source_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50852, column 'source_reseller_free_time_balance': 0, 0
DEBUG: empty 'source_reseller_profile_package_id' local col data for cdr id 50852, skipping
DEBUG: local col data created or up to date for cdr id 50852, column 'source_reseller_contract_balance_id': 77411
DEBUG: local col data created or up to date for cdr id 50852, column 'source_customer_cash_balance': 270.0000, 0
DEBUG: local col data created or up to date for cdr id 50852, column 'source_customer_free_time_balance': 0, 0
DEBUG: empty 'source_customer_profile_package_id' local col data for cdr id 50852, skipping
DEBUG: local col data created or up to date for cdr id 50852, column 'source_customer_contract_balance_id': 77425
DEBUG: empty 'destination_carrier_cash_balance' local col data for cdr id 50852, skipping
DEBUG: empty 'destination_carrier_free_time_balance' local col data for cdr id 50852, skipping
DEBUG: empty 'destination_carrier_profile_package_id' local col data for cdr id 50852, skipping
DEBUG: empty 'destination_carrier_contract_balance_id' local col data for cdr id 50852, skipping
DEBUG: local col data created or up to date for cdr id 50852, column 'destination_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50852, column 'destination_reseller_free_time_balance': 0, 0
DEBUG: empty 'destination_reseller_profile_package_id' local col data for cdr id 50852, skipping
DEBUG: local col data created or up to date for cdr id 50852, column 'destination_reseller_contract_balance_id': 77412
DEBUG: local col data created or up to date for cdr id 50852, column 'destination_customer_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50852, column 'destination_customer_free_time_balance': 0, 0
DEBUG: empty 'destination_customer_profile_package_id' local col data for cdr id 50852, skipping
DEBUG: local col data created or up to date for cdr id 50852, column 'destination_customer_contract_balance_id': 77428
DEBUG: rating cdr ID 50852 completed successfully in 0.167 secs
DEBUG: start rating CDR ID 50853
DEBUG: 4 contract(s) locked: 61903, 61904, 61918, 61920
INFO: 2/3 - rate CDR ID 50853
DEBUG: fetching source provider info for source_provider_id #61903
DEBUG: catching up contract ID 61903 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61903 billing mapping (reseller) is profile id 1 for time 1515762984.000 from ipv4 source ip 192.168.0.1
DEBUG: source_provider_info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77411
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'reseller',
                         'product_id' => 3,
                         'prepaid' => 0,
                         'profile_id' => 1,
                         'int_unit' => 'month',
                         'contract_id' => '61903'
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: fetching destination provider info for destination_provider_id #61904
DEBUG: catching up contract ID 61904 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61904 billing mapping (reseller) is profile id 1 for time 1515762984.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_provider_info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77412
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'reseller',
                         'product_id' => 3,
                         'prepaid' => 0,
                         'profile_id' => 1,
                         'int_unit' => 'month',
                         'contract_id' => '61904'
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: ### 1. write pass ###
DEBUG: call from local subscriber, source_user_id is 6251e106-9e5d-4e5a-979c-322d92efdc4a
DEBUG: call to local subscriber, destination_user_id is 36fcbf8c-a88d-447c-a5a5-7353dfb85f74
DEBUG: destination provider has billing profile 1, get reseller termination cost
DEBUG: calculating call cost for profile_id 1 with type call, direction in, src_user_domain 8881141515762707@testa.com.1515762707, dst_user_domain 8882161515762707@testb.com.1515762707
DEBUG: no match for full uris, trying user only for profile_id 1 with type call, direction in, src_user_domain 8881141515762707, dst_user_domain 8882161515762707
DEBUG: 1 contract balance row(s) updated
DEBUG: destination reseller termination cost is 0
DEBUG: get customer termination cost for destination_user_id 36fcbf8c-a88d-447c-a5a5-7353dfb85f74
DEBUG: catching up contract ID 61920 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61920 billing mapping (sipaccount) is profile id 1135 for time 1515762984.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_customer info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '210',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77428
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount',
                         'product_id' => 4,
                         'prepaid' => 1,
                         'profile_id' => 1135,
                         'int_unit' => 'month',
                         'contract_id' => 61920
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1135 with type call, direction in, src_user_domain 8881141515762707@testa.com.1515762707, dst_user_domain 8882161515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '3',
          'on_follow_interval' => 30,
          'on_init_interval' => 60,
          'on_init_rate' => '3',
          'fee_id' => 1616,
          'off_follow_rate' => '1',
          'source_pattern' => '^8881.+',
          'pattern' => '.',
          'use_free_time' => 0,
          'zone_id' => 504,
          'on_follow_rate' => '1',
          'off_follow_interval' => 30,
          'off_init_interval' => 60
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 3 per sec to costs
DEBUG: interval is 60, so rate for this interval is 180
DEBUG: starting with contract balance: $VAR1 = {
          'free_time_balance_interval' => 0,
          'end_unix' => 1517443199,
          'start_unix' => 1514764800,
          'cash_balance_interval' => '210',
          'free_time_balance_old' => 0,
          'free_time_balance' => 0,
          'cash_balance' => '0',
          'cash_balance_old' => '0',
          'start' => '2018-01-01 00:00:00',
          'id' => 77428
        };
DEBUG: add current interval cost 180 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 180
DEBUG: rating_duration = 90
DEBUG: got call cost 210 and free time 0
DEBUG: treat pre-paid billing profile as post-paid for termination fees
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 210
DEBUG: destination customer termination cost is 210
DEBUG: calculating call cost for profile_id 1 with type call, direction out, src_user_domain 8881141515762707@testa.com.1515762707, dst_user_domain 8882161515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '0',
          'on_follow_interval' => 600,
          'on_init_interval' => 600,
          'on_init_rate' => '0',
          'fee_id' => 1000,
          'off_follow_rate' => '0',
          'source_pattern' => '.',
          'pattern' => '.*',
          'use_free_time' => 0,
          'zone_id' => 1,
          'on_follow_rate' => '0',
          'off_follow_interval' => 600,
          'off_init_interval' => 600
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 0 per sec to costs
DEBUG: interval is 600, so rate for this interval is 0
DEBUG: starting with contract balance: $VAR1 = {
          'end_unix' => 1517443199,
          'free_time_balance_interval' => 0,
          'start_unix' => 1514764800,
          'cash_balance_interval' => 0,
          'free_time_balance' => 0,
          'free_time_balance_old' => 0,
          'cash_balance' => 0,
          'cash_balance_old' => 0,
          'id' => 77411,
          'start' => '2018-01-01 00:00:00'
        };
DEBUG: add current interval cost 0 to total cost 0
DEBUG: rating_duration = 600
DEBUG: 1 contract balance row(s) updated
DEBUG: catching up contract ID 61918 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61918 billing mapping (sipaccount) is profile id 1132 for time 1515762984.000 from ipv4 source ip 192.168.0.1
DEBUG: source_customer info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77426
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount',
                         'product_id' => 4,
                         'prepaid' => 1,
                         'profile_id' => 1132,
                         'int_unit' => 'month',
                         'contract_id' => 61918
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: billing profile is prepaid
DEBUG: prepaid_costs cache already populated
DEBUG: prepaid_costs call_id = *TEST*dVsA-G2Qm4OA75ukwzvsgvIlZp, source_user_id = 6251e106-9e5d-4e5a-979c-322d92efdc4a, destination_user_id = 36fcbf8c-a88d-447c-a5a5-7353dfb85f74 found in cache
DEBUG: calculating call cost for profile_id 1132 with type call, direction out, src_user_domain 8881141515762707@testa.com.1515762707, dst_user_domain 8882161515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '4',
          'on_follow_interval' => 30,
          'on_init_interval' => 60,
          'on_init_rate' => '4',
          'fee_id' => 1609,
          'off_follow_rate' => '1',
          'source_pattern' => '.',
          'pattern' => '^8882.+',
          'use_free_time' => 0,
          'zone_id' => 501,
          'on_follow_rate' => '1',
          'off_follow_interval' => 30,
          'off_init_interval' => 60
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 4 per sec to costs
DEBUG: interval is 60, so rate for this interval is 240
DEBUG: starting with contract balance: $VAR1 = {
          'free_time_balance_interval' => 0,
          'end_unix' => 1517443199,
          'start_unix' => 1514764800,
          'cash_balance_interval' => '0',
          'free_time_balance_old' => 0,
          'free_time_balance' => 0,
          'cash_balance' => '0',
          'cash_balance_old' => '0',
          'start' => '2018-01-01 00:00:00',
          'id' => 77426
        };
DEBUG: add current interval cost 240 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 240
DEBUG: rating_duration = 90
DEBUG: got call cost 270 and free time 0
DEBUG: prepaid_costs call_id = *TEST*dVsA-G2Qm4OA75ukwzvsgvIlZp, source_user_id = 6251e106-9e5d-4e5a-979c-322d92efdc4a, destination_user_id = 36fcbf8c-a88d-447c-a5a5-7353dfb85f74 deleted
DEBUG: dropped prepaid_costs call_id = *TEST*dVsA-G2Qm4OA75ukwzvsgvIlZp, source_user_id = 6251e106-9e5d-4e5a-979c-322d92efdc4a, destination_user_id = 36fcbf8c-a88d-447c-a5a5-7353dfb85f74 from cache
DEBUG: cost for this call is 270
DEBUG: cdr ID 50853 updated
DEBUG: empty 'source_carrier_cash_balance' local col data for cdr id 50853, skipping
DEBUG: empty 'source_carrier_free_time_balance' local col data for cdr id 50853, skipping
DEBUG: empty 'source_carrier_profile_package_id' local col data for cdr id 50853, skipping
DEBUG: empty 'source_carrier_contract_balance_id' local col data for cdr id 50853, skipping
DEBUG: local col data created or up to date for cdr id 50853, column 'source_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50853, column 'source_reseller_free_time_balance': 0, 0
DEBUG: empty 'source_reseller_profile_package_id' local col data for cdr id 50853, skipping
DEBUG: local col data created or up to date for cdr id 50853, column 'source_reseller_contract_balance_id': 77411
DEBUG: local col data created or up to date for cdr id 50853, column 'source_customer_cash_balance': 270.0000, 0
DEBUG: local col data created or up to date for cdr id 50853, column 'source_customer_free_time_balance': 0, 0
DEBUG: empty 'source_customer_profile_package_id' local col data for cdr id 50853, skipping
DEBUG: local col data created or up to date for cdr id 50853, column 'source_customer_contract_balance_id': 77426
DEBUG: empty 'destination_carrier_cash_balance' local col data for cdr id 50853, skipping
DEBUG: empty 'destination_carrier_free_time_balance' local col data for cdr id 50853, skipping
DEBUG: empty 'destination_carrier_profile_package_id' local col data for cdr id 50853, skipping
DEBUG: empty 'destination_carrier_contract_balance_id' local col data for cdr id 50853, skipping
DEBUG: local col data created or up to date for cdr id 50853, column 'destination_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50853, column 'destination_reseller_free_time_balance': 0, 0
DEBUG: empty 'destination_reseller_profile_package_id' local col data for cdr id 50853, skipping
DEBUG: local col data created or up to date for cdr id 50853, column 'destination_reseller_contract_balance_id': 77412
DEBUG: local col data created or up to date for cdr id 50853, column 'destination_customer_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50853, column 'destination_customer_free_time_balance': 0, 0
DEBUG: empty 'destination_customer_profile_package_id' local col data for cdr id 50853, skipping
DEBUG: local col data created or up to date for cdr id 50853, column 'destination_customer_contract_balance_id': 77428
DEBUG: rating cdr ID 50853 completed successfully in 0.129 secs
DEBUG: start rating CDR ID 50854
DEBUG: 4 contract(s) locked: 61903, 61904, 61919, 61920
INFO: 3/3 - rate CDR ID 50854
DEBUG: fetching source provider info for source_provider_id #61903
DEBUG: catching up contract ID 61903 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61903 billing mapping (reseller) is profile id 1 for time 1515762985.000 from ipv4 source ip 192.168.0.1
DEBUG: source_provider_info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77411
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'reseller',
                         'product_id' => 3,
                         'prepaid' => 0,
                         'profile_id' => 1,
                         'int_unit' => 'month',
                         'contract_id' => '61903'
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: fetching destination provider info for destination_provider_id #61904
DEBUG: catching up contract ID 61904 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61904 billing mapping (reseller) is profile id 1 for time 1515762985.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_provider_info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77412
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'reseller',
                         'product_id' => 3,
                         'prepaid' => 0,
                         'profile_id' => 1,
                         'int_unit' => 'month',
                         'contract_id' => '61904'
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: ### 1. write pass ###
DEBUG: call from local subscriber, source_user_id is 89c50bd2-0d57-4595-94e0-8df46444f07e
DEBUG: call to local subscriber, destination_user_id is 36fcbf8c-a88d-447c-a5a5-7353dfb85f74
DEBUG: destination provider has billing profile 1, get reseller termination cost
DEBUG: calculating call cost for profile_id 1 with type call, direction in, src_user_domain 8881151515762707@testa.com.1515762707, dst_user_domain 8882161515762707@testb.com.1515762707
DEBUG: no match for full uris, trying user only for profile_id 1 with type call, direction in, src_user_domain 8881151515762707, dst_user_domain 8882161515762707
DEBUG: 1 contract balance row(s) updated
DEBUG: destination reseller termination cost is 0
DEBUG: get customer termination cost for destination_user_id 36fcbf8c-a88d-447c-a5a5-7353dfb85f74
DEBUG: catching up contract ID 61920 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61920 billing mapping (sipaccount) is profile id 1135 for time 1515762985.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_customer info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '420',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77428
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount',
                         'product_id' => 4,
                         'prepaid' => 1,
                         'profile_id' => 1135,
                         'int_unit' => 'month',
                         'contract_id' => 61920
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1135 with type call, direction in, src_user_domain 8881151515762707@testa.com.1515762707, dst_user_domain 8882161515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '3',
          'on_follow_interval' => 30,
          'on_init_interval' => 60,
          'on_init_rate' => '3',
          'fee_id' => 1616,
          'off_follow_rate' => '1',
          'source_pattern' => '^8881.+',
          'pattern' => '.',
          'use_free_time' => 0,
          'zone_id' => 504,
          'on_follow_rate' => '1',
          'off_follow_interval' => 30,
          'off_init_interval' => 60
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 3 per sec to costs
DEBUG: interval is 60, so rate for this interval is 180
DEBUG: starting with contract balance: $VAR1 = {
          'free_time_balance_interval' => 0,
          'end_unix' => 1517443199,
          'start_unix' => 1514764800,
          'cash_balance_interval' => '420',
          'free_time_balance_old' => 0,
          'free_time_balance' => 0,
          'cash_balance' => '0',
          'cash_balance_old' => '0',
          'start' => '2018-01-01 00:00:00',
          'id' => 77428
        };
DEBUG: add current interval cost 180 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 180
DEBUG: rating_duration = 90
DEBUG: got call cost 210 and free time 0
DEBUG: treat pre-paid billing profile as post-paid for termination fees
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 210
DEBUG: destination customer termination cost is 210
DEBUG: calculating call cost for profile_id 1 with type call, direction out, src_user_domain 8881151515762707@testa.com.1515762707, dst_user_domain 8882161515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '0',
          'on_follow_interval' => 600,
          'on_init_interval' => 600,
          'on_init_rate' => '0',
          'fee_id' => 1000,
          'off_follow_rate' => '0',
          'source_pattern' => '.',
          'pattern' => '.*',
          'use_free_time' => 0,
          'zone_id' => 1,
          'on_follow_rate' => '0',
          'off_follow_interval' => 600,
          'off_init_interval' => 600
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 0 per sec to costs
DEBUG: interval is 600, so rate for this interval is 0
DEBUG: starting with contract balance: $VAR1 = {
          'end_unix' => 1517443199,
          'free_time_balance_interval' => 0,
          'start_unix' => 1514764800,
          'cash_balance_interval' => 0,
          'free_time_balance' => 0,
          'free_time_balance_old' => 0,
          'cash_balance' => 0,
          'cash_balance_old' => 0,
          'id' => 77411,
          'start' => '2018-01-01 00:00:00'
        };
DEBUG: add current interval cost 0 to total cost 0
DEBUG: rating_duration = 600
DEBUG: 1 contract balance row(s) updated
DEBUG: catching up contract ID 61919 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61919 billing mapping (sipaccount) is profile id 1132 for time 1515762985.000 from ipv4 source ip 192.168.0.1
DEBUG: source_customer info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77427
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount',
                         'product_id' => 4,
                         'prepaid' => 1,
                         'profile_id' => 1132,
                         'int_unit' => 'month',
                         'contract_id' => 61919
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: billing profile is prepaid
DEBUG: prepaid_costs cache already populated
DEBUG: prepaid_costs call_id = *TEST*0RIfZeS2Gz67splXPxUK3newJo, source_user_id = 89c50bd2-0d57-4595-94e0-8df46444f07e, destination_user_id = 36fcbf8c-a88d-447c-a5a5-7353dfb85f74 found in cache
DEBUG: calculating call cost for profile_id 1132 with type call, direction out, src_user_domain 8881151515762707@testa.com.1515762707, dst_user_domain 8882161515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '4',
          'on_follow_interval' => 30,
          'on_init_interval' => 60,
          'on_init_rate' => '4',
          'fee_id' => 1609,
          'off_follow_rate' => '1',
          'source_pattern' => '.',
          'pattern' => '^8882.+',
          'use_free_time' => 0,
          'zone_id' => 501,
          'on_follow_rate' => '1',
          'off_follow_interval' => 30,
          'off_init_interval' => 60
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 4 per sec to costs
DEBUG: interval is 60, so rate for this interval is 240
DEBUG: starting with contract balance: $VAR1 = {
          'free_time_balance_interval' => 0,
          'end_unix' => 1517443199,
          'start_unix' => 1514764800,
          'cash_balance_interval' => '0',
          'free_time_balance_old' => 0,
          'free_time_balance' => 0,
          'cash_balance' => '0',
          'cash_balance_old' => '0',
          'start' => '2018-01-01 00:00:00',
          'id' => 77427
        };
DEBUG: add current interval cost 240 to total cost 0
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: add current interval cost 30 to total cost 240
DEBUG: rating_duration = 90
DEBUG: got call cost 270 and free time 0
DEBUG: prepaid_costs call_id = *TEST*0RIfZeS2Gz67splXPxUK3newJo, source_user_id = 89c50bd2-0d57-4595-94e0-8df46444f07e, destination_user_id = 36fcbf8c-a88d-447c-a5a5-7353dfb85f74 deleted
DEBUG: dropped prepaid_costs call_id = *TEST*0RIfZeS2Gz67splXPxUK3newJo, source_user_id = 89c50bd2-0d57-4595-94e0-8df46444f07e, destination_user_id = 36fcbf8c-a88d-447c-a5a5-7353dfb85f74 from cache
DEBUG: cost for this call is 270
DEBUG: cdr ID 50854 updated
DEBUG: empty 'source_carrier_cash_balance' local col data for cdr id 50854, skipping
DEBUG: empty 'source_carrier_free_time_balance' local col data for cdr id 50854, skipping
DEBUG: empty 'source_carrier_profile_package_id' local col data for cdr id 50854, skipping
DEBUG: empty 'source_carrier_contract_balance_id' local col data for cdr id 50854, skipping
DEBUG: local col data created or up to date for cdr id 50854, column 'source_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50854, column 'source_reseller_free_time_balance': 0, 0
DEBUG: empty 'source_reseller_profile_package_id' local col data for cdr id 50854, skipping
DEBUG: local col data created or up to date for cdr id 50854, column 'source_reseller_contract_balance_id': 77411
DEBUG: local col data created or up to date for cdr id 50854, column 'source_customer_cash_balance': 270.0000, 0
DEBUG: local col data created or up to date for cdr id 50854, column 'source_customer_free_time_balance': 0, 0
DEBUG: empty 'source_customer_profile_package_id' local col data for cdr id 50854, skipping
DEBUG: local col data created or up to date for cdr id 50854, column 'source_customer_contract_balance_id': 77427
DEBUG: empty 'destination_carrier_cash_balance' local col data for cdr id 50854, skipping
DEBUG: empty 'destination_carrier_free_time_balance' local col data for cdr id 50854, skipping
DEBUG: empty 'destination_carrier_profile_package_id' local col data for cdr id 50854, skipping
DEBUG: empty 'destination_carrier_contract_balance_id' local col data for cdr id 50854, skipping
DEBUG: local col data created or up to date for cdr id 50854, column 'destination_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50854, column 'destination_reseller_free_time_balance': 0, 0
DEBUG: empty 'destination_reseller_profile_package_id' local col data for cdr id 50854, skipping
DEBUG: local col data created or up to date for cdr id 50854, column 'destination_reseller_contract_balance_id': 77412
DEBUG: local col data created or up to date for cdr id 50854, column 'destination_customer_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50854, column 'destination_customer_free_time_balance': 0, 0
DEBUG: empty 'destination_customer_profile_package_id' local col data for cdr id 50854, skipping
DEBUG: local col data created or up to date for cdr id 50854, column 'destination_customer_contract_balance_id': 77428
DEBUG: rating cdr ID 50854 completed successfully in 0.131 secs
INFO: Batch of 3 CDRs completed. 3 CDRs rated overall so far.
INFO: Less than 5 new CDRs, sleep 10
ok 658 - rate-o-mat executed
ok 659 - prepaid w prepaid costs, no balance: destination_customer_cost = 210.000000
ok 660 - prepaid w prepaid costs, no balance: source_customer_cost = 270.000000
not ok 661 - prepaid w prepaid costs, no balance: source_reseller_cost = 150.000000
ok 662 - prepaid w prepaid costs, no balance: id = 50852
ok 663 - prepaid w prepaid costs, no balance: rating_status = ok
not ok 664 - prepaid w prepaid costs, no balance: destination_reseller_cost = 90.000000
not ok 665 - prepaid w prepaid costs, no balance: destination_reseller_cost = 90.000000
ok 666 - prepaid w prepaid costs, no balance: rating_status = ok
not ok 667 - prepaid w prepaid costs, no balance: source_reseller_cost = 150.000000
ok 668 - prepaid w prepaid costs, no balance: id = 50854
ok 669 - prepaid w prepaid costs, no balance: destination_customer_cost = 210.000000
ok 670 - prepaid w prepaid costs, no balance: source_customer_cost = 270.000000
ok 671 - prepaid w prepaid costs, no balance: source_customer_cost = 270.000000
ok 672 - prepaid w prepaid costs, no balance: destination_customer_cost = 210.000000
not ok 673 - prepaid w prepaid costs, no balance: source_reseller_cost = 150.000000
ok 674 - prepaid w prepaid costs, no balance: id = 50853
ok 675 - prepaid w prepaid costs, no balance: rating_status = ok
not ok 676 - prepaid w prepaid costs, no balance: destination_reseller_cost = 90.000000
not ok 677 - cdrs were all processed
ok 678 - prepaid w prepaid costs, no balance, caller 1: cdr id 50852 source_customer_contract_balance_id number of records 1 = 1
ok 679 - prepaid w prepaid costs, no balance, caller 1: fetch customer id 61917 balance intervals collection page
ok 680 - prepaid w prepaid costs, no balance, caller 1: check 'total_count' of collection
ok 681 - prepaid w prepaid costs, no balance, caller 1: check interval 77425 cash balance 0 = 0
ok 682 - prepaid w prepaid costs, no balance, caller 1: check interval 77425 cash balance interval 0 = 0
ok 683 - prepaid w prepaid costs, no balance, caller 1: check interval 77425 id = 77425
ok 684 - prepaid w prepaid costs, no balance, caller 1: check if all expected items are listed
ok 685 - prepaid w prepaid costs, no balance, caller 1: cdr id 50852 source_customer_cash_balance before 270.0000 = 270.0000
ok 686 - prepaid w prepaid costs, no balance, caller 1: cdr id 50852 source_customer_cash_balance after 0.0000 = 0.0000
ok 687 - prepaid w prepaid costs, no balance, caller 2: cdr id 50853 source_customer_contract_balance_id number of records 1 = 1
ok 688 - prepaid w prepaid costs, no balance, caller 2: fetch customer id 61918 balance intervals collection page
ok 689 - prepaid w prepaid costs, no balance, caller 2: check 'total_count' of collection
ok 690 - prepaid w prepaid costs, no balance, caller 2: check interval 77426 cash balance 0 = 0
ok 691 - prepaid w prepaid costs, no balance, caller 2: check interval 77426 cash balance interval 0 = 0
ok 692 - prepaid w prepaid costs, no balance, caller 2: check interval 77426 id = 77426
ok 693 - prepaid w prepaid costs, no balance, caller 2: check if all expected items are listed
ok 694 - prepaid w prepaid costs, no balance, caller 2: cdr id 50853 source_customer_cash_balance before 270.0000 = 270.0000
ok 695 - prepaid w prepaid costs, no balance, caller 2: cdr id 50853 source_customer_cash_balance after 0.0000 = 0.0000
ok 696 - prepaid w prepaid costs, no balance, caller 3: cdr id 50854 source_customer_contract_balance_id number of records 1 = 1
ok 697 - prepaid w prepaid costs, no balance, caller 3: fetch customer id 61919 balance intervals collection page
ok 698 - prepaid w prepaid costs, no balance, caller 3: check 'total_count' of collection
ok 699 - prepaid w prepaid costs, no balance, caller 3: check interval 77427 cash balance 0 = 0
ok 700 - prepaid w prepaid costs, no balance, caller 3: check interval 77427 cash balance interval 0 = 0
ok 701 - prepaid w prepaid costs, no balance, caller 3: check interval 77427 id = 77427
ok 702 - prepaid w prepaid costs, no balance, caller 3: check if all expected items are listed
ok 703 - prepaid w prepaid costs, no balance, caller 3: cdr id 50854 source_customer_cash_balance before 270.0000 = 270.0000
ok 704 - prepaid w prepaid costs, no balance, caller 3: cdr id 50854 source_customer_cash_balance after 0.0000 = 0.0000
ok 705 - prepaid w prepaid costs, no balance, callee: cdr id 50852 destination_customer_contract_balance_id number of records 1 = 1
ok 706 - prepaid w prepaid costs, no balance, callee: fetch customer id 61920 balance intervals collection page
ok 707 - prepaid w prepaid costs, no balance, callee: check 'total_count' of collection
ok 708 - prepaid w prepaid costs, no balance, callee: check interval 77428 cash balance 0 = 0
ok 709 - prepaid w prepaid costs, no balance, callee: check interval 77428 cash balance interval 6.3 = 6.3
ok 710 - prepaid w prepaid costs, no balance, callee: check interval 77428 id = 77428
ok 711 - prepaid w prepaid costs, no balance, callee: check if all expected items are listed
ok 712 - prepaid w prepaid costs, no balance, callee: cdr id 50852 destination_customer_contract_balance_id 77428 = 77428
ok 713 - prepaid w prepaid costs, no balance, callee: cdr id 50852 destination_customer_cash_balance before 0.0000 = 0.0000
ok 714 - prepaid w prepaid costs, no balance, callee: cdr id 50852 destination_customer_cash_balance after 0.0000 = 0.0000
ok 715 - prepaid w prepaid costs, no balance, callee: cdr id 50853 destination_customer_contract_balance_id 77428 = 77428
ok 716 - prepaid w prepaid costs, no balance, callee: cdr id 50853 destination_customer_cash_balance before 0.0000 = 0.0000
ok 717 - prepaid w prepaid costs, no balance, callee: cdr id 50853 destination_customer_cash_balance after 0.0000 = 0.0000
ok 718 - prepaid w prepaid costs, no balance, callee: cdr id 50854 destination_customer_contract_balance_id 77428 = 77428
ok 719 - prepaid w prepaid costs, no balance, callee: cdr id 50854 destination_customer_cash_balance before 0.0000 = 0.0000
ok 720 - prepaid w prepaid costs, no balance, callee: cdr id 50854 destination_customer_cash_balance after 0.0000 = 0.0000
ok 721 - prepaid w prepaid costs, no balance, callers' provider: cdr id 50852 source_reseller_contract_balance_id number of records 1 = 1
ok 722 - prepaid w prepaid costs, no balance, callers' provider: fetch customer id 61903 balance intervals collection page
ok 723 - prepaid w prepaid costs, no balance, callers' provider: check 'total_count' of collection
not ok 724 - prepaid w prepaid costs, no balance, callers' provider: check interval 77411 cash balance interval 0 = 18
ok 725 - prepaid w prepaid costs, no balance, callers' provider: check interval 77411 id = 77411
ok 726 - prepaid w prepaid costs, no balance, callers' provider: check if all expected items are listed
ok 727 - prepaid w prepaid costs, no balance, callers' provider: cdr id 50852 source_carrier_contract_balance_id number of records 0 = 0
ok 728 - prepaid w prepaid costs, no balance, callers' provider: cdr id 50852 source_reseller_contract_balance_id 77411 = 77411
ok 729 - prepaid w prepaid costs, no balance, callers' provider: cdr id 50853 source_carrier_contract_balance_id number of records 0 = 0
ok 730 - prepaid w prepaid costs, no balance, callers' provider: cdr id 50853 source_reseller_contract_balance_id 77411 = 77411
ok 731 - prepaid w prepaid costs, no balance, callers' provider: cdr id 50854 source_carrier_contract_balance_id number of records 0 = 0
ok 732 - prepaid w prepaid costs, no balance, callers' provider: cdr id 50854 source_reseller_contract_balance_id 77411 = 77411
ok 733 - prepaid w prepaid costs, no balance, callee's provider: cdr id 50852 destination_reseller_contract_balance_id number of records 1 = 1
ok 734 - prepaid w prepaid costs, no balance, callee's provider: fetch customer id 61904 balance intervals collection page
ok 735 - prepaid w prepaid costs, no balance, callee's provider: check 'total_count' of collection
not ok 736 - prepaid w prepaid costs, no balance, callee's provider: check interval 77412 cash balance interval 0 = 10.8
ok 737 - prepaid w prepaid costs, no balance, callee's provider: check interval 77412 id = 77412
ok 738 - prepaid w prepaid costs, no balance, callee's provider: check if all expected items are listed
ok 739 - prepaid w prepaid costs, no balance, callee's provider: cdr id 50852 destination_carrier_contract_balance_id number of records 0 = 0
ok 740 - prepaid w prepaid costs, no balance, callee's provider: cdr id 50852 destination_reseller_contract_balance_id 77412 = 77412
ok 741 - prepaid w prepaid costs, no balance, callee's provider: cdr id 50853 destination_carrier_contract_balance_id number of records 0 = 0
ok 742 - prepaid w prepaid costs, no balance, callee's provider: cdr id 50853 destination_reseller_contract_balance_id 77412 = 77412
ok 743 - prepaid w prepaid costs, no balance, callee's provider: cdr id 50854 destination_carrier_contract_balance_id number of records 0 = 0
ok 744 - prepaid w prepaid costs, no balance, callee's provider: cdr id 50854 destination_reseller_contract_balance_id 77412 = 77412
ok 745 - prepaid w prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50852 source_carrier_profile_package_id number of records 0 = 0
ok 746 - prepaid w prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50852 source_reseller_profile_package_id number of records 0 = 0
ok 747 - prepaid w prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50852 source_customer_profile_package_id number of records 0 = 0
ok 748 - prepaid w prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50852 destination_carrier_profile_package_id number of records 0 = 0
ok 749 - prepaid w prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50852 destination_reseller_profile_package_id number of records 0 = 0
ok 750 - prepaid w prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50852 destination_customer_profile_package_id number of records 0 = 0
ok 751 - prepaid w prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50853 source_carrier_profile_package_id number of records 0 = 0
ok 752 - prepaid w prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50853 source_reseller_profile_package_id number of records 0 = 0
ok 753 - prepaid w prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50853 source_customer_profile_package_id number of records 0 = 0
ok 754 - prepaid w prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50853 destination_carrier_profile_package_id number of records 0 = 0
ok 755 - prepaid w prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50853 destination_reseller_profile_package_id number of records 0 = 0
ok 756 - prepaid w prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50853 destination_customer_profile_package_id number of records 0 = 0
ok 757 - prepaid w prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50854 source_carrier_profile_package_id number of records 0 = 0
ok 758 - prepaid w prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50854 source_reseller_profile_package_id number of records 0 = 0
ok 759 - prepaid w prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50854 source_customer_profile_package_id number of records 0 = 0
ok 760 - prepaid w prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50854 destination_carrier_profile_package_id number of records 0 = 0
ok 761 - prepaid w prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50854 destination_reseller_profile_package_id number of records 0 = 0
ok 762 - prepaid w prepaid costs, no balance providers and subscriber must not have a profile package: cdr id 50854 destination_customer_profile_package_id number of records 0 = 0
ok 763 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50852 source_carrier_free_time_balance number of records 0 = 0
ok 764 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50852 source_reseller_free_time_balance before 0 = 0
ok 765 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50852 source_reseller_free_time_balance after 0 = 0
ok 766 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50852 source_customer_free_time_balance before 0 = 0
ok 767 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50852 source_customer_free_time_balance after 0 = 0
ok 768 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50852 destination_carrier_free_time_balance number of records 0 = 0
ok 769 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50852 destination_reseller_free_time_balance before 0 = 0
ok 770 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50852 destination_reseller_free_time_balance after 0 = 0
ok 771 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50852 destination_customer_free_time_balance before 0 = 0
ok 772 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50852 destination_customer_free_time_balance after 0 = 0
ok 773 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50853 source_carrier_free_time_balance number of records 0 = 0
ok 774 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50853 source_reseller_free_time_balance before 0 = 0
ok 775 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50853 source_reseller_free_time_balance after 0 = 0
ok 776 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50853 source_customer_free_time_balance before 0 = 0
ok 777 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50853 source_customer_free_time_balance after 0 = 0
ok 778 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50853 destination_carrier_free_time_balance number of records 0 = 0
ok 779 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50853 destination_reseller_free_time_balance before 0 = 0
ok 780 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50853 destination_reseller_free_time_balance after 0 = 0
ok 781 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50853 destination_customer_free_time_balance before 0 = 0
ok 782 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50853 destination_customer_free_time_balance after 0 = 0
ok 783 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50854 source_carrier_free_time_balance number of records 0 = 0
ok 784 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50854 source_reseller_free_time_balance before 0 = 0
ok 785 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50854 source_reseller_free_time_balance after 0 = 0
ok 786 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50854 source_customer_free_time_balance before 0 = 0
ok 787 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50854 source_customer_free_time_balance after 0 = 0
ok 788 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50854 destination_carrier_free_time_balance number of records 0 = 0
ok 789 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50854 destination_reseller_free_time_balance before 0 = 0
ok 790 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50854 destination_reseller_free_time_balance after 0 = 0
ok 791 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50854 destination_customer_free_time_balance before 0 = 0
ok 792 - prepaid w prepaid costs, no balance providers and subscriber must have zero free time: cdr id 50854 destination_customer_free_time_balance after 0 = 0
ok 793 - prepaid w prepaid costs, no balance providers must have zero balance: cdr id 50852 source_carrier_cash_balance number of records 0 = 0
ok 794 - prepaid w prepaid costs, no balance providers must have zero balance: cdr id 50852 source_reseller_cash_balance before 0.0000 = 0.0000
ok 795 - prepaid w prepaid costs, no balance providers must have zero balance: cdr id 50852 source_reseller_cash_balance after 0.0000 = 0.0000
ok 796 - prepaid w prepaid costs, no balance providers must have zero balance: cdr id 50852 destination_carrier_cash_balance number of records 0 = 0
ok 797 - prepaid w prepaid costs, no balance providers must have zero balance: cdr id 50852 destination_reseller_cash_balance before 0.0000 = 0.0000
ok 798 - prepaid w prepaid costs, no balance providers must have zero balance: cdr id 50852 destination_reseller_cash_balance after 0.0000 = 0.0000
ok 799 - prepaid w prepaid costs, no balance providers must have zero balance: cdr id 50853 source_carrier_cash_balance number of records 0 = 0
ok 800 - prepaid w prepaid costs, no balance providers must have zero balance: cdr id 50853 source_reseller_cash_balance before 0.0000 = 0.0000
ok 801 - prepaid w prepaid costs, no balance providers must have zero balance: cdr id 50853 source_reseller_cash_balance after 0.0000 = 0.0000
ok 802 - prepaid w prepaid costs, no balance providers must have zero balance: cdr id 50853 destination_carrier_cash_balance number of records 0 = 0
ok 803 - prepaid w prepaid costs, no balance providers must have zero balance: cdr id 50853 destination_reseller_cash_balance before 0.0000 = 0.0000
ok 804 - prepaid w prepaid costs, no balance providers must have zero balance: cdr id 50853 destination_reseller_cash_balance after 0.0000 = 0.0000
ok 805 - prepaid w prepaid costs, no balance providers must have zero balance: cdr id 50854 source_carrier_cash_balance number of records 0 = 0
ok 806 - prepaid w prepaid costs, no balance providers must have zero balance: cdr id 50854 source_reseller_cash_balance before 0.0000 = 0.0000
ok 807 - prepaid w prepaid costs, no balance providers must have zero balance: cdr id 50854 source_reseller_cash_balance after 0.0000 = 0.0000
ok 808 - prepaid w prepaid costs, no balance providers must have zero balance: cdr id 50854 destination_carrier_cash_balance number of records 0 = 0
ok 809 - prepaid w prepaid costs, no balance providers must have zero balance: cdr id 50854 destination_reseller_cash_balance before 0.0000 = 0.0000
ok 810 - prepaid w prepaid costs, no balance providers must have zero balance: cdr id 50854 destination_reseller_cash_balance after 0.0000 = 0.0000
ok 811 - create customercontacts 17
ok 812 - create customers 17
ok 813 - setting customer id 61921 cash_balance to 1000 cents
ok 814 - create subscribers 17
ok 815 - very first balance interval: fetch customer id 61921 balance intervals collection page
ok 816 - very first balance interval: check interval 77429 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 817 - very first balance interval: check interval 77429 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 818 - very first balance interval: check interval 77429 cash balance 10 = 10
ok 819 - very first balance interval: check interval 77429 billing profile id 1132 = 1132
ok 820 - very first balance interval: check if all expected items are listed
ok 821 - create customercontacts 18
ok 822 - create customers 18
ok 823 - setting customer id 61922 cash_balance to 1000 cents
ok 824 - create subscribers 18
ok 825 - very first balance interval: fetch customer id 61922 balance intervals collection page
ok 826 - very first balance interval: check interval 77430 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 827 - very first balance interval: check interval 77430 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 828 - very first balance interval: check interval 77430 cash balance 10 = 10
ok 829 - very first balance interval: check interval 77430 billing profile id 1132 = 1132
ok 830 - very first balance interval: check if all expected items are listed
ok 831 - create customercontacts 19
ok 832 - create customers 19
ok 833 - setting customer id 61923 cash_balance to 1000 cents
ok 834 - create subscribers 19
ok 835 - very first balance interval: fetch customer id 61923 balance intervals collection page
ok 836 - very first balance interval: check interval 77431 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 837 - very first balance interval: check interval 77431 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 838 - very first balance interval: check interval 77431 cash balance 10 = 10
ok 839 - very first balance interval: check interval 77431 billing profile id 1132 = 1132
ok 840 - very first balance interval: check if all expected items are listed
ok 841 - create customercontacts 20
ok 842 - create customers 20
ok 843 - setting customer id 61924 cash_balance to 1000 cents
ok 844 - create subscribers 20
ok 845 - very first balance interval: fetch customer id 61924 balance intervals collection page
ok 846 - very first balance interval: check interval 77432 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 847 - very first balance interval: check interval 77432 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 848 - very first balance interval: check interval 77432 cash balance 10 = 10
ok 849 - very first balance interval: check interval 77432 billing profile id 1135 = 1135
ok 850 - very first balance interval: check if all expected items are listed
ok 851 - cdrs id 50855, 50856, 50857 created
INFO: Trying to connect to billing db...
INFO: Successfully connected to duplication db...
INFO: Trying to connect to provisioning db...
INFO: Successfully connected to provisioning db...
INFO: Trying to connect to accounting db...
INFO: Successfully connected to accounting db...
WARNING: No duplication db credentials, disabled.
INFO: local cdr relation column model loaded
INFO: local cdr cash balance column model loaded
INFO: local cdr time balance column model loaded
INFO: Up and running.
INFO: Grabbed 3 CDRs
DEBUG: start rating CDR ID 50855
DEBUG: 4 contract(s) locked: 61903, 61904, 61921, 61924
INFO: 1/3 - rate CDR ID 50855
DEBUG: fetching source provider info for source_provider_id #61903
DEBUG: catching up contract ID 61903 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61903 billing mapping (reseller) is profile id 1 for time 1515763040.000 from ipv4 source ip 192.168.0.1
DEBUG: source_provider_info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'id' => 77411,
                            'start' => '2018-01-01 00:00:00'
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'reseller',
                         'product_id' => 3,
                         'prepaid' => 0,
                         'profile_id' => 1,
                         'int_unit' => 'month',
                         'contract_id' => '61903'
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: fetching destination provider info for destination_provider_id #61904
DEBUG: catching up contract ID 61904 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61904 billing mapping (reseller) is profile id 1 for time 1515763040.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_provider_info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77412
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'reseller',
                         'product_id' => 3,
                         'prepaid' => 0,
                         'profile_id' => 1,
                         'int_unit' => 'month',
                         'contract_id' => '61904'
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: ### 1. write pass ###
DEBUG: call from local subscriber, source_user_id is 0feb9107-ee27-42ee-84da-04b4f9dc9f38
DEBUG: call to local subscriber, destination_user_id is 8ee14fcd-571e-49d3-afb5-b139c8654bf4
DEBUG: destination provider has billing profile 1, get reseller termination cost
DEBUG: calculating call cost for profile_id 1 with type call, direction in, src_user_domain 8881171515762707@testa.com.1515762707, dst_user_domain 8882201515762707@testb.com.1515762707
DEBUG: no match for full uris, trying user only for profile_id 1 with type call, direction in, src_user_domain 8881171515762707, dst_user_domain 8882201515762707
DEBUG: 1 contract balance row(s) updated
DEBUG: destination reseller termination cost is 0
DEBUG: get customer termination cost for destination_user_id 8ee14fcd-571e-49d3-afb5-b139c8654bf4
DEBUG: catching up contract ID 61924 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61924 billing mapping (sipaccount) is profile id 1135 for time 1515763040.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_customer info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '1000',
                            'cash_balance_old' => '1000',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77432
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount',
                         'product_id' => 4,
                         'prepaid' => 1,
                         'profile_id' => 1135,
                         'int_unit' => 'month',
                         'contract_id' => 61924
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1135 with type call, direction in, src_user_domain 8881171515762707@testa.com.1515762707, dst_user_domain 8882201515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '3',
          'on_follow_interval' => 30,
          'on_init_interval' => 60,
          'on_init_rate' => '3',
          'fee_id' => 1616,
          'off_follow_rate' => '1',
          'source_pattern' => '^8881.+',
          'pattern' => '.',
          'use_free_time' => 0,
          'zone_id' => 504,
          'on_follow_rate' => '1',
          'off_follow_interval' => 30,
          'off_init_interval' => 60
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 3 per sec to costs
DEBUG: interval is 60, so rate for this interval is 180
DEBUG: starting with contract balance: $VAR1 = {
          'free_time_balance_interval' => 0,
          'end_unix' => 1517443199,
          'start_unix' => 1514764800,
          'cash_balance_interval' => '0',
          'free_time_balance_old' => 0,
          'free_time_balance' => 0,
          'cash_balance' => '1000',
          'cash_balance_old' => '1000',
          'start' => '2018-01-01 00:00:00',
          'id' => 77432
        };
DEBUG: we still have cash balance 1000 left, subtract rate 180 from that
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: we still have cash balance 820 left, subtract rate 30 from that
DEBUG: rating_duration = 90
DEBUG: got call cost 0 and free time 0
DEBUG: treat pre-paid billing profile as post-paid for termination fees
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 210
DEBUG: destination customer termination cost is 210
DEBUG: calculating call cost for profile_id 1 with type call, direction out, src_user_domain 8881171515762707@testa.com.1515762707, dst_user_domain 8882201515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '0',
          'on_follow_interval' => 600,
          'on_init_interval' => 600,
          'on_init_rate' => '0',
          'fee_id' => 1000,
          'off_follow_rate' => '0',
          'source_pattern' => '.',
          'pattern' => '.*',
          'use_free_time' => 0,
          'zone_id' => 1,
          'on_follow_rate' => '0',
          'off_follow_interval' => 600,
          'off_init_interval' => 600
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 0 per sec to costs
DEBUG: interval is 600, so rate for this interval is 0
DEBUG: starting with contract balance: $VAR1 = {
          'end_unix' => 1517443199,
          'free_time_balance_interval' => 0,
          'start_unix' => 1514764800,
          'cash_balance_interval' => 0,
          'free_time_balance' => 0,
          'free_time_balance_old' => 0,
          'cash_balance' => 0,
          'cash_balance_old' => 0,
          'start' => '2018-01-01 00:00:00',
          'id' => 77411
        };
DEBUG: add current interval cost 0 to total cost 0
DEBUG: rating_duration = 600
DEBUG: 1 contract balance row(s) updated
DEBUG: catching up contract ID 61921 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61921 billing mapping (sipaccount) is profile id 1132 for time 1515763040.000 from ipv4 source ip 192.168.0.1
DEBUG: source_customer info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '1000',
                            'cash_balance_old' => '1000',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77429
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount',
                         'product_id' => 4,
                         'prepaid' => 1,
                         'profile_id' => 1132,
                         'int_unit' => 'month',
                         'contract_id' => 61921
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: billing profile is prepaid
DEBUG: empty prepaid_costs cache, populate it
DEBUG: prepaid_costs cache populated, 0 records
DEBUG: calculating call cost for profile_id 1132 with type call, direction out, src_user_domain 8881171515762707@testa.com.1515762707, dst_user_domain 8882201515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '4',
          'on_follow_interval' => 30,
          'on_init_interval' => 60,
          'on_init_rate' => '4',
          'fee_id' => 1609,
          'off_follow_rate' => '1',
          'source_pattern' => '.',
          'pattern' => '^8882.+',
          'use_free_time' => 0,
          'zone_id' => 501,
          'on_follow_rate' => '1',
          'off_follow_interval' => 30,
          'off_init_interval' => 60
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 4 per sec to costs
DEBUG: interval is 60, so rate for this interval is 240
DEBUG: starting with contract balance: $VAR1 = {
          'free_time_balance_interval' => 0,
          'end_unix' => 1517443199,
          'start_unix' => 1514764800,
          'cash_balance_interval' => '0',
          'free_time_balance_old' => 0,
          'free_time_balance' => 0,
          'cash_balance' => '1000',
          'cash_balance_old' => '1000',
          'start' => '2018-01-01 00:00:00',
          'id' => 77429
        };
DEBUG: we still have cash balance 1000 left, subtract rate 240 from that
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: we still have cash balance 760 left, subtract rate 30 from that
DEBUG: rating_duration = 90
DEBUG: got call cost 0 and free time 0
WARNING: no prepaid cost record found for call ID *TEST*2FqJaeB9e6m5PKlsvqgN0YZo2., applying calculated costs
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 270
DEBUG: cdr ID 50855 updated
DEBUG: empty 'source_carrier_cash_balance' local col data for cdr id 50855, skipping
DEBUG: empty 'source_carrier_free_time_balance' local col data for cdr id 50855, skipping
DEBUG: empty 'source_carrier_profile_package_id' local col data for cdr id 50855, skipping
DEBUG: empty 'source_carrier_contract_balance_id' local col data for cdr id 50855, skipping
DEBUG: local col data created or up to date for cdr id 50855, column 'source_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50855, column 'source_reseller_free_time_balance': 0, 0
DEBUG: empty 'source_reseller_profile_package_id' local col data for cdr id 50855, skipping
DEBUG: local col data created or up to date for cdr id 50855, column 'source_reseller_contract_balance_id': 77411
DEBUG: local col data created or up to date for cdr id 50855, column 'source_customer_cash_balance': 1000, 730
DEBUG: local col data created or up to date for cdr id 50855, column 'source_customer_free_time_balance': 0, 0
DEBUG: empty 'source_customer_profile_package_id' local col data for cdr id 50855, skipping
DEBUG: local col data created or up to date for cdr id 50855, column 'source_customer_contract_balance_id': 77429
DEBUG: empty 'destination_carrier_cash_balance' local col data for cdr id 50855, skipping
DEBUG: empty 'destination_carrier_free_time_balance' local col data for cdr id 50855, skipping
DEBUG: empty 'destination_carrier_profile_package_id' local col data for cdr id 50855, skipping
DEBUG: empty 'destination_carrier_contract_balance_id' local col data for cdr id 50855, skipping
DEBUG: local col data created or up to date for cdr id 50855, column 'destination_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50855, column 'destination_reseller_free_time_balance': 0, 0
DEBUG: empty 'destination_reseller_profile_package_id' local col data for cdr id 50855, skipping
DEBUG: local col data created or up to date for cdr id 50855, column 'destination_reseller_contract_balance_id': 77412
DEBUG: local col data created or up to date for cdr id 50855, column 'destination_customer_cash_balance': 1000, 790
DEBUG: local col data created or up to date for cdr id 50855, column 'destination_customer_free_time_balance': 0, 0
DEBUG: empty 'destination_customer_profile_package_id' local col data for cdr id 50855, skipping
DEBUG: local col data created or up to date for cdr id 50855, column 'destination_customer_contract_balance_id': 77432
DEBUG: rating cdr ID 50855 completed successfully in 0.155 secs
DEBUG: start rating CDR ID 50856
DEBUG: 4 contract(s) locked: 61903, 61904, 61922, 61924
INFO: 2/3 - rate CDR ID 50856
DEBUG: fetching source provider info for source_provider_id #61903
DEBUG: catching up contract ID 61903 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61903 billing mapping (reseller) is profile id 1 for time 1515763041.000 from ipv4 source ip 192.168.0.1
DEBUG: source_provider_info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77411
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'reseller',
                         'product_id' => 3,
                         'prepaid' => 0,
                         'profile_id' => 1,
                         'int_unit' => 'month',
                         'contract_id' => '61903'
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: fetching destination provider info for destination_provider_id #61904
DEBUG: catching up contract ID 61904 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61904 billing mapping (reseller) is profile id 1 for time 1515763041.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_provider_info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77412
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'reseller',
                         'product_id' => 3,
                         'prepaid' => 0,
                         'profile_id' => 1,
                         'int_unit' => 'month',
                         'contract_id' => '61904'
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: ### 1. write pass ###
DEBUG: call from local subscriber, source_user_id is fb182557-ab92-42cd-bbc7-0e79659b176c
DEBUG: call to local subscriber, destination_user_id is 8ee14fcd-571e-49d3-afb5-b139c8654bf4
DEBUG: destination provider has billing profile 1, get reseller termination cost
DEBUG: calculating call cost for profile_id 1 with type call, direction in, src_user_domain 8881181515762707@testa.com.1515762707, dst_user_domain 8882201515762707@testb.com.1515762707
DEBUG: no match for full uris, trying user only for profile_id 1 with type call, direction in, src_user_domain 8881181515762707, dst_user_domain 8882201515762707
DEBUG: 1 contract balance row(s) updated
DEBUG: destination reseller termination cost is 0
DEBUG: get customer termination cost for destination_user_id 8ee14fcd-571e-49d3-afb5-b139c8654bf4
DEBUG: catching up contract ID 61924 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61924 billing mapping (sipaccount) is profile id 1135 for time 1515763041.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_customer info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '210',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '790',
                            'cash_balance_old' => '790',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77432
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount',
                         'product_id' => 4,
                         'prepaid' => 1,
                         'profile_id' => 1135,
                         'int_unit' => 'month',
                         'contract_id' => 61924
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1135 with type call, direction in, src_user_domain 8881181515762707@testa.com.1515762707, dst_user_domain 8882201515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '3',
          'on_follow_interval' => 30,
          'on_init_interval' => 60,
          'on_init_rate' => '3',
          'fee_id' => 1616,
          'off_follow_rate' => '1',
          'source_pattern' => '^8881.+',
          'pattern' => '.',
          'use_free_time' => 0,
          'zone_id' => 504,
          'on_follow_rate' => '1',
          'off_follow_interval' => 30,
          'off_init_interval' => 60
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 3 per sec to costs
DEBUG: interval is 60, so rate for this interval is 180
DEBUG: starting with contract balance: $VAR1 = {
          'free_time_balance_interval' => 0,
          'end_unix' => 1517443199,
          'start_unix' => 1514764800,
          'cash_balance_interval' => '210',
          'free_time_balance_old' => 0,
          'free_time_balance' => 0,
          'cash_balance' => '790',
          'cash_balance_old' => '790',
          'start' => '2018-01-01 00:00:00',
          'id' => 77432
        };
DEBUG: we still have cash balance 790 left, subtract rate 180 from that
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: we still have cash balance 610 left, subtract rate 30 from that
DEBUG: rating_duration = 90
DEBUG: got call cost 0 and free time 0
DEBUG: treat pre-paid billing profile as post-paid for termination fees
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 210
DEBUG: destination customer termination cost is 210
DEBUG: calculating call cost for profile_id 1 with type call, direction out, src_user_domain 8881181515762707@testa.com.1515762707, dst_user_domain 8882201515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '0',
          'on_follow_interval' => 600,
          'on_init_interval' => 600,
          'on_init_rate' => '0',
          'fee_id' => 1000,
          'off_follow_rate' => '0',
          'source_pattern' => '.',
          'pattern' => '.*',
          'use_free_time' => 0,
          'zone_id' => 1,
          'on_follow_rate' => '0',
          'off_follow_interval' => 600,
          'off_init_interval' => 600
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 0 per sec to costs
DEBUG: interval is 600, so rate for this interval is 0
DEBUG: starting with contract balance: $VAR1 = {
          'end_unix' => 1517443199,
          'free_time_balance_interval' => 0,
          'start_unix' => 1514764800,
          'cash_balance_interval' => 0,
          'free_time_balance' => 0,
          'free_time_balance_old' => 0,
          'cash_balance' => 0,
          'cash_balance_old' => 0,
          'id' => 77411,
          'start' => '2018-01-01 00:00:00'
        };
DEBUG: add current interval cost 0 to total cost 0
DEBUG: rating_duration = 600
DEBUG: 1 contract balance row(s) updated
DEBUG: catching up contract ID 61922 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61922 billing mapping (sipaccount) is profile id 1132 for time 1515763041.000 from ipv4 source ip 192.168.0.1
DEBUG: source_customer info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '1000',
                            'cash_balance_old' => '1000',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77430
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount',
                         'product_id' => 4,
                         'prepaid' => 1,
                         'profile_id' => 1132,
                         'int_unit' => 'month',
                         'contract_id' => 61922
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: billing profile is prepaid
DEBUG: prepaid_costs cache already populated
DEBUG: calculating call cost for profile_id 1132 with type call, direction out, src_user_domain 8881181515762707@testa.com.1515762707, dst_user_domain 8882201515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '4',
          'on_follow_interval' => 30,
          'on_init_interval' => 60,
          'on_init_rate' => '4',
          'fee_id' => 1609,
          'off_follow_rate' => '1',
          'source_pattern' => '.',
          'pattern' => '^8882.+',
          'use_free_time' => 0,
          'zone_id' => 501,
          'on_follow_rate' => '1',
          'off_follow_interval' => 30,
          'off_init_interval' => 60
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 4 per sec to costs
DEBUG: interval is 60, so rate for this interval is 240
DEBUG: starting with contract balance: $VAR1 = {
          'free_time_balance_interval' => 0,
          'end_unix' => 1517443199,
          'start_unix' => 1514764800,
          'cash_balance_interval' => '0',
          'free_time_balance_old' => 0,
          'free_time_balance' => 0,
          'cash_balance' => '1000',
          'cash_balance_old' => '1000',
          'start' => '2018-01-01 00:00:00',
          'id' => 77430
        };
DEBUG: we still have cash balance 1000 left, subtract rate 240 from that
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: we still have cash balance 760 left, subtract rate 30 from that
DEBUG: rating_duration = 90
DEBUG: got call cost 0 and free time 0
WARNING: no prepaid cost record found for call ID *TEST*3JCBiXIXvhKL30GYzv2XVf.sli, applying calculated costs
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 270
DEBUG: cdr ID 50856 updated
DEBUG: empty 'source_carrier_cash_balance' local col data for cdr id 50856, skipping
DEBUG: empty 'source_carrier_free_time_balance' local col data for cdr id 50856, skipping
DEBUG: empty 'source_carrier_profile_package_id' local col data for cdr id 50856, skipping
DEBUG: empty 'source_carrier_contract_balance_id' local col data for cdr id 50856, skipping
DEBUG: local col data created or up to date for cdr id 50856, column 'source_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50856, column 'source_reseller_free_time_balance': 0, 0
DEBUG: empty 'source_reseller_profile_package_id' local col data for cdr id 50856, skipping
DEBUG: local col data created or up to date for cdr id 50856, column 'source_reseller_contract_balance_id': 77411
DEBUG: local col data created or up to date for cdr id 50856, column 'source_customer_cash_balance': 1000, 730
DEBUG: local col data created or up to date for cdr id 50856, column 'source_customer_free_time_balance': 0, 0
DEBUG: empty 'source_customer_profile_package_id' local col data for cdr id 50856, skipping
DEBUG: local col data created or up to date for cdr id 50856, column 'source_customer_contract_balance_id': 77430
DEBUG: empty 'destination_carrier_cash_balance' local col data for cdr id 50856, skipping
DEBUG: empty 'destination_carrier_free_time_balance' local col data for cdr id 50856, skipping
DEBUG: empty 'destination_carrier_profile_package_id' local col data for cdr id 50856, skipping
DEBUG: empty 'destination_carrier_contract_balance_id' local col data for cdr id 50856, skipping
DEBUG: local col data created or up to date for cdr id 50856, column 'destination_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50856, column 'destination_reseller_free_time_balance': 0, 0
DEBUG: empty 'destination_reseller_profile_package_id' local col data for cdr id 50856, skipping
DEBUG: local col data created or up to date for cdr id 50856, column 'destination_reseller_contract_balance_id': 77412
DEBUG: local col data created or up to date for cdr id 50856, column 'destination_customer_cash_balance': 790, 580
DEBUG: local col data created or up to date for cdr id 50856, column 'destination_customer_free_time_balance': 0, 0
DEBUG: empty 'destination_customer_profile_package_id' local col data for cdr id 50856, skipping
DEBUG: local col data created or up to date for cdr id 50856, column 'destination_customer_contract_balance_id': 77432
DEBUG: rating cdr ID 50856 completed successfully in 0.128 secs
DEBUG: start rating CDR ID 50857
DEBUG: 4 contract(s) locked: 61903, 61904, 61923, 61924
INFO: 3/3 - rate CDR ID 50857
DEBUG: fetching source provider info for source_provider_id #61903
DEBUG: catching up contract ID 61903 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61903 billing mapping (reseller) is profile id 1 for time 1515763042.000 from ipv4 source ip 192.168.0.1
DEBUG: source_provider_info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77411
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'reseller',
                         'product_id' => 3,
                         'prepaid' => 0,
                         'profile_id' => 1,
                         'int_unit' => 'month',
                         'contract_id' => '61903'
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: fetching destination provider info for destination_provider_id #61904
DEBUG: catching up contract ID 61904 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61904 billing mapping (reseller) is profile id 1 for time 1515763042.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_provider_info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77412
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'reseller',
                         'product_id' => 3,
                         'prepaid' => 0,
                         'profile_id' => 1,
                         'int_unit' => 'month',
                         'contract_id' => '61904'
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: ### 1. write pass ###
DEBUG: call from local subscriber, source_user_id is 44afa15e-fb19-4615-8b60-d264558d4f68
DEBUG: call to local subscriber, destination_user_id is 8ee14fcd-571e-49d3-afb5-b139c8654bf4
DEBUG: destination provider has billing profile 1, get reseller termination cost
DEBUG: calculating call cost for profile_id 1 with type call, direction in, src_user_domain 8881191515762707@testa.com.1515762707, dst_user_domain 8882201515762707@testb.com.1515762707
DEBUG: no match for full uris, trying user only for profile_id 1 with type call, direction in, src_user_domain 8881191515762707, dst_user_domain 8882201515762707
DEBUG: 1 contract balance row(s) updated
DEBUG: destination reseller termination cost is 0
DEBUG: get customer termination cost for destination_user_id 8ee14fcd-571e-49d3-afb5-b139c8654bf4
DEBUG: catching up contract ID 61924 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61924 billing mapping (sipaccount) is profile id 1135 for time 1515763042.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_customer info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '420',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '580',
                            'cash_balance_old' => '580',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77432
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount',
                         'product_id' => 4,
                         'prepaid' => 1,
                         'profile_id' => 1135,
                         'int_unit' => 'month',
                         'contract_id' => 61924
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1135 with type call, direction in, src_user_domain 8881191515762707@testa.com.1515762707, dst_user_domain 8882201515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '3',
          'on_follow_interval' => 30,
          'on_init_interval' => 60,
          'on_init_rate' => '3',
          'fee_id' => 1616,
          'off_follow_rate' => '1',
          'source_pattern' => '^8881.+',
          'pattern' => '.',
          'use_free_time' => 0,
          'zone_id' => 504,
          'on_follow_rate' => '1',
          'off_follow_interval' => 30,
          'off_init_interval' => 60
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 3 per sec to costs
DEBUG: interval is 60, so rate for this interval is 180
DEBUG: starting with contract balance: $VAR1 = {
          'free_time_balance_interval' => 0,
          'end_unix' => 1517443199,
          'start_unix' => 1514764800,
          'cash_balance_interval' => '420',
          'free_time_balance_old' => 0,
          'free_time_balance' => 0,
          'cash_balance' => '580',
          'cash_balance_old' => '580',
          'start' => '2018-01-01 00:00:00',
          'id' => 77432
        };
DEBUG: we still have cash balance 580 left, subtract rate 180 from that
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: we still have cash balance 400 left, subtract rate 30 from that
DEBUG: rating_duration = 90
DEBUG: got call cost 0 and free time 0
DEBUG: treat pre-paid billing profile as post-paid for termination fees
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 210
DEBUG: destination customer termination cost is 210
DEBUG: calculating call cost for profile_id 1 with type call, direction out, src_user_domain 8881191515762707@testa.com.1515762707, dst_user_domain 8882201515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '0',
          'on_follow_interval' => 600,
          'on_init_interval' => 600,
          'on_init_rate' => '0',
          'fee_id' => 1000,
          'off_follow_rate' => '0',
          'source_pattern' => '.',
          'pattern' => '.*',
          'use_free_time' => 0,
          'zone_id' => 1,
          'on_follow_rate' => '0',
          'off_follow_interval' => 600,
          'off_init_interval' => 600
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 0 per sec to costs
DEBUG: interval is 600, so rate for this interval is 0
DEBUG: starting with contract balance: $VAR1 = {
          'end_unix' => 1517443199,
          'free_time_balance_interval' => 0,
          'start_unix' => 1514764800,
          'cash_balance_interval' => 0,
          'free_time_balance' => 0,
          'free_time_balance_old' => 0,
          'cash_balance' => 0,
          'cash_balance_old' => 0,
          'id' => 77411,
          'start' => '2018-01-01 00:00:00'
        };
DEBUG: add current interval cost 0 to total cost 0
DEBUG: rating_duration = 600
DEBUG: 1 contract balance row(s) updated
DEBUG: catching up contract ID 61923 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61923 billing mapping (sipaccount) is profile id 1132 for time 1515763042.000 from ipv4 source ip 192.168.0.1
DEBUG: source_customer info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '1000',
                            'cash_balance_old' => '1000',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77431
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount',
                         'product_id' => 4,
                         'prepaid' => 1,
                         'profile_id' => 1132,
                         'int_unit' => 'month',
                         'contract_id' => 61923
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: billing profile is prepaid
DEBUG: prepaid_costs cache already populated
DEBUG: calculating call cost for profile_id 1132 with type call, direction out, src_user_domain 8881191515762707@testa.com.1515762707, dst_user_domain 8882201515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '4',
          'on_follow_interval' => 30,
          'on_init_interval' => 60,
          'on_init_rate' => '4',
          'fee_id' => 1609,
          'off_follow_rate' => '1',
          'source_pattern' => '.',
          'pattern' => '^8882.+',
          'use_free_time' => 0,
          'zone_id' => 501,
          'on_follow_rate' => '1',
          'off_follow_interval' => 30,
          'off_init_interval' => 60
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 4 per sec to costs
DEBUG: interval is 60, so rate for this interval is 240
DEBUG: starting with contract balance: $VAR1 = {
          'free_time_balance_interval' => 0,
          'end_unix' => 1517443199,
          'start_unix' => 1514764800,
          'cash_balance_interval' => '0',
          'free_time_balance_old' => 0,
          'free_time_balance' => 0,
          'cash_balance' => '1000',
          'cash_balance_old' => '1000',
          'start' => '2018-01-01 00:00:00',
          'id' => 77431
        };
DEBUG: we still have cash balance 1000 left, subtract rate 240 from that
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: we still have cash balance 760 left, subtract rate 30 from that
DEBUG: rating_duration = 90
DEBUG: got call cost 0 and free time 0
WARNING: no prepaid cost record found for call ID *TEST*OiaX31TdKFSUMi7Xz6sxp9TZ9t, applying calculated costs
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 270
DEBUG: cdr ID 50857 updated
DEBUG: empty 'source_carrier_cash_balance' local col data for cdr id 50857, skipping
DEBUG: empty 'source_carrier_free_time_balance' local col data for cdr id 50857, skipping
DEBUG: empty 'source_carrier_profile_package_id' local col data for cdr id 50857, skipping
DEBUG: empty 'source_carrier_contract_balance_id' local col data for cdr id 50857, skipping
DEBUG: local col data created or up to date for cdr id 50857, column 'source_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50857, column 'source_reseller_free_time_balance': 0, 0
DEBUG: empty 'source_reseller_profile_package_id' local col data for cdr id 50857, skipping
DEBUG: local col data created or up to date for cdr id 50857, column 'source_reseller_contract_balance_id': 77411
DEBUG: local col data created or up to date for cdr id 50857, column 'source_customer_cash_balance': 1000, 730
DEBUG: local col data created or up to date for cdr id 50857, column 'source_customer_free_time_balance': 0, 0
DEBUG: empty 'source_customer_profile_package_id' local col data for cdr id 50857, skipping
DEBUG: local col data created or up to date for cdr id 50857, column 'source_customer_contract_balance_id': 77431
DEBUG: empty 'destination_carrier_cash_balance' local col data for cdr id 50857, skipping
DEBUG: empty 'destination_carrier_free_time_balance' local col data for cdr id 50857, skipping
DEBUG: empty 'destination_carrier_profile_package_id' local col data for cdr id 50857, skipping
DEBUG: empty 'destination_carrier_contract_balance_id' local col data for cdr id 50857, skipping
DEBUG: local col data created or up to date for cdr id 50857, column 'destination_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50857, column 'destination_reseller_free_time_balance': 0, 0
DEBUG: empty 'destination_reseller_profile_package_id' local col data for cdr id 50857, skipping
DEBUG: local col data created or up to date for cdr id 50857, column 'destination_reseller_contract_balance_id': 77412
DEBUG: local col data created or up to date for cdr id 50857, column 'destination_customer_cash_balance': 580, 370
DEBUG: local col data created or up to date for cdr id 50857, column 'destination_customer_free_time_balance': 0, 0
DEBUG: empty 'destination_customer_profile_package_id' local col data for cdr id 50857, skipping
DEBUG: local col data created or up to date for cdr id 50857, column 'destination_customer_contract_balance_id': 77432
DEBUG: rating cdr ID 50857 completed successfully in 0.140 secs
INFO: Batch of 3 CDRs completed. 3 CDRs rated overall so far.
INFO: Less than 5 new CDRs, sleep 10
ok 852 - rate-o-mat executed
not ok 853 - prepaid w/o prepaid costs, balance: destination_reseller_cost = 90.000000
not ok 854 - prepaid w/o prepaid costs, balance: source_reseller_cost = 150.000000
ok 855 - prepaid w/o prepaid costs, balance: rating_status = ok
ok 856 - prepaid w/o prepaid costs, balance: id = 50857
ok 857 - prepaid w/o prepaid costs, balance: source_customer_cost = 270.000000
ok 858 - prepaid w/o prepaid costs, balance: destination_customer_cost = 210.000000
not ok 859 - prepaid w/o prepaid costs, balance: source_reseller_cost = 150.000000
ok 860 - prepaid w/o prepaid costs, balance: rating_status = ok
ok 861 - prepaid w/o prepaid costs, balance: id = 50855
not ok 862 - prepaid w/o prepaid costs, balance: destination_reseller_cost = 90.000000
ok 863 - prepaid w/o prepaid costs, balance: source_customer_cost = 270.000000
ok 864 - prepaid w/o prepaid costs, balance: destination_customer_cost = 210.000000
not ok 865 - prepaid w/o prepaid costs, balance: destination_reseller_cost = 90.000000
ok 866 - prepaid w/o prepaid costs, balance: id = 50856
not ok 867 - prepaid w/o prepaid costs, balance: source_reseller_cost = 150.000000
ok 868 - prepaid w/o prepaid costs, balance: rating_status = ok
ok 869 - prepaid w/o prepaid costs, balance: destination_customer_cost = 210.000000
ok 870 - prepaid w/o prepaid costs, balance: source_customer_cost = 270.000000
not ok 871 - cdrs were all processed
ok 872 - prepaid w/o prepaid costs, balance, caller 1: cdr id 50855 source_customer_contract_balance_id number of records 1 = 1
ok 873 - prepaid w/o prepaid costs, balance, caller 1: fetch customer id 61921 balance intervals collection page
ok 874 - prepaid w/o prepaid costs, balance, caller 1: check 'total_count' of collection
ok 875 - prepaid w/o prepaid costs, balance, caller 1: check interval 77429 cash balance 7.3 = 7.3
ok 876 - prepaid w/o prepaid costs, balance, caller 1: check interval 77429 cash balance interval 2.7 = 2.7
ok 877 - prepaid w/o prepaid costs, balance, caller 1: check interval 77429 id = 77429
ok 878 - prepaid w/o prepaid costs, balance, caller 1: check if all expected items are listed
ok 879 - prepaid w/o prepaid costs, balance, caller 1: cdr id 50855 source_customer_cash_balance before 1000.0000 = 1000.0000
ok 880 - prepaid w/o prepaid costs, balance, caller 1: cdr id 50855 source_customer_cash_balance after 730.0000 = 730.0000
ok 881 - prepaid w/o prepaid costs, balance, caller 2: cdr id 50856 source_customer_contract_balance_id number of records 1 = 1
ok 882 - prepaid w/o prepaid costs, balance, caller 2: fetch customer id 61922 balance intervals collection page
ok 883 - prepaid w/o prepaid costs, balance, caller 2: check 'total_count' of collection
ok 884 - prepaid w/o prepaid costs, balance, caller 2: check interval 77430 cash balance 7.3 = 7.3
ok 885 - prepaid w/o prepaid costs, balance, caller 2: check interval 77430 cash balance interval 2.7 = 2.7
ok 886 - prepaid w/o prepaid costs, balance, caller 2: check interval 77430 id = 77430
ok 887 - prepaid w/o prepaid costs, balance, caller 2: check if all expected items are listed
ok 888 - prepaid w/o prepaid costs, balance, caller 2: cdr id 50856 source_customer_cash_balance before 1000.0000 = 1000.0000
ok 889 - prepaid w/o prepaid costs, balance, caller 2: cdr id 50856 source_customer_cash_balance after 730.0000 = 730.0000
ok 890 - prepaid w/o prepaid costs, balance, caller 3: cdr id 50857 source_customer_contract_balance_id number of records 1 = 1
ok 891 - prepaid w/o prepaid costs, balance, caller 3: fetch customer id 61923 balance intervals collection page
ok 892 - prepaid w/o prepaid costs, balance, caller 3: check 'total_count' of collection
ok 893 - prepaid w/o prepaid costs, balance, caller 3: check interval 77431 cash balance 7.3 = 7.3
ok 894 - prepaid w/o prepaid costs, balance, caller 3: check interval 77431 cash balance interval 2.7 = 2.7
ok 895 - prepaid w/o prepaid costs, balance, caller 3: check interval 77431 id = 77431
ok 896 - prepaid w/o prepaid costs, balance, caller 3: check if all expected items are listed
ok 897 - prepaid w/o prepaid costs, balance, caller 3: cdr id 50857 source_customer_cash_balance before 1000.0000 = 1000.0000
ok 898 - prepaid w/o prepaid costs, balance, caller 3: cdr id 50857 source_customer_cash_balance after 730.0000 = 730.0000
ok 899 - prepaid w/o prepaid costs, balance, callee: cdr id 50855 destination_customer_contract_balance_id number of records 1 = 1
ok 900 - prepaid w/o prepaid costs, balance, callee: fetch customer id 61924 balance intervals collection page
ok 901 - prepaid w/o prepaid costs, balance, callee: check 'total_count' of collection
ok 902 - prepaid w/o prepaid costs, balance, callee: check interval 77432 cash balance 3.7 = 3.7
ok 903 - prepaid w/o prepaid costs, balance, callee: check interval 77432 cash balance interval 6.3 = 6.3
ok 904 - prepaid w/o prepaid costs, balance, callee: check interval 77432 id = 77432
ok 905 - prepaid w/o prepaid costs, balance, callee: check if all expected items are listed
ok 906 - prepaid w/o prepaid costs, balance, callee: cdr id 50855 destination_customer_contract_balance_id 77432 = 77432
ok 907 - prepaid w/o prepaid costs, balance, callee: cdr id 50855 destination_customer_cash_balance before 1000.0000 = 1000.0000
ok 908 - prepaid w/o prepaid costs, balance, callee: cdr id 50855 destination_customer_cash_balance after 790.0000 = 790.0000
ok 909 - prepaid w/o prepaid costs, balance, callee: cdr id 50856 destination_customer_contract_balance_id 77432 = 77432
ok 910 - prepaid w/o prepaid costs, balance, callee: cdr id 50856 destination_customer_cash_balance before 790.0000 = 790.0000
ok 911 - prepaid w/o prepaid costs, balance, callee: cdr id 50856 destination_customer_cash_balance after 580.0000 = 580.0000
ok 912 - prepaid w/o prepaid costs, balance, callee: cdr id 50857 destination_customer_contract_balance_id 77432 = 77432
ok 913 - prepaid w/o prepaid costs, balance, callee: cdr id 50857 destination_customer_cash_balance before 580.0000 = 580.0000
ok 914 - prepaid w/o prepaid costs, balance, callee: cdr id 50857 destination_customer_cash_balance after 370.0000 = 370.0000
ok 915 - prepaid w/o prepaid costs, balance, callers' provider: cdr id 50855 source_reseller_contract_balance_id number of records 1 = 1
ok 916 - prepaid w/o prepaid costs, balance, callers' provider: fetch customer id 61903 balance intervals collection page
ok 917 - prepaid w/o prepaid costs, balance, callers' provider: check 'total_count' of collection
not ok 918 - prepaid w/o prepaid costs, balance, callers' provider: check interval 77411 cash balance interval 0 = 22.5
ok 919 - prepaid w/o prepaid costs, balance, callers' provider: check interval 77411 id = 77411
ok 920 - prepaid w/o prepaid costs, balance, callers' provider: check if all expected items are listed
ok 921 - prepaid w/o prepaid costs, balance, callers' provider: cdr id 50855 source_carrier_contract_balance_id number of records 0 = 0
ok 922 - prepaid w/o prepaid costs, balance, callers' provider: cdr id 50855 source_reseller_contract_balance_id 77411 = 77411
ok 923 - prepaid w/o prepaid costs, balance, callers' provider: cdr id 50856 source_carrier_contract_balance_id number of records 0 = 0
ok 924 - prepaid w/o prepaid costs, balance, callers' provider: cdr id 50856 source_reseller_contract_balance_id 77411 = 77411
ok 925 - prepaid w/o prepaid costs, balance, callers' provider: cdr id 50857 source_carrier_contract_balance_id number of records 0 = 0
ok 926 - prepaid w/o prepaid costs, balance, callers' provider: cdr id 50857 source_reseller_contract_balance_id 77411 = 77411
ok 927 - prepaid w/o prepaid costs, balance, callee's provider: cdr id 50855 destination_reseller_contract_balance_id number of records 1 = 1
ok 928 - prepaid w/o prepaid costs, balance, callee's provider: fetch customer id 61904 balance intervals collection page
ok 929 - prepaid w/o prepaid costs, balance, callee's provider: check 'total_count' of collection
not ok 930 - prepaid w/o prepaid costs, balance, callee's provider: check interval 77412 cash balance interval 0 = 13.5
ok 931 - prepaid w/o prepaid costs, balance, callee's provider: check interval 77412 id = 77412
ok 932 - prepaid w/o prepaid costs, balance, callee's provider: check if all expected items are listed
ok 933 - prepaid w/o prepaid costs, balance, callee's provider: cdr id 50855 destination_carrier_contract_balance_id number of records 0 = 0
ok 934 - prepaid w/o prepaid costs, balance, callee's provider: cdr id 50855 destination_reseller_contract_balance_id 77412 = 77412
ok 935 - prepaid w/o prepaid costs, balance, callee's provider: cdr id 50856 destination_carrier_contract_balance_id number of records 0 = 0
ok 936 - prepaid w/o prepaid costs, balance, callee's provider: cdr id 50856 destination_reseller_contract_balance_id 77412 = 77412
ok 937 - prepaid w/o prepaid costs, balance, callee's provider: cdr id 50857 destination_carrier_contract_balance_id number of records 0 = 0
ok 938 - prepaid w/o prepaid costs, balance, callee's provider: cdr id 50857 destination_reseller_contract_balance_id 77412 = 77412
ok 939 - prepaid w/o prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50855 source_carrier_profile_package_id number of records 0 = 0
ok 940 - prepaid w/o prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50855 source_reseller_profile_package_id number of records 0 = 0
ok 941 - prepaid w/o prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50855 source_customer_profile_package_id number of records 0 = 0
ok 942 - prepaid w/o prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50855 destination_carrier_profile_package_id number of records 0 = 0
ok 943 - prepaid w/o prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50855 destination_reseller_profile_package_id number of records 0 = 0
ok 944 - prepaid w/o prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50855 destination_customer_profile_package_id number of records 0 = 0
ok 945 - prepaid w/o prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50856 source_carrier_profile_package_id number of records 0 = 0
ok 946 - prepaid w/o prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50856 source_reseller_profile_package_id number of records 0 = 0
ok 947 - prepaid w/o prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50856 source_customer_profile_package_id number of records 0 = 0
ok 948 - prepaid w/o prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50856 destination_carrier_profile_package_id number of records 0 = 0
ok 949 - prepaid w/o prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50856 destination_reseller_profile_package_id number of records 0 = 0
ok 950 - prepaid w/o prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50856 destination_customer_profile_package_id number of records 0 = 0
ok 951 - prepaid w/o prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50857 source_carrier_profile_package_id number of records 0 = 0
ok 952 - prepaid w/o prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50857 source_reseller_profile_package_id number of records 0 = 0
ok 953 - prepaid w/o prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50857 source_customer_profile_package_id number of records 0 = 0
ok 954 - prepaid w/o prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50857 destination_carrier_profile_package_id number of records 0 = 0
ok 955 - prepaid w/o prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50857 destination_reseller_profile_package_id number of records 0 = 0
ok 956 - prepaid w/o prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50857 destination_customer_profile_package_id number of records 0 = 0
ok 957 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50855 source_carrier_free_time_balance number of records 0 = 0
ok 958 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50855 source_reseller_free_time_balance before 0 = 0
ok 959 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50855 source_reseller_free_time_balance after 0 = 0
ok 960 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50855 source_customer_free_time_balance before 0 = 0
ok 961 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50855 source_customer_free_time_balance after 0 = 0
ok 962 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50855 destination_carrier_free_time_balance number of records 0 = 0
ok 963 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50855 destination_reseller_free_time_balance before 0 = 0
ok 964 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50855 destination_reseller_free_time_balance after 0 = 0
ok 965 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50855 destination_customer_free_time_balance before 0 = 0
ok 966 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50855 destination_customer_free_time_balance after 0 = 0
ok 967 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50856 source_carrier_free_time_balance number of records 0 = 0
ok 968 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50856 source_reseller_free_time_balance before 0 = 0
ok 969 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50856 source_reseller_free_time_balance after 0 = 0
ok 970 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50856 source_customer_free_time_balance before 0 = 0
ok 971 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50856 source_customer_free_time_balance after 0 = 0
ok 972 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50856 destination_carrier_free_time_balance number of records 0 = 0
ok 973 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50856 destination_reseller_free_time_balance before 0 = 0
ok 974 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50856 destination_reseller_free_time_balance after 0 = 0
ok 975 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50856 destination_customer_free_time_balance before 0 = 0
ok 976 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50856 destination_customer_free_time_balance after 0 = 0
ok 977 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50857 source_carrier_free_time_balance number of records 0 = 0
ok 978 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50857 source_reseller_free_time_balance before 0 = 0
ok 979 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50857 source_reseller_free_time_balance after 0 = 0
ok 980 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50857 source_customer_free_time_balance before 0 = 0
ok 981 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50857 source_customer_free_time_balance after 0 = 0
ok 982 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50857 destination_carrier_free_time_balance number of records 0 = 0
ok 983 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50857 destination_reseller_free_time_balance before 0 = 0
ok 984 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50857 destination_reseller_free_time_balance after 0 = 0
ok 985 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50857 destination_customer_free_time_balance before 0 = 0
ok 986 - prepaid w/o prepaid costs, balance providers and subscriber must have zero free time: cdr id 50857 destination_customer_free_time_balance after 0 = 0
ok 987 - prepaid w/o prepaid costs, balance providers must have zero balance: cdr id 50855 source_carrier_cash_balance number of records 0 = 0
ok 988 - prepaid w/o prepaid costs, balance providers must have zero balance: cdr id 50855 source_reseller_cash_balance before 0.0000 = 0.0000
ok 989 - prepaid w/o prepaid costs, balance providers must have zero balance: cdr id 50855 source_reseller_cash_balance after 0.0000 = 0.0000
ok 990 - prepaid w/o prepaid costs, balance providers must have zero balance: cdr id 50855 destination_carrier_cash_balance number of records 0 = 0
ok 991 - prepaid w/o prepaid costs, balance providers must have zero balance: cdr id 50855 destination_reseller_cash_balance before 0.0000 = 0.0000
ok 992 - prepaid w/o prepaid costs, balance providers must have zero balance: cdr id 50855 destination_reseller_cash_balance after 0.0000 = 0.0000
ok 993 - prepaid w/o prepaid costs, balance providers must have zero balance: cdr id 50856 source_carrier_cash_balance number of records 0 = 0
ok 994 - prepaid w/o prepaid costs, balance providers must have zero balance: cdr id 50856 source_reseller_cash_balance before 0.0000 = 0.0000
ok 995 - prepaid w/o prepaid costs, balance providers must have zero balance: cdr id 50856 source_reseller_cash_balance after 0.0000 = 0.0000
ok 996 - prepaid w/o prepaid costs, balance providers must have zero balance: cdr id 50856 destination_carrier_cash_balance number of records 0 = 0
ok 997 - prepaid w/o prepaid costs, balance providers must have zero balance: cdr id 50856 destination_reseller_cash_balance before 0.0000 = 0.0000
ok 998 - prepaid w/o prepaid costs, balance providers must have zero balance: cdr id 50856 destination_reseller_cash_balance after 0.0000 = 0.0000
ok 999 - prepaid w/o prepaid costs, balance providers must have zero balance: cdr id 50857 source_carrier_cash_balance number of records 0 = 0
ok 1000 - prepaid w/o prepaid costs, balance providers must have zero balance: cdr id 50857 source_reseller_cash_balance before 0.0000 = 0.0000
ok 1001 - prepaid w/o prepaid costs, balance providers must have zero balance: cdr id 50857 source_reseller_cash_balance after 0.0000 = 0.0000
ok 1002 - prepaid w/o prepaid costs, balance providers must have zero balance: cdr id 50857 destination_carrier_cash_balance number of records 0 = 0
ok 1003 - prepaid w/o prepaid costs, balance providers must have zero balance: cdr id 50857 destination_reseller_cash_balance before 0.0000 = 0.0000
ok 1004 - prepaid w/o prepaid costs, balance providers must have zero balance: cdr id 50857 destination_reseller_cash_balance after 0.0000 = 0.0000
ok 1005 - create customercontacts 21
ok 1006 - create customers 21
ok 1007 - setting customer id 61925 cash_balance to 1000 cents
ok 1008 - create subscribers 21
ok 1009 - very first balance interval: fetch customer id 61925 balance intervals collection page
ok 1010 - very first balance interval: check interval 77433 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 1011 - very first balance interval: check interval 77433 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 1012 - very first balance interval: check interval 77433 cash balance 10 = 10
ok 1013 - very first balance interval: check interval 77433 billing profile id 1132 = 1132
ok 1014 - very first balance interval: check if all expected items are listed
ok 1015 - create customercontacts 22
ok 1016 - create customers 22
ok 1017 - setting customer id 61926 cash_balance to 1000 cents
ok 1018 - create subscribers 22
ok 1019 - very first balance interval: fetch customer id 61926 balance intervals collection page
ok 1020 - very first balance interval: check interval 77434 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 1021 - very first balance interval: check interval 77434 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 1022 - very first balance interval: check interval 77434 cash balance 10 = 10
ok 1023 - very first balance interval: check interval 77434 billing profile id 1132 = 1132
ok 1024 - very first balance interval: check if all expected items are listed
ok 1025 - create customercontacts 23
ok 1026 - create customers 23
ok 1027 - setting customer id 61927 cash_balance to 1000 cents
ok 1028 - create subscribers 23
ok 1029 - very first balance interval: fetch customer id 61927 balance intervals collection page
ok 1030 - very first balance interval: check interval 77435 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 1031 - very first balance interval: check interval 77435 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 1032 - very first balance interval: check interval 77435 cash balance 10 = 10
ok 1033 - very first balance interval: check interval 77435 billing profile id 1132 = 1132
ok 1034 - very first balance interval: check if all expected items are listed
ok 1035 - create customercontacts 24
ok 1036 - create customers 24
ok 1037 - setting customer id 61928 cash_balance to 1000 cents
ok 1038 - create subscribers 24
ok 1039 - very first balance interval: fetch customer id 61928 balance intervals collection page
ok 1040 - very first balance interval: check interval 77436 start timestamp timestamp 2018-01-01 00:00:00 = 2018-01-01 00:00:00
ok 1041 - very first balance interval: check interval 77436 stop timestamp 2018-01-31 23:59:59 = 2018-01-31 23:59:59
ok 1042 - very first balance interval: check interval 77436 cash balance 10 = 10
ok 1043 - very first balance interval: check interval 77436 billing profile id 1135 = 1135
ok 1044 - very first balance interval: check if all expected items are listed
ok 1045 - cdrs id 50858, 50859, 50860 with prepaid costs records created
INFO: Trying to connect to billing db...
INFO: Successfully connected to duplication db...
INFO: Trying to connect to provisioning db...
INFO: Successfully connected to provisioning db...
INFO: Trying to connect to accounting db...
INFO: Successfully connected to accounting db...
WARNING: No duplication db credentials, disabled.
INFO: local cdr relation column model loaded
INFO: local cdr cash balance column model loaded
INFO: local cdr time balance column model loaded
INFO: Up and running.
INFO: Grabbed 3 CDRs
DEBUG: start rating CDR ID 50858
DEBUG: 4 contract(s) locked: 61903, 61904, 61925, 61928
INFO: 1/3 - rate CDR ID 50858
DEBUG: fetching source provider info for source_provider_id #61903
DEBUG: catching up contract ID 61903 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61903 billing mapping (reseller) is profile id 1 for time 1515763098.000 from ipv4 source ip 192.168.0.1
DEBUG: source_provider_info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'id' => 77411,
                            'start' => '2018-01-01 00:00:00'
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'reseller',
                         'product_id' => 3,
                         'prepaid' => 0,
                         'profile_id' => 1,
                         'int_unit' => 'month',
                         'contract_id' => '61903'
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: fetching destination provider info for destination_provider_id #61904
DEBUG: catching up contract ID 61904 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61904 billing mapping (reseller) is profile id 1 for time 1515763098.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_provider_info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77412
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'reseller',
                         'product_id' => 3,
                         'prepaid' => 0,
                         'profile_id' => 1,
                         'int_unit' => 'month',
                         'contract_id' => '61904'
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: ### 1. write pass ###
DEBUG: call from local subscriber, source_user_id is 0e5a7072-23c1-424e-9e68-ef0be2e78abc
DEBUG: call to local subscriber, destination_user_id is 7e6c54d2-d420-403a-b7f4-3491fffe3762
DEBUG: destination provider has billing profile 1, get reseller termination cost
DEBUG: calculating call cost for profile_id 1 with type call, direction in, src_user_domain 8881211515762707@testa.com.1515762707, dst_user_domain 8882241515762707@testb.com.1515762707
DEBUG: no match for full uris, trying user only for profile_id 1 with type call, direction in, src_user_domain 8881211515762707, dst_user_domain 8882241515762707
DEBUG: 1 contract balance row(s) updated
DEBUG: destination reseller termination cost is 0
DEBUG: get customer termination cost for destination_user_id 7e6c54d2-d420-403a-b7f4-3491fffe3762
DEBUG: catching up contract ID 61928 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61928 billing mapping (sipaccount) is profile id 1135 for time 1515763098.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_customer info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '1000',
                            'cash_balance_old' => '1000',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77436
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount',
                         'product_id' => 4,
                         'prepaid' => 1,
                         'profile_id' => 1135,
                         'int_unit' => 'month',
                         'contract_id' => 61928
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1135 with type call, direction in, src_user_domain 8881211515762707@testa.com.1515762707, dst_user_domain 8882241515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '3',
          'on_follow_interval' => 30,
          'on_init_interval' => 60,
          'on_init_rate' => '3',
          'fee_id' => 1616,
          'off_follow_rate' => '1',
          'source_pattern' => '^8881.+',
          'pattern' => '.',
          'use_free_time' => 0,
          'zone_id' => 504,
          'on_follow_rate' => '1',
          'off_follow_interval' => 30,
          'off_init_interval' => 60
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 3 per sec to costs
DEBUG: interval is 60, so rate for this interval is 180
DEBUG: starting with contract balance: $VAR1 = {
          'free_time_balance_interval' => 0,
          'end_unix' => 1517443199,
          'start_unix' => 1514764800,
          'cash_balance_interval' => '0',
          'free_time_balance_old' => 0,
          'free_time_balance' => 0,
          'cash_balance' => '1000',
          'cash_balance_old' => '1000',
          'start' => '2018-01-01 00:00:00',
          'id' => 77436
        };
DEBUG: we still have cash balance 1000 left, subtract rate 180 from that
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: we still have cash balance 820 left, subtract rate 30 from that
DEBUG: rating_duration = 90
DEBUG: got call cost 0 and free time 0
DEBUG: treat pre-paid billing profile as post-paid for termination fees
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 210
DEBUG: destination customer termination cost is 210
DEBUG: calculating call cost for profile_id 1 with type call, direction out, src_user_domain 8881211515762707@testa.com.1515762707, dst_user_domain 8882241515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '0',
          'on_follow_interval' => 600,
          'on_init_interval' => 600,
          'on_init_rate' => '0',
          'fee_id' => 1000,
          'off_follow_rate' => '0',
          'source_pattern' => '.',
          'pattern' => '.*',
          'use_free_time' => 0,
          'zone_id' => 1,
          'on_follow_rate' => '0',
          'off_follow_interval' => 600,
          'off_init_interval' => 600
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 0 per sec to costs
DEBUG: interval is 600, so rate for this interval is 0
DEBUG: starting with contract balance: $VAR1 = {
          'end_unix' => 1517443199,
          'free_time_balance_interval' => 0,
          'start_unix' => 1514764800,
          'cash_balance_interval' => 0,
          'free_time_balance' => 0,
          'free_time_balance_old' => 0,
          'cash_balance' => 0,
          'cash_balance_old' => 0,
          'start' => '2018-01-01 00:00:00',
          'id' => 77411
        };
DEBUG: add current interval cost 0 to total cost 0
DEBUG: rating_duration = 600
DEBUG: 1 contract balance row(s) updated
DEBUG: catching up contract ID 61925 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61925 billing mapping (sipaccount) is profile id 1132 for time 1515763098.000 from ipv4 source ip 192.168.0.1
DEBUG: source_customer info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '1000',
                            'cash_balance_old' => '1000',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77433
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount',
                         'product_id' => 4,
                         'prepaid' => 1,
                         'profile_id' => 1132,
                         'int_unit' => 'month',
                         'contract_id' => 61925
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: billing profile is prepaid
DEBUG: empty prepaid_costs cache, populate it
DEBUG: prepaid_costs cache populated, 3 records
DEBUG: prepaid_costs call_id = *TEST*tYEPg4koRhzDq3-mRuuiOwhxSL, source_user_id = 0e5a7072-23c1-424e-9e68-ef0be2e78abc, destination_user_id = 7e6c54d2-d420-403a-b7f4-3491fffe3762 found in cache
DEBUG: calculating call cost for profile_id 1132 with type call, direction out, src_user_domain 8881211515762707@testa.com.1515762707, dst_user_domain 8882241515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '4',
          'on_follow_interval' => 30,
          'on_init_interval' => 60,
          'on_init_rate' => '4',
          'fee_id' => 1609,
          'off_follow_rate' => '1',
          'source_pattern' => '.',
          'pattern' => '^8882.+',
          'use_free_time' => 0,
          'zone_id' => 501,
          'on_follow_rate' => '1',
          'off_follow_interval' => 30,
          'off_init_interval' => 60
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 4 per sec to costs
DEBUG: interval is 60, so rate for this interval is 240
DEBUG: starting with contract balance: $VAR1 = {
          'free_time_balance_interval' => 0,
          'end_unix' => 1517443199,
          'start_unix' => 1514764800,
          'cash_balance_interval' => '0',
          'free_time_balance_old' => 0,
          'free_time_balance' => 0,
          'cash_balance' => '1000',
          'cash_balance_old' => '1000',
          'start' => '2018-01-01 00:00:00',
          'id' => 77433
        };
DEBUG: we still have cash balance 1000 left, subtract rate 240 from that
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: we still have cash balance 760 left, subtract rate 30 from that
DEBUG: rating_duration = 90
DEBUG: got call cost 0 and free time 0
DEBUG: prepaid_costs call_id = *TEST*tYEPg4koRhzDq3-mRuuiOwhxSL, source_user_id = 0e5a7072-23c1-424e-9e68-ef0be2e78abc, destination_user_id = 7e6c54d2-d420-403a-b7f4-3491fffe3762 deleted
DEBUG: dropped prepaid_costs call_id = *TEST*tYEPg4koRhzDq3-mRuuiOwhxSL, source_user_id = 0e5a7072-23c1-424e-9e68-ef0be2e78abc, destination_user_id = 7e6c54d2-d420-403a-b7f4-3491fffe3762 from cache
DEBUG: cost for this call is 270
DEBUG: cdr ID 50858 updated
DEBUG: empty 'source_carrier_cash_balance' local col data for cdr id 50858, skipping
DEBUG: empty 'source_carrier_free_time_balance' local col data for cdr id 50858, skipping
DEBUG: empty 'source_carrier_profile_package_id' local col data for cdr id 50858, skipping
DEBUG: empty 'source_carrier_contract_balance_id' local col data for cdr id 50858, skipping
DEBUG: local col data created or up to date for cdr id 50858, column 'source_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50858, column 'source_reseller_free_time_balance': 0, 0
DEBUG: empty 'source_reseller_profile_package_id' local col data for cdr id 50858, skipping
DEBUG: local col data created or up to date for cdr id 50858, column 'source_reseller_contract_balance_id': 77411
DEBUG: local col data created or up to date for cdr id 50858, column 'source_customer_cash_balance': 1270.0000, 1000
DEBUG: local col data created or up to date for cdr id 50858, column 'source_customer_free_time_balance': 0, 0
DEBUG: empty 'source_customer_profile_package_id' local col data for cdr id 50858, skipping
DEBUG: local col data created or up to date for cdr id 50858, column 'source_customer_contract_balance_id': 77433
DEBUG: empty 'destination_carrier_cash_balance' local col data for cdr id 50858, skipping
DEBUG: empty 'destination_carrier_free_time_balance' local col data for cdr id 50858, skipping
DEBUG: empty 'destination_carrier_profile_package_id' local col data for cdr id 50858, skipping
DEBUG: empty 'destination_carrier_contract_balance_id' local col data for cdr id 50858, skipping
DEBUG: local col data created or up to date for cdr id 50858, column 'destination_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50858, column 'destination_reseller_free_time_balance': 0, 0
DEBUG: empty 'destination_reseller_profile_package_id' local col data for cdr id 50858, skipping
DEBUG: local col data created or up to date for cdr id 50858, column 'destination_reseller_contract_balance_id': 77412
DEBUG: local col data created or up to date for cdr id 50858, column 'destination_customer_cash_balance': 1000, 790
DEBUG: local col data created or up to date for cdr id 50858, column 'destination_customer_free_time_balance': 0, 0
DEBUG: empty 'destination_customer_profile_package_id' local col data for cdr id 50858, skipping
DEBUG: local col data created or up to date for cdr id 50858, column 'destination_customer_contract_balance_id': 77436
DEBUG: rating cdr ID 50858 completed successfully in 0.252 secs
DEBUG: start rating CDR ID 50859
DEBUG: 4 contract(s) locked: 61903, 61904, 61926, 61928
INFO: 2/3 - rate CDR ID 50859
DEBUG: fetching source provider info for source_provider_id #61903
DEBUG: catching up contract ID 61903 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61903 billing mapping (reseller) is profile id 1 for time 1515763099.000 from ipv4 source ip 192.168.0.1
DEBUG: source_provider_info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77411
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'reseller',
                         'product_id' => 3,
                         'prepaid' => 0,
                         'profile_id' => 1,
                         'int_unit' => 'month',
                         'contract_id' => '61903'
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: fetching destination provider info for destination_provider_id #61904
DEBUG: catching up contract ID 61904 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61904 billing mapping (reseller) is profile id 1 for time 1515763099.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_provider_info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77412
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'reseller',
                         'product_id' => 3,
                         'prepaid' => 0,
                         'profile_id' => 1,
                         'int_unit' => 'month',
                         'contract_id' => '61904'
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: ### 1. write pass ###
DEBUG: call from local subscriber, source_user_id is 8d2b55f1-bba3-4a48-ab12-1c4c3f64a8fe
DEBUG: call to local subscriber, destination_user_id is 7e6c54d2-d420-403a-b7f4-3491fffe3762
DEBUG: destination provider has billing profile 1, get reseller termination cost
DEBUG: calculating call cost for profile_id 1 with type call, direction in, src_user_domain 8881221515762707@testa.com.1515762707, dst_user_domain 8882241515762707@testb.com.1515762707
DEBUG: no match for full uris, trying user only for profile_id 1 with type call, direction in, src_user_domain 8881221515762707, dst_user_domain 8882241515762707
DEBUG: 1 contract balance row(s) updated
DEBUG: destination reseller termination cost is 0
DEBUG: get customer termination cost for destination_user_id 7e6c54d2-d420-403a-b7f4-3491fffe3762
DEBUG: catching up contract ID 61928 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61928 billing mapping (sipaccount) is profile id 1135 for time 1515763099.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_customer info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '210',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '790',
                            'cash_balance_old' => '790',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77436
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount',
                         'product_id' => 4,
                         'prepaid' => 1,
                         'profile_id' => 1135,
                         'int_unit' => 'month',
                         'contract_id' => 61928
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1135 with type call, direction in, src_user_domain 8881221515762707@testa.com.1515762707, dst_user_domain 8882241515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '3',
          'on_follow_interval' => 30,
          'on_init_interval' => 60,
          'on_init_rate' => '3',
          'fee_id' => 1616,
          'off_follow_rate' => '1',
          'source_pattern' => '^8881.+',
          'pattern' => '.',
          'use_free_time' => 0,
          'zone_id' => 504,
          'on_follow_rate' => '1',
          'off_follow_interval' => 30,
          'off_init_interval' => 60
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 3 per sec to costs
DEBUG: interval is 60, so rate for this interval is 180
DEBUG: starting with contract balance: $VAR1 = {
          'free_time_balance_interval' => 0,
          'end_unix' => 1517443199,
          'start_unix' => 1514764800,
          'cash_balance_interval' => '210',
          'free_time_balance_old' => 0,
          'free_time_balance' => 0,
          'cash_balance' => '790',
          'cash_balance_old' => '790',
          'start' => '2018-01-01 00:00:00',
          'id' => 77436
        };
DEBUG: we still have cash balance 790 left, subtract rate 180 from that
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: we still have cash balance 610 left, subtract rate 30 from that
DEBUG: rating_duration = 90
DEBUG: got call cost 0 and free time 0
DEBUG: treat pre-paid billing profile as post-paid for termination fees
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 210
DEBUG: destination customer termination cost is 210
DEBUG: calculating call cost for profile_id 1 with type call, direction out, src_user_domain 8881221515762707@testa.com.1515762707, dst_user_domain 8882241515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '0',
          'on_follow_interval' => 600,
          'on_init_interval' => 600,
          'on_init_rate' => '0',
          'fee_id' => 1000,
          'off_follow_rate' => '0',
          'source_pattern' => '.',
          'pattern' => '.*',
          'use_free_time' => 0,
          'zone_id' => 1,
          'on_follow_rate' => '0',
          'off_follow_interval' => 600,
          'off_init_interval' => 600
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 0 per sec to costs
DEBUG: interval is 600, so rate for this interval is 0
DEBUG: starting with contract balance: $VAR1 = {
          'end_unix' => 1517443199,
          'free_time_balance_interval' => 0,
          'start_unix' => 1514764800,
          'cash_balance_interval' => 0,
          'free_time_balance' => 0,
          'free_time_balance_old' => 0,
          'cash_balance' => 0,
          'cash_balance_old' => 0,
          'id' => 77411,
          'start' => '2018-01-01 00:00:00'
        };
DEBUG: add current interval cost 0 to total cost 0
DEBUG: rating_duration = 600
DEBUG: 1 contract balance row(s) updated
DEBUG: catching up contract ID 61926 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61926 billing mapping (sipaccount) is profile id 1132 for time 1515763099.000 from ipv4 source ip 192.168.0.1
DEBUG: source_customer info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '1000',
                            'cash_balance_old' => '1000',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77434
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount',
                         'product_id' => 4,
                         'prepaid' => 1,
                         'profile_id' => 1132,
                         'int_unit' => 'month',
                         'contract_id' => 61926
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: billing profile is prepaid
DEBUG: prepaid_costs cache already populated
DEBUG: prepaid_costs call_id = *TEST*.VOstBjaFH.aCjeCY9TIrzsmck, source_user_id = 8d2b55f1-bba3-4a48-ab12-1c4c3f64a8fe, destination_user_id = 7e6c54d2-d420-403a-b7f4-3491fffe3762 found in cache
DEBUG: calculating call cost for profile_id 1132 with type call, direction out, src_user_domain 8881221515762707@testa.com.1515762707, dst_user_domain 8882241515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '4',
          'on_follow_interval' => 30,
          'on_init_interval' => 60,
          'on_init_rate' => '4',
          'fee_id' => 1609,
          'off_follow_rate' => '1',
          'source_pattern' => '.',
          'pattern' => '^8882.+',
          'use_free_time' => 0,
          'zone_id' => 501,
          'on_follow_rate' => '1',
          'off_follow_interval' => 30,
          'off_init_interval' => 60
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 4 per sec to costs
DEBUG: interval is 60, so rate for this interval is 240
DEBUG: starting with contract balance: $VAR1 = {
          'free_time_balance_interval' => 0,
          'end_unix' => 1517443199,
          'start_unix' => 1514764800,
          'cash_balance_interval' => '0',
          'free_time_balance_old' => 0,
          'free_time_balance' => 0,
          'cash_balance' => '1000',
          'cash_balance_old' => '1000',
          'start' => '2018-01-01 00:00:00',
          'id' => 77434
        };
DEBUG: we still have cash balance 1000 left, subtract rate 240 from that
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: we still have cash balance 760 left, subtract rate 30 from that
DEBUG: rating_duration = 90
DEBUG: got call cost 0 and free time 0
DEBUG: prepaid_costs call_id = *TEST*.VOstBjaFH.aCjeCY9TIrzsmck, source_user_id = 8d2b55f1-bba3-4a48-ab12-1c4c3f64a8fe, destination_user_id = 7e6c54d2-d420-403a-b7f4-3491fffe3762 deleted
DEBUG: dropped prepaid_costs call_id = *TEST*.VOstBjaFH.aCjeCY9TIrzsmck, source_user_id = 8d2b55f1-bba3-4a48-ab12-1c4c3f64a8fe, destination_user_id = 7e6c54d2-d420-403a-b7f4-3491fffe3762 from cache
DEBUG: cost for this call is 270
DEBUG: cdr ID 50859 updated
DEBUG: empty 'source_carrier_cash_balance' local col data for cdr id 50859, skipping
DEBUG: empty 'source_carrier_free_time_balance' local col data for cdr id 50859, skipping
DEBUG: empty 'source_carrier_profile_package_id' local col data for cdr id 50859, skipping
DEBUG: empty 'source_carrier_contract_balance_id' local col data for cdr id 50859, skipping
DEBUG: local col data created or up to date for cdr id 50859, column 'source_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50859, column 'source_reseller_free_time_balance': 0, 0
DEBUG: empty 'source_reseller_profile_package_id' local col data for cdr id 50859, skipping
DEBUG: local col data created or up to date for cdr id 50859, column 'source_reseller_contract_balance_id': 77411
DEBUG: local col data created or up to date for cdr id 50859, column 'source_customer_cash_balance': 1270.0000, 1000
DEBUG: local col data created or up to date for cdr id 50859, column 'source_customer_free_time_balance': 0, 0
DEBUG: empty 'source_customer_profile_package_id' local col data for cdr id 50859, skipping
DEBUG: local col data created or up to date for cdr id 50859, column 'source_customer_contract_balance_id': 77434
DEBUG: empty 'destination_carrier_cash_balance' local col data for cdr id 50859, skipping
DEBUG: empty 'destination_carrier_free_time_balance' local col data for cdr id 50859, skipping
DEBUG: empty 'destination_carrier_profile_package_id' local col data for cdr id 50859, skipping
DEBUG: empty 'destination_carrier_contract_balance_id' local col data for cdr id 50859, skipping
DEBUG: local col data created or up to date for cdr id 50859, column 'destination_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50859, column 'destination_reseller_free_time_balance': 0, 0
DEBUG: empty 'destination_reseller_profile_package_id' local col data for cdr id 50859, skipping
DEBUG: local col data created or up to date for cdr id 50859, column 'destination_reseller_contract_balance_id': 77412
DEBUG: local col data created or up to date for cdr id 50859, column 'destination_customer_cash_balance': 790, 580
DEBUG: local col data created or up to date for cdr id 50859, column 'destination_customer_free_time_balance': 0, 0
DEBUG: empty 'destination_customer_profile_package_id' local col data for cdr id 50859, skipping
DEBUG: local col data created or up to date for cdr id 50859, column 'destination_customer_contract_balance_id': 77436
DEBUG: rating cdr ID 50859 completed successfully in 0.183 secs
DEBUG: start rating CDR ID 50860
DEBUG: 4 contract(s) locked: 61903, 61904, 61927, 61928
INFO: 3/3 - rate CDR ID 50860
DEBUG: fetching source provider info for source_provider_id #61903
DEBUG: catching up contract ID 61903 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61903 billing mapping (reseller) is profile id 1 for time 1515763100.000 from ipv4 source ip 192.168.0.1
DEBUG: source_provider_info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77411
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'reseller',
                         'product_id' => 3,
                         'prepaid' => 0,
                         'profile_id' => 1,
                         'int_unit' => 'month',
                         'contract_id' => '61903'
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: fetching destination provider info for destination_provider_id #61904
DEBUG: catching up contract ID 61904 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61904 billing mapping (reseller) is profile id 1 for time 1515763100.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_provider_info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '0',
                            'cash_balance_old' => '0',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77412
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'reseller',
                         'product_id' => 3,
                         'prepaid' => 0,
                         'profile_id' => 1,
                         'int_unit' => 'month',
                         'contract_id' => '61904'
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: ### 1. write pass ###
DEBUG: call from local subscriber, source_user_id is 0793a820-8424-4f5a-858f-6ea6c64e7f23
DEBUG: call to local subscriber, destination_user_id is 7e6c54d2-d420-403a-b7f4-3491fffe3762
DEBUG: destination provider has billing profile 1, get reseller termination cost
DEBUG: calculating call cost for profile_id 1 with type call, direction in, src_user_domain 8881231515762707@testa.com.1515762707, dst_user_domain 8882241515762707@testb.com.1515762707
DEBUG: no match for full uris, trying user only for profile_id 1 with type call, direction in, src_user_domain 8881231515762707, dst_user_domain 8882241515762707
DEBUG: 1 contract balance row(s) updated
DEBUG: destination reseller termination cost is 0
DEBUG: get customer termination cost for destination_user_id 7e6c54d2-d420-403a-b7f4-3491fffe3762
DEBUG: catching up contract ID 61928 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61928 billing mapping (sipaccount) is profile id 1135 for time 1515763100.000 from ipv4 source ip 192.168.0.1
DEBUG: destination_customer info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '420',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '580',
                            'cash_balance_old' => '580',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77436
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount',
                         'product_id' => 4,
                         'prepaid' => 1,
                         'profile_id' => 1135,
                         'int_unit' => 'month',
                         'contract_id' => 61928
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: calculating call cost for profile_id 1135 with type call, direction in, src_user_domain 8881231515762707@testa.com.1515762707, dst_user_domain 8882241515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '3',
          'on_follow_interval' => 30,
          'on_init_interval' => 60,
          'on_init_rate' => '3',
          'fee_id' => 1616,
          'off_follow_rate' => '1',
          'source_pattern' => '^8881.+',
          'pattern' => '.',
          'use_free_time' => 0,
          'zone_id' => 504,
          'on_follow_rate' => '1',
          'off_follow_interval' => 30,
          'off_init_interval' => 60
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 3 per sec to costs
DEBUG: interval is 60, so rate for this interval is 180
DEBUG: starting with contract balance: $VAR1 = {
          'free_time_balance_interval' => 0,
          'end_unix' => 1517443199,
          'start_unix' => 1514764800,
          'cash_balance_interval' => '420',
          'free_time_balance_old' => 0,
          'free_time_balance' => 0,
          'cash_balance' => '580',
          'cash_balance_old' => '580',
          'start' => '2018-01-01 00:00:00',
          'id' => 77436
        };
DEBUG: we still have cash balance 580 left, subtract rate 180 from that
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: we still have cash balance 400 left, subtract rate 30 from that
DEBUG: rating_duration = 90
DEBUG: got call cost 0 and free time 0
DEBUG: treat pre-paid billing profile as post-paid for termination fees
DEBUG: 1 contract balance row(s) updated
DEBUG: cost for this call is 210
DEBUG: destination customer termination cost is 210
DEBUG: calculating call cost for profile_id 1 with type call, direction out, src_user_domain 8881231515762707@testa.com.1515762707, dst_user_domain 8882241515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '0',
          'on_follow_interval' => 600,
          'on_init_interval' => 600,
          'on_init_rate' => '0',
          'fee_id' => 1000,
          'off_follow_rate' => '0',
          'source_pattern' => '.',
          'pattern' => '.*',
          'use_free_time' => 0,
          'zone_id' => 1,
          'on_follow_rate' => '0',
          'off_follow_interval' => 600,
          'off_init_interval' => 600
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 0 per sec to costs
DEBUG: interval is 600, so rate for this interval is 0
DEBUG: starting with contract balance: $VAR1 = {
          'end_unix' => 1517443199,
          'free_time_balance_interval' => 0,
          'start_unix' => 1514764800,
          'cash_balance_interval' => 0,
          'free_time_balance' => 0,
          'free_time_balance_old' => 0,
          'cash_balance' => 0,
          'cash_balance_old' => 0,
          'id' => 77411,
          'start' => '2018-01-01 00:00:00'
        };
DEBUG: add current interval cost 0 to total cost 0
DEBUG: rating_duration = 600
DEBUG: 1 contract balance row(s) updated
DEBUG: catching up contract ID 61927 balance rows
DEBUG: 0 contract balance rows created
DEBUG: contract ID 61927 billing mapping (sipaccount) is profile id 1132 for time 1515763100.000 from ipv4 source ip 192.168.0.1
DEBUG: source_customer info is $VAR1 = {
          'balances' => [
                          {
                            'free_time_balance_interval' => 0,
                            'end_unix' => 1517443199,
                            'start_unix' => 1514764800,
                            'cash_balance_interval' => '0',
                            'free_time_balance_old' => 0,
                            'free_time_balance' => 0,
                            'cash_balance' => '1000',
                            'cash_balance_old' => '1000',
                            'start' => '2018-01-01 00:00:00',
                            'id' => 77435
                          }
                        ],
          'billing' => {
                         'int_free_time' => 0,
                         'int_free_cash' => '0',
                         'int_count' => 1,
                         'int_charge' => '0',
                         'class' => 'sipaccount',
                         'product_id' => 4,
                         'prepaid' => 1,
                         'profile_id' => 1132,
                         'int_unit' => 'month',
                         'contract_id' => 61927
                       },
          'package' => {
                         'underrun_profiles_applied' => 0,
                         'underrun_lock_threshold' => undef,
                         'underrun_lock_level' => undef,
                         'underrun_profile_threshold' => undef,
                         'underrun_lock_applied' => 0,
                         'id' => undef
                       }
        };
DEBUG: billing profile is prepaid
DEBUG: prepaid_costs cache already populated
DEBUG: prepaid_costs call_id = *TEST*.8eiLgbxJlN5ibgVT9DnwKStco, source_user_id = 0793a820-8424-4f5a-858f-6ea6c64e7f23, destination_user_id = 7e6c54d2-d420-403a-b7f4-3491fffe3762 found in cache
DEBUG: calculating call cost for profile_id 1132 with type call, direction out, src_user_domain 8881231515762707@testa.com.1515762707, dst_user_domain 8882241515762707@testb.com.1515762707
DEBUG: billing fee is $VAR1 = {
          'off_init_rate' => '4',
          'on_follow_interval' => 30,
          'on_init_interval' => 60,
          'on_init_rate' => '4',
          'fee_id' => 1609,
          'off_follow_rate' => '1',
          'source_pattern' => '.',
          'pattern' => '^8882.+',
          'use_free_time' => 0,
          'zone_id' => 501,
          'on_follow_rate' => '1',
          'off_follow_interval' => 30,
          'off_init_interval' => 60
        };
DEBUG: try to rate remaining duration of 90.000 secs
DEBUG: add init rate 4 per sec to costs
DEBUG: interval is 60, so rate for this interval is 240
DEBUG: starting with contract balance: $VAR1 = {
          'free_time_balance_interval' => 0,
          'end_unix' => 1517443199,
          'start_unix' => 1514764800,
          'cash_balance_interval' => '0',
          'free_time_balance_old' => 0,
          'free_time_balance' => 0,
          'cash_balance' => '1000',
          'cash_balance_old' => '1000',
          'start' => '2018-01-01 00:00:00',
          'id' => 77435
        };
DEBUG: we still have cash balance 1000 left, subtract rate 240 from that
DEBUG: try to rate remaining duration of 30 secs
DEBUG: add follow rate 1 per sec to costs
DEBUG: interval is 30, so rate for this interval is 30
DEBUG: we still have cash balance 760 left, subtract rate 30 from that
DEBUG: rating_duration = 90
DEBUG: got call cost 0 and free time 0
DEBUG: prepaid_costs call_id = *TEST*.8eiLgbxJlN5ibgVT9DnwKStco, source_user_id = 0793a820-8424-4f5a-858f-6ea6c64e7f23, destination_user_id = 7e6c54d2-d420-403a-b7f4-3491fffe3762 deleted
DEBUG: dropped prepaid_costs call_id = *TEST*.8eiLgbxJlN5ibgVT9DnwKStco, source_user_id = 0793a820-8424-4f5a-858f-6ea6c64e7f23, destination_user_id = 7e6c54d2-d420-403a-b7f4-3491fffe3762 from cache
DEBUG: cost for this call is 270
DEBUG: cdr ID 50860 updated
DEBUG: empty 'source_carrier_cash_balance' local col data for cdr id 50860, skipping
DEBUG: empty 'source_carrier_free_time_balance' local col data for cdr id 50860, skipping
DEBUG: empty 'source_carrier_profile_package_id' local col data for cdr id 50860, skipping
DEBUG: empty 'source_carrier_contract_balance_id' local col data for cdr id 50860, skipping
DEBUG: local col data created or up to date for cdr id 50860, column 'source_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50860, column 'source_reseller_free_time_balance': 0, 0
DEBUG: empty 'source_reseller_profile_package_id' local col data for cdr id 50860, skipping
DEBUG: local col data created or up to date for cdr id 50860, column 'source_reseller_contract_balance_id': 77411
DEBUG: local col data created or up to date for cdr id 50860, column 'source_customer_cash_balance': 1270.0000, 1000
DEBUG: local col data created or up to date for cdr id 50860, column 'source_customer_free_time_balance': 0, 0
DEBUG: empty 'source_customer_profile_package_id' local col data for cdr id 50860, skipping
DEBUG: local col data created or up to date for cdr id 50860, column 'source_customer_contract_balance_id': 77435
DEBUG: empty 'destination_carrier_cash_balance' local col data for cdr id 50860, skipping
DEBUG: empty 'destination_carrier_free_time_balance' local col data for cdr id 50860, skipping
DEBUG: empty 'destination_carrier_profile_package_id' local col data for cdr id 50860, skipping
DEBUG: empty 'destination_carrier_contract_balance_id' local col data for cdr id 50860, skipping
DEBUG: local col data created or up to date for cdr id 50860, column 'destination_reseller_cash_balance': 0, 0
DEBUG: local col data created or up to date for cdr id 50860, column 'destination_reseller_free_time_balance': 0, 0
DEBUG: empty 'destination_reseller_profile_package_id' local col data for cdr id 50860, skipping
DEBUG: local col data created or up to date for cdr id 50860, column 'destination_reseller_contract_balance_id': 77412
DEBUG: local col data created or up to date for cdr id 50860, column 'destination_customer_cash_balance': 580, 370
DEBUG: local col data created or up to date for cdr id 50860, column 'destination_customer_free_time_balance': 0, 0
DEBUG: empty 'destination_customer_profile_package_id' local col data for cdr id 50860, skipping
DEBUG: local col data created or up to date for cdr id 50860, column 'destination_customer_contract_balance_id': 77436
DEBUG: rating cdr ID 50860 completed successfully in 0.157 secs
INFO: Batch of 3 CDRs completed. 3 CDRs rated overall so far.
INFO: Less than 5 new CDRs, sleep 10
ok 1046 - rate-o-mat executed
not ok 1047 - prepaid w prepaid costs, balance: destination_reseller_cost = 90.000000
ok 1048 - prepaid w prepaid costs, balance: rating_status = ok
not ok 1049 - prepaid w prepaid costs, balance: source_reseller_cost = 150.000000
ok 1050 - prepaid w prepaid costs, balance: id = 50858
ok 1051 - prepaid w prepaid costs, balance: destination_customer_cost = 210.000000
ok 1052 - prepaid w prepaid costs, balance: source_customer_cost = 270.000000
not ok 1053 - prepaid w prepaid costs, balance: destination_reseller_cost = 90.000000
ok 1054 - prepaid w prepaid costs, balance: id = 50860
not ok 1055 - prepaid w prepaid costs, balance: source_reseller_cost = 150.000000
ok 1056 - prepaid w prepaid costs, balance: rating_status = ok
ok 1057 - prepaid w prepaid costs, balance: destination_customer_cost = 210.000000
ok 1058 - prepaid w prepaid costs, balance: source_customer_cost = 270.000000
not ok 1059 - prepaid w prepaid costs, balance: destination_reseller_cost = 90.000000
not ok 1060 - prepaid w prepaid costs, balance: source_reseller_cost = 150.000000
ok 1061 - prepaid w prepaid costs, balance: id = 50859
ok 1062 - prepaid w prepaid costs, balance: rating_status = ok
ok 1063 - prepaid w prepaid costs, balance: source_customer_cost = 270.000000
ok 1064 - prepaid w prepaid costs, balance: destination_customer_cost = 210.000000
not ok 1065 - cdrs were all processed
ok 1066 - prepaid w prepaid costs, balance, caller 1: cdr id 50858 source_customer_contract_balance_id number of records 1 = 1
ok 1067 - prepaid w prepaid costs, balance, caller 1: fetch customer id 61925 balance intervals collection page
ok 1068 - prepaid w prepaid costs, balance, caller 1: check 'total_count' of collection
ok 1069 - prepaid w prepaid costs, balance, caller 1: check interval 77433 cash balance 10 = 10
ok 1070 - prepaid w prepaid costs, balance, caller 1: check interval 77433 cash balance interval 0 = 0
ok 1071 - prepaid w prepaid costs, balance, caller 1: check interval 77433 id = 77433
ok 1072 - prepaid w prepaid costs, balance, caller 1: check if all expected items are listed
ok 1073 - prepaid w prepaid costs, balance, caller 1: cdr id 50858 source_customer_cash_balance before 1270.0000 = 1270.0000
ok 1074 - prepaid w prepaid costs, balance, caller 1: cdr id 50858 source_customer_cash_balance after 1000.0000 = 1000.0000
ok 1075 - prepaid w prepaid costs, balance, caller 2: cdr id 50859 source_customer_contract_balance_id number of records 1 = 1
ok 1076 - prepaid w prepaid costs, balance, caller 2: fetch customer id 61926 balance intervals collection page
ok 1077 - prepaid w prepaid costs, balance, caller 2: check 'total_count' of collection
ok 1078 - prepaid w prepaid costs, balance, caller 2: check interval 77434 cash balance 10 = 10
ok 1079 - prepaid w prepaid costs, balance, caller 2: check interval 77434 cash balance interval 0 = 0
ok 1080 - prepaid w prepaid costs, balance, caller 2: check interval 77434 id = 77434
ok 1081 - prepaid w prepaid costs, balance, caller 2: check if all expected items are listed
ok 1082 - prepaid w prepaid costs, balance, caller 2: cdr id 50859 source_customer_cash_balance before 1270.0000 = 1270.0000
ok 1083 - prepaid w prepaid costs, balance, caller 2: cdr id 50859 source_customer_cash_balance after 1000.0000 = 1000.0000
ok 1084 - prepaid w prepaid costs, balance, caller 3: cdr id 50860 source_customer_contract_balance_id number of records 1 = 1
ok 1085 - prepaid w prepaid costs, balance, caller 3: fetch customer id 61927 balance intervals collection page
ok 1086 - prepaid w prepaid costs, balance, caller 3: check 'total_count' of collection
ok 1087 - prepaid w prepaid costs, balance, caller 3: check interval 77435 cash balance 10 = 10
ok 1088 - prepaid w prepaid costs, balance, caller 3: check interval 77435 cash balance interval 0 = 0
ok 1089 - prepaid w prepaid costs, balance, caller 3: check interval 77435 id = 77435
ok 1090 - prepaid w prepaid costs, balance, caller 3: check if all expected items are listed
ok 1091 - prepaid w prepaid costs, balance, caller 3: cdr id 50860 source_customer_cash_balance before 1270.0000 = 1270.0000
ok 1092 - prepaid w prepaid costs, balance, caller 3: cdr id 50860 source_customer_cash_balance after 1000.0000 = 1000.0000
ok 1093 - prepaid w prepaid costs, balance, callee: cdr id 50858 destination_customer_contract_balance_id number of records 1 = 1
ok 1094 - prepaid w prepaid costs, balance, callee: fetch customer id 61928 balance intervals collection page
ok 1095 - prepaid w prepaid costs, balance, callee: check 'total_count' of collection
ok 1096 - prepaid w prepaid costs, balance, callee: check interval 77436 cash balance 3.7 = 3.7
ok 1097 - prepaid w prepaid costs, balance, callee: check interval 77436 cash balance interval 6.3 = 6.3
ok 1098 - prepaid w prepaid costs, balance, callee: check interval 77436 id = 77436
ok 1099 - prepaid w prepaid costs, balance, callee: check if all expected items are listed
ok 1100 - prepaid w prepaid costs, balance, callee: cdr id 50858 destination_customer_contract_balance_id 77436 = 77436
ok 1101 - prepaid w prepaid costs, balance, callee: cdr id 50858 destination_customer_cash_balance before 1000.0000 = 1000.0000
ok 1102 - prepaid w prepaid costs, balance, callee: cdr id 50858 destination_customer_cash_balance after 790.0000 = 790.0000
ok 1103 - prepaid w prepaid costs, balance, callee: cdr id 50859 destination_customer_contract_balance_id 77436 = 77436
ok 1104 - prepaid w prepaid costs, balance, callee: cdr id 50859 destination_customer_cash_balance before 790.0000 = 790.0000
ok 1105 - prepaid w prepaid costs, balance, callee: cdr id 50859 destination_customer_cash_balance after 580.0000 = 580.0000
ok 1106 - prepaid w prepaid costs, balance, callee: cdr id 50860 destination_customer_contract_balance_id 77436 = 77436
ok 1107 - prepaid w prepaid costs, balance, callee: cdr id 50860 destination_customer_cash_balance before 580.0000 = 580.0000
ok 1108 - prepaid w prepaid costs, balance, callee: cdr id 50860 destination_customer_cash_balance after 370.0000 = 370.0000
ok 1109 - prepaid w prepaid costs, balance, callers' provider: cdr id 50858 source_reseller_contract_balance_id number of records 1 = 1
ok 1110 - prepaid w prepaid costs, balance, callers' provider: fetch customer id 61903 balance intervals collection page
ok 1111 - prepaid w prepaid costs, balance, callers' provider: check 'total_count' of collection
not ok 1112 - prepaid w prepaid costs, balance, callers' provider: check interval 77411 cash balance interval 0 = 27
ok 1113 - prepaid w prepaid costs, balance, callers' provider: check interval 77411 id = 77411
ok 1114 - prepaid w prepaid costs, balance, callers' provider: check if all expected items are listed
ok 1115 - prepaid w prepaid costs, balance, callers' provider: cdr id 50858 source_carrier_contract_balance_id number of records 0 = 0
ok 1116 - prepaid w prepaid costs, balance, callers' provider: cdr id 50858 source_reseller_contract_balance_id 77411 = 77411
ok 1117 - prepaid w prepaid costs, balance, callers' provider: cdr id 50859 source_carrier_contract_balance_id number of records 0 = 0
ok 1118 - prepaid w prepaid costs, balance, callers' provider: cdr id 50859 source_reseller_contract_balance_id 77411 = 77411
ok 1119 - prepaid w prepaid costs, balance, callers' provider: cdr id 50860 source_carrier_contract_balance_id number of records 0 = 0
ok 1120 - prepaid w prepaid costs, balance, callers' provider: cdr id 50860 source_reseller_contract_balance_id 77411 = 77411
ok 1121 - prepaid w prepaid costs, balance, callee's provider: cdr id 50858 destination_reseller_contract_balance_id number of records 1 = 1
ok 1122 - prepaid w prepaid costs, balance, callee's provider: fetch customer id 61904 balance intervals collection page
ok 1123 - prepaid w prepaid costs, balance, callee's provider: check 'total_count' of collection
not ok 1124 - prepaid w prepaid costs, balance, callee's provider: check interval 77412 cash balance interval 0 = 16.2
ok 1125 - prepaid w prepaid costs, balance, callee's provider: check interval 77412 id = 77412
ok 1126 - prepaid w prepaid costs, balance, callee's provider: check if all expected items are listed
ok 1127 - prepaid w prepaid costs, balance, callee's provider: cdr id 50858 destination_carrier_contract_balance_id number of records 0 = 0
ok 1128 - prepaid w prepaid costs, balance, callee's provider: cdr id 50858 destination_reseller_contract_balance_id 77412 = 77412
ok 1129 - prepaid w prepaid costs, balance, callee's provider: cdr id 50859 destination_carrier_contract_balance_id number of records 0 = 0
ok 1130 - prepaid w prepaid costs, balance, callee's provider: cdr id 50859 destination_reseller_contract_balance_id 77412 = 77412
ok 1131 - prepaid w prepaid costs, balance, callee's provider: cdr id 50860 destination_carrier_contract_balance_id number of records 0 = 0
ok 1132 - prepaid w prepaid costs, balance, callee's provider: cdr id 50860 destination_reseller_contract_balance_id 77412 = 77412
ok 1133 - prepaid w prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50858 source_carrier_profile_package_id number of records 0 = 0
ok 1134 - prepaid w prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50858 source_reseller_profile_package_id number of records 0 = 0
ok 1135 - prepaid w prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50858 source_customer_profile_package_id number of records 0 = 0
ok 1136 - prepaid w prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50858 destination_carrier_profile_package_id number of records 0 = 0
ok 1137 - prepaid w prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50858 destination_reseller_profile_package_id number of records 0 = 0
ok 1138 - prepaid w prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50858 destination_customer_profile_package_id number of records 0 = 0
ok 1139 - prepaid w prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50859 source_carrier_profile_package_id number of records 0 = 0
ok 1140 - prepaid w prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50859 source_reseller_profile_package_id number of records 0 = 0
ok 1141 - prepaid w prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50859 source_customer_profile_package_id number of records 0 = 0
ok 1142 - prepaid w prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50859 destination_carrier_profile_package_id number of records 0 = 0
ok 1143 - prepaid w prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50859 destination_reseller_profile_package_id number of records 0 = 0
ok 1144 - prepaid w prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50859 destination_customer_profile_package_id number of records 0 = 0
ok 1145 - prepaid w prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50860 source_carrier_profile_package_id number of records 0 = 0
ok 1146 - prepaid w prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50860 source_reseller_profile_package_id number of records 0 = 0
ok 1147 - prepaid w prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50860 source_customer_profile_package_id number of records 0 = 0
ok 1148 - prepaid w prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50860 destination_carrier_profile_package_id number of records 0 = 0
ok 1149 - prepaid w prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50860 destination_reseller_profile_package_id number of records 0 = 0
ok 1150 - prepaid w prepaid costs, balance providers and subscriber must not have a profile package: cdr id 50860 destination_customer_profile_package_id number of records 0 = 0
ok 1151 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50858 source_carrier_free_time_balance number of records 0 = 0
ok 1152 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50858 source_reseller_free_time_balance before 0 = 0
ok 1153 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50858 source_reseller_free_time_balance after 0 = 0
ok 1154 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50858 source_customer_free_time_balance before 0 = 0
ok 1155 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50858 source_customer_free_time_balance after 0 = 0
ok 1156 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50858 destination_carrier_free_time_balance number of records 0 = 0
ok 1157 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50858 destination_reseller_free_time_balance before 0 = 0
ok 1158 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50858 destination_reseller_free_time_balance after 0 = 0
ok 1159 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50858 destination_customer_free_time_balance before 0 = 0
ok 1160 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50858 destination_customer_free_time_balance after 0 = 0
ok 1161 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50859 source_carrier_free_time_balance number of records 0 = 0
ok 1162 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50859 source_reseller_free_time_balance before 0 = 0
ok 1163 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50859 source_reseller_free_time_balance after 0 = 0
ok 1164 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50859 source_customer_free_time_balance before 0 = 0
ok 1165 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50859 source_customer_free_time_balance after 0 = 0
ok 1166 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50859 destination_carrier_free_time_balance number of records 0 = 0
ok 1167 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50859 destination_reseller_free_time_balance before 0 = 0
ok 1168 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50859 destination_reseller_free_time_balance after 0 = 0
ok 1169 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50859 destination_customer_free_time_balance before 0 = 0
ok 1170 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50859 destination_customer_free_time_balance after 0 = 0
ok 1171 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50860 source_carrier_free_time_balance number of records 0 = 0
ok 1172 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50860 source_reseller_free_time_balance before 0 = 0
ok 1173 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50860 source_reseller_free_time_balance after 0 = 0
ok 1174 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50860 source_customer_free_time_balance before 0 = 0
ok 1175 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50860 source_customer_free_time_balance after 0 = 0
ok 1176 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50860 destination_carrier_free_time_balance number of records 0 = 0
ok 1177 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50860 destination_reseller_free_time_balance before 0 = 0
ok 1178 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50860 destination_reseller_free_time_balance after 0 = 0
ok 1179 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50860 destination_customer_free_time_balance before 0 = 0
ok 1180 - prepaid w prepaid costs, balance providers and subscriber must have zero free time: cdr id 50860 destination_customer_free_time_balance after 0 = 0
ok 1181 - prepaid w prepaid costs, balance providers must have zero balance: cdr id 50858 source_carrier_cash_balance number of records 0 = 0
ok 1182 - prepaid w prepaid costs, balance providers must have zero balance: cdr id 50858 source_reseller_cash_balance before 0.0000 = 0.0000
ok 1183 - prepaid w prepaid costs, balance providers must have zero balance: cdr id 50858 source_reseller_cash_balance after 0.0000 = 0.0000
ok 1184 - prepaid w prepaid costs, balance providers must have zero balance: cdr id 50858 destination_carrier_cash_balance number of records 0 = 0
ok 1185 - prepaid w prepaid costs, balance providers must have zero balance: cdr id 50858 destination_reseller_cash_balance before 0.0000 = 0.0000
ok 1186 - prepaid w prepaid costs, balance providers must have zero balance: cdr id 50858 destination_reseller_cash_balance after 0.0000 = 0.0000
ok 1187 - prepaid w prepaid costs, balance providers must have zero balance: cdr id 50859 source_carrier_cash_balance number of records 0 = 0
ok 1188 - prepaid w prepaid costs, balance providers must have zero balance: cdr id 50859 source_reseller_cash_balance before 0.0000 = 0.0000
ok 1189 - prepaid w prepaid costs, balance providers must have zero balance: cdr id 50859 source_reseller_cash_balance after 0.0000 = 0.0000
ok 1190 - prepaid w prepaid costs, balance providers must have zero balance: cdr id 50859 destination_carrier_cash_balance number of records 0 = 0
ok 1191 - prepaid w prepaid costs, balance providers must have zero balance: cdr id 50859 destination_reseller_cash_balance before 0.0000 = 0.0000
ok 1192 - prepaid w prepaid costs, balance providers must have zero balance: cdr id 50859 destination_reseller_cash_balance after 0.0000 = 0.0000
ok 1193 - prepaid w prepaid costs, balance providers must have zero balance: cdr id 50860 source_carrier_cash_balance number of records 0 = 0
ok 1194 - prepaid w prepaid costs, balance providers must have zero balance: cdr id 50860 source_reseller_cash_balance before 0.0000 = 0.0000
ok 1195 - prepaid w prepaid costs, balance providers must have zero balance: cdr id 50860 source_reseller_cash_balance after 0.0000 = 0.0000
ok 1196 - prepaid w prepaid costs, balance providers must have zero balance: cdr id 50860 destination_carrier_cash_balance number of records 0 = 0
ok 1197 - prepaid w prepaid costs, balance providers must have zero balance: cdr id 50860 destination_reseller_cash_balance before 0.0000 = 0.0000
ok 1198 - prepaid w prepaid costs, balance providers must have zero balance: cdr id 50860 destination_reseller_cash_balance after 0.0000 = 0.0000
1..1198
